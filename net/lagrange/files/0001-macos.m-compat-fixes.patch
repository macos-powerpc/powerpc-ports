From 4827215ec1bf4321156204b88a3a481e98e010c0 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Sun, 8 Feb 2026 09:32:15 +0800
Subject: [PATCH 2/2] macos.m: compat fixes

---
 src/macos.m | 162 ++++++++++++++++++++++++++++++++++++++++++----------
 1 file changed, 133 insertions(+), 29 deletions(-)

diff --git src/macos.m src/macos.m
index 16552c17..9f411d61 100644
--- src/macos.m
+++ src/macos.m
@@ -33,30 +33,52 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. */
 #include <SDL_syswm.h>
 #include <the_Foundation/stringset.h>
 
+#include <AvailabilityMacros.h>
+
 #import <AppKit/AppKit.h>
 
 #if defined (LAGRANGE_ENABLE_SPARKLE)
 #   import <Sparkle/Sparkle.h>
 #endif
 
+#if MAC_OS_X_VERSION_MAX_ALLOWED < 101200
+    typedef NSUInteger NSEventModifierFlags;
+#endif
+
+#ifndef NSEventModifierFlagCommand
+#   define NSEventModifierFlagCommand NSCommandKeyMask
+#   define NSEventModifierFlagOption NSAlternateKeyMask
+#   define NSEventModifierFlagControl NSControlKeyMask
+#   define NSEventModifierFlagShift NSShiftKeyMask
+#   define NSEventModifierFlagFunction NSFunctionKeyMask
+#   define NSEventModifierFlagCapsLock NSAlphaShiftKeyMask
+#   define NSEventMaskScrollWheel NSScrollWheelMask
+#   define NSEventMaskKeyDown NSKeyDownMask
+#   define NSControlStateValueOn NSOnState
+#endif
+
+#if !defined(__clang__) || MAC_OS_X_VERSION_MAX_ALLOWED < 101202
+#   define LAGRANGE_NO_TOUCHBAR
+#endif
+
+#if !defined(__clang__) || MAC_OS_X_VERSION_MAX_ALLOWED < 1070
+#   define OBJC_NO_GENERICS
+#endif
+
+#ifndef LAGRANGE_NO_TOUCHBAR
 static NSTouchBarItemIdentifier goBack_TouchId_      = @"fi.skyjake.Lagrange.back";
 static NSTouchBarItemIdentifier goForward_TouchId_   = @"fi.skyjake.Lagrange.forward";
 static NSTouchBarItemIdentifier find_TouchId_        = @"fi.skyjake.Lagrange.find";
 static NSTouchBarItemIdentifier newTab_TouchId_      = @"fi.skyjake.Lagrange.tabs.new";
 static NSTouchBarItemIdentifier sidebarMode_TouchId_ = @"fi.skyjake.Lagrange.sidebar.mode";
+#else
+typedef NSString* NSTouchBarItemIdentifier;
+#endif
 
 enum iTouchBarVariant {
     default_TouchBarVariant,
 };
 
-static iInt2 macVer_(void) {
-    if ([[NSProcessInfo processInfo] respondsToSelector:@selector(operatingSystemVersion)]) {
-        const NSOperatingSystemVersion ver = [[NSProcessInfo processInfo] operatingSystemVersion];
-        return init_I2(ver.majorVersion, ver.minorVersion);
-    }
-    return init_I2(10, 10);
-}
-
 static NSWindow *nsWindow_(SDL_Window *window) {
     SDL_SysWMinfo wm;
     SDL_VERSION(&wm.version);
@@ -69,17 +91,12 @@ static NSWindow *nsWindow_(SDL_Window *window) {
 
 static NSString *currentSystemAppearance_(void) {
     /* This API does not exist on 10.13. */
-    if ([NSApp respondsToSelector:@selector(effectiveAppearance)]) {
+    @try {
         return [[NSApp effectiveAppearance] name];
     }
-    return @"NSAppearanceNameAqua";
-}
-
-iBool shouldDefaultToMetalRenderer_MacOS(void) {
-    const iInt2 ver = macVer_();
-    SDL_DisplayMode dispMode;
-    SDL_GetDesktopDisplayMode(0, &dispMode);
-    return dispMode.refresh_rate > 60 && (ver.x > 10 || ver.y > 13);
+    @catch (NSException *) {
+        return @"NSAppearanceNameAqua";
+    }
 }
 
 static void ignoreImmediateKeyDownEvents_(void) {
@@ -94,6 +111,7 @@ static void ignoreImmediateKeyDownEvents_(void) {
 
 /*----------------------------------------------------------------------------------------------*/
 
+#ifndef LAGRANGE_NO_TOUCHBAR
 @interface CommandButton : NSCustomTouchBarItem {
     NSString *command;
     iWidget *widget;
@@ -158,11 +176,16 @@ static void ignoreImmediateKeyDownEvents_(void) {
 }
 
 @end
+#endif /* LAGRANGE_NO_TOUCHBAR */
 
 /*----------------------------------------------------------------------------------------------*/
 
 @interface MenuCommands : NSObject {
+#ifdef OBJC_NO_GENERICS
+    NSMutableDictionary *commands;
+#else
     NSMutableDictionary<NSString *, NSString *> *commands;
+#endif
     iWidget *source;
 }
 @end
@@ -171,12 +194,16 @@ static void ignoreImmediateKeyDownEvents_(void) {
 
 - (id)init {
     self = [super init];
-    commands = [[NSMutableDictionary<NSString *, NSString *> alloc] init];
+    commands = [[NSMutableDictionary
+#ifndef OBJC_NO_GENERICS
+                <NSString *, NSString *>
+#endif
+                alloc] init];
     source = NULL;
     return self;
 }
 
-- (void)setCommand:(NSString * __nonnull)command forMenuItem:(NSMenuItem * __nonnull)menuItem {
+- (void)setCommand:(NSString *)command forMenuItem:(NSMenuItem *)menuItem {
     [commands setObject:command forKey:[menuItem title]];
 }
 
@@ -213,7 +240,10 @@ static NSMenuItem *makeMenuItems_(NSMenu *menu, MenuCommands *commands, int atIn
 
 /*----------------------------------------------------------------------------------------------*/
 
-@interface MyDelegate : NSResponder<NSApplicationDelegate, NSTouchBarDelegate
+@interface MyDelegate : NSResponder<NSApplicationDelegate
+#ifndef LAGRANGE_NO_TOUCHBAR
+        , NSTouchBarDelegate
+#endif
 #if defined (LAGRANGE_ENABLE_SPARKLE)
         , SUUpdaterDelegate
 #endif
@@ -224,10 +254,17 @@ static NSMenuItem *makeMenuItems_(NSMenu *menu, MenuCommands *commands, int atIn
     MenuCommands *menuCommands;
 }
 - (id)initWithSDLDelegate:(NSObject<NSApplicationDelegate> *)sdl;
+#ifndef LAGRANGE_NO_TOUCHBAR
 - (NSTouchBar *)makeTouchBar;
+#endif
 - (BOOL)application:(NSApplication *)app openFile:(NSString *)filename;
+#ifdef OBJC_NO_GENERICS
+- (void)application:(NSApplication *)app openFiles:(NSArray *)filenames;
+- (void)application:(NSApplication *)app openURLs:(NSArray *)urls;
+#else
 - (void)application:(NSApplication *)app openFiles:(NSArray<NSString *> *)filenames;
 - (void)application:(NSApplication *)app openURLs:(NSArray<NSURL *> *)urls;
+#endif
 - (void)applicationDidFinishLaunching:(NSNotification *)notifications;
 - (BOOL)applicationShouldTerminateAfterLastWindowClosed:(NSApplication *)sender;
 - (NSApplicationTerminateReply)applicationShouldTerminate:(NSApplication *)sender;
@@ -256,8 +293,10 @@ static NSMenuItem *makeMenuItems_(NSMenu *menu, MenuCommands *commands, int atIn
 }
 
 - (void)setTouchBarVariant:(enum iTouchBarVariant)variant {
+#ifndef LAGRANGE_NO_TOUCHBAR
     touchBarVariant = variant;
     self.touchBar = nil;
+#endif
 }
 
 - (MenuCommands *)menuCommands {
@@ -280,7 +319,9 @@ static void appearanceChanged_MacOS_(NSString *name) {
             [currentAppearanceName release];
         }
         currentAppearanceName = [name retain];
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 101400
         appearanceChanged_MacOS_(currentAppearanceName);
+#endif
     }
 }
 
@@ -288,7 +329,11 @@ static void appearanceChanged_MacOS_(NSString *name) {
     return [sdlDelegate application:app openFile:filename];
 }
 
-- (void)application:(NSApplication *)app openFiles:(NSArray<NSString *> *)filenames {
+- (void)application:(NSApplication *)app openFiles:(NSArray
+#ifndef OBJC_NO_GENERICS
+                                                    <NSString *>
+#endif
+                                                    *)filenames {
     /* TODO: According to AppKit docs, this method won't be called when openURLs is defined. */
     for (NSString *fn in filenames) {
         NSLog(@"openFiles: %@", fn);
@@ -296,7 +341,11 @@ static void appearanceChanged_MacOS_(NSString *name) {
     }
 }
 
-- (void)application:(NSApplication *)app openURLs:(NSArray<NSURL *> *)urls {
+- (void)application:(NSApplication *)app openURLs:(NSArray
+#ifndef OBJC_NO_GENERICS
+                                                    <NSURL *>
+#endif
+                                                    *)urls {
     for (NSURL *url in urls) {
         NSLog(@"openURLs: %@", [url absoluteString]);
         [sdlDelegate application:app openFile:[url absoluteString]];
@@ -343,10 +392,14 @@ static void appearanceChanged_MacOS_(NSString *name) {
                        context:(void *)context {
     iUnused(object, change);
     if ([keyPath isEqualToString:@"effectiveAppearance"] && context == self) {
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 101400
         [self setAppearance:[[NSApp effectiveAppearance] name]];
+#endif
     }
 }
 
+#ifndef LAGRANGE_NO_TOUCHBAR
+
 - (NSTouchBar *)makeTouchBar {
     NSTouchBar *bar = [[NSTouchBar alloc] init];
     bar.delegate = self;
@@ -424,6 +477,8 @@ static void appearanceChanged_MacOS_(NSString *name) {
     return nil;
 }
 
+#endif /* LAGRANGE_NO_TOUCHBAR */
+
 @end
 
 void enableMomentumScroll_MacOS(void) {
@@ -458,7 +513,11 @@ void registerURLHandler_MacOS(void) {
 }
 
 static iBool processKeyDownEvent_(NSEvent *event) {
+#ifdef NSEventModifierFlagFunction
     if ((event.modifierFlags & NSEventModifierFlagFunction) && (event.keyCode == 0xe)) {
+#else
+    if ((event.modifierFlags & NSFunctionKeyMask) && (event.keyCode == 0xe)) {
+#endif
         /* Globe-E shows the sysetm Character Viewer in recent versions of macOS. */
         postCommand_App("emojipicker");
         return iTrue;
@@ -470,8 +529,15 @@ static int swipeDir_ = 0;
 static int preventTapGlitch_ = 0;
 
 static iBool processScrollWheelEvent_(NSEvent *event) {
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 101200
     const iBool isPerPixel = (event.hasPreciseScrollingDeltas != 0);
     const iBool isInertia  = (event.momentumPhase & (NSEventPhaseBegan | NSEventPhaseChanged)) != 0;
+#else
+    const iBool isPerPixel = iFalse;
+    const iBool isInertia  = iFalse;
+    #define scrollingDeltaX deltaX
+    #define scrollingDeltaY deltaY
+#endif
     const iBool isEnded    = event.scrollingDeltaX == 0.0f && event.scrollingDeltaY == 0.0f && !isInertia;
     const iWindow *win     = NULL; //&get_MainWindow()->base;
     /* If this event belongs to one of the MainWindows, handle it and mark it for that window.
@@ -489,6 +555,7 @@ static iBool processScrollWheelEvent_(NSEvent *event) {
     if (isPerPixel) {
         /* On macOS 12.1, stopping ongoing inertia scroll with a tap seems to sometimes produce
            spurious large scroll events. */
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 101200
         switch (preventTapGlitch_) {
             case 0:
                 if (isInertia && event.momentumPhase == NSEventPhaseChanged) {
@@ -520,6 +587,7 @@ static iBool processScrollWheelEvent_(NSEvent *event) {
                 preventTapGlitch_ = 0;
                 break;
         }
+#endif
     }
     else {
         SDL_MouseWheelEvent e = { .type = SDL_MOUSEWHEEL };
@@ -527,8 +595,18 @@ static iBool processScrollWheelEvent_(NSEvent *event) {
         e.windowID = id_Window(win);
         e.which = 1; /* Distinction between trackpad and regular mouse. */
         /* Disregard any wheel acceleration. */
-        e.x = event.scrollingDeltaX > 0 ? 1 : event.scrollingDeltaX < 0 ? -1 : 0;
-        e.y = event.scrollingDeltaY > 0 ? 1 : event.scrollingDeltaY < 0 ? -1 : 0;
+        /* Disregard any wheel acceleration. Use runtime-available accessors. */
+        CGFloat dx = 0, dy = 0;
+        if ([event respondsToSelector:@selector(scrollingDeltaX)]) {
+            dx = [event scrollingDeltaX];
+            dy = [event scrollingDeltaY];
+        }
+        else {
+            dx = [event deltaX];
+            dy = [event deltaY];
+        }
+        e.x = dx > 0 ? 1 : dx < 0 ? -1 : 0;
+        e.y = dy > 0 ? 1 : dy < 0 ? -1 : 0;
         SDL_PushEvent((SDL_Event *) &e);
         return iTrue;
     }
@@ -541,8 +619,17 @@ static iBool processScrollWheelEvent_(NSEvent *event) {
     if (isPerPixel) {
         setInertia_MouseWheelEvent(&e, isInertia);
         setScrollFinished_MouseWheelEvent(&e, isEnded);
-        e.x = event.scrollingDeltaX * win->pixelRatio;
-        e.y = event.scrollingDeltaY * win->pixelRatio;
+        CGFloat dx = 0, dy = 0;
+        if ([event respondsToSelector:@selector(scrollingDeltaX)]) {
+            dx = [event scrollingDeltaX];
+            dy = [event scrollingDeltaY];
+        }
+        else {
+            dx = [event deltaX];
+            dy = [event deltaY];
+        }
+        e.x = dx * win->pixelRatio;
+        e.y = dy * win->pixelRatio;
         /* Only scroll on one axis at a time. */
         if (swipeDir_ == 0) {
             swipeDir_ = iAbs(e.x) > iAbs(e.y) ? 1 : 2;
@@ -559,8 +646,17 @@ static iBool processScrollWheelEvent_(NSEvent *event) {
     }
     else {
         /* Disregard wheel acceleration applied by the OS. */
-        e.x = -event.scrollingDeltaX;
-        e.y = iSign(event.scrollingDeltaY);
+        CGFloat dx = 0, dy = 0;
+        if ([event respondsToSelector:@selector(scrollingDeltaX)]) {
+            dx = [event scrollingDeltaX];
+            dy = [event scrollingDeltaY];
+        }
+        else {
+            dx = [event deltaX];
+            dy = [event deltaY];
+        }
+        e.x = -dx;
+        e.y = iSign(dy);
     }
 //    printf("#### Window %d [%d] dx:%d dy:%d phase:%ld inertia:%d end:%d\n", e.windowID,
 //           preventTapGlitch_, e.x, e.y, (long) event.momentumPhase,
@@ -605,7 +701,7 @@ void setupApplication_MacOS(void) {
     };
     makeMenuItems_(windowMenu, [myDel menuCommands], 4, iFalse,
                    macWindowMenuItems_, iElemCount(macWindowMenuItems_));
-
+#ifdef __clang__
     [NSEvent addLocalMonitorForEventsMatchingMask:NSEventMaskScrollWheel
                                           handler:^NSEvent*(NSEvent *event){
                                             if (event.type == NSEventTypeScrollWheel &&
@@ -622,6 +718,7 @@ void setupApplication_MacOS(void) {
                                               }
                                               return event;
                                           }];
+#endif /* __clang__ */
 #if defined (LAGRANGE_ENABLE_SPARKLE)
     [[SUUpdater sharedUpdater] setDelegate:myDel];
 #endif
@@ -1012,8 +1109,12 @@ void showPopupMenu_MacOS(iWidget *source, iInt2 windowCoord, const iMenuItem *it
     }
     windowCoord.y = window->size.y - windowCoord.y;
     windowCoord = divf_I2(windowCoord, window->pixelRatio);
+#if MAC_OS_X_VERSION_MAX_ALLOWED < 1070
+    NSPoint screenPoint = [nsWindow convertBaseToScreen:NSMakePoint(0, 0)];
+#else
     NSPoint screenPoint = [nsWindow convertRectToScreen:(CGRect){ { windowCoord.x, windowCoord.y },
                                   { 0, 0 } }].origin;
+#endif
     NSMenuItem *selectedItem = makeMenuItems_(menu, menuCommands, 0, iFalse, items, n);
     [menuCommands setSource:source];
     if (isCentered) {
@@ -1052,6 +1153,7 @@ void showPopupMenu_MacOS(iWidget *source, iInt2 windowCoord, const iMenuItem *it
 }
 
 iColor systemAccent_Color(void) {
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 101400
     if (@available(macOS 10.14, *)) {
         NSColor *accent = [[NSColor controlAccentColor] colorUsingColorSpace:
                                                             [NSColorSpace deviceRGBColorSpace]];
@@ -1061,6 +1163,8 @@ iColor systemAccent_Color(void) {
                          255 };
     }
     return get_Color(cyan_ColorId);
+#endif
+    return (iColor){ 255, 255, 255, 255 };
 }
 
 #if defined (LAGRANGE_ENABLE_SPARKLE)

From e9b1c7041f0912a3b833d8b4def1e76d81cf0396 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Tue, 10 Feb 2026 14:25:08 +0800
Subject: [PATCH 3/3] upd

---
 src/macos.m | 81 ++++++++++++++++++++++++-----------------------------
 1 file changed, 36 insertions(+), 45 deletions(-)

diff --git src/macos.m src/macos.m
index 9f411d61..b9f7e164 100644
--- src/macos.m
+++ src/macos.m
@@ -90,13 +90,21 @@ static NSWindow *nsWindow_(SDL_Window *window) {
 }
 
 static NSString *currentSystemAppearance_(void) {
-    /* This API does not exist on 10.13. */
-    @try {
+    /* This API does not exist on 10.13. Prefer selector check over exceptions. */
+    if ([NSApp respondsToSelector:@selector(effectiveAppearance)]) {
         return [[NSApp effectiveAppearance] name];
     }
-    @catch (NSException *) {
-        return @"NSAppearanceNameAqua";
-    }
+    return @"NSAppearanceNameAqua";
+}
+
+static iInt2 macVer_(void) {
+    /* Minimal macOS version. */
+    return init_I2(10, 5);
+}
+
+iBool shouldDefaultToMetalRenderer_MacOS(void) {
+    /* Disable Metal. */
+    return iFalse;
 }
 
 static void ignoreImmediateKeyDownEvents_(void) {
@@ -529,16 +537,27 @@ static int swipeDir_ = 0;
 static int preventTapGlitch_ = 0;
 
 static iBool processScrollWheelEvent_(NSEvent *event) {
-#if MAC_OS_X_VERSION_MAX_ALLOWED >= 101200
-    const iBool isPerPixel = (event.hasPreciseScrollingDeltas != 0);
-    const iBool isInertia  = (event.momentumPhase & (NSEventPhaseBegan | NSEventPhaseChanged)) != 0;
-#else
-    const iBool isPerPixel = iFalse;
-    const iBool isInertia  = iFalse;
-    #define scrollingDeltaX deltaX
-    #define scrollingDeltaY deltaY
+    /* Runtime feature checks; avoid ObjC dot syntax for GCC. */
+    iBool isPerPixel = iFalse;
+    if ([event respondsToSelector:@selector(hasPreciseScrollingDeltas)]) {
+        isPerPixel = [event hasPreciseScrollingDeltas] != 0;
+    }
+    iBool isInertia = iFalse;
+#ifdef NSEventPhaseChanged
+    if ([event respondsToSelector:@selector(momentumPhase)]) {
+        NSUInteger phase = (NSUInteger) [event momentumPhase];
+        isInertia = (phase & (NSEventPhaseBegan | NSEventPhaseChanged)) != 0;
+    }
 #endif
-    const iBool isEnded    = event.scrollingDeltaX == 0.0f && event.scrollingDeltaY == 0.0f && !isInertia;
+    CGFloat dx = 0, dy = 0;
+    if ([event respondsToSelector:@selector(scrollingDeltaX)]) {
+        dx = [event scrollingDeltaX];
+        dy = [event scrollingDeltaY];
+    } else {
+        dx = [event deltaX];
+        dy = [event deltaY];
+    }
+    const iBool isEnded = (dx == 0.0f && dy == 0.0f && !isInertia);
     const iWindow *win     = NULL; //&get_MainWindow()->base;
     /* If this event belongs to one of the MainWindows, handle it and mark it for that window.
        If it's for an auxiliary window, let the system handle it. */
@@ -595,16 +614,6 @@ static iBool processScrollWheelEvent_(NSEvent *event) {
         e.windowID = id_Window(win);
         e.which = 1; /* Distinction between trackpad and regular mouse. */
         /* Disregard any wheel acceleration. */
-        /* Disregard any wheel acceleration. Use runtime-available accessors. */
-        CGFloat dx = 0, dy = 0;
-        if ([event respondsToSelector:@selector(scrollingDeltaX)]) {
-            dx = [event scrollingDeltaX];
-            dy = [event scrollingDeltaY];
-        }
-        else {
-            dx = [event deltaX];
-            dy = [event deltaY];
-        }
         e.x = dx > 0 ? 1 : dx < 0 ? -1 : 0;
         e.y = dy > 0 ? 1 : dy < 0 ? -1 : 0;
         SDL_PushEvent((SDL_Event *) &e);
@@ -619,15 +628,7 @@ static iBool processScrollWheelEvent_(NSEvent *event) {
     if (isPerPixel) {
         setInertia_MouseWheelEvent(&e, isInertia);
         setScrollFinished_MouseWheelEvent(&e, isEnded);
-        CGFloat dx = 0, dy = 0;
-        if ([event respondsToSelector:@selector(scrollingDeltaX)]) {
-            dx = [event scrollingDeltaX];
-            dy = [event scrollingDeltaY];
-        }
-        else {
-            dx = [event deltaX];
-            dy = [event deltaY];
-        }
+        /* Use the dx/dy computed earlier. */
         e.x = dx * win->pixelRatio;
         e.y = dy * win->pixelRatio;
         /* Only scroll on one axis at a time. */
@@ -646,15 +647,6 @@ static iBool processScrollWheelEvent_(NSEvent *event) {
     }
     else {
         /* Disregard wheel acceleration applied by the OS. */
-        CGFloat dx = 0, dy = 0;
-        if ([event respondsToSelector:@selector(scrollingDeltaX)]) {
-            dx = [event scrollingDeltaX];
-            dy = [event scrollingDeltaY];
-        }
-        else {
-            dx = [event deltaX];
-            dy = [event deltaY];
-        }
         e.x = -dx;
         e.y = iSign(dy);
     }
@@ -1110,7 +1102,7 @@ void showPopupMenu_MacOS(iWidget *source, iInt2 windowCoord, const iMenuItem *it
     windowCoord.y = window->size.y - windowCoord.y;
     windowCoord = divf_I2(windowCoord, window->pixelRatio);
 #if MAC_OS_X_VERSION_MAX_ALLOWED < 1070
-    NSPoint screenPoint = [nsWindow convertBaseToScreen:NSMakePoint(0, 0)];
+    NSPoint screenPoint = [nsWindow convertBaseToScreen:NSMakePoint(windowCoord.x, windowCoord.y)];
 #else
     NSPoint screenPoint = [nsWindow convertRectToScreen:(CGRect){ { windowCoord.x, windowCoord.y },
                                   { 0, 0 } }].origin;
@@ -1162,9 +1154,8 @@ iColor systemAccent_Color(void) {
                          iClamp([accent blueComponent]  * 255, 0, 255),
                          255 };
     }
-    return get_Color(cyan_ColorId);
 #endif
-    return (iColor){ 255, 255, 255, 255 };
+    return get_Color(cyan_ColorId);
 }
 
 #if defined (LAGRANGE_ENABLE_SPARKLE)
