From 4b14718017b90351570897d060c9a42fe57f25c5 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 29 Jan 2026 00:19:31 +0800
Subject: [PATCH] Fix Makefile

diff --git a/Makefile.in b/Makefile.in
index 33419b8..e2cb075 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -16,12 +16,10 @@ BORING_SSL_COMMIT := 673e61fc215b178a90c0e67858bbf162c8158993
 # We need to pin to 1.64 or lower, since the priority flag was removed.
 # See: https://nghttp2.org/blog/2025/03/02/nghttp2-v1-65-0/
 NGHTTP2_VERSION := 1.63.0
-NGHTTP2_URL := https://github.com/nghttp2/nghttp2/releases/download/v$(NGHTTP2_VERSION)/nghttp2-$(NGHTTP2_VERSION).tar.bz2
 NGTCP2_VERSION := 1.11.0
-NGTCP2_URL := https://github.com/ngtcp2/ngtcp2/releases/download/v$(NGTCP2_VERSION)/ngtcp2-$(NGTCP2_VERSION).tar.bz2
 NGHTTP3_VERSION := 1.9.0
-NGHTTP3_URL := https://github.com/ngtcp2/nghttp3/releases/download/v$(NGHTTP3_VERSION)/nghttp3-$(NGHTTP3_VERSION).tar.bz2
-CURL_VERSION := curl-8_15_0
+CURL_TAG := 8_15_0
+CURL_DIST := curl-$(CURL_TAG)
 
 # https://github.com/google/brotli/commit/641bec0e30bea648b3da1cd90fc6b44deb429f71
 brotli_install_dir := $(abspath brotli-$(BROTLI_VERSION)/out/installed)
@@ -70,15 +68,13 @@ help: ## Show this help message
 .PHONY: help
 .DEFAULT_GOAL := help
 
-build: $(CURL_VERSION)/.chrome
-	cd $(CURL_VERSION)
-	# Don't pass this Makefile's MAKEFLAGS
-	$(MAKE) MAKEFLAGS=-j$(SUBJOBS)
+build: $(CURL_DIST)/.chrome
+	cd $(CURL_DIST) && $(MAKE) MAKEFLAGS=-j$(SUBJOBS)
 .PHONY: build
 
 checkbuild: ## Run basic checks on the built binary
 ifeq ($(host),$(build))
-	cd $(CURL_VERSION)
+	cd $(CURL_DIST)
 	# Make sure all needed features were compiled in
 	./src/curl-impersonate -V | grep -q zlib
 	./src/curl-impersonate -V | grep -q brotli
@@ -91,24 +87,15 @@ endif
 .PHONY: checkbuild
 
 install:
-	cd $(CURL_VERSION)
-	$(MAKE) install-exec MAKEFLAGS=
-	# Wrapper scripts for the cli shortcut (e.g. 'curl_chrome99')
-	install $(srcdir)/bin/curl_* @bindir@
+	cd $(CURL_DIST) && $(MAKE) install-exec MAKEFLAGS= && install $(srcdir)/bin/curl_* @bindir@
 .PHONY: install
 
 install-strip: ## Like 'install', but strip binaries for smaller size
-	cd $(CURL_VERSION)
-	$(MAKE) install-exec MAKEFLAGS=
-	# We could have used 'install-strip' but then the docs would be installed as well.
-	# Instead strip manually.
-	$(STRIP) @bindir@/curl-impersonate
-	# Wrapper scripts for the cli shortcut (e.g. 'curl_chrome99')
-	install $(srcdir)/bin/curl_* @bindir@
+	cd $(CURL_DIST) && $(MAKE) install-exec MAKEFLAGS= && $(STRIP) @bindir@/curl-impersonate && install $(srcdir)/bin/curl_* @bindir@
 .PHONY: install-strip
 
 uninstall: ## Uninstall the Chrome version of curl-impersonate after 'make install'
-	cd $(CURL_VERSION)
+	cd $(CURL_DIST)
 	$(MAKE) uninstall MAKEFLAGS=
 	rm -Rf @bindir@/curl_*
 .PHONY: uninstall
@@ -120,7 +107,7 @@ clean:
 	rm -Rf nghttp2-$(NGHTTP2_VERSION).tar.bz2 nghttp2-$(NGHTTP2_VERSION)
 	rm -Rf ngtcp2-$(NGTCP2_VERSION).tar.bz2 ngtcp2-$(NGTCP2_VERSION)
 	rm -Rf nghttp3-$(NGHTTP3_VERSION).tar.bz2 nghttp3-$(NGHTTP3_VERSION)
-	rm -Rf $(CURL_VERSION).tar.gz $(CURL_VERSION)
+	rm -Rf $(CURL_DIST).tar.gz $(CURL_DIST)
 .PHONY: clean
 
 
@@ -288,77 +286,19 @@ $(nghttp3_static_libs): nghttp3-$(NGHTTP3_VERSION).tar.bz2
 	$(MAKE) MAKEFLAGS=-j$(SUBJOBS)
 	$(MAKE) install MAKEFLAGS=
 
-$(CURL_VERSION).tar.gz:
-	curl -L "https://github.com/curl/curl/archive/$(CURL_VERSION).tar.gz" \
-		-o "$(CURL_VERSION).tar.gz"
+$(CURL_DIST).tar.gz:
+	curl -L "https://github.com/curl/curl/archive/$(CURL_DIST).tar.gz" \
+		-o "$(CURL_DIST).tar.gz"
 
 # Apply the "Chorme version" patches and mark using a dummy file
-$(CURL_VERSION)/.patched: $(srcdir)/patches/curl.patch
-	rm -Rf $(CURL_VERSION)
-	tar -xf $(CURL_VERSION).tar.gz
-	mv curl-$(CURL_VERSION) $(CURL_VERSION)  # fix directory name
-	cd $(CURL_VERSION)
-	for p in $^; do patch -p1 < $$p; done
-	# Re-generate the configure script
-	autoreconf -fi
-	touch .patched
+$(CURL_DIST)/.patched:
+	cd $(CURL_DIST) && autoreconf -fi && touch .patched
 
 # This is a small hack that flags that curl was patched and configured in the "chrome" version
-$(CURL_VERSION)/.chrome: $(chrome_libs)	$(CURL_VERSION).tar.gz $(CURL_VERSION)/.patched
-	cd $(CURL_VERSION)
-
-	# Set up the configure flags to curl.
-	# If the user provided the --host flag to our configure script
-	# (for cross compilation), then pass it on to curl.
-	
-	# XXX: psl should be enabled in the future:
-	# https://daniel.haxx.se/blog/2024/01/10/psl-in-curl/
-	{ \
-	  config_flags="--prefix=@prefix@"; \
-	  config_flags="$$config_flags --with-brotli=$(brotli_install_dir)"; \
-	  config_flags="$$config_flags --with-nghttp2=$(nghttp2_install_dir)"; \
-	  config_flags="$$config_flags --with-ngtcp2=$(ngtcp2_install_dir)"; \
-	  config_flags="$$config_flags --with-nghttp3=$(nghttp3_install_dir)"; \
-	  config_flags="$$config_flags --with-openssl=$(boringssl_dir)"; \
-	  config_flags="$$config_flags --without-libpsl"; \
-	  config_flags="$$config_flags --enable-websockets"; \
-	  config_flags="$$config_flags --enable-ech"; \
-	  config_flags="$$config_flags --enable-ssls-export"; \
-	  config_flags="$$config_flags --enable-ipv6"; \
-	  config_flags="$$config_flags USE_CURL_SSLKEYLOGFILE=true"; \
-	  if test "$(static_build)" = "yes"; then \
-	    config_flags="$$config_flags --enable-static --disable-shared"; \
-	  fi; \
-	  if test -n "$(host_alias)"; then \
-	    config_flags="$$config_flags --host=$(host_alias)"; \
-	  fi; \
-	  if test -n "$(with_zlib)"; then \
-	    config_flags="$$config_flags --with-zlib=$(with_zlib)"; \
-	  else \
-	    config_flags+=" --with-zlib"; \
-	  fi; \
-	  if test -n "$(with_zstd)"; then \
-	    config_flags="$$config_flags --with-zstd=$(with_zstd)"; \
-	  else \
-	    config_flags+=" --with-zstd"; \
-	  fi; \
-	  if test -n "$(with_ca_bundle)"; then \
-		config_flags="$$config_flags --with-ca-bundle=$(with_ca_bundle)"; \
-	  fi; \
-	  if test -n "$(with_ca_path)"; then \
-		config_flags="$$config_flags --with-ca-path=$(with_ca_path)"; \
-	  fi; \
-	  add_libs="-pthread -lc++"; \
-	}
-
-	echo "Configuring curl with: $$config_flags"
-
-	LDFLAGS="-Wl,-rpath,$(ngtcp2_install_dir)/lib" \
-			 ./configure \
-			 $$config_flags \
-			 LIBS="$$add_libs" \
-			 PKG_CONFIG_PATH="$(ngtcp2_install_dir)/crypto/boringssl/"
-
-	# Remove possible leftovers from a previous compilation
-	$(MAKE) clean MAKEFLAGS=
-	touch .chrome
+$(CURL_DIST)/.chrome: $(CURL_DIST)/.patched
+	cd ./$(CURL_DIST) && CC=@CC@ LDFLAGS="$(LDFLAGS) -Wl,-rpath,$(ngtcp2_install_dir)/lib" LIBS="-pthread -l@CXXLIB@" PKG_CONFIG_PATH="$(ngtcp2_install_dir)/lib/pkgconfig" \
+		./configure --prefix=@prefix@ $(CURL_CONFIG_FLAGS) --with-ca-bundle=$(with_ca_bundle) --with-brotli=$(brotli_install_dir) \
+		--with-nghttp2=$(nghttp2_install_dir) --with-nghttp3=$(nghttp3_install_dir) --with-ngtcp2=$(ngtcp2_install_dir) \
+		--with-openssl=$(boringssl_dir) --without-libpsl --enable-websockets --enable-ech --enable-ssls-export \
+		--enable-ipv6 --enable-static --disable-shared --disable-ldap --with-zlib=$(with_zlib) --with-zstd==$(with_zstd) \
+		&& touch .chrome
