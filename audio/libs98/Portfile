# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           makefile 1.0

set modname         s98
name                lib${modname}
github.setup        TTK-qmmp qmmp-${modname} 1afca4e92220e3a0daf228206847a47978f0dee9
version             20251016
revision            0
categories          audio
license             GPL-3
maintainers         nomaintainer
description         Input plugin for qmmp to play ${modname} modules
long_description    {*}${description}
checksums           rmd160  0d161ea5e93a21ee8974875d327ce12effffd8c6 \
                    sha256  80db2c70c883b10fc60a078487322fd999e193f25646c651dfe63c0f4d2e4d13 \
                    size    559571
github.tarball_from archive

post-extract {
    copy ${filespath}/Makefile ${worksrcpath}/
}

post-patch {
    # Old Xcode gcc neither need nor support this flag:
    if {[string match *gcc-4.* ${configure.compiler}]} {
        reinplace "s|@extra_flag@||" ${worksrcpath}/Makefile
    } else {
        reinplace "s|@extra_flag@|-Wno-incompatible-pointer-types|" ${worksrcpath}/Makefile
    }
}

depends_lib-append  port:zlib

destroot {
    copy ${worksrcpath}/${name}.dylib ${destroot}${prefix}/lib/
    set incdir ${destroot}${prefix}/include/${name}
    xinstall -d ${incdir}
    copy ${worksrcpath}/${name}/${modname}.h ${incdir}/
    copy ${worksrcpath}/${name}/tchar.h ${incdir}/
    # Okay, this is ugly, I know.
    # We need to install headers, preserving directory hierarchy...
    fs-traverse f ${worksrcpath}/${name}/device {
        if {[file isfile ${f}] && ([file extension ${f}] eq ".c" || [file extension ${f}] == ".cpp" \
            || [file extension ${f}] eq ".o" || [file extension ${f}] == ".txt")} {
            delete ${f}
        }
    }
    copy ${worksrcpath}/${name}/device ${incdir}/
}
