# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0
PortGroup           openssl 1.0
PortGroup           qt4 1.0

openssl.branch      1.1

github.setup        Greedysky TTKMusicPlayer fcd86bfa42b0cfcdc89144708d56c63c2ef67029
version             4.2.0.0
revision            1
categories          multimedia audio
license             {GPL-3 LGPL-3}
maintainers         {@barracuda156 macos-powerpc.org:barracuda}
description         ${name} is a Qt-based music player
long_description    ${name} imitates Kugou UI and uses qmmp core library based on Qt.

checksums           rmd160  15b3a18b0af9397f5797427e38f7cf64a78f559e \
                    sha256  8e20187ba2ca336428d647965476d5ccbb05e21277ba83c5225b7b0498d0c8b5 \
                    size    5874116
github.tarball_from archive

patch.pre_args-replace  -p0 -p1

post-patch {
    # https://github.com/Greedysky/TTKMusicPlayer/issues/130
    reinplace "s|\${CMAKE_CACHEFILE_DIR}|${cmake.build_dir}|g" ${worksrcpath}/CMakeLists.txt
}

# In result it ends up in ${prefix}/libexec/${name}
cmake.install_prefix \
                    ${prefix}/libexec

# For rename
depends_build-append \
                    port:util-linux

depends_lib-append  port:libpng \
                    port:libqmmp

compiler.cxx_standard   2011

# clang: error: unsupported option '-fopenmp'
compiler.openmp_version 3.0

set ttkroot         ${prefix}/libexec/TTKMusicPlayer

# These configure args are important
configure.args-append \
                    -DCMAKE_INSTALL_NAME_DIR=${ttkroot}/${version} \
                    -DOPENSSL_DIR=[openssl::install_area] \
                    -DQT_LRELEASE_EXECUTABLE=${qt_dir}/bin/lrelease \
                    -DQT_QMAKE_EXECUTABLE=${qt_dir}/bin/qmake \
                    -DTTK_BUILD_SHARED=ON \
                    -DTTK_QMMP_LIBRARY=${ttkroot}/${version}/libTTKqmmp.dylib \
                    -DTTK_QT_VERSION=4

configure.cppflags-append \
                    -D_DARWIN_C_SOURCE

post-destroot {
    xinstall -m 775 ${worksrcpath}/TTKResource/_extras/TTKInit.sh ${destroot}${ttkroot}/${version}/
    xinstall -m 775 ${worksrcpath}/TTKResource/_extras/TTKConsole.sh ${destroot}${ttkroot}/${version}/
    xinstall -m 775 ${worksrcpath}/TTKResource/_extras/TTKRoutineCopy.sh ${destroot}${ttkroot}/${version}/
    xinstall -m 775 ${worksrcpath}/TTKResource/_extras/TTKService.sh ${destroot}${ttkroot}/${version}/
    xinstall -m 775 ${worksrcpath}/TTKResource/_extras/TTKMusicPlayer.sh ${destroot}${ttkroot}/
    xinstall -m 775 ${worksrcpath}/TTKResource/_extras/TTKRoutine.sh ${destroot}${ttkroot}/
}
