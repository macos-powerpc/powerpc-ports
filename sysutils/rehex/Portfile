# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           legacysupport 1.1
PortGroup           makefile 1.0
PortGroup           wxWidgets 1.0

github.setup        solemnwarning rehex 0.63.4
revision            0
categories          sysutils devel
maintainers         {@barracuda156 gmail.com:vital.had} openmaintainer

description         Reverse Engineersâ€™ Hex Editor
long_description    {*}${description}
license             GPL-2
homepage            https://rehex.solemnwarning.net

checksums           rmd160  678b6fe012a6c7e2bbf67374714cd62818d6e425 \
                    sha256  ddddd21525e9a07e05b961773e535add9fa606a03e79ab675a471ed09a228a8a \
                    size    5049620
github.tarball_from archive

wxWidgets.use       wxGTK-3.2
set lua_v           53
set botan_v         3

patchfiles-append   patch-SettingsDialogKeyboard.cpp.diff \
                    patch-wxLua-wxStandardPaths.diff \
                    patch-fix-linking.diff

# https://github.com/solemnwarning/rehex/pull/276
patchfiles-append   patch-cmath.diff \
                    patch-macros.diff

# Possibly riscv64 needs this as well.
if {[string match *gcc* ${configure.compiler}] && ${configure.build_arch} in [list arm i386 ppc]} {
    patchfiles-append \
                    patch-libatomic.diff
}

# https://github.com/solemnwarning/rehex/issues/275
post-patch {
    reinplace "s|__APPLE__|__WXCOCOA__|g" \
                    ${worksrcpath}/src/App.hpp \
                    ${worksrcpath}/src/AppMain.cpp \
                    ${worksrcpath}/src/AppTestable.cpp \
                    ${worksrcpath}/src/DiffWindow.cpp \
                    ${worksrcpath}/src/document.cpp \
                    ${worksrcpath}/src/mainwindow.cpp \
                    ${worksrcpath}/src/buffer.hpp \
                    ${worksrcpath}/res/version.h \
                    ${worksrcpath}/res/version.cpp
}

depends_build-append \
                    port:lua${lua_v}-busted \
                    path:bin/pkg-config:pkgconfig

depends_lib-append  port:botan${botan_v} \
                    port:capstone \
                    port:jansson \
                    port:jq \
                    port:libiconv \
                    port:libunistring \
                    port:lua${lua_v} \
                    port:${wxWidgets.port}

depends_run-append  port:desktop-file-utils

compiler.cxx_standard   2020

build.env-append    PATH=${wxWidgets.wxdir}:${prefix}/bin:${prefix}/sbin:/usr/bin:/usr/sbin:/bin:/sbin

build.args-append   BOTAN_PKG=botan-${botan_v} \
                    BUILD_HELP=0 \
                    BUSTED=${prefix}/libexec/lua${lua_v}/bin/busted \
                    prefix=${prefix} \
                    V=1

destroot.env-append PATH=${wxWidgets.wxdir}:${prefix}/bin:${prefix}/sbin:/usr/bin:/usr/sbin:/bin:/sbin \
                    BUILD_HELP=0 \
                    BUSTED=${prefix}/libexec/lua${lua_v}/bin/busted \
                    prefix=${prefix}

post-activate {
    system "${prefix}/bin/update-desktop-database ${prefix}/share/applications"
    system "${prefix}/bin/gtk-update-icon-cache -f -t ${prefix}/share/icons/hicolor"
}
