From cf8e6d55264edbdcddab48bdf905fd319dfc9ac5 Mon Sep 17 00:00:00 2001
From: Joshua Root <jmr@macports.org>
Date: Thu, 5 Feb 2026 16:21:03 +1100
Subject: [PATCH] Check if tar -k errors on existing files

Closes: https://trac.macports.org/ticket/73467
---
 aclocal.m4                               | 17 +++++++++++++++++
 configure                                | 18 ++++++++++++++++++
 configure.ac                             |  1 +
 src/macports1.0/macports.tcl             |  9 +++++++--
 src/macports1.0/macports_autoconf.tcl.in |  1 +
 5 files changed, 44 insertions(+), 2 deletions(-)

diff --git a/aclocal.m4 b/aclocal.m4
index 7c220f0d1e..ab7ef458e0 100644
--- a/aclocal.m4
+++ b/aclocal.m4
@@ -1043,6 +1043,23 @@ AC_DEFUN([MP_TAR_FAST_READ],[
 	AC_SUBST(TAR_Q)
 ])
 
+dnl This macro tests for tar support of -k (keep existing files)
+dnl without erroring when files exist.
+AC_DEFUN([MP_TAR_KEEP_OLD],[
+	AC_MSG_CHECKING([whether tar -k works])
+	mkdir -p conftest_dir
+	touch conftest_dir/file
+	$TAR -cf conftest.tar conftest_dir
+	if $TAR -xkf conftest.tar </dev/null 2>/dev/null ; then
+		AC_MSG_RESULT([yes])
+		TAR_K='k'
+	else
+		AC_MSG_RESULT([no])
+		TAR_K=
+	fi
+	AC_SUBST(TAR_K)
+])
+
 dnl This macro tests for tar support of --no-same-owner
 AC_DEFUN([MP_TAR_NO_SAME_OWNER],[
 	AC_PATH_PROG(TAR, [tar])
diff --git a/configure b/configure
index 0dec50629f..8137abd1b7 100755
--- a/configure
+++ b/configure
@@ -718,6 +718,7 @@ CFLAGS_WERROR
 CFLAGS_PEDANTIC
 CFLAGS_QUICHEEATERS
 TAR_CMD
+TAR_K
 TAR_Q
 ZIP
 XZ
@@ -6453,6 +6454,23 @@ printf "%s\n" "no (gnutar)" >&6; }
 
 
 
+	{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: checking whether tar -k works" >&5
+printf %s "checking whether tar -k works... " >&6; }
+	mkdir -p conftest_dir
+	touch conftest_dir/file
+	$TAR -cf conftest.tar conftest_dir
+	if $TAR -xkf conftest.tar </dev/null 2>/dev/null ; then
+		{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+printf "%s\n" "yes" >&6; }
+		TAR_K='k'
+	else
+		{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: result: no" >&5
+printf "%s\n" "no" >&6; }
+		TAR_K=
+	fi
+
+
+
 	# Extract the first word of "tar", so it can be a program name with args.
 set dummy tar; ac_word=$2
 { printf "%s\n" "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
diff --git a/configure.ac b/configure.ac
index 687929cf3e..940c676693 100644
--- a/configure.ac
+++ b/configure.ac
@@ -189,6 +189,7 @@ if test "x$MTREE" = "x"; then
 fi
 
 MP_TAR_FAST_READ
+MP_TAR_KEEP_OLD
 MP_TAR_NO_SAME_OWNER
 MP_PATCH_GNU_VERSION
 
diff --git a/src/macports1.0/macports.tcl b/src/macports1.0/macports.tcl
index d2a02f942f..b88d188330 100644
--- a/src/macports1.0/macports.tcl
+++ b/src/macports1.0/macports.tcl
@@ -3772,8 +3772,13 @@ proc mportsync {{options {}}} {
                             }
                         }
                         file delete -force ${extractdir}/tmp
-                        # use -k to skip extracting files that exist
-                        set kflag k
+                        # use -k if supported to skip extracting files that exist
+                        global macports::prefix_frozen
+                        if {[string match ${prefix_frozen}/bin/* $tar]} {
+                            set kflag k
+                        } else {
+                            set kflag $macports::autoconf::tar_k
+                        }
                     }
 
                     set tar_cmd "$tar -C ${extractdir} -x${zflag}${kflag}f $tarball"
diff --git a/src/macports1.0/macports_autoconf.tcl.in b/src/macports1.0/macports_autoconf.tcl.in
index 3da5587623..81acbc3523 100644
--- a/src/macports1.0/macports_autoconf.tcl.in
+++ b/src/macports1.0/macports_autoconf.tcl.in
@@ -55,6 +55,7 @@ namespace eval macports::autoconf {
     variable signify_path "@prefix_expanded@/libexec/macports/bin/signify"
     variable tar_command "@TAR_CMD@"
     variable tar_path "@TAR@"
+    variable tar_k "@TAR_K@"
     variable tar_q "@TAR_Q@"
     variable tclsh_path "@TCLSH@"
     variable unzip_path "@UNZIP@"

From efb8744580952888551b59d6d8d39844b27e48d1 Mon Sep 17 00:00:00 2001
From: Joshua Root <jmr@macports.org>
Date: Thu, 5 Feb 2026 19:20:40 +1100
Subject: [PATCH] MP_TAR_KEEP_OLD: correct output redirection

---
 aclocal.m4 | 2 +-
 configure  | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/aclocal.m4 b/aclocal.m4
index ab7ef458e0..985e7848c5 100644
--- a/aclocal.m4
+++ b/aclocal.m4
@@ -1050,7 +1050,7 @@ AC_DEFUN([MP_TAR_KEEP_OLD],[
 	mkdir -p conftest_dir
 	touch conftest_dir/file
 	$TAR -cf conftest.tar conftest_dir
-	if $TAR -xkf conftest.tar </dev/null 2>/dev/null ; then
+	if $TAR -xkf conftest.tar >/dev/null 2>&1 ; then
 		AC_MSG_RESULT([yes])
 		TAR_K='k'
 	else
diff --git a/configure b/configure
index 8137abd1b7..8795a97534 100755
--- a/configure
+++ b/configure
@@ -6459,7 +6459,7 @@ printf %s "checking whether tar -k works... " >&6; }
 	mkdir -p conftest_dir
 	touch conftest_dir/file
 	$TAR -cf conftest.tar conftest_dir
-	if $TAR -xkf conftest.tar </dev/null 2>/dev/null ; then
+	if $TAR -xkf conftest.tar >/dev/null 2>&1 ; then
 		{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: result: yes" >&5
 printf "%s\n" "yes" >&6; }
 		TAR_K='k'
