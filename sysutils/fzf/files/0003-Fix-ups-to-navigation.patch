From bcd80d705440fb4d6097853d9ab783c66f806f9d Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Wed, 11 Feb 2026 06:47:21 +0800
Subject: [PATCH] Fix-ups to navigation

diff --git fzf.ml fzf.ml
index 3bd548e..ddbf227 100644
--- fzf.ml
+++ fzf.ml
@@ -5,7 +5,7 @@ type t = {
   mutable items: string list
 ; mutable filtered_items : string list
 ; mutable selected_index : int
-; mutable selection_list : string list
+; mutable all_filtered : string list
 ; spinner : Spinner.t
 ; mutable entered_text : string option
 }
@@ -15,13 +15,13 @@ let create () =
     items = []
   ; filtered_items = []
   ; selected_index = 0
-  ; selection_list = []
+  ; all_filtered = []
   ; spinner = Spinner.create ~spin_every:(sec 0.2)
   ; entered_text = None
   }
 
 let filter_items_and_selection t entered_text =
-  let { items; filtered_items = _; selected_index = _; selection_list = _; spinner = _; entered_text = _} = t in
+  let { items; filtered_items = _; selected_index = _; all_filtered = _; spinner = _; entered_text = _} = t in
   t.entered_text <- entered_text;
   let filtered_items =
     match entered_text with
@@ -32,39 +32,40 @@ let filter_items_and_selection t entered_text =
       |> List.filter ~f:(fun item ->
           Option.is_some @@ String.Search_pattern.index ~in_:item pattern)
   in
-  let selection_list, filtered_items =
-    match filtered_items with
-    | first :: rest -> ([first], rest)
-    | [] -> ([], [])
-  in
   (* Reset selection index when filter changes *)
   t.selected_index <- 0;
-  t.selection_list <- selection_list;
-  t.filtered_items <- filtered_items;
+  t.all_filtered <- filtered_items;
+  t.filtered_items <- filtered_items
 ;;
 
 let get_selected t =
-  List.nth t.selection_list t.selected_index
+  List.nth t.all_filtered t.selected_index
 ;;
 
 let widget t screen =
   let open Tty_text in
-  let {items = _; filtered_items; selected_index = _; selection_list = _; spinner; entered_text } = t in
+  let {items = _; filtered_items = _; selected_index; all_filtered; spinner; entered_text } = t in
   let prompt_size = 1 in
   let item_count = screen.Screen_dimensions.height - prompt_size in
-  let all_but_selection =
-    List.take filtered_items item_count
+
+  (* Calculate visible window *)
+  let visible_start = max 0 (selected_index - item_count + 1) in
+  let visible_items =
+    all_filtered
+    |> (fun lst -> List.drop lst visible_start)
+    |> (fun lst -> List.take lst (item_count + 1))
+    |> List.rev  (* Reverse for display - last item at top *)
   in
+  let selected_in_window = (List.length visible_items - 1) - (selected_index - visible_start) in
   let editor = Widget.text ("> " ^ (Option.value ~default:"" entered_text))
   in
   let lines =
-    List.map all_but_selection ~f: (fun text ->
-        Widget.text text)
-  in
-  let selected =
-    match List.nth t.selection_list t.selected_index with
-    | Some sel -> Some (Widget.text sel)
-    | None -> None
+    List.mapi visible_items ~f:(fun i text ->
+      if i = selected_in_window then
+        Widget.text ("> " ^ text)
+      else
+        Widget.text ("  " ^ text)
+    )
   in
   let spinner = Option.map
       (Spinner.to_char spinner)
@@ -76,43 +77,24 @@ let widget t screen =
     |> Widget.horizontal_group
   in
   let padding =
-    List.init (item_count - (List.length all_but_selection))
+    List.init (max 0 (item_count + 1 - List.length visible_items))
       ~f:(fun _ -> Widget.text "")
-  in Widget.vertical_group
-    (padding @ lines @ (List.filter_opt [selected]) @ [prompt])
+  in
+  Widget.vertical_group
+    (padding @ lines @ [prompt])
 ;;
 
 let handle_input t input =
   match input with
   | Tty_text.User_input.Arrow_down -> begin
-      let all_items = t.selection_list @ t.filtered_items in
-      let max_index = (List.length all_items) - 1 in
-      if t.selected_index < max_index then begin
-        t.selected_index <- t.selected_index + 1;
-        (* If we move past current selection_list, rotate items *)
-        if t.selected_index >= List.length t.selection_list then begin
-          match t.filtered_items with
-          | next :: rest ->
-            t.selection_list <- t.selection_list @ [next];
-            t.filtered_items <- rest
-          | [] -> ()
-        end
-      end;
+      if t.selected_index > 0 then
+        t.selected_index <- t.selected_index - 1;
       `Continue t
     end
   | Tty_text.User_input.Arrow_up -> begin
-      if t.selected_index > 0 then begin
-        t.selected_index <- t.selected_index - 1;
-        (* If we move back and selection_list is too long, rotate back *)
-        if List.length t.selection_list > 1 &&
-           t.selected_index < List.length t.selection_list - 1 then begin
-          match List.rev t.selection_list with
-          | last :: rest ->
-            t.selection_list <- List.rev rest;
-            t.filtered_items <- last :: t.filtered_items
-          | [] -> ()
-        end
-      end;
+      let max_index = List.length t.all_filtered - 1 in
+      if t.selected_index < max_index then
+        t.selected_index <- t.selected_index + 1;
       `Continue t
     end
   | Tty_text.User_input.Backspace -> begin
@@ -153,16 +135,16 @@ let run user_input tty_text stdin =
       ; stdin_closed]
   in
   let t = create () in
-  let last_rendered : (string option * (string list)) ref = ref (None, []) in
+  let last_rendered : (string option * string list * int) ref = ref (None, [], 0) in
   let how_often_to_render = (sec 0.1) in
   Render.every
     ~how_often_to_render
     ~render:(fun () ->
-        if ([%compare.equal:string option * string list]
-              !last_rendered (t.entered_text, t.filtered_items))
+        if ([%compare.equal:string option * string list * int]
+              !last_rendered (t.entered_text, t.all_filtered, t.selected_index))
         then Deferred.unit
         else begin
-          last_rendered := (t.entered_text, t.filtered_items);
+          last_rendered := (t.entered_text, t.all_filtered, t.selected_index);
           Tty_text.render tty_text (widget t (Tty_text.screen_dimensions tty_text))
         end)
     (fun () ->
