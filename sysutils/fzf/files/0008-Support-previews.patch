From 41e4d226e020111e0c421ed98f3935667fd36d99 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 12 Feb 2026 08:33:41 +0800
Subject: [PATCH] Support previews

---
 fzf.ml | 90 +++++++++++++++++++++++++++++++++++++++++++++++++---------
 1 file changed, 76 insertions(+), 14 deletions(-)

diff --git fzf.ml fzf.ml
index ede7220..4e4c520 100644
--- fzf.ml
+++ fzf.ml
@@ -8,18 +8,22 @@ type t = {
 ; mutable filtered_items : string list
 ; prompt: string
 ; header: string option
+; preview_command: string option
+; mutable preview_text: string
 ; mutable selected_index : int
 ; mutable all_filtered : string list
 ; spinner : Spinner.t
 ; mutable entered_text : string option
 }
 
-let create ~prompt ~header =
+let create ~prompt ~header ~preview =
   {
     items = []
   ; filtered_items = []
   ; prompt = prompt
   ; header = header
+  ; preview_command = preview
+  ; preview_text = ""
   ; selected_index = 0
   ; all_filtered = []
   ; spinner = Spinner.create ~spin_every:(sec 0.2)
@@ -27,7 +31,7 @@ let create ~prompt ~header =
   }
 
 let filter_items_and_selection t entered_text =
-  let { items; filtered_items = _; prompt = _; header = _; selected_index = _; all_filtered = _; spinner = _; entered_text = _} = t in
+  let { items; filtered_items = _; prompt = _; header = _; preview_command = _; preview_text = _; selected_index = _; all_filtered = _; spinner = _; entered_text = _} = t in
   t.entered_text <- entered_text;
   let filtered_items =
     match entered_text with
@@ -49,10 +53,45 @@ let get_selected t =
   List.nth t.all_filtered t.selected_index
 ;;
 
+let update_preview t =
+  match t.preview_command with
+  | None -> ()
+  | Some cmd ->
+    match get_selected t with
+    | None -> t.preview_text <- ""
+    | Some selected ->
+      (* Calculate line number (0-indexed) of selected item in original list *)
+      let line_number = 
+        List.findi t.all_filtered ~f:(fun _ item -> String.equal item selected)
+        |> Option.map ~f:fst
+        |> Option.value ~default:0
+      in
+      (* Escape single quotes in selected item for shell safety *)
+      let escaped = String.substr_replace_all selected ~pattern:"'" ~with_:"'\\\''" in
+      (* Replace {n} with line number FIRST, then {} with selected item *)
+      let command =
+        cmd
+        |> String.substr_replace_all ~pattern:"{n}" ~with_:(Int.to_string line_number)
+        |> String.substr_replace_all ~pattern:"{}" ~with_:("'" ^ escaped ^ "'")
+      in
+      try
+        let ic = Core_unix.open_process_in command in
+        let lines = In_channel.input_lines ic in
+        let status = Core_unix.close_process_in ic in
+        (match status with
+         | Ok () -> t.preview_text <- String.concat ~sep:"\n" lines
+         | Error _ -> t.preview_text <- "[Preview command failed]")
+      with
+      | exn -> t.preview_text <- sprintf "[Preview error: %s]" (Exn.to_string exn)
+;;
+
 let widget t screen =
   let open Tty_text in
-  let {items = _; filtered_items = _; prompt; header = _; selected_index; all_filtered; spinner; entered_text } = t in
+  let {items = _; filtered_items = _; prompt; header = _; preview_command; preview_text; selected_index; all_filtered; spinner; entered_text } = t in
   let prompt_size = 1 in
+  let has_preview = Option.is_some preview_command in
+  let list_width = if has_preview then screen.Screen_dimensions.width / 2 else screen.Screen_dimensions.width in
+  let preview_width = if has_preview then screen.Screen_dimensions.width - list_width - 3 else 0 in
   let item_count = screen.Screen_dimensions.height - prompt_size in
 
   (* Calculate visible window *)
@@ -68,12 +107,22 @@ let widget t screen =
   in
   let lines =
     List.mapi visible_items ~f:(fun i text ->
+      let truncated = if String.length text > list_width - 3 then String.prefix text (list_width - 3) else text in
       if i = selected_in_window then
-        Widget.text ("> " ^ text)
+        Widget.text ("> " ^ truncated)
       else
-        Widget.text ("  " ^ text)
+        Widget.text ("  " ^ truncated)
     )
   in
+  let preview_lines =
+    if has_preview then
+      let lines = String.split_lines preview_text in
+      List.take lines item_count
+      |> List.map ~f:(fun line ->
+        let truncated = if String.length line > preview_width then String.prefix line preview_width else line in
+        Widget.text truncated)
+    else []
+  in
   let spinner = Option.map
       (Spinner.to_char spinner)
       ~f:(fun c -> Widget.text (String.of_char_list [c]))
@@ -87,21 +136,31 @@ let widget t screen =
     List.init (max 0 (item_count + 1 - List.length visible_items))
       ~f:(fun _ -> Widget.text "")
   in
-  Widget.vertical_group
-    (padding @ lines @ [prompt])
+  let left_pane = Widget.vertical_group (padding @ lines @ [prompt]) in
+  if has_preview then
+    let separator = Widget.vertical_group (List.init (item_count + 1) ~f:(fun _ -> Widget.text " | ")) in
+    let right_pane = Widget.vertical_group (preview_lines @ List.init (max 0 (item_count + 1 - List.length preview_lines)) ~f:(fun _ -> Widget.text "")) in
+    Widget.horizontal_group [left_pane; separator; right_pane]
+  else
+    left_pane
 ;;
 
 let handle_input t input =
+  let needs_preview_update = ref false in
   match input with
   | Tty_text.User_input.Arrow_down -> begin
       if t.selected_index > 0 then
-        t.selected_index <- t.selected_index - 1;
+        (t.selected_index <- t.selected_index - 1;
+         needs_preview_update := true);
+      if !needs_preview_update then update_preview t;
       `Continue t
     end
   | Tty_text.User_input.Arrow_up -> begin
       let max_index = List.length t.all_filtered - 1 in
       if t.selected_index < max_index then
-        t.selected_index <- t.selected_index + 1;
+        (t.selected_index <- t.selected_index + 1;
+         needs_preview_update := true);
+      if !needs_preview_update then update_preview t;
       `Continue t
     end
   | Tty_text.User_input.Backspace -> begin
@@ -113,6 +172,7 @@ let handle_input t input =
           then None
           else Some (String.sub text ~pos:0 ~len:(String.length text - 1))
         in filter_items_and_selection t new_entered_text;
+        update_preview t;
         `Continue t
     end
   | Ctrl_c -> `Finished None
@@ -122,13 +182,14 @@ let handle_input t input =
         | Some text -> String.(text ^ (of_char_list [x]))
       in
       filter_items_and_selection t (Some text);
+      update_preview t;
       `Continue t
     end
   | Return -> (`Finished (get_selected t))
   | Escape -> (`Finished None)
 ;;
 
-let run user_input tty_text stdin ~prompt ~header =
+let run user_input tty_text stdin ~prompt ~header ~preview =
   let stdin_reader =
     Pipe.map ~f:(fun x -> `Stdin x) (Reader.lines stdin)
   in
@@ -141,7 +202,7 @@ let run user_input tty_text stdin ~prompt ~header =
       ; Pipe.map user_input ~f:(fun x -> `Input x)
       ; stdin_closed]
   in
-  let t = create ~prompt ~header in
+  let t = create ~prompt ~header ~preview in
   let last_rendered : (string option * string list * int) ref = ref (None, [], 0) in
   let how_often_to_render = (sec 0.1) in
   Render.every
@@ -159,6 +220,7 @@ let run user_input tty_text stdin ~prompt ~header =
        | `Eof -> raise_s [%message "impossible?"]
        | `Ok `Stdin_closed ->
          Spinner.finish t.spinner;
+         update_preview t;
          return (`Repeat ());
        | `Ok `Stdin x ->
          t.items <- x :: t.items;
@@ -206,15 +268,15 @@ let () =
         ~doc:"STRING Prompt string (default: '> ')"
     and header = flag "--header" (optional string)
         ~doc:"STRING Header string"
-    and _preview = flag "--preview" (optional string)
-        ~doc:"STRING Preview command (not supported, ignored)"
+    and preview = flag "--preview" (optional string)
+        ~doc:"STRING Preview command (use {} for item)"
     in
     fun () ->
       let open Deferred.Let_syntax in
       let stdin = force Reader.stdin in
       match%bind
         Tty_text.with_rendering (fun (input, tty_text) ->
-            run input tty_text stdin ~prompt ~header)
+            run input tty_text stdin ~prompt ~header ~preview)
       with
       | None -> Deferred.unit
       | Some output ->
