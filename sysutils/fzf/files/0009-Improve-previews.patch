From 3a5ed6156c8678156b77964d36f520ee2b942b80 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 12 Feb 2026 09:12:15 +0800
Subject: [PATCH] Improve previews

---
 fzf.ml | 17 ++++++++++++-----
 1 file changed, 12 insertions(+), 5 deletions(-)

diff --git fzf.ml fzf.ml
index 4e4c520..f832482 100644
--- fzf.ml
+++ fzf.ml
@@ -90,7 +90,7 @@ let widget t screen =
   let {items = _; filtered_items = _; prompt; header = _; preview_command; preview_text; selected_index; all_filtered; spinner; entered_text } = t in
   let prompt_size = 1 in
   let has_preview = Option.is_some preview_command in
-  let list_width = if has_preview then screen.Screen_dimensions.width / 2 else screen.Screen_dimensions.width in
+  let list_width = if has_preview then (screen.Screen_dimensions.width * 2) / 5 else screen.Screen_dimensions.width in
   let preview_width = if has_preview then screen.Screen_dimensions.width - list_width - 3 else 0 in
   let item_count = screen.Screen_dimensions.height - prompt_size in
 
@@ -107,7 +107,7 @@ let widget t screen =
   in
   let lines =
     List.mapi visible_items ~f:(fun i text ->
-      let truncated = if String.length text > list_width - 3 then String.prefix text (list_width - 3) else text in
+      let truncated = if String.length text > list_width - 4 then String.prefix text (list_width - 4) ^ "…" else text in
       if i = selected_in_window then
         Widget.text ("> " ^ truncated)
       else
@@ -116,10 +116,17 @@ let widget t screen =
   in
   let preview_lines =
     if has_preview then
-      let lines = String.split_lines preview_text in
-      List.take lines item_count
+      (* Clean preview text - remove ANSI codes and control chars that might cause artifacts *)
+      let clean_text =
+        preview_text
+        |> String.filter ~f:(fun c ->
+            let code = Char.to_int c in
+            code >= 32 || code = 10) (* Keep printable + newline *)
+      in
+      let lines = String.split_lines clean_text in
+      List.take lines (item_count - 2) (* Leave some padding *)
       |> List.map ~f:(fun line ->
-        let truncated = if String.length line > preview_width then String.prefix line preview_width else line in
+        let truncated = if String.length line > preview_width then String.prefix line (preview_width - 1) ^ "…" else line in
         Widget.text truncated)
     else []
   in
