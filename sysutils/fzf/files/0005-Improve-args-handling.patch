From d17cec79eea440469d12bd4b9faf8dee8f007be8 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 12 Feb 2026 03:15:50 +0800
Subject: [PATCH] Improve args handling

diff --git fzf.ml fzf.ml
index 95fbec8..45091c0 100644
--- fzf.ml
+++ fzf.ml
@@ -36,8 +36,9 @@ let filter_items_and_selection t entered_text =
       |> List.filter ~f:(fun item ->
           Option.is_some @@ String.Search_pattern.index ~in_:item pattern)
   in
-  (* Reset selection index when filter changes *)
-  t.selected_index <- 0;
+  (* Reset selection to LAST item (appears at TOP after display reversal) *)
+  let max_idx = List.length filtered_items - 1 in
+  t.selected_index <- if max_idx >= 0 then max_idx else 0;
   t.all_filtered <- filtered_items;
   t.filtered_items <- filtered_items
 ;;
@@ -172,8 +173,30 @@ let run user_input tty_text stdin ~prompt ~header =
     )
 ;;
 
+(* Convert --flag=value to --flag value for Command library *)
+let preprocess_argv () =
+  let argv = Array.to_list Stdlib.Sys.argv in
+  let rec process acc = function
+    | [] -> List.rev acc
+    | arg :: rest ->
+        (* Match --flag=value pattern *)
+        match String.lsplit2 arg ~on:'=' with
+        | Some (flag, value) when String.is_prefix flag ~prefix:"--" ->
+            (* Split into two separate args: --flag value *)
+            process (value :: flag :: acc) rest
+        | _ ->
+            (* Keep as-is (not a --flag=value pattern) *)
+            process (arg :: acc) rest
+  in
+  Array.of_list (process [] argv)
+;;
+
 let () =
-  Command_unix.run @@
+  (* Preprocess argv to handle --flag=value *)
+  let transformed_argv = preprocess_argv () in
+  Command_unix.run
+    ~argv:(Array.to_list transformed_argv)
+  @@
   let open Command.Let_syntax in
   Command.async ~summary:"fzf" [%map_open
     let prompt = flag "--prompt" (optional_with_default "> " string)
