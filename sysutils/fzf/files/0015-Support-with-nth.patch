From 3282b3c060bd3837dd096acd7097335f4604eebe Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 12 Feb 2026 11:57:24 +0800
Subject: [PATCH] Support --with-nth

---
 fzf.ml | 53 +++++++++++++++++++++++++++++++++++++++--------------
 1 file changed, 39 insertions(+), 14 deletions(-)

diff --git fzf.ml fzf.ml
index 95513ce..f32fdac 100644
--- fzf.ml
+++ fzf.ml
@@ -13,13 +13,14 @@ type t = {
 ; mutable preview_enabled: bool
 ; delimiter: string option
 ; nth_fields: int list option
+; with_nth_fields: int list option
 ; mutable selected_index : int
 ; mutable all_filtered : string list
 ; spinner : Spinner.t
 ; mutable entered_text : string option
 }
 
-let create ~prompt ~header ~preview ~delimiter ~nth =
+let create ~prompt ~header ~preview ~delimiter ~nth ~with_nth =
   {
     items = []
   ; filtered_items = []
@@ -30,6 +31,7 @@ let create ~prompt ~header ~preview ~delimiter ~nth =
   ; preview_enabled = Option.is_some preview  (* Start enabled if --preview was given *)
   ; delimiter = delimiter
   ; nth_fields = nth
+  ; with_nth_fields = with_nth
   ; selected_index = 0
   ; all_filtered = []
   ; spinner = Spinner.create ~spin_every:(sec 0.2)
@@ -46,7 +48,7 @@ let parse_nth_fields nth_str =
   with _ -> None
 ;;
 
-let extract_fields item delimiter nth_fields =
+let extract_fields_for_search item delimiter nth_fields =
   match delimiter, nth_fields with
   | None, None -> item
   | delim_opt, Some fields ->
@@ -61,19 +63,38 @@ let extract_fields item delimiter nth_fields =
     fields
     |> List.filter_map ~f:(fun idx ->
         let actual_idx = if idx < 0 then num_parts + idx else idx - 1 in
-        if actual_idx >= 0 && actual_idx < num_parts 
+        if actual_idx >= 0 && actual_idx < num_parts
         then List.nth parts actual_idx
         else None)
     |> String.concat ~sep:" "
-  | Some delim, None ->
-    (* Delimiter without nth just normalizes display *)
-    let re = Str.regexp (Str.quote delim) in
-    Str.split re item |> String.concat ~sep:" "
+  | Some _, None -> item
+;;
+
+let extract_fields_for_display item delimiter with_nth_fields =
+  match delimiter, with_nth_fields with
+  | None, None -> item
+  | delim_opt, Some fields ->
+    let parts = 
+      match delim_opt with
+      | None -> String.split item ~on:' ' |> List.filter ~f:(fun s -> not (String.is_empty s))
+      | Some delim -> 
+        let re = Str.regexp (Str.quote delim) in
+        Str.split re item
+    in
+    let num_parts = List.length parts in
+    fields
+    |> List.filter_map ~f:(fun idx ->
+        let actual_idx = if idx < 0 then num_parts + idx else idx - 1 in
+        if actual_idx >= 0 && actual_idx < num_parts
+        then List.nth parts actual_idx
+        else None)
+    |> String.concat ~sep:" "
+  | Some _, None -> item
 ;;
 
 let filter_items_and_selection t entered_text =
   let { items; filtered_items = _; prompt = _; header = _; preview_command = _;
-        preview_text = _; preview_enabled = _; delimiter; nth_fields; selected_index = _;
+        preview_text = _; preview_enabled = _; delimiter; nth_fields; with_nth_fields = _; selected_index = _;
         all_filtered = _; spinner = _; entered_text = _} = t in
   t.entered_text <- entered_text;
   let filtered_items =
@@ -83,7 +104,7 @@ let filter_items_and_selection t entered_text =
       let pattern = String.Search_pattern.create text in
       items
       |> List.filter ~f:(fun original_item ->
-          let item = extract_fields original_item delimiter nth_fields in
+          let item = extract_fields_for_search original_item delimiter nth_fields in
           Option.is_some @@ String.Search_pattern.index ~in_:item pattern)
   in
   (* Reset selection to LAST item (appears at TOP after display reversal) *)
@@ -132,7 +153,7 @@ let update_preview t =
 
 let widget t screen =
   let open Tty_text in
-  let {items = _; filtered_items = _; prompt; header = _; preview_command; preview_text; preview_enabled; delimiter; nth_fields; selected_index; all_filtered; spinner; entered_text } = t in
+  let {items = _; filtered_items = _; prompt; header = _; preview_command; preview_text; preview_enabled; delimiter; nth_fields = _; with_nth_fields; selected_index; all_filtered; spinner; entered_text } = t in
   let prompt_size = 1 in
   let has_preview = Option.is_some preview_command && preview_enabled in
   let list_width = if has_preview then (screen.Screen_dimensions.width * 2) / 5 else screen.Screen_dimensions.width in
@@ -152,7 +173,7 @@ let widget t screen =
   in
   let lines =
     List.mapi visible_items ~f:(fun i text ->
-      let display_text = extract_fields text delimiter nth_fields in
+      let display_text = extract_fields_for_display text delimiter with_nth_fields in
       let truncated = if String.length display_text > list_width - 4 then String.prefix display_text (list_width - 4) ^ "â€¦" else display_text in
       if i = selected_in_window then
         Widget.text ("> " ^ truncated)
@@ -245,7 +266,7 @@ let handle_input t input =
   | Escape -> (`Finished None)
 ;;
 
-let run user_input tty_text stdin ~prompt ~header ~preview ~delimiter ~nth =
+let run user_input tty_text stdin ~prompt ~header ~preview ~delimiter ~nth ~with_nth =
   let stdin_reader =
     Pipe.map ~f:(fun x -> `Stdin x) (Reader.lines stdin)
   in
@@ -258,7 +279,7 @@ let run user_input tty_text stdin ~prompt ~header ~preview ~delimiter ~nth =
       ; Pipe.map user_input ~f:(fun x -> `Input x)
       ; stdin_closed]
   in
-  let t = create ~prompt ~header ~preview ~delimiter ~nth in
+  let t = create ~prompt ~header ~preview ~delimiter ~nth ~with_nth in
   let last_rendered : (string option * string list * int * bool) ref = ref (None, [], 0, false) in
   let how_often_to_render = (sec 0.1) in
   Render.every
@@ -344,14 +365,18 @@ let () =
     and nth =
       flag "--nth" (optional string)
         ~doc:"FIELDS Comma-separated field indices (1-indexed, negative from end)"
+    and with_nth =
+      flag "--with-nth" (optional string)
+        ~doc:"FIELDS Comma-separated field indices to display (1-indexed, negative from end)"
     in
     fun () ->
       let open Deferred.Let_syntax in
       let stdin = force Reader.stdin in
       let nth_parsed = Option.bind nth ~f:parse_nth_fields in
+      let with_nth_parsed = Option.bind with_nth ~f:parse_nth_fields in
       match%bind
         Tty_text.with_rendering (fun (input, tty_text) ->
-            run input tty_text stdin ~prompt ~header ~preview ~delimiter ~nth:nth_parsed)
+            run input tty_text stdin ~prompt ~header ~preview ~delimiter ~nth:nth_parsed ~with_nth:with_nth_parsed)
       with
       | None -> Deferred.unit
       | Some output ->
