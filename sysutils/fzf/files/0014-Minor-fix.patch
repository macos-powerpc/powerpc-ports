From 294e2ce94026ec5749b3eb08dc1eb4e18aed8ead Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 12 Feb 2026 10:52:34 +0800
Subject: [PATCH] Minor fix

---
 dune         |  2 +-
 fzf.ml       | 20 +++++++++++---------
 tty_text.mli |  2 +-
 3 files changed, 13 insertions(+), 11 deletions(-)

diff --git dune dune
index a304575..5120511 100644
--- dune
+++ dune
@@ -1,4 +1,4 @@
 (executable
  (name fzf)
- (libraries core async core_unix.command_unix)
+ (libraries core async core_unix.command_unix str)
  (preprocess (pps ppx_jane)))
diff --git fzf.ml fzf.ml
index bf89774..95513ce 100644
--- fzf.ml
+++ fzf.ml
@@ -73,7 +73,7 @@ let extract_fields item delimiter nth_fields =
 
 let filter_items_and_selection t entered_text =
   let { items; filtered_items = _; prompt = _; header = _; preview_command = _;
-        preview_text = _; delimiter; nth_fields; selected_index = _;
+        preview_text = _; preview_enabled = _; delimiter; nth_fields; selected_index = _;
         all_filtered = _; spinner = _; entered_text = _} = t in
   t.entered_text <- entered_text;
   let filtered_items =
@@ -100,11 +100,11 @@ let get_selected t =
 let update_preview t =
   match t.preview_command, t.preview_enabled with
   | Some cmd, true ->
-    match get_selected t with
+    (match get_selected t with
     | None -> t.preview_text <- ""
     | Some selected ->
       (* Calculate line number (0-indexed) of selected item in original list *)
-      let line_number = 
+      let line_number =
         List.findi t.all_filtered ~f:(fun _ item -> String.equal item selected)
         |> Option.map ~f:fst
         |> Option.value ~default:0
@@ -125,8 +125,9 @@ let update_preview t =
          | Ok () -> t.preview_text <- String.concat ~sep:"\n" lines
          | Error _ -> t.preview_text <- "[Preview command failed]")
       with
-      | exn -> t.preview_text <- sprintf "[Preview error: %s]" (Exn.to_string exn)
-  | _, _ -> t.preview_text <- ""
+      | exn -> t.preview_text <- sprintf "[Preview error: %s]" (Exn.to_string exn))
+  | Some _, false -> t.preview_text <- ""  (* Preview disabled *)
+  | None, _ -> ()  (* No preview command *)
 ;;
 
 let widget t screen =
@@ -258,16 +259,16 @@ let run user_input tty_text stdin ~prompt ~header ~preview ~delimiter ~nth =
       ; stdin_closed]
   in
   let t = create ~prompt ~header ~preview ~delimiter ~nth in
-  let last_rendered : (string option * string list * int) ref = ref (None, [], 0) in
+  let last_rendered : (string option * string list * int * bool) ref = ref (None, [], 0, false) in
   let how_often_to_render = (sec 0.1) in
   Render.every
     ~how_often_to_render
     ~render:(fun () ->
-        if ([%compare.equal:string option * string list * int]
-              !last_rendered (t.entered_text, t.all_filtered, t.selected_index))
+        if ([%compare.equal:string option * string list * int * bool]
+              !last_rendered (t.entered_text, t.all_filtered, t.selected_index, t.preview_enabled))
         then Deferred.unit
         else begin
-          last_rendered := (t.entered_text, t.all_filtered, t.selected_index);
+          last_rendered := (t.entered_text, t.all_filtered, t.selected_index, t.preview_enabled);
           Tty_text.render tty_text (widget t (Tty_text.screen_dimensions tty_text))
         end)
     (fun () ->
@@ -280,6 +281,7 @@ let run user_input tty_text stdin ~prompt ~header ~preview ~delimiter ~nth =
        | `Ok `Stdin x ->
          t.items <- x :: t.items;
          filter_items_and_selection t t.entered_text;
+         update_preview t;
          return (`Repeat ());
        | `Ok `Input user_input ->
          match handle_input t user_input with
diff --git tty_text.mli tty_text.mli
index 5dd2939..0152b9f 100644
--- tty_text.mli
+++ tty_text.mli
@@ -27,8 +27,8 @@ end
 
 module User_input : sig
   type t =
-    | Arrow_up
     | Arrow_down
+    | Arrow_up
     | Backspace
     | Char of char
     | Ctrl_backslash
