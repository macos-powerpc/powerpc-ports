From 1556a35018b57ba8b40d7b5d2b1d66dd080a517b Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 12 Feb 2026 10:45:29 +0800
Subject: [PATCH] Allow turn off previews

---
 fzf.ml       | 22 +++++++++++++++++-----
 tty_text.ml  | 11 +++++++----
 tty_text.mli |  7 ++++---
 3 files changed, 28 insertions(+), 12 deletions(-)

diff --git fzf.ml fzf.ml
index cd86938..090aca8 100644
--- fzf.ml
+++ fzf.ml
@@ -10,6 +10,7 @@ type t = {
 ; header: string option
 ; preview_command: string option
 ; mutable preview_text: string
+; mutable preview_enabled: bool
 ; delimiter: string option
 ; nth_fields: int list option
 ; mutable selected_index : int
@@ -26,6 +27,7 @@ let create ~prompt ~header ~preview ~delimiter ~nth =
   ; header = header
   ; preview_command = preview
   ; preview_text = ""
+  ; preview_enabled = Option.is_some preview  (* Start enabled if --preview was given *)
   ; delimiter = delimiter
   ; nth_fields = nth
   ; selected_index = 0
@@ -96,9 +98,8 @@ let get_selected t =
 ;;
 
 let update_preview t =
-  match t.preview_command with
-  | None -> ()
-  | Some cmd ->
+  match t.preview_command, t.preview_enabled with
+  | Some cmd, true ->
     match get_selected t with
     | None -> t.preview_text <- ""
     | Some selected ->
@@ -125,13 +126,14 @@ let update_preview t =
          | Error _ -> t.preview_text <- "[Preview command failed]")
       with
       | exn -> t.preview_text <- sprintf "[Preview error: %s]" (Exn.to_string exn)
+  | _, _ -> t.preview_text <- ""
 ;;
 
 let widget t screen =
   let open Tty_text in
-  let {items = _; filtered_items = _; prompt; header = _; preview_command; preview_text; delimiter; nth_fields; selected_index; all_filtered; spinner; entered_text } = t in
+  let {items = _; filtered_items = _; prompt; header = _; preview_command; preview_text; preview_enabled; delimiter; nth_fields; selected_index; all_filtered; spinner; entered_text } = t in
   let prompt_size = 1 in
-  let has_preview = Option.is_some preview_command in
+  let has_preview = Option.is_some preview_command && preview_enabled in
   let list_width = if has_preview then (screen.Screen_dimensions.width * 2) / 5 else screen.Screen_dimensions.width in
   let preview_width = if has_preview then screen.Screen_dimensions.width - list_width - 3 else 0 in
   let item_count = screen.Screen_dimensions.height - prompt_size in
@@ -206,6 +208,16 @@ let handle_input t input =
       if !needs_preview_update then update_preview t;
       `Continue t
     end
+  | Tty_text.User_input.Ctrl_backslash ->
+    (* Toggle preview visibility *)
+    if Option.is_some t.preview_command then begin
+      t.preview_enabled <- not t.preview_enabled;
+      if not t.preview_enabled then
+        t.preview_text <- ""
+      else
+        update_preview t;
+      `Continue t
+    end else `Continue t
   | Tty_text.User_input.Backspace -> begin
       match t.entered_text with
       | None -> `Continue t
diff --git tty_text.ml tty_text.ml
index e8f04ad..9d6003f 100644
--- tty_text.ml
+++ tty_text.ml
@@ -3,13 +3,14 @@ open Async
 
 module User_input = struct
   type t =
-    | Ctrl_c
-    | Arrow_up
     | Arrow_down
-    | Escape
+    | Arrow_up
     | Backspace
-    | Return (* Enter key *)
     | Char of char
+    | Ctrl_backslash
+    | Ctrl_c
+    | Escape
+    | Return (* Enter key *)
   [@@deriving sexp_of]
 end
 
@@ -181,6 +182,8 @@ let with_rendering f =
             | 3 (* CTRL + C *) ->
               let%bind () = Pipe.write w User_input.Ctrl_c in
               return (`Finished ())
+            | 28 (* CTRL + \ *) ->
+              repeat User_input.Ctrl_backslash
             | 0O33  -> (* ESC - check if it's an arrow key *)
               (* Try to read the next two bytes for arrow key sequences *)
               let%bind read_result =
diff --git tty_text.mli tty_text.mli
index 5721fe0..5dd2939 100644
--- tty_text.mli
+++ tty_text.mli
@@ -27,13 +27,14 @@ end
 
 module User_input : sig
   type t =
-    | Ctrl_c
     | Arrow_up
     | Arrow_down
-    | Escape
     | Backspace
-    | Return (* Enter key *)
     | Char of char
+    | Ctrl_backslash
+    | Ctrl_c
+    | Escape
+    | Return (* Enter key *)
   [@@deriving sexp_of]
 end
 
