From 6787a4764d3c8e3cc52363db71459579fc81c77b Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 12 Feb 2026 10:30:57 +0800
Subject: [PATCH] Support --nth, --delimiter

---
 fzf.ml | 66 +++++++++++++++++++++++++++++++++++++++++++++++++++-------
 1 file changed, 58 insertions(+), 8 deletions(-)

diff --git fzf.ml fzf.ml
index 821bf0e..cd86938 100644
--- fzf.ml
+++ fzf.ml
@@ -10,13 +10,15 @@ type t = {
 ; header: string option
 ; preview_command: string option
 ; mutable preview_text: string
+; delimiter: string option
+; nth_fields: int list option
 ; mutable selected_index : int
 ; mutable all_filtered : string list
 ; spinner : Spinner.t
 ; mutable entered_text : string option
 }
 
-let create ~prompt ~header ~preview =
+let create ~prompt ~header ~preview ~delimiter ~nth =
   {
     items = []
   ; filtered_items = []
@@ -24,14 +26,53 @@ let create ~prompt ~header ~preview =
   ; header = header
   ; preview_command = preview
   ; preview_text = ""
+  ; delimiter = delimiter
+  ; nth_fields = nth
   ; selected_index = 0
   ; all_filtered = []
   ; spinner = Spinner.create ~spin_every:(sec 0.2)
   ; entered_text = None
   }
 
+let parse_nth_fields nth_str =
+  try
+    String.split ~on:',' nth_str
+    |> List.map ~f:(fun s ->
+        let trimmed = String.strip s in
+        Int.of_string trimmed)
+    |> Some
+  with _ -> None
+;;
+
+let extract_fields item delimiter nth_fields =
+  match delimiter, nth_fields with
+  | None, None -> item
+  | delim_opt, Some fields ->
+    let parts = 
+      match delim_opt with
+      | None -> String.split item ~on:' ' |> List.filter ~f:(fun s -> not (String.is_empty s))
+      | Some delim -> 
+        let re = Str.regexp (Str.quote delim) in
+        Str.split re item
+    in
+    let num_parts = List.length parts in
+    fields
+    |> List.filter_map ~f:(fun idx ->
+        let actual_idx = if idx < 0 then num_parts + idx else idx - 1 in
+        if actual_idx >= 0 && actual_idx < num_parts 
+        then List.nth parts actual_idx
+        else None)
+    |> String.concat ~sep:" "
+  | Some delim, None ->
+    (* Delimiter without nth just normalizes display *)
+    let re = Str.regexp (Str.quote delim) in
+    Str.split re item |> String.concat ~sep:" "
+;;
+
 let filter_items_and_selection t entered_text =
-  let { items; filtered_items = _; prompt = _; header = _; preview_command = _; preview_text = _; selected_index = _; all_filtered = _; spinner = _; entered_text = _} = t in
+  let { items; filtered_items = _; prompt = _; header = _; preview_command = _;
+        preview_text = _; delimiter; nth_fields; selected_index = _;
+        all_filtered = _; spinner = _; entered_text = _} = t in
   t.entered_text <- entered_text;
   let filtered_items =
     match entered_text with
@@ -39,7 +80,8 @@ let filter_items_and_selection t entered_text =
     | Some text ->
       let pattern = String.Search_pattern.create text in
       items
-      |> List.filter ~f:(fun item ->
+      |> List.filter ~f:(fun original_item ->
+          let item = extract_fields original_item delimiter nth_fields in
           Option.is_some @@ String.Search_pattern.index ~in_:item pattern)
   in
   (* Reset selection to LAST item (appears at TOP after display reversal) *)
@@ -87,7 +129,7 @@ let update_preview t =
 
 let widget t screen =
   let open Tty_text in
-  let {items = _; filtered_items = _; prompt; header = _; preview_command; preview_text; selected_index; all_filtered; spinner; entered_text } = t in
+  let {items = _; filtered_items = _; prompt; header = _; preview_command; preview_text; delimiter; nth_fields; selected_index; all_filtered; spinner; entered_text } = t in
   let prompt_size = 1 in
   let has_preview = Option.is_some preview_command in
   let list_width = if has_preview then (screen.Screen_dimensions.width * 2) / 5 else screen.Screen_dimensions.width in
@@ -107,7 +149,8 @@ let widget t screen =
   in
   let lines =
     List.mapi visible_items ~f:(fun i text ->
-      let truncated = if String.length text > list_width - 4 then String.prefix text (list_width - 4) ^ "…" else text in
+      let display_text = extract_fields text delimiter nth_fields in
+      let truncated = if String.length display_text > list_width - 4 then String.prefix display_text (list_width - 4) ^ "…" else display_text in
       if i = selected_in_window then
         Widget.text ("> " ^ truncated)
       else
@@ -189,7 +232,7 @@ let handle_input t input =
   | Escape -> (`Finished None)
 ;;
 
-let run user_input tty_text stdin ~prompt ~header ~preview =
+let run user_input tty_text stdin ~prompt ~header ~preview ~delimiter ~nth =
   let stdin_reader =
     Pipe.map ~f:(fun x -> `Stdin x) (Reader.lines stdin)
   in
@@ -202,7 +245,7 @@ let run user_input tty_text stdin ~prompt ~header ~preview =
       ; Pipe.map user_input ~f:(fun x -> `Input x)
       ; stdin_closed]
   in
-  let t = create ~prompt ~header ~preview in
+  let t = create ~prompt ~header ~preview ~delimiter ~nth in
   let last_rendered : (string option * string list * int) ref = ref (None, [], 0) in
   let how_often_to_render = (sec 0.1) in
   Render.every
@@ -270,13 +313,20 @@ let () =
         ~doc:"STRING Header string"
     and preview = flag "--preview" (optional string)
         ~doc:"STRING Preview command (use {} for item)"
+    and delimiter =
+      flag "--delimiter" (optional string)
+        ~doc:"STRING Field delimiter (default: whitespace)"
+    and nth =
+      flag "--nth" (optional string)
+        ~doc:"FIELDS Comma-separated field indices (1-indexed, negative from end)"
     in
     fun () ->
       let open Deferred.Let_syntax in
       let stdin = force Reader.stdin in
+      let nth_parsed = Option.bind nth ~f:parse_nth_fields in
       match%bind
         Tty_text.with_rendering (fun (input, tty_text) ->
-            run input tty_text stdin ~prompt ~header ~preview)
+            run input tty_text stdin ~prompt ~header ~preview ~delimiter ~nth:nth_parsed)
       with
       | None -> Deferred.unit
       | Some output ->
