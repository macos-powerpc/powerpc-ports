# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0
PortGroup           legacysupport 1.1
PortGroup           openssl 1.0
PortGroup           wxWidgets 1.0

# O_CLOEXEC
legacysupport.newest_darwin_requires_legacy 10

github.setup        elfmz far2l 2.6.5 v_
revision            0
categories          sysutils www
license             GPL-2
maintainers         {@barracuda156 macos-powerpc.org:barracuda} openmaintainer
description         Fork of FAR Manager v2
long_description    {*}${description} for Unix-like systems.
checksums           rmd160  07a883899d74a0a567e612cd425df9a9ae615b0b \
                    sha256  0e68efff1c5d950c86cdad0387bf1aae7b152dbdd7d24b70bbefeeb4f873a9c9 \
                    size    8274199
github.tarball_from archive

# https://github.com/elfmz/far2l/pull/2874
patchfiles-append   patch-CMakeLists.diff \
                    patch-flags.diff \
                    patch-notifications.diff

# https://github.com/elfmz/far2l/pull/2871
patchfiles-append   patch-endian.diff

# Adjustments for the build with wxGTK:
patchfiles-append   patch-wx.diff

# FIXME: trash brewisms.
# https://github.com/elfmz/far2l/issues/2872
# FIXME: at the moment only TUI works, no wx GUI:
# https://github.com/elfmz/far2l/issues/2873

# Fix header path:
patchfiles-append   patch-unrar.diff

post-patch {
    reinplace "s,@PREFIX@,${prefix},g" ${worksrcpath}/CMakeLists.txt
}

cmake.generator     Ninja

compiler.c_standard     1999
compiler.cxx_standard   2017

depends_build-append \
                    path:bin/pkg-config:pkgconfig

depends_lib-append  path:lib/pkgconfig/gnutls.pc:gnutls \
                    path:lib/pkgconfig/icu-uc.pc:icu \
                    port:libarchive \
                    port:libnfs \
                    port:libssh \
                    port:libunrar \
                    port:libxml2 \
                    port:neon \
                    port:uchardet \
                    port:xorg-libice \
                    port:xorg-libsm \
                    port:xorg-libX11 \
                    port:xorg-libXext \
                    port:xorg-libXi

depends_run-append  port:desktop-file-utils \
                    port:htop

configure.args-append \
                    -DICU_MODE=runtime \
                    -DMULTIARC=ON \
                    -DNETROCKS=ON \
                    -DPYTHON=OFF \
                    -DNR_AWS=OFF \
                    -DNR_SMB=OFF \
                    -DTESTING=OFF \
                    -DUNRAR=lib \
                    -DUNRAR_INCLUDE_DIR=${prefix}/include \
                    -DUSEUCD=ON \
                    -DUSEWX=OFF

variant gui description "Build with wx-based GUI" {
    wxWidgets.use   wxGTK-3.2

    depends_lib-append \
                    port:${wxWidgets.port}

    configure.args-replace \
                    -DUSEWX=OFF -DUSEWX=ON
    configure.args-append \
                    -DwxWidgets_CONFIG_EXECUTABLE:FILEPATH=${wxWidgets.wxconfig}
}

variant s3 description "Enable S3 support" {
    depends_lib-append \
                    port:aws-sdk-cpp

    configure.args-replace \
                    -DNR_AWS=OFF -DNR_AWS=ON
}

variant smb description "Enable SMB support" {
    depends_lib-append \
                    path:lib/libsmbclient.dylib:samba4

    configure.args-replace \
                    -DNR_SMB=OFF -DNR_SMB=ON
}

default_variants    +gui +s3 +smb

notes "
It is recommended to use a modern terminal for better user experience.\
Consider using mlterm(-minimal) or iTerm2 ports.
"

post-activate {
    system "${prefix}/bin/update-desktop-database ${prefix}/share/applications"
}
