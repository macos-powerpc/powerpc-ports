# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           legacysupport 1.1

# strnlen
legacysupport.newest_darwin_requires_legacy 10

set rev             4c0ae3917d4feab6ae1c99d7b750a69cdf3cc96c

github.setup        google angle $rev

# Major and minor version from src/common/angle_version.h
# Patch version using `git rev-list HEAD --count`
version             2.1.26821
revision            0
categories          graphics devel
platforms           {darwin >= 10}
license             BSD
maintainers         {makr @mohd-akram} {@barracuda156 macos-powerpc.org:barracuda} openmaintainer

description         OpenGL ES implementation
long_description    Cross-platform, conformant OpenGL ES implementation.

homepage            https://angleproject.org

github.tarball_from archive

# grep -E '/src/(build\.|testing|third_party/zlib)|jsoncpp_revision.:|SPIRV-(Headers|Tools)|Vulkan-Headers|astc-encoder@' DEPS
set astc_encoder    2319d9c4d4af53a7fc7c52985e264ce6e8a02a9b
set cr_build        d747365c051153cc89f25e6adc95538aabcdd319
set cr_jsoncpp      f62d44704b4da6014aa231cfc116e7fd29617d2a
set cr_testing      3052f51ada5e06b1ce10dbe07b77f5a7cc282401
set cr_zlib         2182f37a0861358faa9f6b8e0dacce32142c3a33
set jsoncpp         42e892d96e47b1f6e29844cc705e148ec4856448
set spirv_headers   babee77020ff82b571d723ce2c0262e2ec0ee3f1
set spirv_tools     539a11dff0ef8d8fbc4fe4c85a4cc4765b543859
set vk_headers      0777a3ad88bad5f4b11cfd509458bbc0ddadc773

master_sites-append https://github.com/gsource-mirror/chromium-src-build/archive/${cr_build}:chromium-build
distfiles-append    chromium-src-build-${cr_build}${extract.suffix}:chromium-build

master_sites-append https://github.com/gsource-mirror/chromium-src-testing/archive/${cr_testing}:chromium-testing
distfiles-append    chromium-src-testing-${cr_testing}${extract.suffix}:chromium-testing

master_sites-append https://github.com/gsource-mirror/chromium-src-third_party-jsoncpp/archive/${cr_jsoncpp}:chromium-jsoncpp
distfiles-append    chromium-src-third_party-jsoncpp-${cr_jsoncpp}${extract.suffix}:chromium-jsoncpp

master_sites-append https://github.com/gsource-mirror/chromium-src-third_party-zlib/archive/${cr_zlib}:chromium-zlib
distfiles-append    chromium-src-third_party-zlib-${cr_zlib}${extract.suffix}:chromium-zlib

master_sites-append https://github.com/KhronosGroup/SPIRV-Headers/archive/${spirv_headers}:spirv-headers
distfiles-append    SPIRV-Headers-${spirv_headers}${extract.suffix}:spirv-headers

master_sites-append https://github.com/KhronosGroup/SPIRV-Tools/archive/${spirv_tools}:spirv-tools
distfiles-append    SPIRV-Tools-${spirv_tools}${extract.suffix}:spirv-tools

master_sites-append https://github.com/KhronosGroup/Vulkan-Headers/archive/${vk_headers}:vulkan-headers
distfiles-append    Vulkan-Headers-${vk_headers}${extract.suffix}:vulkan-headers

master_sites-append https://github.com/ARM-software/astc-encoder/archive/${astc_encoder}:astc-encoder
distfiles-append    astc-encoder-${astc_encoder}${extract.suffix}:astc-encoder

master_sites-append https://github.com/open-source-parsers/jsoncpp/archive/${jsoncpp}:jsoncpp
distfiles-append    jsoncpp-${jsoncpp}${extract.suffix}:jsoncpp

checksums           ${distname}${extract.suffix} \
                    rmd160  3259dda0cfd275ed91356da47150fdcd36d6b30e \
                    sha256  f52b135fcfb150f9113159a2e279b8aec650eb0ec4554f01d594300b40eee903 \
                    size    16493881 \
                    chromium-src-build-${cr_build}${extract.suffix} \
                    rmd160  f5dbcbc76037803be7b5752f41bec007be6b2230 \
                    sha256  d0a21bd5a152bb020edde401d9d59c79bb29a03831e87bffad7b3a45557b1362 \
                    size    1736324 \
                    chromium-src-testing-${cr_testing}${extract.suffix} \
                    rmd160  a340331eac60d0bc78f4caf10a7b7024193019f2 \
                    sha256  f6f245e4d5e533642545305e72244cdade2f3bd8c5d01e9fb9738e95aaac5c11 \
                    size    2044476 \
                    chromium-src-third_party-jsoncpp-${cr_jsoncpp}${extract.suffix} \
                    rmd160  8611455ceb50dd821a942c3b10f2110c418fe182 \
                    sha256  7360eff9ce58208c68da260db23bdc29bbc00c769905af10aa45af0dd308aba4 \
                    size    4411 \
                    chromium-src-third_party-zlib-${cr_zlib}${extract.suffix} \
                    rmd160  2854c75368e77332ca284b21d7a2b0283523ca96 \
                    sha256  063dc5528626929a5745443532de403689ed38af5b53e226e43e50e90e3cfb30 \
                    size    616519 \
                    SPIRV-Headers-${spirv_headers}${extract.suffix} \
                    rmd160  21ff2bff548dcdee4c012997fbbdc6bf00eb27be \
                    sha256  7a997a11fbe2af478c28617e838eb1928885a5d1b073bdae6cf2ce401a8755b3 \
                    size    559265 \
                    SPIRV-Tools-${spirv_tools}${extract.suffix} \
                    rmd160  18bd37a12b292b680559dd67ea8c9fb23ef24f21 \
                    sha256  db4fa97407b1436a096737e2528713751d8b78a522df8422e0a4c5c45bd1909e \
                    size    3442224 \
                    Vulkan-Headers-${vk_headers}${extract.suffix} \
                    rmd160  8848a1e1fac7025adf68be23341f27cb6b152349 \
                    sha256  8bbe062c204fd66bbfe6284e1bc80b645334ac8c090bbb10d9127e9a886ce32a \
                    size    2954420 \
                    astc-encoder-${astc_encoder}${extract.suffix} \
                    rmd160  1c792cca8415346924640772699e6ffc2d3871f4 \
                    sha256  8b5068ef28a8db1cb354d89d9cefd19d43eddfc72c3468fce7ebb92b2431d4c4 \
                    size    36161899 \
                    jsoncpp-${jsoncpp}${extract.suffix} \
                    rmd160  2938aba554af493df2cc854497fa3a00d55521ee \
                    sha256  0b40e4598d68d3dbd8cab90b249e18f1363ecc694c38f727851f4db34b6887ec \
                    size    216350

post-extract {
    delete ${worksrcpath}/build
    move ${workpath}/chromium-src-build-${cr_build} ${worksrcpath}/build

    delete ${worksrcpath}/testing
    move ${workpath}/chromium-src-testing-${cr_testing} ${worksrcpath}/testing

    delete ${worksrcpath}/third_party/jsoncpp
    move ${workpath}/chromium-src-third_party-jsoncpp-${cr_jsoncpp} \
        ${worksrcpath}/third_party/jsoncpp

    delete ${worksrcpath}/third_party/zlib
    move ${workpath}/chromium-src-third_party-zlib-${cr_zlib} \
        ${worksrcpath}/third_party/zlib

    delete ${worksrcpath}/third_party/spirv-headers/src
    move ${workpath}/SPIRV-Headers-${spirv_headers} \
        ${worksrcpath}/third_party/spirv-headers/src

    delete ${worksrcpath}/third_party/spirv-tools/src
    move ${workpath}/SPIRV-Tools-${spirv_tools} \
        ${worksrcpath}/third_party/spirv-tools/src

    delete ${worksrcpath}/third_party/vulkan-headers/src
    move ${workpath}/Vulkan-Headers-${vk_headers} \
        ${worksrcpath}/third_party/vulkan-headers/src

    delete ${worksrcpath}/third_party/astc-encoder/src
    move ${workpath}/astc-encoder-${astc_encoder} \
        ${worksrcpath}/third_party/astc-encoder/src

    delete ${worksrcpath}/third_party/jsoncpp/source
    move ${workpath}/jsoncpp-${jsoncpp} \
        ${worksrcpath}/third_party/jsoncpp/source

    copy ${filespath}/gclient_args.gni ${worksrcpath}/build/config/
}

set py_ver          3.13
set py_ver_nodot    [string map {. {}} ${py_ver}]

depends_build       port:gn \
                    port:ninja \
                    port:python${py_ver_nodot} \
                    path:lib/pkgconfig/RapidJSON.pc:rapidjson

# Python only needed for scripts
depends_skip_archcheck-append \
                    python${py_ver_nodot}
configure.python    ${prefix}/bin/python${py_ver}

use_xcode           yes

# Upstream MacPorts patches:
patchfiles          patch-commit-id.diff \
                    patch-apple-toolchain.diff \
                    patch-src-common-platform.diff

# Our patches. These are needed / safe to use unconditionally,
# and sufficient to fix build on Catalina.
patchfiles-append   patch-debug.cpp.diff \
                    patch-apple_platform_utils.diff \
                    patch-SystemInfo_macos.mm.diff \
                    patch-build_config.h.diff \
                    patch-roll_aosp.sh.diff \
                    patch-driver_utils_mac.mm.diff \
                    patch-no-stupid-error-in-host_byteorder.diff

# May need to be broken down into general vs legacy part:
patchfiles-append   fix-broken-build-system.diff

# Misc fixes, exact threshold is unknown.
# Fixes bugs in build system, throws away rust includes (rust is not used for any archs,
# but gn includes its build spec files, which breaks powerpc build), recognizes powerpc,
# fixes OpenGL includes, fix wrong paths to /Developer contents.
if {${os.platform} eq "darwin" && ${os.major} < 19} {
    patchfiles-append \
                    fix-sdk-path.diff \
                    patch-FunctionsCGL.diff \
                    patch-fix-libtool.diff \
                    patch-IOSurfaceSurfaceCGL.cpp.diff \
                    patch-WindowSurfaceCGL.mm.diff \
                    patch-DisplayCGL.mm.diff \
                    patch-no-dsyms-and-strip.diff
}

if {${os.platform} eq "darwin" && ${os.major} < 15} {
    patchfiles-append \
                    no-metal-for-goodness-sake.patch
}

# No direct linking to CoreGraphics before 10.8:
if {${os.platform} eq "darwin" && ${os.major} < 12} {
    patchfiles-append \
                    patch-fix-frameworks.diff
}

# legacy-support, adjust if needed.
if {${os.platform} eq "darwin" && ${os.major} < 11} {
    patchfiles-append \
                    patch-legacysupport.diff
}

# Fix wrong struct size on ppc32:
if {${os.platform} eq "darwin" && ${configure.build_arch} eq "ppc"} {
    patchfiles-append \
                    patch-Uniform.h-fix-struct-size.diff
}

# Drop clangisms, fix 32-bit builds with gcc:
if {[string match *gcc* ${configure.compiler}]} {
    patchfiles-append \
                    fix-wrong-flags-for-gcc.diff \
                    patch-fix-threadId.diff \
                    patch-SoftLinking.h.diff \
                    patch-Context.cpp.diff \
                    patch-Display.cpp.diff \
                    patch-global_state.cpp.diff \
                    patch-fix-id-bug.diff

    if {${configure.build_arch} in [list arm i386 ppc]} {
        patchfiles-append \
                    patch-libatomic.diff
    }
}

post-patch {
    reinplace "s|@COMMIT_POSITION@|[lindex [split ${version} .] 2]|" \
        ${worksrcpath}/src/commit_id.py

    fs-traverse f ${worksrcpath} {
        if {[string match *.py ${f}]} {
            reinplace -q "s|/usr/bin/python3|${configure.python}|" ${f}
            reinplace -q "s|/usr/bin/env python3|${configure.python}|" ${f}
        }
    }
    reinplace "s|@PYTHON@|${configure.python}|" ${worksrcpath}/scripts/roll_aosp.sh
    reinplace "s|exec python3|exec ${configure.python}|" ${worksrcpath}/build/gn_editor
    reinplace "s|/usr/bin/env python3|${configure.python}|" ${worksrcpath}/build/util/ide_query

    if {${os.platform} eq "darwin" && ${os.major} < 11} {
        reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/build/config/compiler/BUILD.gn
    }
}

compiler.cxx_standard   2020

if {${macosx_deployment_target} eq ""} {
    # Uses IOSurface
    set macosx_deployment_target 10.6
}

configure.cmd       gn
configure.pre_args  gen out
configure.args      --args='\
                    angle_build_tests=false \
                    angle_enable_metal=false \
                    angle_enable_vulkan=false \
                    angle_enable_wgpu=false \
                    fatal_linker_warnings=false \
                    is_clang=false \
                    is_official_build=true \
                    install_prefix=\"${destroot}${prefix}\" \
                    mac_sdk_min=\"${macosx_deployment_target}\" \
                    mac_deployment_target=\"${macosx_deployment_target}\" \
                    mac_min_system_version=\"${macosx_deployment_target}\" \
                    treat_warnings_as_errors=false \
                    use_custom_libcxx=false \
                    use_system_xcode=true' \
                    --script-executable=${configure.python}
configure.post_args -v

build.cmd           ninja
build.pre_args      -C out
build.post_args     -v
build.env           ANGLE_UPSTREAM_HASH=[string range $rev 0 11]

destroot.cmd        ninja
destroot.pre_args   -C out
destroot.post_args  -v
destroot.destdir
destroot.target     install_angle

platform darwin {
    post-destroot {
        copy ${worksrcpath}/out/angle_shader_translator ${destroot}${prefix}/bin/

        foreach f [glob -tails -directory ${destroot} ${prefix}/lib/*.dylib] {
            system "install_name_tool -id /$f ${destroot}/$f"
        }

        system "install_name_tool -change ./libGLESv2.dylib ${prefix}/lib/libGLESv2.dylib \
            ${destroot}${prefix}/lib/libGLESv1_CM.dylib"

        reinplace "s|^prefix=.*$|prefix=${prefix}|" \
            {*}[glob ${destroot}${prefix}/lib/pkgconfig/*.pc]

        delete \
            ${destroot}${prefix}/include/CL \
            ${destroot}${prefix}/include/GLX \
            ${destroot}${prefix}/include/WGL \
            ${destroot}${prefix}/include/GLSLANG \
            ${destroot}${prefix}/include/vulkan \
            ${destroot}${prefix}/include/platform \
            {*}[glob ${destroot}${prefix}/include/*.h] \
            {*}[glob ${destroot}${prefix}/include/*/README.md] \
            {*}[glob ${destroot}${prefix}/include/*/.clang-format]
    }
}

livecheck.url       https://chromiumdash.appspot.com/fetch_releases?channel=Stable&platform=Mac
livecheck.regex     {"angle":"([0-9a-f]+)"}
livecheck.version   $rev
