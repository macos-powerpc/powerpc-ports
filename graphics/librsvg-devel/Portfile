# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           gitlab 1.0
PortGroup           gobject_introspection 1.0

gitlab.instance     https://gitlab.gnome.org

set my_name         librsvg
name                ${my_name}-devel
gitlab.setup        GNOME ${my_name} ef930995
# gitlab.setup        sp1rit ${my_name} 653164d
conflicts           ${my_name}
version             2.40.23
revision            0
epoch               1
categories          graphics gnome
license             {GPL-2+ LGPL-2+}
maintainers         {mascguy @mascguy} openmaintainer
description         GNOME implementation of rsvg
long_description    {*}${description}
homepage            https://wiki.gnome.org/Projects/LibRsvg
checksums           rmd160  2446171ce7ed85f86780bb864065f04088d3d790 \
                    sha256  e450c14dc958c855e459afca5d261ab7cd5c840e8eaedbb71388c7b61f898612 \
                    size    2020305
gitlab.livecheck.branch ${my_name}-for-gtk

use_autoreconf      yes
autoreconf.args     -fiv

depends_build-append \
                    port:gtk-doc \
                    path:bin/pkg-config:pkgconfig

# These should default to -devel subports.
depends_lib-append  path:lib/pkgconfig/cairo.pc:cairo \
                    path:lib/pkgconfig/freetype2.pc:freetype \
                    path:lib/pkgconfig/gdk-pixbuf-2.0.pc:gdk-pixbuf2 \
                    path:lib/pkgconfig/glib-2.0.pc:glib2 \
                    path:lib/pkgconfig/harfbuzz.pc:harfbuzz \
                    port:libcroco \
                    port:libxml2 \
                    path:lib/pkgconfig/pango.pc:pango \
                    path:bin/vala:vala

license_noconflict  gobject-introspection \
                    vala

# https://trac.macports.org/ticket/65407
patchfiles-append   patch-librsvg-makefile-in-vapi-deps.diff

compiler.c_standard 2011

gobject_introspection   yes

configure.args-append \
                    --disable-Bsymbolic \
                    --disable-gtk-doc \
                    --disable-silent-rules \
                    --enable-introspection=yes \
                    --enable-vala=yes

configure.ldflags-append \
                    -lobjc

test.run            yes
test.dir            ${worksrcpath}/tests
test.target         check

post-destroot {
    set docdir ${prefix}/share/doc/${my_name}
    xinstall -d ${destroot}${docdir}
    xinstall -m 644 -W ${worksrcpath} AUTHORS COPYING COPYING.LIB \
        ${destroot}${docdir}

    xinstall -m 755 -W ${filespath} svg2pdf \
        ${destroot}${prefix}/bin

    set badfile ${prefix}/lib/gdk-pixbuf-2.0/2.10.0/loaders/libpixbufloader-svg.a
    if {[file exists ${destroot}${badfile}]} {
        file delete ${destroot}${badfile}
    }
}

post-activate {
    system "${prefix}/bin/gdk-pixbuf-query-loaders --update-cache"
}

post-deactivate {
    system "${prefix}/bin/gdk-pixbuf-query-loaders --update-cache"
}

# variant viewer disabled by default in an attempt to avoid loading
# gtk3 by those who are using it strictly as a library outside of GTK+/GNOME.
# https://trac.macports.org/ticket/43328
# https://trac.macports.org/ticket/47443
# https://trac.macports.org/ticket/47596
variant viewer description "Build the rsvg-view-3 viewer utility" {
    depends_lib-append  path:lib/pkgconfig/gtk+-3.0.pc:gtk3
    depends_run-append  port:adwaita-icon-theme
}

livecheck.type      gnome
livecheck.name      ${my_name}
