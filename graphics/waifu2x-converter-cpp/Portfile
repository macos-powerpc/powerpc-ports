# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0
PortGroup           LTO 1.0

github.setup        DeadSix27 waifu2x-converter-cpp 57520b25864e648c133ea0b2f4e7e07410ddc1f4
version             5.3.4
revision            0
epoch               1
categories          graphics manga
# As of now, the build uses OpenCL headers. Though it should not...
platforms           {darwin >= 10}
license             MIT
maintainers         nomaintainer

description         Improved fork of Waifu2X C++
long_description    {*}${description} using OpenCV.

checksums           rmd160  ceb9077591a9fbcdf0507af25d8a145230bd983c \
                    sha256  f8f0236e4b13974ce22e079c1fc3a897897cb23bbcaed54f0db046592a652ea3 \
                    size    12532435
github.tarball_from archive

# modelHandler_OpenCL.cpp:55:21: error: 'std::__fs' has not been declared
patchfiles          fix-wrong-filesystem-namespace.patch

patchfiles-append   patch-CMakeLists.txt

post-patch {
    reinplace "s|@BRANCH@|master|" ${worksrcpath}/CMakeLists.txt
    reinplace "s|@HASH@|${github.version}|" ${worksrcpath}/CMakeLists.txt
    reinplace "s|@VER@|${version}|" ${worksrcpath}/CMakeLists.txt
}

LTO.gcc_lto_jobs    auto

set cvv             4
cmake.module_path-append \
                    ${prefix}/libexec/opencv${cvv}/cmake

depends_build-append \
                    path:bin/pkg-config:pkgconfig

# Prioritize a newer version:
depends_lib-append  path:lib/opencv${cvv}/pkgconfig/opencv${cvv}.pc:opencv${cvv}-devel

# Note that upstream lies about OpenCL: the option is supposed to exist, but in fact it does nothing.
# However, the build does not link to OpenCL library, so w/e.
configure.args-append \
                    -DENABLE_CUDA=OFF \
                    -DENABLE_OPENCV=ON \
                    -DENABLE_OPENCL=OFF \
                    -DENABLE_TESTS=OFF \
                    -DENABLE_UNICODE=ON \
                    -DINSTALL_MODELS=ON

# filesystem
compiler.cxx_standard   2017
