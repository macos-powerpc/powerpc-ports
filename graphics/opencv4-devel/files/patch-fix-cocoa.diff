From b7f04541d27bec4c3e45801c5ffa1689144b23f1 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Wed, 18 Feb 2026 06:46:29 +0800
Subject: [PATCH 1/2] window_cocoa: fix

---
 modules/highgui/src/window_cocoa.mm | 234 ++++++++++++++++------------
 1 file changed, 138 insertions(+), 96 deletions(-)

diff --git a/modules/highgui/src/window_cocoa.mm b/modules/highgui/src/window_cocoa.mm
index f14b45dab1..7e2a6c5721 100644
--- a/modules/highgui/src/window_cocoa.mm
+++ b/modules/highgui/src/window_cocoa.mm
@@ -81,7 +81,17 @@ static NSApplication *application = nil;
 static NSMutableDictionary *windows = nil;
 static bool wasInitialized = false;
 
+// Define constants not available in 10.6 SDK
+#if MAC_OS_X_VERSION_MAX_ALLOWED < 1070
+#define NSFullScreenWindowMask (1 << 14)
+#endif
+
 @interface CVView : NSView
+{
+    NSView *imageView;
+    NSImage *image;
+    int sliderHeight;
+}
 @property(retain) NSView *imageView;
 @property(retain) NSImage *image;
 @property int sliderHeight;
@@ -138,7 +148,7 @@ CV_IMPL int cvInitSystem( int , char** )
     application = [NSApplication sharedApplication];
     windows = [[NSMutableDictionary alloc] init];
 
-#if MAC_OS_X_VERSION_MAX_ALLOWED >= MAC_OS_X_VERSION_10_6
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 1060
 
 #ifndef NSAppKitVersionNumber10_5
 #define NSAppKitVersionNumber10_5 949
@@ -153,13 +163,13 @@ CV_IMPL int cvInitSystem( int , char** )
 
 static CVWindow *cvGetWindow(const char *name) {
     CVWindow *retval = nil;
-    @autoreleasepool{
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
         NSString *cvname = [NSString stringWithFormat:@"%s", name];
         retval = (CVWindow*) [windows valueForKey:cvname];
         if (retval != nil) {
             [retval retain];
         }
-    }
+    [pool drain];
     return [retval autorelease];
 }
 
@@ -170,33 +180,37 @@ CV_IMPL int cvStartWindowThread()
 
 CV_IMPL void cvDestroyWindow( const char* name)
 {
-    @autoreleasepool {
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
         CVWindow *window = cvGetWindow(name);
         if(window) {
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 1070
             if ([window styleMask] & NSFullScreenWindowMask) {
                 [window toggleFullScreen:nil];
             }
+#endif
             [window close];
             [windows removeObjectForKey:[NSString stringWithFormat:@"%s", name]];
         }
-    }
+    [pool drain];
 }
 
 
 CV_IMPL void cvDestroyAllWindows( void )
 {
-    @autoreleasepool {
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
         NSDictionary* list = [NSDictionary dictionaryWithDictionary:windows];
-        for(NSString *key in list) {
+        NSEnumerator *enumerator = [list keyEnumerator];
+        NSString *key;
+        while((key = [enumerator nextObject])) {
             cvDestroyWindow([key cStringUsingEncoding:NSASCIIStringEncoding]);
         }
-    }
+    [pool drain];
 }
 
 
 CV_IMPL void cvShowImage( const char* name, const CvArr* arr)
 {
-    @autoreleasepool{
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
         CVWindow *window = cvGetWindow(name);
         if(!window)
         {
@@ -221,21 +235,23 @@ CV_IMPL void cvShowImage( const char* name, const CvArr* arr)
                     if ([[window contentView] respondsToSelector:@selector(convertSizeFromBacking:)])
                     {
                         // Only resize for retina displays if the image is bigger than the screen
-                        NSSize screenSize = NSScreen.mainScreen.visibleFrame.size;
-                        CGFloat titleBarHeight = window.frame.size.height - [window contentRectForFrameRect:window.frame].size.height;
+                        NSSize screenSize = [[NSScreen mainScreen] visibleFrame].size;
+                        CGFloat titleBarHeight = [window frame].size.height - [window contentRectForFrameRect:[window frame]].size.height;
                         screenSize.height -= titleBarHeight;
                         if (imageSize.width > screenSize.width || imageSize.height > screenSize.height)
                         {
                             CGFloat fx = screenSize.width/std::max(imageSize.width, (CGFloat)1.f);
                             CGFloat fy = screenSize.height/std::max(imageSize.height, (CGFloat)1.f);
                             CGFloat min_f = std::min(fx, fy);
-                            scaledImageSize = [[window contentView] convertSizeFromBacking:imageSize];
+                            typedef NSSize (*ConvertSizeFunc)(id, SEL, NSSize);
+                            ConvertSizeFunc convertFunc = (ConvertSizeFunc)[[window contentView] methodForSelector:@selector(convertSizeFromBacking:)];
+                            scaledImageSize = convertFunc([window contentView], @selector(convertSizeFromBacking:), imageSize);
                             scaledImageSize.width = std::min(scaledImageSize.width, min_f*imageSize.width);
                             scaledImageSize.height = std::min(scaledImageSize.height, min_f*imageSize.height);
                         }
                     }
                     NSSize contentSize = vrectOld.size;
-                    contentSize.height = scaledImageSize.height + [window contentView].sliderHeight;
+                    contentSize.height = scaledImageSize.height + [[window contentView] sliderHeight];
                     contentSize.width = std::max<int>(scaledImageSize.width, MIN_SLIDER_WIDTH);
                     [window setContentSize:contentSize]; //adjust sliders to fit new window size
                     if([window firstContent])
@@ -252,19 +268,19 @@ CV_IMPL void cvShowImage( const char* name, const CvArr* arr)
             }
             [window setFirstContent:NO];
         }
-    }
+    [pool drain];
 }
 
 CV_IMPL void cvResizeWindow( const char* name, int width, int height)
 {
-    @autoreleasepool{
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
         CVWindow *window = cvGetWindow(name);
         if(window && ![window autosize]) {
-            height += [window contentView].sliderHeight;
+            height += [[window contentView] sliderHeight];
             NSSize size = { (CGFloat)width, (CGFloat)height };
             [window setContentSize:size];
         }
-    }
+    [pool drain];
 }
 
 CV_IMPL void cvMoveWindow( const char* name, int x, int y)
@@ -274,10 +290,11 @@ CV_IMPL void cvMoveWindow( const char* name, int x, int y)
     __BEGIN__;
 
     CVWindow *window = nil;
+    NSAutoreleasePool *pool = nil;
 
     if(name == NULL)
         CV_ERROR( CV_StsNullPtr, "NULL window name" );
-    @autoreleasepool{
+    pool = [[NSAutoreleasePool alloc] init];
         window = cvGetWindow(name);
         if(window) {
             if([window firstContent]) {
@@ -289,7 +306,7 @@ CV_IMPL void cvMoveWindow( const char* name, int x, int y)
                 [window setFrameTopLeftPoint:NSMakePoint(x, y)];
             }
         }
-    }
+    [pool drain];
     __END__;
 }
 
@@ -302,11 +319,12 @@ CV_IMPL int cvCreateTrackbar (const char* trackbar_name,
 
     int result = 0;
     CVWindow *window = nil;
+    NSAutoreleasePool *pool = nil;
 
     __BEGIN__;
     if(window_name == NULL)
         CV_ERROR( CV_StsNullPtr, "NULL window name" );
-    @autoreleasepool {
+    pool = [[NSAutoreleasePool alloc] init];
         window = cvGetWindow(window_name);
         if(window) {
             [window createSliderWithName:trackbar_name
@@ -315,7 +333,7 @@ CV_IMPL int cvCreateTrackbar (const char* trackbar_name,
                                 callback:on_notify];
             result = 1;
         }
-    }
+    [pool drain];
     __END__;
     return result;
 }
@@ -328,7 +346,7 @@ CV_IMPL int cvCreateTrackbar2(const char* trackbar_name,
                               void* userdata)
 {
     int res = cvCreateTrackbar(trackbar_name, window_name, val, count, NULL);
-    @autoreleasepool{
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
         if(res) {
             CVWindow *window = cvGetWindow(window_name);
             if (window && [window respondsToSelector:@selector(sliders)]) {
@@ -337,7 +355,7 @@ CV_IMPL int cvCreateTrackbar2(const char* trackbar_name,
                 [slider setUserData:userdata];
             }
         }
-    }
+    [pool drain];
     return res;
 }
 
@@ -348,16 +366,17 @@ cvSetMouseCallback( const char* name, CvMouseCallback function, void* info)
     CV_FUNCNAME("cvSetMouseCallback");
 
     CVWindow *window = nil;
+    NSAutoreleasePool *pool = nil;
     __BEGIN__;
     if(name == NULL)
         CV_ERROR( CV_StsNullPtr, "NULL window name" );
-    @autoreleasepool{
+    pool = [[NSAutoreleasePool alloc] init];
         window = cvGetWindow(name);
         if(window) {
             [window setMouseCallback:function];
             [window setMouseParam:info];
         }
-    }
+    [pool drain];
     __END__;
 }
 
@@ -366,13 +385,14 @@ cvSetMouseCallback( const char* name, CvMouseCallback function, void* info)
     CV_FUNCNAME("cvGetTrackbarPos");
 
     CVWindow *window = nil;
+    NSAutoreleasePool *pool = nil;
     int pos = -1;
 
     __BEGIN__;
     if(trackbar_name == NULL || window_name == NULL)
         CV_ERROR( CV_StsNullPtr, "NULL trackbar or window name" );
 
-    @autoreleasepool{
+    pool = [[NSAutoreleasePool alloc] init];
         window = cvGetWindow(window_name);
         if(window && [window respondsToSelector:@selector(sliders)]) {
             CVSlider *slider = [[window sliders] valueForKey:[NSString stringWithFormat:@"%s", trackbar_name]];
@@ -380,7 +400,7 @@ cvSetMouseCallback( const char* name, CvMouseCallback function, void* info)
                 pos = [[slider slider] intValue];
             }
         }
-    }
+    [pool drain];
     __END__;
     return pos;
 }
@@ -391,6 +411,7 @@ CV_IMPL void cvSetTrackbarPos(const char* trackbar_name, const char* window_name
 
     CVWindow *window = nil;
     CVSlider *slider = nil;
+    NSAutoreleasePool *pool = nil;
 
     __BEGIN__;
     if(trackbar_name == NULL || window_name == NULL)
@@ -399,7 +420,7 @@ CV_IMPL void cvSetTrackbarPos(const char* trackbar_name, const char* window_name
     if(pos < 0)
         CV_ERROR( CV_StsOutOfRange, "Bad trackbar maximal value" );
 
-    @autoreleasepool{
+    pool = [[NSAutoreleasePool alloc] init];
         window = cvGetWindow(window_name);
         if(window && [window respondsToSelector:@selector(sliders)]) {
             slider = [[window sliders] valueForKey:[NSString stringWithFormat:@"%s", trackbar_name]];
@@ -410,7 +431,7 @@ CV_IMPL void cvSetTrackbarPos(const char* trackbar_name, const char* window_name
                 }
             }
         }
-    }
+    [pool drain];
     __END__;
 }
 
@@ -420,12 +441,13 @@ CV_IMPL void cvSetTrackbarMax(const char* trackbar_name, const char* window_name
 
     CVWindow *window = nil;
     CVSlider *slider = nil;
+    NSAutoreleasePool *pool = nil;
 
     __BEGIN__;
     if(trackbar_name == NULL || window_name == NULL)
         CV_ERROR( CV_StsNullPtr, "NULL trackbar or window name" );
 
-    @autoreleasepool{
+    pool = [[NSAutoreleasePool alloc] init];
         window = cvGetWindow(window_name);
         if(window && [window respondsToSelector:@selector(sliders)]) {
             slider = [[window sliders] valueForKey:[NSString stringWithFormat:@"%s", trackbar_name]];
@@ -437,7 +459,7 @@ CV_IMPL void cvSetTrackbarMax(const char* trackbar_name, const char* window_name
                 }
             }
         }
-    }
+    [pool drain];
     __END__;
 }
 
@@ -447,12 +469,13 @@ CV_IMPL void cvSetTrackbarMin(const char* trackbar_name, const char* window_name
 
     CVWindow *window = nil;
     CVSlider *slider = nil;
+    NSAutoreleasePool *pool = nil;
 
     __BEGIN__;
     if(trackbar_name == NULL || window_name == NULL)
         CV_ERROR( CV_StsNullPtr, "NULL trackbar or window name" );
 
-    @autoreleasepool{
+    pool = [[NSAutoreleasePool alloc] init];
         window = cvGetWindow(window_name);
         if(window && [window respondsToSelector:@selector(sliders)]) {
             slider = [[window sliders] valueForKey:[NSString stringWithFormat:@"%s", trackbar_name]];
@@ -464,7 +487,7 @@ CV_IMPL void cvSetTrackbarMin(const char* trackbar_name, const char* window_name
                 }
             }
         }
-    }
+    [pool drain];
     __END__;
 }
 
@@ -476,13 +499,16 @@ CV_IMPL void* cvGetWindowHandle( const char* name )
 
 CV_IMPL const char* cvGetWindowName( void* window_handle )
 {
-    @autoreleasepool{
-        for(NSString *key in windows) {
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
+        NSEnumerator *enumerator = [windows keyEnumerator];
+        NSString *key;
+        while((key = [enumerator nextObject])) {
             if([windows valueForKey:key] == window_handle) {
+                [pool drain];
                 return [key UTF8String];
             }
         }
-    }
+    [pool drain];
     return 0;
 }
 
@@ -491,11 +517,12 @@ CV_IMPL int cvNamedWindow( const char* name, int flags )
     if( !wasInitialized )
         cvInitSystem(0, 0);
 
-    @autoreleasepool{
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
         CVWindow *window = cvGetWindow(name);
         if( window )
         {
             [window setAutosize:(flags == CV_WINDOW_AUTOSIZE)];
+            [pool drain];
             return 0;
         }
 
@@ -535,14 +562,14 @@ CV_IMPL int cvNamedWindow( const char* name, int flags )
         [window setAutosize:(flags == CV_WINDOW_AUTOSIZE)];
 
         [windows setValue:window forKey:windowName];
+        [pool drain];
         return [windows count]-1;
-    }
 }
 
 CV_IMPL int cvWaitKey (int maxWait)
 {
     int returnCode = -1;
-    @autoreleasepool{
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
         double start = [[NSDate date] timeIntervalSince1970];
 
         while(true) {
@@ -566,8 +593,8 @@ CV_IMPL int cvWaitKey (int maxWait)
 
             [NSThread sleepForTimeInterval:1/100.];
         }
-        return returnCode;
-    }
+    [pool drain];
+    return returnCode;
 }
 
 CvRect cvGetWindowRect_COCOA( const char* name )
@@ -588,16 +615,16 @@ CvRect cvGetWindowRect_COCOA( const char* name )
     {
         CV_ERROR( CV_StsNullPtr, "NULL window" );
     } else {
-        @autoreleasepool {
+        NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
             NSRect rect = [window frame];
-#if MAC_OS_X_VERSION_MAX_ALLOWED > MAC_OS_X_VERSION_10_6
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 1070
             NSPoint pt = [window convertRectToScreen:rect].origin;
 #else
             NSPoint pt = [window convertBaseToScreen:rect.origin];
 #endif
             NSSize sz = [[[window contentView] image] size];
             result = cvRect(pt.x, pt.y, sz.width, sz.height);
-        }
+        [pool drain];
     }
     __END__;
     return result;
@@ -622,7 +649,7 @@ double cvGetModeWindow_COCOA( const char* name )
         CV_ERROR( CV_StsNullPtr, "NULL window" );
     }
 
-    result = window.status;
+    result = [window status];
     __END__;
     return result;
 }
@@ -631,9 +658,10 @@ void cvSetModeWindow_COCOA( const char* name, double prop_value )
 {
     CVWindow *window = nil;
 
-#if MAC_OS_X_VERSION_MAX_ALLOWED < MAC_OS_X_VERSION_10_7
+#if MAC_OS_X_VERSION_MAX_ALLOWED < 1070
     NSDictionary *fullscreenOptions = nil;
 #endif
+    NSAutoreleasePool *pool = nil;
 
     CV_FUNCNAME( "cvSetModeWindow_COCOA" );
 
@@ -654,13 +682,13 @@ void cvSetModeWindow_COCOA( const char* name, double prop_value )
         return;
     }
 
-    @autoreleasepool{
-#if MAC_OS_X_VERSION_MAX_ALLOWED > MAC_OS_X_VERSION_10_6
+    pool = [[NSAutoreleasePool alloc] init];
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 1070
         if ( ([window styleMask] & NSFullScreenWindowMask) && prop_value==CV_WINDOW_NORMAL )
         {
             [window toggleFullScreen:nil];
 
-            window.status=CV_WINDOW_NORMAL;
+            [window setStatus:CV_WINDOW_NORMAL];
         }
         else if( !([window styleMask] & NSFullScreenWindowMask) && prop_value==CV_WINDOW_FULLSCREEN )
         {
@@ -677,23 +705,22 @@ void cvSetModeWindow_COCOA( const char* name, double prop_value )
 
             [window setFrameTopLeftPoint: frame.origin];
 
-            window.status=CV_WINDOW_FULLSCREEN;
+            [window setStatus:CV_WINDOW_FULLSCREEN];
         }
 #else
         fullscreenOptions = [NSDictionary dictionaryWithObject:[NSNumber numberWithBool:YES] forKey:NSFullScreenModeSetting];
         if ( [[window contentView] isInFullScreenMode] && prop_value==CV_WINDOW_NORMAL )
         {
             [[window contentView] exitFullScreenModeWithOptions:fullscreenOptions];
-            window.status=CV_WINDOW_NORMAL;
+            [window setStatus:CV_WINDOW_NORMAL];
         }
         else if( ![[window contentView] isInFullScreenMode] && prop_value==CV_WINDOW_FULLSCREEN )
         {
             [[window contentView] enterFullScreenMode:[NSScreen mainScreen] withOptions:fullscreenOptions];
-            window.status=CV_WINDOW_FULLSCREEN;
+            [window setStatus:CV_WINDOW_FULLSCREEN];
         }
 #endif
-    }
-
+    [pool drain];
     __END__;
 }
 
@@ -716,7 +743,7 @@ double cvGetPropVisible_COCOA(const char* name)
         CV_ERROR(CV_StsNullPtr, "NULL window");
     }
 
-    result = window.isVisible ? 1 : 0;
+    result = [window isVisible] ? 1 : 0;
 
     __END__;
     return result;
@@ -741,7 +768,7 @@ double cvGetPropTopmost_COCOA(const char* name)
         CV_ERROR(CV_StsNullPtr, "NULL window");
     }
 
-    result = (window.level == NSStatusWindowLevel) ? 1 : 0;
+    result = ([window level] == NSStatusWindowLevel) ? 1 : 0;
 
     __END__;
     return result;
@@ -750,6 +777,7 @@ double cvGetPropTopmost_COCOA(const char* name)
 void cvSetPropTopmost_COCOA( const char* name, const bool topmost )
 {
     CVWindow *window = nil;
+    NSAutoreleasePool *pool = nil;
     CV_FUNCNAME( "cvSetPropTopmost_COCOA" );
 
     __BEGIN__;
@@ -757,35 +785,35 @@ void cvSetPropTopmost_COCOA( const char* name, const bool topmost )
     {
         CV_ERROR( CV_StsNullPtr, "NULL name string" );
     }
-    @autoreleasepool{
+    pool = [[NSAutoreleasePool alloc] init];
         window = cvGetWindow(name);
         if ( window == NULL )
         {
             CV_ERROR( CV_StsNullPtr, "NULL window" );
         }
-
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 1070
         if (([window styleMask] & NSFullScreenWindowMask))
         {
+            [pool drain];
             EXIT;
         }
-
+#endif
         if (topmost)
         {
-            [window makeKeyAndOrderFront:window.self];
+            [window makeKeyAndOrderFront:window];
             [window setLevel:CGWindowLevelForKey(kCGMaximumWindowLevelKey)];
         }
         else
         {
             [window makeKeyAndOrderFront:nil];
         }
-    }
+    [pool drain];
     __END__;
 }
 
 void setWindowTitle_COCOA(const cv::String& winname, const cv::String& title)
 {
-
-    @autoreleasepool{
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
         CVWindow *window = cvGetWindow(winname.c_str());
 
         if (window == NULL)
@@ -799,8 +827,7 @@ void setWindowTitle_COCOA(const cv::String& winname, const cv::String& title)
 
         NSString *windowTitle = [NSString stringWithFormat:@"%s", title.c_str()];
         [window setTitle:windowTitle];
-    }
-
+    [pool drain];
 }
 
 static NSSize constrainAspectRatio(NSSize base, NSSize constraint) {
@@ -835,35 +862,46 @@ static NSSize constrainAspectRatio(NSSize base, NSSize constraint) {
 - (void)cvSendMouseEvent:(NSEvent *)event type:(int)type flags:(int)flags {
     (void)event;
     NSPoint mp = [NSEvent mouseLocation];
-    mp = [self convertScreenToBase: mp];
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 1070
+    if ([self respondsToSelector:@selector(convertRectFromScreen:)]) {
+        NSRect screenRect = NSMakeRect(mp.x, mp.y, 0, 0);
+        mp = [self convertRectFromScreen:screenRect].origin;
+    } else
+#endif
+    {
+         mp = [self convertScreenToBase: mp];
+    }
     CVView *contentView = [self contentView];
     NSSize viewSize = contentView.frame.size;
-    if (contentView.imageView) {
-        viewSize = contentView.imageView.frame.size;
+    if ([contentView imageView]) {
+        viewSize = [[contentView imageView] frame].size;
     }
     else {
-        viewSize.height -= contentView.sliderHeight;
+        viewSize.height -= [contentView sliderHeight];
     }
     mp.y = viewSize.height - mp.y;
 
-    NSSize imageSize = contentView.image.size;
-    mp.y *= (imageSize.height / std::max(viewSize.height, 1.));
-    mp.x *= (imageSize.width / std::max(viewSize.width, 1.));
-
-    if( [event type] == NSEventTypeScrollWheel ) {
-        if( event.hasPreciseScrollingDeltas ) {
-            mp.x = int(event.scrollingDeltaX);
-            mp.y = int(event.scrollingDeltaY);
-        } else {
-            mp.x = int(event.scrollingDeltaX / 0.100006);
-            mp.y = int(event.scrollingDeltaY / 0.100006);
+    NSSize imageSize = [[contentView image] size];
+    mp.y *= (imageSize.height / std::max(viewSize.height, (CGFloat)1.));
+    mp.x *= (imageSize.width / std::max(viewSize.width, (CGFloat)1.));
+
+    if( [event type] == NSScrollWheel ) {
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 1070
+        if( [event respondsToSelector:@selector(hasPreciseScrollingDeltas)] && [event hasPreciseScrollingDeltas] ) {
+            mp.x = int([event scrollingDeltaX]);
+            mp.y = int([event scrollingDeltaY]);
+        } else
+#endif
+        {
+            mp.x = int([event deltaX] * 10.0);
+            mp.y = int([event deltaY] * 10.0);
         }
         if( mp.x && !mp.y && cv::EVENT_MOUSEWHEEL == type ) {
             type = cv::EVENT_MOUSEHWHEEL;
         }
         mouseCallback(type, mp.x, mp.y, flags, mouseParam);
     } else if( mp.x >= 0 && mp.y >= 0 && mp.x < imageSize.width && mp.y < imageSize.height ) {
-        mouseCallback(type, mp.x, mp.y, flags, mouseParam);
+         mouseCallback(type, mp.x, mp.y, flags, mouseParam);
     }
 }
 
@@ -876,7 +914,7 @@ static NSSize constrainAspectRatio(NSSize base, NSSize constraint) {
     if([event modifierFlags] & NSControlKeyMask)	flags |= cv::EVENT_FLAG_CTRLKEY;
     if([event modifierFlags] & NSAlternateKeyMask)	flags |= cv::EVENT_FLAG_ALTKEY;
 
-    //modified code using ternary operator:
+    // Modified code using ternary operator:
     if ([event type] == NSLeftMouseDown) {
     [self cvSendMouseEvent:event
                       type:([event modifierFlags] & NSControlKeyMask) ? cv::EVENT_RBUTTONDOWN : cv::EVENT_LBUTTONDOWN
@@ -897,7 +935,7 @@ static NSSize constrainAspectRatio(NSSize base, NSSize constraint) {
     if([event type] == NSLeftMouseDragged) {[self cvSendMouseEvent:event type:cv::EVENT_MOUSEMOVE   flags:flags | cv::EVENT_FLAG_LBUTTON];}
     if([event type] == NSRightMouseDragged)	{[self cvSendMouseEvent:event type:cv::EVENT_MOUSEMOVE   flags:flags | cv::EVENT_FLAG_RBUTTON];}
     if([event type] == NSOtherMouseDragged)	{[self cvSendMouseEvent:event type:cv::EVENT_MOUSEMOVE   flags:flags | cv::EVENT_FLAG_MBUTTON];}
-    if([event type] == NSEventTypeScrollWheel) {[self cvSendMouseEvent:event type:cv::EVENT_MOUSEWHEEL   flags:flags ];}
+    if([event type] == NSScrollWheel) {[self cvSendMouseEvent:event type:cv::EVENT_MOUSEWHEEL    flags:flags ];}
 }
 
 -(void)scrollWheel:(NSEvent *)theEvent {
@@ -953,7 +991,7 @@ static NSSize constrainAspectRatio(NSSize base, NSSize constraint) {
     // Create slider
     CVSlider *slider = [[CVSlider alloc] init];
     [[slider name] setStringValue:cvname];
-    slider.initialName = [NSString stringWithFormat:@"%s", name];
+    [slider setInitialName:[NSString stringWithFormat:@"%s", name]];
     [[slider slider] setMaxValue:max];
     [[slider slider] setMinValue:0];
     if(value)
@@ -972,20 +1010,20 @@ static NSSize constrainAspectRatio(NSSize base, NSSize constraint) {
     [slidersKeys addObject:cvname];
     [[self contentView] addSubview:slider];
 
-    //update contentView size to contain sliders
+    // Update contentView size to contain sliders
     NSSize viewSize=[[self contentView] frame].size,
            sliderSize=[slider frame].size;
     viewSize.height += sliderSize.height;
     viewSize.width = std::max<int>(viewSize.width, MIN_SLIDER_WIDTH);
 
     // Update slider sizes
-    [self contentView].sliderHeight += sliderSize.height;
+    [[self contentView] setSliderHeight:[[self contentView] sliderHeight] + sliderSize.height];
 
     if ([[self contentView] image] && ![[self contentView] imageView]) {
         [[self contentView] setNeedsDisplay:YES];
     }
 
-    //update window size to contain sliders
+    // Update window size to contain sliders
     [self setContentSize: viewSize];
 }
 
@@ -997,7 +1035,9 @@ static NSSize constrainAspectRatio(NSSize base, NSSize constraint) {
 
 @implementation CVView
 
+@synthesize imageView;
 @synthesize image;
+@synthesize sliderHeight;
 
 - (id)init {
     [super init];
@@ -1006,7 +1046,7 @@ static NSSize constrainAspectRatio(NSSize base, NSSize constraint) {
 
 - (void)setImageData:(CvArr *)arr {
     cv::Mat arrMat = cv::cvarrToMat(arr);
-    @autoreleasepool{
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
         NSBitmapImageRep *bitmap = [[NSBitmapImageRep alloc] initWithBitmapDataPlanes:NULL
                     pixelsWide:arrMat.cols
                     pixelsHigh:arrMat.rows
@@ -1068,7 +1108,7 @@ static NSSize constrainAspectRatio(NSSize base, NSSize constraint) {
             redisplayRect.size.height -= [self sliderHeight];
             [self setNeedsDisplayInRect:redisplayRect];
         }
-    }
+    [pool drain];
 }
 
 - (void)setFrameSize:(NSSize)size {
@@ -1076,19 +1116,21 @@ static NSSize constrainAspectRatio(NSSize base, NSSize constraint) {
 
     int height = size.height;
 
-    @autoreleasepool{
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
         CVWindow *cvwindow = (CVWindow *)[self window];
         if ([cvwindow respondsToSelector:@selector(sliders)]) {
-            for(NSString *key in [cvwindow slidersKeys]) {
+            NSEnumerator *enumerator = [[cvwindow slidersKeys] objectEnumerator];
+            NSString *key;
+            while((key = [enumerator nextObject])) {
                 CVSlider *slider = [[cvwindow sliders] valueForKey:key];
                 NSRect r = [slider frame];
                 r.origin.y = height - r.size.height;
                 r.size.width = [[cvwindow contentView] frame].size.width;
 
-                CGRect sliderRect = slider.slider.frame;
+                NSRect sliderRect = [[slider slider] frame];
                 CGFloat targetWidth = r.size.width - (sliderRect.origin.x + 10);
                 sliderRect.size.width = targetWidth < 0 ? 0 : targetWidth;
-                slider.slider.frame = sliderRect;
+                [[slider slider] setFrame:sliderRect];
 
                 [slider setFrame:r];
                 height -= r.size.height;
@@ -1105,21 +1147,21 @@ static NSSize constrainAspectRatio(NSSize base, NSSize constraint) {
             NSRect constrainedFrame = { imageViewFrame.origin, constrainAspectRatio(imageViewFrame.size, [image size]) };
             [[self imageView] setFrame:constrainedFrame];
         }
-    }
+    [pool drain];
 }
 
 - (void)drawRect:(NSRect)rect {
     [super drawRect:rect];
     // If imageView exists, all drawing will be done by it and nothing needs to happen here
     if ([self image] && ![self imageView]) {
-        @autoreleasepool{
+        NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
             if(image != nil) {
                 [image drawInRect: [self frame]
                         fromRect: NSZeroRect
                         operation: NSCompositeSourceOver
                         fraction: 1.0];
             }
-        }
+        [pool drain];
     }
 }
 
