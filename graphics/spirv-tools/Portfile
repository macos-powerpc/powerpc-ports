# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           conflicts_build 1.0
PortGroup           github 1.0
PortGroup           legacysupport 1.1

github.setup        KhronosGroup SPIRV-Tools 2025.5 v
name                spirv-tools
revision            0

categories          graphics
license             Apache-2
maintainers         {judaew @judaew} openmaintainer

description         Various SPIR-V tools
long_description    SPIR-V assembler, binary module parser, \
                    disassembler, validator and optimizer
homepage            https://vulkan.lunarg.com

# move extracted main module to worksrcpath
# Move submodules to cmakes expected location in worksrcpath
post-extract {
    foreach {sub_author sub_project sub_commit sub_dest} ${submodules} {
        move ${workpath}/${sub_project}-${sub_commit} ${worksrcpath}/${sub_dest}
    }
}

github.tarball_from archive

checksums           SPIRV-Tools-${version}.tar.gz \
                    rmd160  9ca6e8972d1ab90cfb09aa2de98b63275a2038f4 \
                    sha256  23769a70967e91f16f1bf8a58665b643fc4e765d734e85c51faa7d990f01a64f \
                    size    3422476 \
                    SPIRV-Headers-b824a462d4256d720bebb40e78b9eb8f78bbb305.tar.gz \
                    rmd160  3a4ae286af7a471cffa157b99289304b7f2a583e \
                    sha256  c693867f10a7760ef1bcf85419d51783586768cc2c601d03841bc6a8b2554b9c \
                    size    558965 \
                    mimalloc-09a27098aa6e9286518bd9c74e6ffa7199c3f04e.tar.gz \
                    rmd160  18c97c131687fa39a3eca05f6493093ee5e8eabf \
                    sha256  eae25b79e4a8ec7dc00807cbda895bb2a3fb66d0e29b2433b6239018f85419f5 \
                    size    1295238

compiler.cxx_standard 2017
# Need to use MacPorts libc++ on macOS 10.14 Mojave and older, because
# Apple Clang only added support for the C++17 <filesystem> library
# starting in Xcode 11 (clang-1100) for macOS 10.15+.
# References:
# * https://stackoverflow.com/a/55353263
# * https://developer.apple.com/documentation/xcode-release-notes/xcode-11-release-notes
legacysupport.newest_darwin_requires_legacy 18
legacysupport.use_mp_libcxx yes

set py_ver          3.13
set py_ver_nodot    [string map {. {}} ${py_ver}]
foreach stage {configure build destroot test} {
    ${stage}.env-append PATH=${frameworks_dir}/Python.framework/Versions/${py_ver}/bin:$env(PATH)
}
depends_build-append port:python${py_ver_nodot}

# See DEPS file in repo
# Exept abseil changed to lts version.
set submodules {
    KhronosGroup SPIRV-Headers b824a462d4256d720bebb40e78b9eb8f78bbb305 external/spirv-headers
    microsoft mimalloc 09a27098aa6e9286518bd9c74e6ffa7199c3f04e external/mimalloc
}

foreach {sub_author sub_project sub_commit sub_dest} ${submodules} {
    master_sites-append https://github.com/${sub_author}/${sub_project}/archive/${sub_commit}.tar.gz?dummy=:${sub_project}
    distfiles-append    ${sub_project}-${sub_commit}.tar.gz:${sub_project}
}

configure.args-append \
                    -DBUILD_SHARED_LIBS=ON \
                    -DCMAKE_INSTALL_PREFIX=${prefix} \
                    -DSPIRV_SKIP_TESTS=ON \
                    -DSPIRV_TOOLS_BUILD_STATIC=OFF \
                    -DSPIRV_TOOLS_USE_MIMALLOC=ON \
                    -DSPIRV_WERROR=OFF
