From d6cc82958cc2d63642bd26f64b10652da49083ef Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Mon, 1 Dec 2025 15:11:20 +0800
Subject: [PATCH 5/5] mimetypes fixes

---
 build/cmake/files.cmake   |  5 +++--
 include/wx/gtk/mimetype.h | 10 ++++++----
 src/gtk/mimetype.cpp      |  4 ++--
 3 files changed, 11 insertions(+), 8 deletions(-)

diff --git a/build/cmake/files.cmake b/build/cmake/files.cmake
index 4ca5db08fc..425f15617b 100644
--- a/build/cmake/files.cmake
+++ b/build/cmake/files.cmake
@@ -34,7 +34,6 @@ set(BASE_UNIX_AND_DARWIN_HDR
 
 set(BASE_UNIX_AND_DARWIN_NOTWXMAC_SRC
     ${BASE_UNIX_AND_DARWIN_SRC}
-    src/unix/mimetype.cpp
     src/unix/uilocale.cpp
 )
 
@@ -46,6 +45,7 @@ set(BASE_UNIX_AND_DARWIN_NOTWXMAC_HDR
 set(BASE_UNIX_SRC
     ${BASE_UNIX_AND_DARWIN_NOTWXMAC_SRC}
     src/unix/fswatcher_inotify.cpp
+    src/unix/mimetype.cpp
     src/unix/secretstore.cpp
     src/unix/stdpaths.cpp
 )
@@ -53,6 +53,7 @@ set(BASE_UNIX_SRC
 set(BASE_UNIX_HDR
     ${BASE_UNIX_AND_DARWIN_NOTWXMAC_HDR}
     wx/unix/fswatcher_inotify.h
+    wx/unix/mimetype.h
     wx/unix/stdpaths.h
 )
 
@@ -113,6 +114,7 @@ set(BASE_WIN32_HDR
 set(BASE_COREFOUNDATION_SRC
     src/osx/core/cfstring.cpp
     src/osx/core/evtloop_cf.cpp
+    src/osx/core/mimetype.cpp
     src/osx/core/secretstore.cpp
     src/osx/core/strconv_cf.cpp
     src/osx/cocoa/utils_base.mm
@@ -140,7 +142,6 @@ set(BASE_COREFOUNDATION_HDR
 )
 
 set(BASE_OSX_SHARED_SRC
-    src/osx/core/mimetype.cpp
     src/osx/fswatcher_fsevents.cpp
     ${BASE_COREFOUNDATION_SRC}
     ${BASE_UNIX_AND_DARWIN_SRC}
diff --git a/include/wx/gtk/mimetype.h b/include/wx/gtk/mimetype.h
index ed645c6de3..e33143a7e1 100644
--- a/include/wx/gtk/mimetype.h
+++ b/include/wx/gtk/mimetype.h
@@ -12,10 +12,12 @@
 
 #include "wx/defs.h"
 
-#if defined(__UNIX__)
-#include "wx/unix/mimetype.h"
+#if defined(__DARWIN__)
+    #include "wx/osx/mimetype.h"
+#elif defined(__UNIX__)
+    #include "wx/unix/mimetype.h"
 #elif defined(__WINDOWS__)
-#include "wx/msw/mimetype.h"
+    #include "wx/msw/mimetype.h"
 #endif
 
 #if wxUSE_MIMETYPE
@@ -23,7 +25,7 @@
 class WXDLLIMPEXP_CORE wxGTKMimeTypesManagerImpl : public wxMimeTypesManagerImpl
 {
 protected:
-#if defined(__UNIX__)
+#if defined(__UNIX__) && !defined(__DARWIN__)
     wxString GetIconFromMimeType(const wxString& mime) wxOVERRIDE;
 #endif
 };
diff --git a/src/gtk/mimetype.cpp b/src/gtk/mimetype.cpp
index 99f5aa19a0..d203e672f4 100644
--- a/src/gtk/mimetype.cpp
+++ b/src/gtk/mimetype.cpp
@@ -18,7 +18,7 @@
 #include "wx/gtk/private/string.h"
 #include "wx/gtk/private/object.h"
 
-#if defined(__UNIX__)
+#if defined(__UNIX__) && !defined(__DARWIN__)
 wxString wxGTKMimeTypesManagerImpl::GetIconFromMimeType(const wxString& mime)
 {
     wxString icon;
@@ -57,7 +57,7 @@ wxString wxGTKMimeTypesManagerImpl::GetIconFromMimeType(const wxString& mime)
 #endif // GTK_CHECK_VERSION(2,14,0)
     return icon;
 }
-#endif // defined(__UNIX__)
+#endif // defined(__UNIX__) && !defined(__DARWIN__)
 
 wxMimeTypesManagerImpl *wxGTKMimeTypesManagerFactory::CreateMimeTypesManagerImpl()
 {

diff --git a/src/osx/core/mimetype.cpp b/src/osx/core/mimetype.cpp
index 9f878b0ab3..d4801d1618 100644
--- a/src/osx/core/mimetype.cpp
+++ b/src/osx/core/mimetype.cpp
@@ -427,7 +427,17 @@ void wxMimeTypesManagerImpl::LoadDisplayDataForUti(const wxString& uti)
     wxCFStringRef ext = UTTypeCopyPreferredTagWithClass( cfuti, kUTTagClassFilenameExtension );
 
     // Look up the preferred application
-    wxCFRef<CFURLRef> appUrl = LSCopyDefaultApplicationURLForContentType( cfuti, kLSRolesAll, NULL);
+    wxCFRef<CFURLRef> appUrl;
+#if MAC_OS_X_VERSION_MIN_REQUIRED < 101000
+    CFURLRef aurl;
+    // THIS FUNCTION, DESPITE ITS NAME, RETAINS THE URL REFERENCE ON BEHALF OF THE CALLER.
+    OSStatus status = LSGetApplicationForInfo( kLSUnknownType, kLSUnknownCreator, ext, kLSRolesAll, nullptr, &aurl );
+    if( status != noErr )
+        return;
+    appUrl.reset(aurl);
+#else
+    appUrl.reset(LSCopyDefaultApplicationURLForContentType( cfuti, kLSRolesAll, nullptr));
+#endif
 
     if( !appUrl )
         return;
