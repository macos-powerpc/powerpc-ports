# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           codeberg 1.0
PortGroup           meson 1.0

name                komikku
codeberg.setup      valos Komikku 1.89.0 v
revision            1
categories          gnome graphics
license             GPL-3+
maintainers         {@barracuda156 macos-powerpc.org:barracuda} openmaintainer

description         Manga reader for GNOME
long_description    {*}${description}. Experimental at the moment, use at your own risk.
checksums           rmd160  020e14c895410fb2a7abf4496b3c3815bc379f9d \
                    sha256  8add4846dfebf49aa7d7d5214470f2efd3859acc319c0ab0d468b6b3c1dafadb \
                    size    4619595

meson.wrap_mode     nodownload

set py_ver          3.12
set py_ver_nodot    [string map {. {}} ${py_ver}]

configure.python    ${prefix}/bin/python${py_ver}

patch.pre_args-replace  -p0 -p1

patchfiles-append   0001-Revert-to-non-rusty-colorthief.patch \
                    0002-meson.build-fix-finding-python-and-other-deps.patch \
                    0003-Really-not-glycin.patch \
                    0004-Restore-support-for-libadwaita-1.7.patch \
                    0005-debug_info-no-webkit.patch

# https://codeberg.org/valos/Komikku/issues/847
# Generated by the script from https://codeberg.org/valos/Komikku/commit/6d1d71d955462e1c2883577375a2d71d1aa6771c
patchfiles-append   0006-Do-not-require-WebKit.patch

post-patch {
    reinplace "s|@PYTHON@|${configure.python}|" ${worksrcpath}/meson.build
}

depends_build-append \
                    port:appstream-glib \
                    port:blueprint-compiler \
                    path:bin/pkg-config:pkgconfig

depends_lib-append  path:lib/pkgconfig/cairo.pc:cairo \
                    path:lib/pkgconfig/gdk-pixbuf-2.0.pc:gdk-pixbuf2 \
                    path:lib/pkgconfig/glib-2.0.pc:glib2 \
                    path:lib/pkgconfig/gobject-introspection-1.0.pc:gobject-introspection \
                    port:graphene \
                    path:lib/pkgconfig/gtk4.pc:gtk4 \
                    port:libadwaita \
                    port:libnotify \
                    path:lib/pkgconfig/libsoup-3.0.pc:libsoup \
                    path:lib/pkgconfig/pango.pc:pango \
                    port:py${py_ver_nodot}-beautifulsoup4 \
                    port:py${py_ver_nodot}-brotli \
                    port:py${py_ver_nodot}-colorthief \
                    port:py${py_ver_nodot}-cryptography \
                    port:py${py_ver_nodot}-dateparser \
                    port:py${py_ver_nodot}-emoji \
                    port:py${py_ver_nodot}-gobject3 \
                    port:py${py_ver_nodot}-keyring \
                    port:py${py_ver_nodot}-lxml \
                    port:py${py_ver_nodot}-magic \
                    port:py${py_ver_nodot}-natsort \
                    port:py${py_ver_nodot}-piexif \
                    port:py${py_ver_nodot}-Pillow \
                    port:py${py_ver_nodot}-pypdf \
                    port:py${py_ver_nodot}-rarfile \
                    port:py${py_ver_nodot}-regex \
                    port:py${py_ver_nodot}-requests \
                    port:py${py_ver_nodot}-tzlocal \
                    port:py${py_ver_nodot}-unidecode \
                    port:py${py_ver_nodot}-urllib3

depends_run-append  port:desktop-file-utils \
                    port:gsettings-desktop-schemas \
                    port:hicolor-icon-theme \
                    port:webp-pixbuf-loader

configure.args-append \
                    -Dprofile=default

post-activate {
    system "${prefix}/bin/update-desktop-database ${prefix}/share/applications"
    system "${prefix}/bin/gtk4-update-icon-cache -f -t ${prefix}/share/icons/hicolor"
    system "${prefix}/bin/glib-compile-schemas ${prefix}/share/glib-2.0/schemas"
}

# GTK4 is broken by design, and its upstream sees no problem in that.
# This is not powerpc-specific and affects x86_64 and arm64 as well.
# https://trac.macports.org/ticket/70137
notes "
As a workaround for a bug in GTK4, please export GSK_RENDERER=cairo to the environment,\
otherwise GUI may crash on launch.
"
