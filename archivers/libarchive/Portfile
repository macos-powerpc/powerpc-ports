# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem      1.0
PortGroup       clang_dependency 1.0
PortGroup       github 1.0
PortGroup       legacysupport 1.1
PortGroup       muniversal 1.0

# _getline
legacysupport.newest_darwin_requires_legacy 10

github.setup    libarchive libarchive 3.8.4 v
revision        0
categories      archivers
license         BSD
maintainers     {toby @tobypeterson} openmaintainer
description     Functions for reading and writing streaming archives
long_description \
    Libarchive is a programming library that can create and \
    read several different streaming archive formats, including \
    most popular tar variants, several cpio formats, 7zip and rar. \
    It can also write shar archives.
homepage        https://libarchive.org
use_xz          yes
checksums       rmd160  f55a810a05fe20818078e6ad2f8f5cc3a6953cbc \
                sha256  c7b847b57feacf5e182f4d14dd6cae545ac6843d55cb725f58e107cdf1c9ad73 \
                size    6065584
github.tarball_from releases

# To build with Xcode gcc, without requiring C++11 in rdeps, drop libxml2:
depends_lib-append \
                port:bzip2 \
                port:libb2 \
                port:libiconv \
                port:libxml2 \
                port:lz4 \
                port:lzo2 \
                port:xz \
                port:zlib \
                port:zstd

patchfiles      fix_pc_file.patch

platform darwin 8 {
    patchfiles-append   patch-libarchive-3.5-fix-tests-tiger.diff
}

depends_build   path:bin/pkg-config:pkgconfig

configure.args  --disable-silent-rules \
                --enable-bsdcpio=shared \
                --enable-bsdtar=shared \
                --with-lzo2 \
                --with-zstd \
                --without-nettle \
                --without-openssl

configure.checks.implicit_function_declaration.whitelist-append strchr

post-destroot {
    xinstall -d ${destroot}${prefix}/libexec/${subport}
    foreach program [glob -tails -directory ${destroot}${prefix}/bin *] {
        ln -s ${prefix}/bin/${program} ${destroot}${prefix}/libexec/${subport}
    }
}

test.run        yes
test.target     check
