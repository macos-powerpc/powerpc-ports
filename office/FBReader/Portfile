# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           legacysupport 1.1
PortGroup           qt4 1.0

name                FBReader
github.setup        geometer FBReader 0.99.5
revision            2
github.tarball_from archive
categories          office
description         A lightweight ebook reader.
long_description    ${description}

checksums           rmd160  d05e33eb45b8aa700ec66da94bd7d0121f38a5c4 \
                    sha256  0d0be59ffae2c617ca29021e458d74e3160467b90a848fa655cc5939a819e51c \
                    size    25498653

depends_build-append \
                    port:ccache

depends_lib         port:curl \
                    port:expat \
                    port:fribidi \
                    port:libunibreak \
                    port:libzip \
                    port:sqlite3

patchfiles-append   target-mk.patch

platform darwin 8 {
    depends_build-append port:gmake
    build.cmd ${prefix}/bin/gmake
    
    patchfiles-append   iconv.patch
}

configure {}

build.env-append qt_dir=${qt_dir} \
                 FBREADERQTLIB_FLAGS=${qt_dir}/lib \
                 FBREADERQTFRAME_FLAGS=${qt_dir}/Library/Frameworks/QtCore.framework/Versions/4 \
                 FBREADERIQT_FLAGS=${qt_dir}/include \
                 FBREADERIQTCORE_FLAGS=${qt_dir}/include/QtCore \
                 FBREADERIQTGUI_FLAGS=${qt_dir}/include/QtGui \
                 FBREADERIQTNETWORK_FLAGS=${qt_dir}/include/QtNetwork \
                 FBREADERQTINCLUDE_FLAGS=${qt_dir}/include \
                 FBREADERFFREAMEWORKS_FLAGS=${qt_dir}/Library/Frameworks \
                 FBREADERFINCLUDE_FLAGS=${qt_dir}/include \
                 FBREADERFLIB_FLAGS=${qt_dir}/lib \
                 INSTALLDIR=${applications_dir}/FBReader.app \
                 ARCH_FLAGS= "-arch ${os.arch} -mmacosx-version-min={macosx_deployment_target}"
build.cmd-prepend ccache
build.cmd-append  --environment-overrides

destroot.env-append qt_dir=${qt_dir} \
                 DESTDIR = ${destroot} \
                 FBREADERQTLIB_FLAGS=${qt_dir}/lib \
                 FBREADERQTFRAME_FLAGS=${qt_dir}/Library/Frameworks/QtCore.framework/Versions/4 \
                 FBREADERIQT_FLAGS=${qt_dir}/include \
                 FBREADERIQTCORE_FLAGS=${qt_dir}/include/QtCore \
                 FBREADERIQTGUI_FLAGS=${qt_dir}/include/QtGui \
                 FBREADERIQTNETWORK_FLAGS=${qt_dir}/include/QtNetwork \
                 FBREADERQTINCLUDE_FLAGS=${qt_dir}/include \
                 FBREADERFFREAMEWORKS_FLAGS=${qt_dir}/Library/Frameworks \
                 FBREADERFINCLUDE_FLAGS=${qt_dir}/include \
                 FBREADERFLIB_FLAGS=${qt_dir}/lib \
                 INSTALLDIR=${applications_dir}/FBReader.app \
                 ARCH_FLAGS= "-arch ${os.arch} -mmacosx-version-min={macosx_deployment_target}"

post-destroot {
set fbreader "${destroot}${applications_dir}/FBReader.app/Contents/MacOS/FBReader"
file mkdir ${destroot}${applications_dir}/FBReader.app/Contents/Frameworks
foreach dep [exec otool -L ${fbreader} | grep libgcc] {
    if [string match -nocase "*/libgcc*.dylib" {dep}] {
        ui_info "Copy libgcc files over from ${dep} to {worksrcpath}/Contents/Frameworks"
        file copy ${dep} ${destroot}/Applications/Contents/Frameworks
    }
}
system "install_name_tool -change ${prefix}/lib/libgcc/libstdc++.6.dylib \
    @executable_path/../Frameworks/libstdc++.6.dylib ${fbreader}"
system "install_name_tool -change ${prefix}/lib/libgcc/libgcc_s.1.1.dylib \
    @executable_path/../Frameworks/libgcc_s.1.1.dylib ${fbreader}"
system "cd ../../../../../../../../../../.. \
${qt_dir}/bin/macdeployqt ${destroot}${applications_dir}/FBReader.app"
}

post-activate {
system "install_name_tool -change @executable_path/../Frameworks/libgcc_s.1.1.dylib ${prefix}/lib/libgcc/libgcc_s.1.1.dylib ${applications_dir}/FBReader.app/Contents/MacOS/FBReader"
system "install_name_tool -change @executable_path/../Frameworks/libstdc++.6.dylib ${prefix}/lib/libgcc/libstdc++.6.dylib ${applications_dir}/FBReader.app/Contents/MacOS/FBReader"
}