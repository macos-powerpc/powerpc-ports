# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           legacysupport 1.1
PortGroup           qt4 1.0
PortGroup           qmake 1.0

name                FBReader
github.setup        geometer FBReader 0.99.5
github.tarball_from tarball
categories          office
description         A lightweight ebook reader.
long_description    ${description}

checksums           rmd160  d05e33eb45b8aa700ec66da94bd7d0121f38a5c4 \
                    sha256  0d0be59ffae2c617ca29021e458d74e3160467b90a848fa655cc5939a819e51c \
                    size    25498653

depends_build-append \
                    port:ccache \
                    port:gmake

depends_lib         port:curl \
                    port:expat \
                    port:fribidi \
                    port:libunibreak \
                    port:libzip \
                    port:qt4-mac \
                    port:sqlite3

patchfiles-append   target-mk.patch

platform darwin 8 {
patchfiles-append   iconv.patch
}

configure {}

build.env-append prefix=${prefix} \
                 FBREADERQTLIB_FLAGS=${prefix}/libexec/qt4/lib \
                 FBREADERQTFRAME_FLAGS=${prefix}/libexec/qt4/Library/Frameworks/QtCore.framework/Versions/4 \
                 FBREADERIQT_FLAGS=${prefix}/libexec/qt4/include \
                 FBREADERIQTCORE_FLAGS=${prefix}/libexec/qt4/include/QtCore \
                 FBREADERIQTGUI_FLAGS=${prefix}/libexec/qt4/include/QtGui \
                 FBREADERIQTNETWORK_FLAGS=${prefix}/libexec/qt4/include/QtNetwork \
                 FBREADERQTINCLUDE_FLAGS=${prefix}/libexec/qt4/include \
                 FBREADERFFREAMEWORKS_FLAGS=${prefix}/libexec/qt4/Library/Frameworks \
                 FBREADERFINCLUDE_FLAGS=${prefix}/libexec/qt4/include \
                 FBREADERFLIB_FLAGS=${prefix}/libexec/qt4/lib
build.cmd ccache ${prefix}/bin/gmake --environment-overrides

destroot.env-append prefix=${prefix} \
                 DESTDIR = ${prefix}/var/macports/build/_Users_powerpc-ports_office_FBReader/FBReader/work/destroot \
                 FBREADERQTLIB_FLAGS=${prefix}/libexec/qt4/lib \
                 FBREADERQTFRAME_FLAGS=${prefix}/libexec/qt4/Library/Frameworks/QtCore.framework/Versions/4 \
                 FBREADERIQT_FLAGS=${prefix}/libexec/qt4/include \
                 FBREADERIQTCORE_FLAGS=${prefix}/libexec/qt4/include/QtCore \
                 FBREADERIQTGUI_FLAGS=${prefix}/libexec/qt4/include/QtGui \
                 FBREADERIQTNETWORK_FLAGS=${prefix}/libexec/qt4/include/QtNetwork \
                 FBREADERQTINCLUDE_FLAGS=${prefix}/libexec/qt4/include \
                 FBREADERFFREAMEWORKS_FLAGS=${prefix}/libexec/qt4/Library/Frameworks \
                 FBREADERFINCLUDE_FLAGS=${prefix}/libexec/qt4/include \
                 FBREADERFLIB_FLAGS=${prefix}/libexec/qt4/lib

post-destroot {
set fbreader "${workpath}/destroot/Applications/Macports/FBReader.app/Contents/MacOS/FBReader"
file mkdir ${workpath}/destroot/Applications/Macports/FBReader.app/Contents/Frameworks
foreach dep [exec otool -L ${fbreader} | grep libgcc] {
    if [string match -nocase "*/libgcc*.dylib" {dep}] {
        ui_info "Copy libgcc files over from ${dep} to {worksrcpath}/Contents/Frameworks"
        file copy ${dep} ${workpath}/destroot/Applications/Contents/Frameworks
    }
}
system "install_name_tool -change ${prefix}/lib/libgcc/libstdc++.6.dylib \
    @executable_path/../Frameworks/libstdc++.6.dylib ${fbreader}"
system "install_name_tool -change ${prefix}/lib/libgcc/libgcc_s.1.1.dylib \
    @executable_path/../Frameworks/libgcc_s.1.1.dylib ${fbreader}"
system "cd ../../../../../../../../../../.. \
sudo ${prefix}/libexec/qt4/bin/macdeployqt ${prefix}/var/macports/build/_Users_powerpc-ports_office_FBReader/FBReader/work/destroot/Applications/Macports/FBReader.app"
}

post-activate {
system "sudo install_name_tool -change @executable_path/../Frameworks/libgcc_s.1.1.dylib ${prefix}/lib/libgcc/libgcc_s.1.1.dylib /Applications/Macports/FBReader.app/Contents/MacOS/FBReader"
system "sudo install_name_tool -change @executable_path/../Frameworks/libstdc++.6.dylib ${prefix}/lib/libgcc/libstdc++.6.dylib /Applications/Macports/FBReader.app/Contents/MacOS/FBReader"
}