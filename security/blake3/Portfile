# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake   1.1
PortGroup           github  1.0

github.setup        BLAKE3-team BLAKE3 1.8.3
name                blake3
revision            0
categories          security
license             Apache-2
maintainers         {@barracuda156 macos-powerpc.org:barracuda} openmaintainer
description         ${name} is a cryptographic hash function
long_description    {*}${description} that is much faster \
                    than MD5, SHA-1, SHA-2, SHA-3 and BLAKE2, \
                    secure, unlike MD5 and SHA-1, secure against \
                    length extension, unlike SHA-2, highly parallelizable \
                    and capable of verified streaming and incremental updates.
checksums           rmd160  5bf065ef7524f625333d5616df737ad72877e381 \
                    sha256  5a11e3f834719b6c1cae7aced1e848a37013f6f10f97272e7849aa0da769f295 \
                    size    266132
github.tarball_from archive

worksrcdir              ${worksrcpath}/c

compiler.c_standard     1999
compiler.cxx_standard   2020

depends_build-append    path:bin/pkg-config:pkgconfig

configure.args-append   -DBLAKE3_USE_TBB=OFF \
                        -DBUILD_SHARED_LIBS=ON

variant tbb description "Use TBB" {
    depends_lib-append  port:onetbb

    configure.args-replace \
                        -DBLAKE3_USE_TBB=OFF \
                        -DBLAKE3_USE_TBB=ON

    # Undefined symbols for architecture ppc: "___atomic_fetch_add_8"
    if {[string match *gcc* ${configure.compiler}] && ${configure.build_arch} in [list arm i386 ppc]} {
        configure.ldflags-append \
                        -latomic
    }
}
