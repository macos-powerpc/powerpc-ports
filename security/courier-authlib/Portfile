# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0

name                    courier-authlib
# Recent versions are broken: https://github.com/svarshavchik/courier/issues/71
version                 0.72.3
revision                0
categories              security mail
license                 GPL-3
maintainers             nomaintainer
description             Courier Authentication Library is a generic authentication API
long_description        {*}${description}

homepage                https://www.courier-mta.org/authlib/
master_sites            sourceforge:project/courier/authlib/${version}
use_bzip2               yes
checksums               rmd160  0529e92ea14c160bcdb0bf31922288a2b22d3d50 \
                        sha256  411b8a3c9b145eba0bdf87b9942a5413ad22646144781046f6c46b17406b050a \
                        size    2289793

depends_build-append    port:gmake \
                        path:bin/pkg-config:pkgconfig

set bdb_v               48

depends_lib-append      port:db${bdb_v} \
                        port:libidn2 \
                        port:libtool \
                        port:courier-unicode

configure.args          --with-db=db \
                        --without-authmysql \
                        --without-authpgsql \
                        --without-authldap \
                        --without-authpam \
                        -C

configure.env-append    MAKE="gmake"
configure.args-append   MAKE="gmake"

configure.cflags-append -I${prefix}/include/db${bdb_v}
configure.ldflags-append \
                        -L${prefix}/lib/db${bdb_v}

compiler.cxx_standard   2017
configure.cxxflags-append \
                        -std=gnu++17

build.cmd               ${prefix}/bin/gmake

post-extract {
    foreach _file {install-sh config.guess config.sub} {
        reinplace -E {s|#!/usr/bin/sh|#!/usr/bin/env sh|} ${_file}
    }
}

patchfiles-append       patch-remove-dtag-configure.diff

post-destroot {
    system -W "${destroot}${prefix}/lib/courier-authlib" "rm -f *.a *.la"
}

startupitem.create      yes
startupitem.start       "${prefix}/sbin/authdaemond start"
startupitem.stop        "${prefix}/sbin/authdaemond stop"
startupitem.restart     "${prefix}/sbin/authdaemond restart"
startupitem.pidfile     clean ${prefix}/var/spool/authdaemon/pid

# Limit the length of the minor and patch version components to avoid picking
# up development versions (that contain a YYYYMMDD timestamp).
livecheck.regex         "[quotemeta ${name}]-(\\d+(\\.\\d{1,7})*)[quotemeta ${extract.suffix}]"
