# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               active_variants 1.1
PortGroup               fuse 1.0
PortGroup               github 1.0
PortGroup               xcode 1.0

name                    macfusion2

# TODO: https://github.com/macfusion-ng/macfusion2/issues/51
if {${os.platform} eq "darwin" && ${os.major} < 11} {
    github.setup        mgorbach macfusion2 2.0.4 Macfusion
    revision            0
    checksums           sha256  845dd7f2fcfcae072eca4b238b29b7f89964762242783337810167f8d1e9a11b \
                        rmd160  9c4d9543414e9d0b310baa2ba8b0fdbeb1887ec4 \
                        size    4375834

    require_active_variants osxfuse universal
} else {
#    github.setup        macfusion-ng macfusion2 2.1.1 {} -dev.3
    github.setup        macfusion-ng macfusion2 6362735b6390ae3aa185d88f3236b67e0f377bf5
    version             2.1.1
    revision            0
    checksums           sha256  1175baf88bc6cd4c5d0751187d70bef17377dfcd4f73ea1dd440f7a5907afb59 \
                        rmd160  2ef6712807b7fc99000d7ecddde09779d8d173d8 \
                        size    11477475

    xcode.build.settings \
                        CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO
    xcode.destroot.settings \
                        {*}${xcode.build.settings}
}

github.tarball_from     archive

categories              fuse aqua
license                 Apache-2
platforms               macosx
maintainers             {@barracuda156 macos-powerpc.org:barracuda} openmaintainer
homepage                http://macfusionapp.org
description             MacFusion 2
long_description        ${name} brings servers from across the internet directly to your Macâ€™s desktop!

post-patch {
    reinplace "s|/usr/local|${prefix}|g" ${worksrcpath}/MacFusion2.xcodeproj/project.pbxproj
}

xcode.configuration     Release
xcode.target            All

if {[vercmp ${xcodeversion} 10.0] >= 0} {
    build.pre_args      -UseNewBuildSystem=NO
    destroot.pre_args   -UseNewBuildSystem=NO
}

use_parallel_build      no

post-destroot {
    # Fix linking of pre-built binaries:
    if {${os.platform} eq "darwin" && ${os.major} < 11} {
        system "install_name_tool -change /usr/local/lib/libfuse.0.dylib ${prefix}/lib/libosxfuse.dylib ${destroot}${applications_dir}/Macfusion.app/Contents/PlugIns/ftpfs.mfplugin/Contents/Resources/curlftpfs_static_mg"
        system "install_name_tool -change /usr/local/lib/libfuse.0.dylib ${prefix}/lib/libosxfuse.dylib ${destroot}${applications_dir}/Macfusion.app/Contents/PlugIns/sshfs.mfplugin/Contents/Resources/sshfs-static"
    } else {
        # FIXME: https://github.com/macfusion-ng/macfusion2/issues/53
        system "install_name_tool -change /usr/local/lib/libosxfuse.2.dylib ${prefix}/lib/libosxfuse.dylib ${destroot}${applications_dir}/Macfusion.app/Contents/PlugIns/ftpfs.mfplugin/Contents/Resources/curlftpfs-static"
        system "install_name_tool -change /usr/local/lib/libfuse.0.dylib ${prefix}/lib/libfuse.dylib ${destroot}${applications_dir}/Macfusion.app/Contents/PlugIns/ftpfs.mfplugin/Contents/Resources/curlftpfs-static-legacy"
        system "install_name_tool -change /usr/local/lib/libosxfuse.2.dylib ${prefix}/lib/libosxfuse.dylib ${destroot}${applications_dir}/Macfusion.app/Contents/PlugIns/sshfs.mfplugin/Contents/Resources/sshfs-static"
        system "install_name_tool -change /usr/local/lib/libfuse.0.dylib ${prefix}/lib/libfuse.dylib ${destroot}${applications_dir}/Macfusion.app/Contents/PlugIns/sshfs.mfplugin/Contents/Resources/sshfs-static-legacy"
        system "install_name_tool -change /usr/local/lib/libosxfuse_i64.2.dylib ${prefix}/lib/libosxfuse_i64.2.dylib ${destroot}${applications_dir}/Macfusion.app/Contents/PlugIns/sshfs.mfplugin/Contents/Resources/sshfs-static-lions"
    }

    # https://github.com/macfusion-ng/macfusion2/issues/52
    foreach f {ftpfs_askpass ftpfs.mfplugin macfusionAgent.app MacfusionMenuling.app MFCore.framework mfctl new_sshfs_askpass sshfs.mfplugin} {
        delete -f ${destroot}${applications_dir}/${f}
    }
    # Delete broken symlinks:
    delete -f ${destroot}${applications_dir}/Macfusion.app/Contents/PlugIns/ftpfs.mfplugin/ftpfs.mfplugin
    delete -f ${destroot}${applications_dir}/Macfusion.app/Contents/PlugIns/sshfs.mfplugin/sshfs.mfplugin
}
