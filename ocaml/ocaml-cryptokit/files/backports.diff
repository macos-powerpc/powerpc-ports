From 84bc924f755187c4393c6f0c3ba974112eff8865 Mon Sep 17 00:00:00 2001
From: Antonio Nuno Monteiro <anmonteiro@gmail.com>
Date: Mon, 8 Jul 2024 00:33:02 -0700
Subject: [PATCH] Fix dune build (#37)

.c include files must be listed as "extra files".
---
 src/aesni.c  |  2 +-
 src/dune     | 22 +++++++++++++++++++++-
 src/pclmul.c |  2 +-
 3 files changed, 23 insertions(+), 3 deletions(-)

diff --git a/src/aesni.c b/src/aesni.c
index 79e620a..7713859 100644
--- src/aesni.c
+++ src/aesni.c
@@ -301,7 +301,7 @@ EXPORT void aesniDecrypt(const unsigned char * key, int nrounds,
   
 #else
 
-int aesni_available = 0;
+EXPORT int aesni_available = 0;
 
 EXPORT int aesni_check_available(void) { return 0; }
 
diff --git a/src/dune b/src/dune
index b3c8dd5..e9d1948 100644
--- src/dune
+++ src/dune
@@ -26,7 +26,27 @@
          stubs-ghash
          stubs-poly1305
          stubs-siphash
-         stubs-blake3))
+         stubs-blake3)
+  (extra_deps
+    aesni.c
+    arcfour.c
+    blowfish.c
+    d3des.c
+    rijndael-alg-fst.c
+    ripemd160.c
+    sha1.c
+    sha256.c
+    sha512.c
+    keccak.c
+    chacha20.c
+    blake2.c
+    ghash.c
+    pclmul.c
+    poly1305-donna.c
+    siphash.c
+    blake3.c
+    blake3_dispatch.c
+    blake3_portable.c))
   (c_library_flags (:include library_flags.sexp))
   (flags :standard -safe-string -w -7 -w -27 -w -37))
 
diff --git a/src/pclmul.c b/src/pclmul.c
index 07f76e5..0c6de07 100644
--- src/pclmul.c
+++ src/pclmul.c
@@ -102,7 +102,7 @@ EXPORT void pclmul_mult(uint8_t res[16],
 
 #else
 
-int pclmul_available = -1;
+EXPORT int pclmul_available = -1;
 
 EXPORT int pclmul_check_available(void) { return 0; }
 
From 0c037d9fe269fc0d16e78a2169d1959f10888c46 Mon Sep 17 00:00:00 2001
From: Xavier Leroy <xavier.leroy@college-de-france.fr>
Date: Mon, 8 Jul 2024 09:47:56 +0200
Subject: [PATCH] Fix initial value of `pclmul_available` when `__PCLMUL__` is
 not defined

Previous value was causing too many calls to `pclmul_check_available`.
---
 src/pclmul.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/pclmul.c b/src/pclmul.c
index 0c6de07..e47cd66 100644
--- src/pclmul.c
+++ src/pclmul.c
@@ -102,7 +102,7 @@ EXPORT void pclmul_mult(uint8_t res[16],
 
 #else
 
-EXPORT int pclmul_available = -1;
+EXPORT int pclmul_available = 0;
 
 EXPORT int pclmul_check_available(void) { return 0; }
 
