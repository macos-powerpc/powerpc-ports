# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           ocaml 1.1

name                ocaml-mirage-crypto
github.setup        mirage mirage-crypto 2.0.2 v
revision            0
categories          ocaml crypto devel
maintainers         {@barracuda156 macos-powerpc.org:barracuda} openmaintainer
license             ISC
description         Simple symmetric cryptography for the modern age
long_description    {*}${description}
use_bzip2           yes
extract.suffix      .tbz
checksums           rmd160  67d89845d9ea2bd7eb5cf20b4290229a320f4dec \
                    sha256  739a9d39f34027fbc93557f87c5cac4190a52bddadff72f212faa803d6215874 \
                    size    2782947
github.tarball_from releases

# https://github.com/mirage/mirage-crypto/pull/269
patchfiles          fix-powerpc.patch

depends_lib-append  port:ocaml-eqaf

ocaml.build_type    dune

subport ${name}-ec {
    description     Elliptic Curve Cryptography with primitives taken from Fiat

    depends_lib-append \
                    port:ocaml-dune-configurator \
                    port:ocaml-mirage-crypto-rng
}

subport ${name}-pk {
    description     Simple public-key cryptography

    depends_build-append \
                    path:bin/pkg-config:pkgconfig

    depends_lib-append \
                    port:gmp \
                    port:ocaml-mirage-crypto \
                    port:ocaml-mirage-crypto-rng \
                    port:ocaml-zarith
}

subport ${name}-rng {
    PortGroup       legacysupport 1.1

    # getentropy
    legacysupport.newest_darwin_requires_legacy 15

    description     Cryptographically secure PRNG

    if {${os.platform} eq "darwin" && ${os.major} < 16} {
        patchfiles-append \
                    fix-rng.patch
        post-patch {
            reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/rng/unix/dune
        }
    }

    depends_lib-append \
                    port:ocaml-dune-configurator \
                    port:ocaml-duration \
                    port:ocaml-logs \
                    port:ocaml-mirage-crypto
}

if {${subport} ne ${name}} {
    depends_lib-append \
                    port:ocaml-digestif
}
