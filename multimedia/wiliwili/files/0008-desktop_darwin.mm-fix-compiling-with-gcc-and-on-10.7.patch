From f375babc97c61dd305029c06f0c4124a08985aa8 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Fri, 3 Oct 2025 19:37:14 +0800
Subject: [PATCH] desktop_darwin.mm: fix compiling with gcc and on < 10.7

---
 .../lib/platforms/desktop/desktop_darwin.mm   | 57 +++++++++++++++++--
 1 file changed, 53 insertions(+), 4 deletions(-)

diff --git library/lib/platforms/desktop/desktop_darwin.mm library/lib/platforms/desktop/desktop_darwin.mm
index 27e00e5e..15dc4074 100644
--- library/borealis/library/lib/platforms/desktop/desktop_darwin.mm
+++ library/borealis/library/lib/platforms/desktop/desktop_darwin.mm
@@ -15,15 +15,28 @@
     limitations under the License.
 */
 
-#import <borealis/core/logger.hpp>
-#import <borealis/platforms/desktop/desktop_platform.hpp>
-#import <CoreWLAN/CoreWLAN.h>
+#include <string>
+#include <functional>
+
+#include <AvailabilityMacros.h>
+
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1060
+    #define HAS_CORE_WLAN 1
+#else
+    #define HAS_CORE_WLAN 0
+#endif
+
+#if HAS_CORE_WLAN
+    #import <CoreWLAN/CoreWLAN.h>
+#endif
 
 namespace brls
 {
 
 // Interface method, fetching the current connection info.
 int darwin_wlan_quality() {
+#if HAS_CORE_WLAN
+#ifdef __clang__
     @autoreleasepool {
         CWWiFiClient* Client = CWWiFiClient.sharedWiFiClient;
         CWInterface* currentInterface = Client.interface;
@@ -38,21 +51,57 @@ int darwin_wlan_quality() {
         if (rssi > -80) return 2;
         return 1;
     }
+#else
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
+    CWInterface* currentInterface = [CWInterface interface];
+    if (![currentInterface ssid]) {
+        [pool drain];
+        return 0;
+    }
+    NSNumber* rssiNumber = [currentInterface rssi];
+    int result = 1;
+    if (rssiNumber) {
+        int rssi = [rssiNumber intValue];
+        if (rssi > -50) result = 3;
+        else if (rssi > -80) result = 2;
+    }
+    [pool drain];
+    return result;
+#endif
+#else // HAS_CORE_WLAN
+    return -1;
+#endif
 }
 
 bool darwin_runloop(const std::function<bool()>& runLoopImpl) {
+#ifdef __clang__
     @autoreleasepool {
         return runLoopImpl();
     }
+#else
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
+    bool result = runLoopImpl();
+    [pool drain];
+    return result;
+#endif
 }
 
 std::string darwin_locale() {
+#ifdef __clang__
     @autoreleasepool {
         NSUserDefaults *defaults = [NSUserDefaults standardUserDefaults];
         NSArray *languages = [defaults objectForKey:@"AppleLanguages"];
         NSString *current = [languages objectAtIndex:0];
         return [current UTF8String];
     }
+#else
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
+    NSUserDefaults *defaults = [NSUserDefaults standardUserDefaults];
+    NSArray *languages = [defaults objectForKey:@"AppleLanguages"];
+    NSString *current = [languages objectAtIndex:0];
+    [pool drain];
+    return [current UTF8String];
+#endif
 }
 
-}
\ No newline at end of file
+}
