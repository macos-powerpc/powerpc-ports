From 64bc63004ce89a00b3dea0df8354c398545eccb6 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Wed, 25 Feb 2026 02:30:08 +0800
Subject: [PATCH] GL fixes

---
 src/modules/VideoFilters/VFilters.hpp |  9 ++++-
 src/qmplay2/opengl/OpenGLCommon.cpp   | 15 +++++++-
 src/qmplay2/opengl/OpenGLInstance.cpp | 55 +++++++++------------------
 3 files changed, 39 insertions(+), 40 deletions(-)

diff --git a/src/modules/VideoFilters/VFilters.hpp b/src/modules/VideoFilters/VFilters.hpp
index cc870baf..bea0d964 100644
--- a/src/modules/VideoFilters/VFilters.hpp
+++ b/src/modules/VideoFilters/VFilters.hpp
@@ -28,9 +28,14 @@ class VFilters : public Module
 public:
     VFilters();
 private slots:
-#if QT_VERSION < QT_VERSION_CHECK(5, 0, 0) || defined(Q_MOC_RUN)
-    void onFullScreenChanged(bool fs) { m_fullScreen = fs; }
+    // Qt4: Must be visible to MOC unconditionally
+    void onFullScreenChanged(bool fs) {
+#if QT_VERSION < QT_VERSION_CHECK(5, 0, 0)
+        m_fullScreen = fs;
+#else
+        Q_UNUSED(fs);
 #endif
+    }
 private:
     QList<Info> getModulesInfo(const bool) const;
     void *createInstance(const QString &);
diff --git a/src/qmplay2/opengl/OpenGLCommon.cpp b/src/qmplay2/opengl/OpenGLCommon.cpp
index 5a6307ef..06ab9430 100644
--- a/src/qmplay2/opengl/OpenGLCommon.cpp
+++ b/src/qmplay2/opengl/OpenGLCommon.cpp
@@ -77,9 +77,8 @@ OpenGLCommon::OpenGLCommon() :
     texCoordYCbCr[0] = texCoordYCbCr[4] = texCoordYCbCr[5] = texCoordYCbCr[7] = 0.0f;
     texCoordYCbCr[1] = texCoordYCbCr[3] = 1.0f;
 
-#ifndef Q_OS_MAC
+    // Qt4+macOS may have OpenGL 2.0, not 3.0 - check the actual version
     m_gl3 = (m_glInstance->glVer >= 30);
-#endif
 
     m_matrixChangeFn = [this] {
         setMatrix = true;
@@ -270,6 +269,12 @@ void OpenGLCommon::initializeGL()
     if (target == GL_TEXTURE_RECTANGLE_ARB)
         videoFrag.prepend("#define TEXTURE_RECTANGLE\n");
     shaderProgramVideo->addShaderFromSourceCode(QGLShader::Fragment, videoFrag);
+    if (!shaderProgramVideo->link())
+    {
+        QMPlay2Core.logError(tr("Shader link error: ") + shaderProgramVideo->log());
+        isOK = false;
+        return;
+    }
     if (shaderProgramVideo->bind())
     {
         texCoordYCbCrLoc = shaderProgramVideo->attributeLocation("aTexCoord");
@@ -294,6 +299,12 @@ void OpenGLCommon::initializeGL()
     /* OSD shader */
     shaderProgramOSD->addShaderFromSourceCode(QGLShader::Vertex, readShader(":/opengl/OSD.vert"));
     shaderProgramOSD->addShaderFromSourceCode(QGLShader::Fragment, readShader(":/opengl/OSD.frag"));
+    if (!shaderProgramOSD->link())
+    {
+        QMPlay2Core.logError(tr("Shader link error: ") + shaderProgramOSD->log());
+        isOK = false;
+        return;
+    }
     if (shaderProgramOSD->bind())
     {
         texCoordOSDLoc = shaderProgramOSD->attributeLocation("aTexCoord");
diff --git a/src/qmplay2/opengl/OpenGLInstance.cpp b/src/qmplay2/opengl/OpenGLInstance.cpp
index 96102785..06b9e7bc 100644
--- a/src/qmplay2/opengl/OpenGLInstance.cpp
+++ b/src/qmplay2/opengl/OpenGLInstance.cpp
@@ -10,45 +10,27 @@
 
 bool OpenGLInstance::init()
 {
-    // Qt4: Need an active GL context to query
-    // Create a temporary context if needed
-#if QT_VERSION < QT_VERSION_CHECK(5, 0, 0)
-    QGLWidget *tempWidget = nullptr;
-    const QGLContext *existingContext = QGLContext::currentContext();
-    if (!existingContext)
-    {
-        // Create temporary offscreen widget to get a context
-        QGLFormat format;
-        format.setVersion(2, 0);
-        tempWidget = new QGLWidget(format);
-
-        // Ensure context is created - on some platforms we need this
-        if (!tempWidget->isValid())
-        {
-            delete tempWidget;
-            return false;
-        }
-
-        tempWidget->makeCurrent();
-
-        // Verify context is now current
-        if (!QGLContext::currentContext())
-        {
-            delete tempWidget;
-            return false;
-        }
-    }
-#endif
+#if QT_VERSION < QT_VERSION_CHECK(5, 0, 0) && defined(Q_OS_MAC)
+    // Qt4 + macOS: Skip OpenGL capability detection for now
+    // macOS 10.6 has OpenGL 2.0 support (2.1 may be available but not guaranteed)
+    // We'll query capabilities when first widget creates a context
+
+    // Set reasonable defaults for macOS 10.6 with OpenGL 2.0
+    isGLES = false;
+    canUse16bitTexture = false; // Conservative default for GL 2.0
+    hasVbo = true;  // OpenGL 2.0 has VBOs
+    hasMapBufferRange = false;
+    hasMapBuffer = true;
+    hasPbo = false;
+    glVer = 20; // OpenGL 2.0
 
+    return true;
+#else
+    // Qt5+: Normal capability detection
     // Get OpenGL version
     const char *versionStr = (const char *)glGetString(GL_VERSION);
     if (!versionStr)
-    {
-#if QT_VERSION < QT_VERSION_CHECK(5, 0, 0)
-        delete tempWidget;
-#endif
         return false;
-    }
 
     // Parse version string (e.g., "2.1 ..." or "3.0 ...")
     int majorVersion = 2;
@@ -95,8 +77,8 @@ bool OpenGLInstance::init()
 #ifndef Q_OS_MAC
     glVer = majorVersion * 10 + minorVersion;
 #else
-    // macOS 10.6.8 has OpenGL 2.0/2.1
-    glVer = 20;
+    // macOS 10.6 has OpenGL 2.0 support (use detected version or default to 2.0)
+    glVer = (majorVersion >= 2) ? (majorVersion * 10 + minorVersion) : 20;
 #endif
 
 #if QT_VERSION < QT_VERSION_CHECK(5, 0, 0)
@@ -105,6 +87,7 @@ bool OpenGLInstance::init()
 #endif
 
     return true;
+#endif // QT_VERSION < QT_VERSION_CHECK(5, 0, 0) && defined(Q_OS_MAC)
 }
 
 QString OpenGLInstance::name() const
