From a6c2d8a61075152e9819aaca3cdd846fa1ec0224 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 26 Feb 2026 04:09:17 +0800
Subject: [PATCH] System yt-dlp

---
 src/qmplay2/YouTubeDL.cpp | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/src/qmplay2/YouTubeDL.cpp b/src/qmplay2/YouTubeDL.cpp
index b4df69ea..26f1bd48 100644
--- a/src/qmplay2/YouTubeDL.cpp
+++ b/src/qmplay2/YouTubeDL.cpp
@@ -38,6 +38,11 @@
 #include <QFile>
 #include <QDir>
 
+/* Avoid bundled yt-dlp, it fails to work correctly. Use our port. */
+#ifndef BUNDLED_YTDLP
+#define BUNDLED_YTDLP 0
+#endif
+
 constexpr const char *g_name = "YouTubeDL";
 static bool g_mustUpdate = true;
 #if QT_VERSION >= QT_VERSION_CHECK(5, 14, 0)
@@ -70,6 +75,18 @@ QString YouTubeDL::getFilePath()
 {
     if (auto customPath = getCustomFilePath(); !customPath.isEmpty())
         return customPath;
+
+#ifdef Q_OS_MAC
+    // On macOS, prefer MacPorts yt-dlp or user-provided symlink
+    QString homeYtDlp = QDir::homePath() + "/.qmplay2/yt-dlp";
+    if (QFileInfo(homeYtDlp).exists())
+        return homeYtDlp;
+
+    QString macPortsYtDlp = "@prefix@/bin/yt-dlp";
+    if (QFileInfo(macPortsYtDlp).exists())
+        return macPortsYtDlp;
+#endif
+
     return QMPlay2Core.getSettingsDir() + getYtDlpFileName();
 }
 QStringList YouTubeDL::getCommonArgs()
@@ -357,6 +374,7 @@ bool YouTubeDL::prepare()
             return false;
     }
 
+#if BUNDLED_YTDLP
 #if QT_VERSION >= QT_VERSION_CHECK(5, 2, 0)
     if (!QFileInfo::exists(m_ytDlPath))
 #else
@@ -387,6 +405,7 @@ bool YouTubeDL::prepare()
         }
         g_mustUpdate = false;
     }
+#endif
 
     ensureExecutable();
 
@@ -394,6 +413,7 @@ bool YouTubeDL::prepare()
     return true;
 }
 
+#if BUNDLED_YTDLP
 bool YouTubeDL::download()
 {
     // Mutex must be locked here
@@ -455,6 +475,9 @@ bool YouTubeDL::download()
     qCritical() << "Unable to download \"youtube-dl\"";
     return false;
 }
+#endif
+
+#if BUNDLED_YTDLP
 bool YouTubeDL::update()
 {
     if (QMPlay2Core.getSettings().getBool("YtDl/DontAutoUpdate"))
@@ -508,6 +531,7 @@ bool YouTubeDL::update()
     QMPlay2Core.setWorking(false);
     return true;
 }
+#endif
 
 void YouTubeDL::ensureExecutable()
 {
