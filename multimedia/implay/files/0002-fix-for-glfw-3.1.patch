From 7634c0c212d72930235eac0b1e0604bf72e48e59 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 8 Jan 2026 14:28:16 +0800
Subject: [PATCH] window.cpp: fix for glfw 3.1

---
 source/window.cpp                     | 32 ++++++++++++++++++++++++---
 third_party/glfw/include/GLFW/glfw3.h |  4 ++++
 2 files changed, 33 insertions(+), 3 deletions(-)

diff --git source/window.cpp source/window.cpp
index 397dcc2..9d8f8e2 100644
--- source/window.cpp
+++ source/window.cpp
@@ -56,7 +56,7 @@ void Window::initGLFW() {
   glfwWindowHint(GLFW_CONTEXT_VERSION_MINOR, 0);
   glfwWindowHint(GLFW_CONTEXT_CREATION_API, GLFW_EGL_CONTEXT_API);
   glfwWindowHint(GLFW_CLIENT_API, GLFW_OPENGL_ES_API);
-#elif defined(__APPLE__)
+#elif defined(__APPLE__) && !defined(GLFW_COMPAT)
   glfwWindowHint(GLFW_CONTEXT_VERSION_MAJOR, 3);
   glfwWindowHint(GLFW_CONTEXT_VERSION_MINOR, 2);
   glfwWindowHint(GLFW_OPENGL_PROFILE, GLFW_OPENGL_CORE_PROFILE);
@@ -138,7 +138,11 @@ void Window::run() {
     double targetDelta = 1.0f / config->Data.Interface.Fps;
     double delta = lastTime - glfwGetTime();
     if (delta > 0 && delta < targetDelta)
+#ifdef GLFW_COMPAT
+      std::this_thread::sleep_for(std::chrono::duration<double>(delta));
+#else
       glfwWaitEventsTimeout(delta);
+#endif
     else
       lastTime = glfwGetTime();
     lastTime += targetDelta;
@@ -199,7 +208,7 @@ void Window::installCallbacks(GLFWwindow* target) {
     auto win = static_cast<Window*>(glfwGetWindowUserPointer(window));
     win->lastInputAt = glfwGetTime();
     if (ImGui::GetIO().WantCaptureMouse) return;
-#ifdef __APPLE__
+#if defined(__APPLE__) && !defined(GLFW_COMPAT)
     float xscale, yscale;
     glfwGetWindowContentScale(window, &xscale, &yscale);
     x *= xscale;
@@ -310,7 +319,20 @@ void Window::SetSwapInterval(int interval) { glfwSwapInterval(interval); }
 
 void Window::BackendNewFrame() { ImGui_ImplGlfw_NewFrame(); };
 
-void Window::GetWindowScale(float* x, float* y) { glfwGetWindowContentScale(window, x, y); }
+void Window::GetWindowScale(float* x, float* y) {
+#ifndef GLFW_COMPAT
+  glfwGetWindowContentScale(window, x, y);
+#else
+  int windowWidth, windowHeight;
+  int framebufferWidth, framebufferHeight;
+  
+  glfwGetWindowSize(window, &windowWidth, &windowHeight);
+  glfwGetFramebufferSize(window, &framebufferWidth, &framebufferHeight);
+  
+  if (x) *x = (windowWidth > 0) ? (float)framebufferWidth / windowWidth : 1.0f;
+  if (y) *y = (windowHeight > 0) ? (float)framebufferHeight / windowHeight : 1.0f;
+#endif
+}
 
 void Window::GetWindowPos(int* x, int* y) { glfwGetWindowPos(window, x, y); }
 
