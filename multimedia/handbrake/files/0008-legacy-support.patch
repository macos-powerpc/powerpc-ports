From 22841c006d80bb7c84c14baf438a1f9be584e882 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Mon, 23 Feb 2026 09:11:06 +0800
Subject: [PATCH] legacy-support

--- a/gtk/meson.build
+++ b/gtk/meson.build
@@ -83,7 +83,7 @@ endif
 # OS-specific dependencies
 
 if host_machine.system() == 'darwin'
-  darwin_frameworks = ['AudioToolbox', 'CoreAudio', 'DiskArbitration', 'Foundation', 'IOKit']
+  darwin_frameworks = ['AudioToolbox', 'CoreAudio', 'CoreServices', 'DiskArbitration', 'Foundation', 'IOKit']
   foreach framework: darwin_frameworks
     ghb_deps += dependency('appleframeworks', modules: framework)
   endforeach
@@ -111,6 +111,9 @@ if not cc.has_function('iconv')
   add_project_arguments('-DLIBICONV_PLUG', language: ['c', 'cpp'])
 endif
 
+ghb_deps += cc.find_library('MacportsLegacySupport')
+add_project_arguments('-isystem@PREFIX@/include/LegacySupport', language: ['c', 'cpp'])
+
 if not get_option('c_std').contains('gnu')
   add_project_arguments('-D_DEFAULT_SOURCE', language: ['c', 'cpp'])
 endif

--- a/gtk/module.defs
+++ b/gtk/module.defs
@@ -83,6 +83,8 @@ ifeq (1,$(FEATURE.vt))
 else
     GTK.CONFIGURE.extra += -Dvt=disabled
     GTK.GCC.D += HB_DISABLE_VT
+    GTK.GCC.I += @PREFIX@/include/LegacySupport
+    GTK.GCC.l += MacportsLegacySupport
 endif
 
 ifeq (1,$(FEATURE.flatpak))

--- a/libhb/module.defs
+++ b/libhb/module.defs
@@ -77,6 +77,8 @@ else ifeq ($(HOST.system),darwin)
         LIBHB.metal += $(wildcard $(LIBHB.src/)platform/macosx/shaders/*.metal)
     else
         LIBHB.GCC.D += HB_DISABLE_VT
+        LIBHB.GCC.I += @PREFIX@/include/LegacySupport
+        LIBHB.GCC.l += MacportsLegacySupport
         LIBHB.c += $(LIBHB.src/)platform/macosx/encca_aac.c
         LIBHB.m += $(LIBHB.src/)platform/macosx/config.m
     endif

--- a/test/module.defs
+++ b/test/module.defs
@@ -58,7 +58,7 @@ ifeq ($(HOST.system),darwin)
 ifeq (1,$(FEATURE.vt))
     TEST.GCC.f += CoreGraphics CoreMedia CoreText CoreVideo IOSurface Metal VideoToolbox
 endif
-    TEST.GCC.l += iconv
+    TEST.GCC.l += iconv MacportsLegacySupport
 else ifeq ($(HOST.system),linux)
     TEST.GCC.l += pthread dl m
 ifeq (1, $(FEATURE.numa))
