# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           legacysupport 1.1
PortGroup           wxWidgets 1.0

# LegacySupport only used for providing wrappers here.
legacysupport.newest_darwin_requires_legacy 10

name                filezilla-server
version             1.12.3
revision            0
categories          www net
maintainers         {@barracuda156 gmail.com:vital.had} openmaintainer
license             AGPL-3
homepage            https://filezilla-project.org
description         A simple FTP, FTPS or SFTP server
long_description    {*}${description}

installs_libs       no

# Arch Linux sources: https://aur.archlinux.org/packages/filezilla-server
master_sites        https://sourceforge.net/projects/fabiololix-os-archive/files/src/

use_xz              yes
distname            FileZilla_Server_${version}_src

checksums           rmd160  f2854af1963875dda95a406aa007d6e35d7d04b2 \
                    sha256  a06efb93a23c55fcb66f1371a129546659c6c79839fd3c502da274af60a28d4c \
                    size    1633428

worksrcdir          ${name}-${version}

patchfiles          patch-no-demos.diff

# Hack around a buggy header.
patchfiles-append   patch-no-64-bit-lockfree.diff

# Use POSIX-compliant syntax, not gnuisms:
post-patch {
    reinplace "s|cp -a |cp -pRP |" ${worksrcpath}/src/filezilla/webui/app/Makefile.in
}

wxWidgets.use       wxGTK-3.2

depends_build-append \
                    path:bin/pkg-config:pkgconfig

depends_lib-append  port:libfilezilla \
                    port:pugixml \
                    port:sqlite3 \
                    port:${wxWidgets.port}

depends_run-append  port:desktop-file-utils

legacysupport.redirect_bins \
    filezilla-server filezilla-server-config-converter filezilla-server-crypt filezilla-server-gui filezilla-server-impersonator

configure.args-append \
                    --disable-update-checker \
                    --disable-silent-rules \
                    --enable-webui \
                    --with-pugixml=system \
                    --with-wx-config=${wxWidgets.wxconfig} \
                    --with-wxdir=${wxWidgets.wxdir}

compiler.cxx_standard           2017
compiler.thread_local_storage   yes
compiler.blacklist-append       {clang < 1000}

# You'd imagine that disabling update checker sets appropriate defines...
configure.cppflags-append \
                    -DWITHOUT_FZ_UPDATE_CHECKER

if {[string match *gcc* ${configure.compiler}] && ${configure.build_arch} in [list arm i386 ppc]} {
    configure.ldflags-append \
                    -latomic
}

depends_test-append port:cppunit

test.run            yes
test.target         check
