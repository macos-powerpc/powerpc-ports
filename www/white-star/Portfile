# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               github 1.0

github.setup            dbsoft White-Star 4b752df82987fe0e2ccd70e85acbc16815f02433
name                    white-star
version                 2025.08.18
categories              www
maintainers             {@barracuda156 gmail.com:vital.had} openmaintainer
license                 GPL-2
description             White Star web-browser
long_description        ${description} based on PaleMoon.
homepage                https://dbsoft.org/whitestar.php

github.tarball_from archive

# PaleMoon 33.8.2
set platform_date       20250824
# https://github.com/dbsoft/White-Star-Branding/commits/macppc
set branding_hash       426c59c0acf10976ef4c04b608ed24ef534c2955

master_sites-append     https://repo.palemoon.org/MoonchildProductions/UXP/archive/:platform_dist \
                        https://github.com/dbsoft/White-Star-Branding/archive/${branding_hash}/:branding

distfiles-append        RB_${platform_date}.tar.gz:platform_dist \
                        White-Star-Branding-${branding_hash}.tar.gz:branding

checksums               ${distname}${extract.suffix} \
                        rmd160  9729948e4bbbc90a552ed8c67752bc6f48e06c50 \
                        sha256  be22f252ddbeb3d8fc2c68035b186d18cb2ce4cf72c5b4fa4f5da6fd9c6a4038 \
                        size    5534723 \
                        RB_${platform_date}${extract.suffix} \
                        rmd160  35cfb71432351de2bfd31b9940e938e8371dd672 \
                        sha256  8d7b6b62db78ce1aef8b52c4534cf759663ff201ef796b3876ad7e562b74922a \
                        size    264316783 \
                        White-Star-Branding-${branding_hash}${extract.suffix} \
                        rmd160  f10008305e8f2541bd7f45df557fda33d901836a \
                        sha256  c1caf44c8c91e629052ab6331fdfaf0a335fc4c4498a9c154fee77d3a0c01d0e \
                        size    9144775

extract.only            ${distname}${extract.suffix}

post-extract {
    set tar [findBinary tar ${portutil::autoconf::tar_command}]
    system -W ${workpath} "${tar} -zxf ${distpath}/RB_${platform_date}.tar.gz"
    system -W ${workpath} "${tar} -zxf ${distpath}/White-Star-Branding-${branding_hash}.tar.gz"
    # Delete empty directories:
    delete -force ${worksrcpath}/platform
    delete -force ${worksrcpath}/whitestar/branding/whitestar
    # Move extracted sources into place:
    move ${workpath}/uxp ${worksrcpath}/platform
    move ${workpath}/White-Star-Branding-${branding_hash} ${worksrcpath}/whitestar/branding/whitestar
    # Use our config:
    copy ${filespath}/mozconfig ${worksrcpath}/.mozconfig
}

universal_variant       no
installs_libs           no

# Yeah, it must use the archaic python:
set py_v                2.7
set py_v_nodot          [string map {. {}} ${py_v}]

# https://github.com/dbsoft/White-Star/issues/2
# https://dbsoft.org/whitestar-build-mac.php
depends_build-append    port:autoconf \
                        port:cctools \
                        port:ld64 \
                        port:m4 \
                        path:bin/pkg-config:pkgconfig \
                        port:python${py_v_nodot}

compiler.cxx_standard   2011

patch.dir               ${worksrcpath}/platform
patch.pre_args-replace  -p0 -p1
patchfiles-append       0001-Issue-2051-Follow-up-Part-1-Various-fixes-for-Mac-Po.patch \
                        0002-Issue-2051-Follow-up-Part-1b-Fix-building-on-later-M.patch \
                        0003-Issue-2051-Follow-up-Part-2-Add-additional-safety-ch.patch \
                        0004-Issue-2051-Follow-up-Part-2b-Even-more-safety-checks.patch \
                        0005-Issue-2051-Follow-up-Part-2c-No-IOSurface-support-on.patch \
                        0006-Issue-2051-Follow-up-Part-2d-Fix-missing-or-misplace.patch \
                        0007-Issue-2051-Follow-up-Part-2e-Force-fallback-to-raste.patch \
                        0008-Issue-2051-2777-Follow-up-Part-3-Add-MacOS-PPC-confi.patch \
                        0009-Issue-2051-Follow-up-Part-2f-Miscellaneous-fixes.patch \
                        0010-Issue-2051-Follow-up-Part-2g-Readd-CoreGraphics-supp.patch \
                        0011-DrawTargetCG.cpp-macros-should-be-SDK-conditional-no.patch \
                        0012-gfxMacPlatformFontList.mm-fix-for-10.6-SDK.patch \
                        0013-ffvpx-adjust-configs-for-darwin.patch \
                        0014-widget-cocoa-fixes-for-10.6-SDK.patch

configure.sysroot       ${developer_dir}/SDKs/MacOSX${macosx_deployment_target}.sdk

# FIXME: This is a hack, build against 10.6 SDK needs some extra fixes:
macosx_deployment_target    10.5

variant G5 description "Optimize for G5 machines" { }

# This requires to modify mozconfig accordingly.
variant external_libs description "Build against libs provided by ports" {
    depends_lib-append  port:bzip2 \
                        path:include/turbojpeg.h:libjpeg-turbo \
                        port:nspr \
                        port:nss \
                        port:zlib
}

post-patch {
    # buildmakejobs are not guaranteed to have a non-zero value.
    # The build can run in parallel, set buildmakejobs in macports.conf.
    if {${buildmakejobs} == 0 || ${buildmakejobs} eq ""} {
        set buildmakejobs 1
    }

    reinplace "s|@CC@|${configure.cc}|" ${worksrcpath}/.mozconfig
    reinplace "s|@CXX@|${configure.cxx}|" ${worksrcpath}/.mozconfig
    reinplace "s|@LD@|${prefix}/bin/ld|" ${worksrcpath}/.mozconfig
    reinplace "s|@STRIP@|${prefix}/bin/strip|" ${worksrcpath}/.mozconfig
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/.mozconfig
    reinplace "s|@DEPTARGET@|${macosx_deployment_target}|" ${worksrcpath}/.mozconfig
    reinplace "s|@SYSROOT@|${configure.sysroot}|" ${worksrcpath}/.mozconfig
    reinplace "s|@JOBS@|${buildmakejobs}|" ${worksrcpath}/.mozconfig

    if {${configure.build_arch} in [list ppc ppc64]} {
        reinplace "s|@TRIPLE@|powerpc-apple-${os.platform}|g" ${worksrcpath}/.mozconfig

        if {[variant_isset G5]} {
            reinplace "s|@NATIVE@|-mtune=G5|g" ${worksrcpath}/.mozconfig
        } else {
            reinplace "s|@NATIVE@|-mcpu=G4|g" ${worksrcpath}/.mozconfig
        }
    } else {
        reinplace "s|@TRIPLE@|${configure.build_arch}-apple-${os.platform}|g" ${worksrcpath}/.mozconfig
        reinplace "s|@NATIVE@||g" ${worksrcpath}/.mozconfig
    }
    if {${configure.build_arch} in [list arm i386 ppc]} {
        reinplace "s|@BITS@|32|g" ${worksrcpath}/.mozconfig
    } else {
        reinplace "s|@BITS@|64|g" ${worksrcpath}/.mozconfig
    }
}

use_configure           no

build.cmd               ./mach
build.target            build

build.env-append        PYTHON=${prefix}/bin/python${py_v}

destroot {
    copy "${worksrcpath}/obj-powerpc-apple-darwin/dist/White Star.app" ${destroot}${applications_dir}
}
