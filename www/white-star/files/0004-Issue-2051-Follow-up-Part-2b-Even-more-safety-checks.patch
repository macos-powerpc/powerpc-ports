From 945d7035d91bb3f478f21e71781d76ced3c2fb29 Mon Sep 17 00:00:00 2001
From: Brian Smith <brian@dbsoft.org>
Date: Mon, 15 Jul 2024 02:32:49 -0500
Subject: [PATCH 04/14] Issue #2051 - Follow-up Part 2b: Even more safety
 checks in the older font code.

---
 gfx/thebes/gfxMacPlatformFontList.mm | 10 +++++-----
 gfx/thebes/gfxTextRun.cpp            |  6 +++---
 2 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/gfx/thebes/gfxMacPlatformFontList.mm b/gfx/thebes/gfxMacPlatformFontList.mm
index 04bde977b1..ae0792bcbf 100644
--- a/gfx/thebes/gfxMacPlatformFontList.mm
+++ b/gfx/thebes/gfxMacPlatformFontList.mm
@@ -494,15 +494,15 @@ MacOSFontEntry::GetFontTable(uint32_t aTag)
 
 #ifdef DEBUG_X
         uint32_t j = 12;
-        uint8_t *table = (reinterpret_cast<uint8_t *>(
-                mFontTableDir.Elements()));
+        uint8_t *table = (reinterpret_cast<uint8_t *>(mFontTableDir.Elements()));
         fprintf(stderr, "fast fetch ");
 #endif
         uint32_t i;
-        uint32_t *wtable = (reinterpret_cast<uint32_t *>(
-                mFontTableDir.Elements()));
+        uint32_t *wtable = (reinterpret_cast<uint32_t *>(mFontTableDir.Elements()));
+        uint32_t count = mFontTableDirSize / 4;
+        uint32_t length = mFontTableDir.Length();
 
-        for (i=3; i<(mFontTableDirSize/4); i+=4) { // Skip header
+        for (i=3; i<count && i<length; i+=4) { // Skip header
 #ifdef DEBUG_X
                 char tag[5] = { table[j], table[j+1], table[j+2], table[j+3],
                         '\0' };
diff --git a/gfx/thebes/gfxTextRun.cpp b/gfx/thebes/gfxTextRun.cpp
index aac9d57f6f..f17c129a0e 100644
--- a/gfx/thebes/gfxTextRun.cpp
+++ b/gfx/thebes/gfxTextRun.cpp
@@ -1609,8 +1609,6 @@ gfxFontGroup::~gfxFontGroup()
 void
 gfxFontGroup::BuildFontList()
 {
-    bool enumerateFonts = true;
-
     // initialize fonts in the font family list
     AutoTArray<gfxFontFamily*,10> fonts;
     gfxPlatformFontList *pfl = gfxPlatformFontList::PlatformFontList();
@@ -1639,7 +1637,9 @@ gfxFontGroup::BuildFontList()
 
     // build the fontlist from the specified families
     for (gfxFontFamily* fontFamily : fonts) {
-        AddFamilyToFontList(fontFamily);
+        if(fontFamily) {
+            AddFamilyToFontList(fontFamily);
+        }
     }
 }
 
-- 
2.50.1

