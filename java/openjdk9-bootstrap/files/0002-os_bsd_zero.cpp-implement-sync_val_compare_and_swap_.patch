From f17131cf3d8ee744705fface5bfb431aebec5908 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Sun, 20 Jul 2025 22:50:05 +0800
Subject: [PATCH 02/31] os_bsd_zero.cpp: implement sync_val_compare_and_swap_8

Cherry-picked from: https://github.com/nilsvanvelzen/mac_ppc_openjdk8u60/commit/25b5795c961e3199e76d023f6a2f531d5fc33210
---
 hotspot/src/os_cpu/bsd_zero/vm/os_bsd_zero.cpp | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/hotspot/src/os_cpu/bsd_zero/vm/os_bsd_zero.cpp b/hotspot/src/os_cpu/bsd_zero/vm/os_bsd_zero.cpp
index 15a5b7d046..e516bfe4ec 100644
--- a/hotspot/src/os_cpu/bsd_zero/vm/os_bsd_zero.cpp
+++ b/hotspot/src/os_cpu/bsd_zero/vm/os_bsd_zero.cpp
@@ -456,7 +456,16 @@ extern "C" {
     volatile void *ptr,
     long long unsigned int oldval,
     long long unsigned int newval) {
-    ShouldNotCallThis();
+    long long unsigned int curval;
+    __sync_synchronize();
+    curval = *( long long unsigned int *) (ptr);
+    // curval = static_cast<long long unsigned int>(*ptr);
+    if (curval == oldval){
+       // static_cast<long long unsigned int> *ptr = newval;
+     *( long long unsigned int *) (ptr) = newval; 
+    }
+    return curval;
+    // ShouldNotCallThis();
   }
 };
 #endif // !_LP64
-- 
2.24.3 (Apple Git-128)

