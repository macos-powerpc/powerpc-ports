From 17bcc9eb14cb1e4ffa282dc1b90dbb87afa1a155 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Mon, 21 Jul 2025 02:22:49 +0800
Subject: [PATCH 23/31] AWTFont.m: skip JNF_COCOA_ENTER stuff

---
 .../macosx/native/libawt_lwawt/font/AWTFont.m | 34 +++++++++++++------
 1 file changed, 23 insertions(+), 11 deletions(-)

diff --git a/jdk/src/java.desktop/macosx/native/libawt_lwawt/font/AWTFont.m b/jdk/src/java.desktop/macosx/native/libawt_lwawt/font/AWTFont.m
index bca2102134..d57d9b6347 100644
--- a/jdk/src/java.desktop/macosx/native/libawt_lwawt/font/AWTFont.m
+++ b/jdk/src/java.desktop/macosx/native/libawt_lwawt/font/AWTFont.m
@@ -23,17 +23,17 @@
  * questions.
  */
 
-#import <JavaNativeFoundation/JavaNativeFoundation.h>
+#include <AvailabilityMacros.h>
 
-#import "java_awt_Font.h"
-#import "sun_awt_PlatformFont.h"
-#import "sun_awt_FontDescriptor.h"
-#import "sun_font_CFont.h"
-#import "sun_font_CFontManager.h"
+#include "java_awt_Font.h"
+#include "sun_awt_PlatformFont.h"
+#include "sun_awt_FontDescriptor.h"
+#include "sun_font_CFont.h"
+#include "sun_font_CFontManager.h"
 
-#import "AWTFont.h"
-#import "AWTStrike.h"
-#import "CoreTextSupport.h"
+#include "AWTFont.h"
+#include "AWTStrike.h"
+#include "CoreTextSupport.h"
 
 @implementation AWTFont
 
@@ -372,6 +372,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
 
     jint num = 0;
 
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1070
 JNF_COCOA_ENTER(env);
 
     NSArray *filteredFonts = GetFilteredFonts();
@@ -391,6 +392,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
     }
 
 JNF_COCOA_EXIT(env);
+#endif
 }
 
 /*
@@ -402,6 +404,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
 Java_sun_font_CFontManager_loadNativeDirFonts
 (JNIEnv *env, jclass clz, jstring filename)
 {
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1070
 JNF_COCOA_ENTER(env);
 
     NSString *path = JNFJavaToNSString(env, filename);
@@ -413,6 +416,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
     printf("res is %d\n", res);
 #endif
 JNF_COCOA_EXIT(env);
+#endif
 }
 
 #pragma mark --- sun.font.CFont JNI ---
@@ -459,6 +463,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
      jlong awtFontPtr, jint jtag)
 {
     jbyteArray jbytes = NULL;
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1070
 JNF_COCOA_ENTER(env);
 
     CTFontTableTag tag = (CTFontTableTag)jtag;
@@ -502,7 +507,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
     CFRelease(table);
 
 JNF_COCOA_EXIT(env);
-
+#endif
     return jbytes;
 }
 
@@ -518,6 +523,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
 {
     AWTFont *awtFont = nil;
 
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1070
 JNF_COCOA_ENTER(env);
 
     awtFont =
@@ -529,7 +535,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
     }
 
 JNF_COCOA_EXIT(env);
-
+#endif
     return ptr_to_jlong(awtFont);
 }
 
@@ -543,6 +549,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
     (JNIEnv *env, jobject cfont, jlong awtFontPtr)
 {
     float widthVal;
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1070
 JNF_COCOA_ENTER(env);
 
     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);
@@ -553,6 +560,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
     widthVal = (float)[width floatValue];
 
 JNF_COCOA_EXIT(env);
+#endif
    return (jfloat)widthVal;
 }
 
@@ -566,6 +574,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
     (JNIEnv *env, jobject cfont, jlong awtFontPtr)
 {
     float weightVal;
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1070
 JNF_COCOA_ENTER(env);
 
     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);
@@ -576,6 +585,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
     weightVal = (float)[weight floatValue];
 
 JNF_COCOA_EXIT(env);
+#endif
    return (jfloat)weightVal;
 }
 
@@ -588,6 +598,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
 Java_sun_font_CFont_disposeNativeFont
     (JNIEnv *env, jclass clazz, jlong awtFontPtr)
 {
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1070
 JNF_COCOA_ENTER(env);
 
     if (awtFontPtr) {
@@ -595,6 +606,7 @@ static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
     }
 
 JNF_COCOA_EXIT(env);
+#endif
 }
 
 
-- 
2.24.3 (Apple Git-128)

