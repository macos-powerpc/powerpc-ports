# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           ruby 1.0

ruby.branches       3.4 3.3 3.2
ruby.setup          rtfm-filemanager 7.3.6 gem {} rubygems
revision            0
categories-append   sysutils
platforms           any
license             Unlicense
maintainers         nomaintainer
description         ${name} is a full-featured terminal file-manager
long_description    {*}${description}
homepage            https://isene.com
checksums           rmd160  22c769f6ae58f14e315739e201516950b589c036 \
                    sha256  ba1ab982023fe3364749432d8a2787a350805e9f576efd8a79427a9c874c8701 \
                    size    1597440
supported_archs     noarch

if {${subport} ne ${name}} {
    depends_run-append \
                    port:rb${ruby.suffix}-bootsnap \
                    port:rb${ruby.suffix}-rcurses \
                    port:rb${ruby.suffix}-ruby-openai \
                    port:rb${ruby.suffix}-termpix

    depends_run-append \
                    port:catdoc \
                    port:ffmpegthumbnailer \
                    port:gnumeric \
                    port:highlight \
                    port:ImageMagick \
                    port:libsixel \
                    port:ncurses \
                    port:TermMark \
                    port:unzip \
                    port:w3m

    post-destroot {
        # Fix rb-ruby-openai version
        reinplace "s|~> 7.4|>= 7.4|g" ${destroot}${ruby.gemdir}/specifications/${ruby.module}-${version}.gemspec

        # https://github.com/isene/RTFM/issues/8
        reinplace "s|\'bat\' : \'batcat\'|\'bat\' : \'highlight\'|g" ${destroot}${ruby.gemdir}/gems/${ruby.module}-${version}/bin/rtfm
        reinplace "s|-n --color=always|-O ansi --force --line-numbers|g" ${destroot}${ruby.gemdir}/gems/${ruby.module}-${version}/bin/rtfm
        reinplace "s|pandoc \@s -t plain|termmark \@s|g" ${destroot}${ruby.gemdir}/gems/${ruby.module}-${version}/bin/rtfm
    }
}

notes "
    You may want to set RCURSES_BORDERS=ascii in the environment.
"

# TODO: add select PortGroup here.

# TODO: there were observed occasional crashes if terminal window is resized
# when the app is running. It is unclear at the moment what goes wrong,
# the log points to ruby library and KERN_PROTECTION_FAILURE at 0x0000000000000006.
# May not be deterministic. It is safer though to set a desired window size
# prior to launching the app.
