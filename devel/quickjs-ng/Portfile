# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem      1.0
PortGroup       cmake 1.1
PortGroup       github 1.0
PortGroup       legacysupport 1.1

# _clock_gettime
legacysupport.newest_darwin_requires_legacy 15

# FIXME: at least recent versions do not work correctly.
# See: https://github.com/quickjs-ng/quickjs/issues/1122
# Another quickjs* (non-ng) seems to work fine.

set real_name   quickjs
name            ${real_name}-ng
github.setup    ${real_name}-ng ${real_name} 0.11.0 v
revision        0
conflicts       ${real_name} ${real_name}-devel
categories      devel
license         MIT
maintainers     {@barracuda156 macos-powerpc.org:barracuda} openmaintainer
description     small and embeddable JavaScript engine
long_description \
                ${name} is a {*}${description}. \
                It supports the ES2020 specification including modules, \
                asynchronous generators, proxies and BigInt.
checksums       rmd160  bec7efc2364c507570f6d78ed1c3422dc1c6cbfc \
                sha256  b456e6aa05522eed9cbf9dec1e947ba1ba6578fd09386391e581339ddabaa641 \
                size    784539
github.tarball_from archive

compiler.c_standard 2011

# https://github.com/quickjs-ng/quickjs/issues/1023
configure.args-append \
                -DQJS_BUILD_LIBC=ON

if {[string match *gcc* ${configure.cc}]} {
    configure.ldflags-append \
                -latomic
}

# configure.pre_args-replace \
#                 -DCMAKE_BUILD_WITH_INSTALL_RPATH:BOOL=ON \
#                 -DCMAKE_BUILD_WITH_INSTALL_RPATH:BOOL=OFF

# Test executable tries to find non-existing file:
# run-test262: sta.js: No such file or directory
# test.run        yes
# test.cmd        ${cmake.build_dir}/run-test262
# test.target
