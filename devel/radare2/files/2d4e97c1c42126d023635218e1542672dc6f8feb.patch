From 2d4e97c1c42126d023635218e1542672dc6f8feb Mon Sep 17 00:00:00 2001
From: pancake <pancake@nopcode.org>
Date: Sat, 30 Aug 2025 17:44:14 +0200
Subject: [PATCH] Fix #22956 - Update acr to adjust the macppc triplet ##build

---
 configure                    | 20 +++++++++++++++++---
 subprojects/binaryninja.mk   |  2 +-
 subprojects/capstone-next.mk |  2 +-
 subprojects/capstone-v4.mk   |  2 +-
 subprojects/capstone-v5.mk   |  2 +-
 subprojects/qjs.mk           |  2 +-
 subprojects/sdb.mk           |  2 +-
 7 files changed, 23 insertions(+), 9 deletions(-)

diff --git a/configure b/configure
index b821390fcd5ec..1e2cd52a1ebb1 100755
--- a/configure
+++ b/configure
@@ -101,13 +101,27 @@ if [ -e "${VPATH}/config.guess" ]; then
 	sh ${VPATH}/config.guess
 	return
 fi
-CPU="`uname -m|sed -e 's, ,,g'|cut -d - -f 1`"
+CPU="`uname -m | tr 'A-Z' 'a-z' | sed -e 's, ,,g' | cut -d - -f 1`"
 OS="`uname -s|tr A-Z a-z`"
 uname -r | grep -qE "(Microsoft|WSL)" 2>/dev/null && OS="wsl"
 GNU="`uname --help 2>&1 | grep gnu`"
 [ "${GNU}" ] && OS="${OS}-gnu"
-[ "${CPU}" = ppc ] && CPU="powerpc"
-echo "${CPU}-unknown-${OS}"
+# normalize CPU
+case "${CPU}" in
+	ppc*|powermac*|powermacintosh*|powerpc*)
+		if echo "${CPU}" | grep -q '64'; then
+			CPU=powerpc64
+		else
+			CPU=powerpc
+		fi
+		;;
+	*) ;;
+esac
+VENDOR="unknown"
+if [ "${OS}" = "darwin" ]; then
+	VENDOR=apple
+fi
+echo "${CPU}-${VENDOR}-${OS}"
 }
 
 SEARCHPATH="/usr /usr/local /usr/pkg /sw"
diff --git a/subprojects/binaryninja.mk b/subprojects/binaryninja.mk
index 576dab46c14c4..4e2320f47e72b 100644
--- a/subprojects/binaryninja.mk
+++ b/subprojects/binaryninja.mk
@@ -6,7 +6,7 @@ WRAP_wrap_git_directory:=binaryninja
 WRAP_wrap_git_patch_directory:=binaryninja
 WRAP_wrap_git_depth:=1
 
-.PHONY: binaryninja
+.PHONY: binaryninja_clean binaryninja_all
 
 binaryninja:
 	if [ ! -d "binaryninja" -o "c40a5f04deec68d388b2072dc42b29141089f9ce" != "$(shell cd binaryninja 2>/dev/null && git rev-parse HEAD)" ]; then rm -rf "binaryninja"; ${MAKE} binaryninja_all; fi
diff --git a/subprojects/capstone-next.mk b/subprojects/capstone-next.mk
index 789b15a99ec23..d5adff3248d35 100644
--- a/subprojects/capstone-next.mk
+++ b/subprojects/capstone-next.mk
@@ -7,7 +7,7 @@ WRAP_wrap_git_directory:=capstone-next
 WRAP_wrap_git_diff_files:=capstone-next/capstone-patches/fix-x86-16.patch
 WRAP_wrap_git_depth:=1
 
-.PHONY: capstone-next
+.PHONY: capstone-next_clean capstone-next_all
 
 capstone-next:
 	if [ ! -d "capstone-next" -o "ccbc41d3dadb2953deed9e050abfae146876288d" != "$(shell cd capstone-next 2>/dev/null && git rev-parse HEAD)" ]; then rm -rf "capstone-next"; ${MAKE} capstone-next_all; fi
diff --git a/subprojects/capstone-v4.mk b/subprojects/capstone-v4.mk
index 048bc7f0a268d..315eba8cfb4e3 100644
--- a/subprojects/capstone-v4.mk
+++ b/subprojects/capstone-v4.mk
@@ -7,7 +7,7 @@ WRAP_wrap_git_directory:=capstone-v4
 WRAP_wrap_git_diff_files:=capstone-v4/capstone-patches/v4/capstone-calloc.patch,capstone-v4/capstone-patches/v4/fix-x86-16.patch,capstone-v4/capstone-patches/v4/sparc-crash.patch,capstone-v4/capstone-patches/v4/sstream-null.patch
 WRAP_wrap_git_depth:=1
 
-.PHONY: capstone-v4
+.PHONY: capstone-v4_clean capstone-v4_all
 
 capstone-v4:
 	if [ ! -d "capstone-v4" -o "d7e459d026b19d6c3a7b743bfc475d919ff03f74" != "$(shell cd capstone-v4 2>/dev/null && git rev-parse HEAD)" ]; then rm -rf "capstone-v4"; ${MAKE} capstone-v4_all; fi
diff --git a/subprojects/capstone-v5.mk b/subprojects/capstone-v5.mk
index d5d16208e5cf4..684c5779e656b 100644
--- a/subprojects/capstone-v5.mk
+++ b/subprojects/capstone-v5.mk
@@ -7,7 +7,7 @@ WRAP_wrap_git_directory:=capstone-v5
 WRAP_wrap_git_diff_files:=capstone-v5/capstone-patches/fix-x86-16.patch
 WRAP_wrap_git_depth:=1
 
-.PHONY: capstone-v5
+.PHONY: capstone-v5_clean capstone-v5_all
 
 capstone-v5:
 	if [ ! -d "capstone-v5" -o "accf4df62f1fba6f92cae692985d27063552601c" != "$(shell cd capstone-v5 2>/dev/null && git rev-parse HEAD)" ]; then rm -rf "capstone-v5"; ${MAKE} capstone-v5_all; fi
diff --git a/subprojects/qjs.mk b/subprojects/qjs.mk
index 4ece9534de102..e143a39298c04 100644
--- a/subprojects/qjs.mk
+++ b/subprojects/qjs.mk
@@ -6,7 +6,7 @@ WRAP_wrap_git_directory:=qjs
 WRAP_wrap_git_patch_directory:=qjs
 WRAP_wrap_git_depth:=1
 
-.PHONY: qjs
+.PHONY: qjs_clean qjs_all
 
 qjs:
 	if [ ! -d "qjs" -o "7238ee64dbc2fbdea044555cda8cda78785a93ed" != "$(shell cd qjs 2>/dev/null && git rev-parse HEAD)" ]; then rm -rf "qjs"; ${MAKE} qjs_all; fi
diff --git a/subprojects/sdb.mk b/subprojects/sdb.mk
index 958905d8dcd4f..f697c3582aed5 100644
--- a/subprojects/sdb.mk
+++ b/subprojects/sdb.mk
@@ -5,7 +5,7 @@ WRAP_wrap_git_revision:=2.2.0
 WRAP_wrap_git_directory:=sdb
 WRAP_wrap_git_depth:=1
 
-.PHONY: sdb
+.PHONY: sdb_clean sdb_all
 
 sdb:
 	if [ ! -d "sdb" -o "2.2.0" != "$(shell cd sdb 2>/dev/null && git rev-parse HEAD)" ]; then rm -rf "sdb"; ${MAKE} sdb_all; fi
