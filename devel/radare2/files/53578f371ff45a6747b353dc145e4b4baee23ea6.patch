From 53578f371ff45a6747b353dc145e4b4baee23ea6 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Mon, 1 Sep 2025 05:40:15 +0800
Subject: [PATCH] core/cmd: fix environ for macOS

---
 libr/core/cmd.c          | 6 ++++++
 libr/core/cmd_anal.inc.c | 4 ++++
 2 files changed, 10 insertions(+)

diff --git a/libr/core/cmd.c b/libr/core/cmd.c
index 91e9afd472aa7..08dd4004a5d6a 100644
--- a/libr/core/cmd.c
+++ b/libr/core/cmd.c
@@ -10,6 +10,12 @@
 #ifndef __wasi__
 #include <pwd.h>
 #endif
+#ifdef __APPLE__
+#include <TargetConditionals.h>
+#if !TARGET_OS_IPHONE
+#include <crt_externs.h>
+#endif
+#endif
 #endif
 
 #define SPECIAL_CHARS "@;~$#|`\"'()<>"
diff --git a/libr/core/cmd_anal.inc.c b/libr/core/cmd_anal.inc.c
index b093cca1d3790..bfffa506714fd 100644
--- a/libr/core/cmd_anal.inc.c
+++ b/libr/core/cmd_anal.inc.c
@@ -9288,8 +9288,12 @@ static void cmd_anal_esil(RCore *core, const char *input, bool verbose) {
 				envp[i] = 0;
 #if R2__UNIX__
 				if (strstr (input, "$env")) {
+#if defined(__APPLE__) && !TARGET_OS_IPHONE
+					cmd_debug_stack_init (core, argc, argv, (*_NSGetEnviron()));
+#else
 					extern char **environ;
 					cmd_debug_stack_init (core, argc, argv, environ);
+#endif
 				} else {
 					cmd_debug_stack_init (core, argc, argv, envp);
 				}
