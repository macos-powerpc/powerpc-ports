# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           boost 1.0
PortGroup           cmake 1.1
PortGroup           github 1.0

boost.version       1.81

# 0.8.1 release assumes an old version of catch2
github.setup        arximboldi immer df6ef46d97e1fe81f397015b9aeb32505cef653b
version             2024.09.19
revision            0
categories          devel
platforms           any
license             Boost-1
maintainers         {@barracuda156 macos-powerpc.org:barracuda} openmaintainer
description         ${name} is a library of persistent and immutable data structures
long_description    {*}${description}, written in C++.
homepage            https://sinusoid.es/${name}
checksums           rmd160  60ce2eec827801b5f3a4fb8cad656cbb05e17573 \
                    sha256  debe8c5d465a53958142a3dc3cac015d1eb609f15f36fae6b966ab859aeb8a12 \
                    size    745022
github.tarball_from archive
supported_archs     noarch

set libfmt_v        11
cmake.module_path-append \
                    ${prefix}/lib/libfmt${libfmt_v}/cmake

# Library itself is header-only.
depends_build-append \
                    port:boehmgc \
                    port:catch2 \
                    port:libfmt${libfmt_v} \
                    path:bin/pkg-config:pkgconfig

# Build with -Werror fails:
# https://github.com/arximboldi/immer/issues/307
configure.args-append \
                    -DDISABLE_FREE_LIST=off \
                    -DDISABLE_THREAD_SAFETY=off \
                    -DDISABLE_WERROR=on \
                    -DENABLE_BOOST_COROUTINE=on \
                    -DENABLE_COVERAGE=off \
                    -DENABLE_GUILE=off \
                    -DENABLE_PYTHON=off \
                    -Dimmer_BUILD_DOCS=off \
                    -Dimmer_BUILD_EXAMPLES=off \
                    -Dimmer_BUILD_EXTRAS=off \
                    -Dimmer_BUILD_PERSIST_TESTS=off \
                    -Dimmer_BUILD_TESTS=on \
                    -Dimmer_INSTALL_FUZZERS=off

# At the moment fiber/coroutine libs are broken on powerpc64-apple-darwin9.
if {${configure.build_arch} eq "ppc64"} {
    configure.args-replace \
                    -DENABLE_BOOST_COROUTINE=on -DENABLE_BOOST_COROUTINE=off
}

# https://github.com/arximboldi/immer/issues/308
configure.cppflags-append \
                    -I${prefix}/include/libfmt11
configure.ldflags-append \
                    -L${prefix}/lib/libfmt11 -lfmt

compiler.cxx_standard  2014

# Some tests fail: https://github.com/arximboldi/immer/issues/309
# 97% tests passed, 3 tests failed out of 86
test.run            yes
test.target         check
