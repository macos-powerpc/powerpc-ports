# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               github 1.0
PortGroup               legacysupport 1.1
PortGroup               meson 1.0

set real_name           libplacebo
name                    ${real_name}-devel
github.setup            haasn ${real_name} bc90ef94944a3dcaab324b86d3e3769ad1d8698b
conflicts               ${real_name}
version                 2025.12.22
revision                0
categories              devel multimedia
license                 LGPL-2
maintainers             {i0ntempest @i0ntempest} {@barracuda156 macos-powerpc.org:barracuda} openmaintainer

description             Core rendering algorithms and ideas of mpv rewritten as an independent library
long_description        ${name} is, in a nutshell, the core rendering algorithms and ideas of mpv rewritten as \
                        an independent library. As of today, libplacebo contains a large assortment of video processing \
                        shaders, focusing on both quality and performance.
homepage                https://libplacebo.org

checksums               rmd160  705d46bbbda326994ef1eb76dfda53635c1b9aeb \
                        sha256  a7f97c961e24a8efc56a18c9af3bbf88410c6e5a75e1c60a24636bf20010e127 \
                        size    860061
github.tarball_from     archive

patch.pre_args-replace  -p0 -p1

# Wrong code in meson.build results in passing '' to the linker,
# which breaks the build. Why test anything, indeed...
patchfiles-append       patch-fix-silly-bug.diff

# We need to use dynamic lib, not static:
patchfiles-append       patch-spirv.diff

# Unbreak GL
patchfiles-append       0001-Restore-GL-3-support.patch

post-patch {
    reinplace "s|import\(\'python\'\).find_installation\(\)|import\(\'python\'\).find_installation\(\'${frameworks_dir}/Python.framework/Versions/${python_ver}/bin/python${python_ver}\'\)|" \
        ${worksrcpath}/meson.build
}

set python_ver          3.13
set python_branch       [string map {. {}} ${python_ver}]

# Vulkan headers required regardless of vulkan feature
depends_build-append    port:fast-float \
                        path:bin/pkg-config:pkgconfig \
                        port:py${python_branch}-jinja2 \
                        port:vulkan-headers

depends_lib-append      port:lcms2 \
                        port:xxhashlib

configure.args-append   -Dd3d11=disabled \
                        -Ddovi=enabled \
                        -Ddemos=true \
                        -Dgl-proc-addr=disabled \
                        -Dglslang=disabled \
                        -Dlcms=enabled \
                        -Dlibdovi=disabled \
                        -Dopengl=disabled \
                        -Dshaderc=disabled \
                        -Dtests=false \
                        -Dunwind=disabled \
                        -Dvk-proc-addr=disabled \
                        -Dvulkan=disabled \
                        -Dxxhash=enabled

compiler.c_standard     2011
compiler.cxx_standard   2020
# Undefined symbols: "std::__1::to_chars(char*, char*, double)"
legacysupport.newest_darwin_requires_legacy \
                        21
legacysupport.use_mp_libcxx \
                        yes

# Hack due to our changes:
# src/renderer.c:2379:41: error: incompatible pointer to integer conversion initializing
# 'ident_t' (aka 'unsigned short') with an expression of type 'const char *' [-Wint-conversion]
configure.cflags-append -Wno-error=int-conversion

variant demo description "Build demo programs" {
    configure.args-replace \
                        -Ddemos=false \
                        -Ddemos=true
}

variant glslang description "Enable glslang SPIR-V compiler" {
    depends_lib-append  port:glslang
    configure.args-replace \
                        -Dglslang=disabled \
                        -Dglslang=enabled
}

variant opengl description "Enable OpenGL support" {
    depends_build-append \
                        port:py${python_branch}-glad2
    configure.args-replace \
                        -Dopengl=disabled \
                        -Dopengl=enabled
    configure.args-replace \
                        -Dgl-proc-addr=disabled \
                        -Dgl-proc-addr=enabled
}

variant shaderc description "Enable glslang shaderc" {
    depends_lib-append  port:shaderc
    configure.args-replace \
                        -Dshaderc=disabled \
                        -Dshaderc=enabled
}

variant vulkan description "Enable Vulkan support" {
    depends_lib-append  port:vulkan-loader
    configure.args-replace \
                        -Dvulkan=disabled \
                        -Dvulkan=enabled
    configure.args-replace \
                        -Dvk-proc-addr=disabled \
                        -Dvk-proc-addr=enabled
}

default_variants-append +opengl
