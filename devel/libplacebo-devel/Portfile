# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               github 1.0
PortGroup               legacysupport 1.1
PortGroup               meson 1.0

set real_name           libplacebo
name                    ${real_name}-devel
github.setup            haasn ${real_name} 63a3d64ac32eaaa56aa60b5000d43c02544c6508
conflicts               ${real_name}
version                 2025.10.06
revision                0
categories              devel multimedia
license                 LGPL-2
maintainers             {i0ntempest @i0ntempest} openmaintainer

description             Core rendering algorithms and ideas of mpv rewritten as an independent library
long_description        ${name} is, in a nutshell, the core rendering algorithms and ideas of mpv rewritten as \
                        an independent library. As of today, libplacebo contains a large assortment of video processing \
                        shaders, focusing on both quality and performance.
homepage                https://libplacebo.org

checksums               rmd160  afc430e5c871e1daa48551793ed2f0eceb35afc9 \
                        sha256  378c4ab014bbbfb0e028952acd5d370c86e064b39ae3b3fe113f7b7594517a24 \
                        size    858851
github.tarball_from     archive

set python_ver          3.12
set python_branch       [string map {. {}} ${python_ver}]

# Vulkan headers required regardless of vulkan feature
depends_build-append    port:fast-float \
                        path:bin/pkg-config:pkgconfig \
                        port:py${python_branch}-jinja2 \
                        port:vulkan-headers

depends_lib-append      port:lcms2 \
                        port:xxhashlib

configure.args-append   -Dd3d11=disabled \
                        -Ddovi=enabled \
                        -Ddemos=true \
                        -Dgl-proc-addr=disabled \
                        -Dglslang=disabled \
                        -Dlcms=enabled \
                        -Dlibdovi=disabled \
                        -Dopengl=disabled \
                        -Dshaderc=enabled \
                        -Dtests=false \
                        -Dunwind=disabled \
                        -Dvk-proc-addr=disabled \
                        -Dvulkan=disabled \
                        -Dxxhash=enabled

patch.pre_args-replace  -p0 -p1

# Wrong code in meson.build results in passing '' to the linker,
# which breaks the build. Why test anything, indeed...
patchfiles-append       patch-fix-silly-bug.diff

# Unbreak GL
patchfiles-append       0001-Restore-GL-3-support.patch

post-patch {
    reinplace "s|import\(\'python\'\).find_installation\(\)|import\(\'python\'\).find_installation\(\'${frameworks_dir}/Python.framework/Versions/${python_ver}/bin/python${python_ver}\'\)|" \
        ${worksrcpath}/meson.build
}

compiler.c_standard     2011
compiler.cxx_standard   2020
# Undefined symbols: "std::__1::to_chars(char*, char*, double)"
legacysupport.newest_darwin_requires_legacy \
                        21
legacysupport.use_mp_libcxx \
                        yes

# Hack due to our changes:
# src/renderer.c:2379:41: error: incompatible pointer to integer conversion initializing
# 'ident_t' (aka 'unsigned short') with an expression of type 'const char *' [-Wint-conversion]
configure.cflags-append -Wno-error=int-conversion

variant opengl description {enable OpenGL support} {
    depends_build-append \
                        port:py${python_branch}-glad2
    configure.args-replace \
                        -Dopengl=disabled \
                        -Dopengl=enabled
    configure.args-replace \
                        -Dgl-proc-addr=disabled \
                        -Dgl-proc-addr=enabled
}

variant vulkan description {enable Vulkan support} {
    depends_lib-append  port:vulkan-loader
    configure.args-replace \
                        -Dvulkan=disabled \
                        -Dvulkan=enabled
    configure.args-replace \
                        -Dvk-proc-addr=disabled \
                        -Dvk-proc-addr=enabled
}

variant demo description {build demo programs} {
    configure.args-replace \
                        -Ddemos=false \
                        -Ddemos=true
}

variant glslang description {enable glslang SPIR-V compiler} {
    depends_lib-append  port:glslang
    configure.args-replace \
                        -Dglslang=disabled \
                        -Dglslang=enabled
}

default_variants-append +opengl
