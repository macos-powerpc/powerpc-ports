# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem                          1.0
PortGroup                           github 1.0
PortGroup                           legacysupport 1.1
PortGroup                           makefile 1.0

# utimensat
legacysupport.newest_darwin_requires_legacy 16

github.setup                        actboy168 luamake 1.7 v
revision                            0
categories                          devel lua
license                             MIT
maintainers                         {mcalhoun @MarcusCalhoun-Lopez} openmaintainer
description                         a platform independent configuration and build system that uses \
                                    the standard Lua command-line interpreter
long_description                    luamake is {*}${description}.

checksums                           rmd160  2a921a7d979e33a56b6e14347abc5ffbbfe7c249 \
                                    sha256  68997d895ba371ab2f3e529344131544d15479085c33768b9c5a91374e7d6202 \
                                    size    73557

fetch.type                          git
post-extract {
    system -W ${worksrcpath}        "git submodule update --init"
}

# no Lua dependency
# luamake uses bee.lua, which seems to reimplement parts of Lua
# see https://github.com/actboy168/bee.lua

depends_lib                         port:ninja
compiler.cxx_standard               2017

installs_libs                       no

patchfiles-append                   patch-macos.ninja.diff \
                                    patch-lua_platform.diff \
                                    patch-endpoint.diff

# For some reason MacPorts decided to break a working patch in the last update,
# so fix it back:
patchfiles-append                   patch-unbreak-linking.diff

if {${os.platform} eq "darwin" && ${os.major} < 11} {
    patchfiles-append               patch-filewatch_osx.diff \
                                    patch-version-legacy.diff \
                                    patch-test_filewatch.diff
}

post-extract {
    xinstall -m 0644                ${filespath}/Makefile \
                                    ${worksrcpath}
}

destroot {
    # do not pollute ${prefix}/bin with all the extra files and directories that are required to be in the same director as the luamake binary
    set bindir                      ${prefix}/libexec/${name}/bin

    set script                      [open "${destroot}${prefix}/bin/luamake" w 0755]
    puts ${script}                  "#!/bin/sh"
    puts ${script}                  ""
    puts ${script}                  "exec ${bindir}/luamake \"$@\""
    close ${script}

    xinstall -d -m 0755             ${destroot}${bindir}

    xinstall -m 0755                ${worksrcpath}/luamake \
                                    ${destroot}${bindir}

    xinstall -m 0644                ${worksrcpath}/main.lua \
                                    ${destroot}${bindir}

    foreach dir {scripts tools} {
        xinstall -d -m 0755         ${destroot}${bindir}/${dir}
        fs-traverse -tails f        ${worksrcpath}/${dir} {
            if {[file isdirectory   ${worksrcpath}/${dir}/${f}]} {
                xinstall -d -m 0755 ${destroot}${bindir}/${dir}/${f}
            } else {
                xinstall -m 0644    ${worksrcpath}/${dir}/${f} \
                                    ${destroot}${bindir}/${dir}/${f}
            }
        }
    }
}
