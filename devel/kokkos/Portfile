# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem                  1.0
PortGroup                   cmake 1.1
PortGroup                   github 1.0

# TODO: update to 5.x branch once confirmed all is good.
github.setup                kokkos kokkos 4.7.02
conflicts                   kokkos-devel
revision                    0
categories                  devel
license                     BSD
maintainers                 {mcalhoun @MarcusCalhoun-Lopez} \
                            {@barracuda156 macos-powerpc.org:barracuda} \
                            openmaintainer
description                 implements a programming model in C++ for writing performance portable applications \
                            targeting all major HPC platforms
long_description            Kokkos Core {*}${description}.

checksums                   rmd160  b1aca233485a15a5c574751317afd9801153abe1 \
                            sha256  a81826ac0a167933d13506bc2a986fb5517038df9abb780fe9bb2c1d4e80803b \
                            size    2523459
github.tarball_from         releases

subport kokkos-devel {
    github.setup            kokkos kokkos 384e3179f2161a4a81a2f104603930fa62520a7d
    version                 5.0-2026.02.07
    revision                0
    epoch                   1
    conflicts               kokkos
    checksums               rmd160  ebfbe596b5bbf3ea784127dac21c692518552867 \
                            sha256  ad71bf1ddeaf4723b0c1e13baf5be7ffdd24cca57ef495c73e4697cb99be59cf \
                            size    1778456
    github.tarball_from     archive
    github.livecheck.branch develop
    # Kokkos_HostSpace.cpp:79:11: error: aligned allocation function
    # of type 'void *(std::size_t, std::align_val_t, const std::nothrow_t &)
    # noexcept' is only available on macOS 10.13 or newer
    if {${os.platform} eq "darwin" && ${os.major} < 17} {
        if {${configure.cxx_stdlib} eq "libc++"} {
            configure.cxxflags-append -fno-aligned-allocation
        }
    }
}

if {${subport} eq "kokkos-devel"} {
    compiler.cxx_standard   2020
} else {
    compiler.cxx_standard   2017
}
compiler.openmp_version     4.0

depends_lib-append          port:hwloc

configure.args-append       -DBUILD_SHARED_LIBS=ON \
                            -DKokkos_ENABLE_HWLOC=ON \
                            -DKokkos_ENABLE_OPENMP=ON \
                            -DKokkos_ENABLE_SERIAL=ON

# see https://github.com/macports/macports-base/commit/7c91604891fa0d071b8d598490c4dc2edb8e0031
# see https://github.com/macports/macports-ports/pull/17877#discussion_r1183486766
compiler.log_verbose_output no

variant tests description {Enable tests} {
    configure.args-append   -DKokkos_ENABLE_TESTS=ON
    configure.pre_args-replace \
                            -DCMAKE_BUILD_WITH_INSTALL_RPATH:BOOL=ON \
                            -DCMAKE_BUILD_WITH_INSTALL_RPATH:BOOL=OFF
    test.run                yes
}
