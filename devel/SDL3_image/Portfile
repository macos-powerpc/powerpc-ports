# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem      1.0
PortGroup       cmake 1.1
PortGroup       github 1.0

name            SDL3_image

# Update together with SDL3 port update.
github.setup    libsdl-org SDL_image 3.2.6 release-
revision        0
categories      devel graphics
license         zlib
maintainers     {jmr @jmroot} openmaintainer
description     Add-on library for libSDL handling several image formats

long_description \
    This is a simple library to load images of various formats as SDL surfaces. \
    This library supports BMP, PPM, PCX, GIF, JPEG, PNG, TGA and TIFF formats.

github.tarball_from releases
distname        ${name}-${version}

checksums       rmd160  ccd6f45762c7fa258ca9dd9caf8c6b6b97caa5fc \
                sha256  2daee16e6f8f9ea1c59ea243c0b089e2a2c7a2c402efa67f291a6359e5bd50d2 \
                size    10705194

# Disable broken compilers:
# SDL_stdinc.h:1149: error: size of array ‘SDL_compile_time_assert_bool_size’ is negative
compiler.blacklist  *clang* *gcc-4.*

depends_build-append \
                path:bin/pkg-config:pkgconfig
depends_lib     path:include/turbojpeg.h:libjpeg-turbo \
                port:libpng \
                port:SDL3 \
                port:tiff \
                port:webp \
                port:zlib

# STB disabled due to: https://github.com/Green-Sky/tomato/issues/53
configure.args-append \
                -DSDLIMAGE_AVIF=OFF \
                -DSDLIMAGE_BACKEND_IMAGEIO=OFF \
                -DSDLIMAGE_BACKEND_STB=OFF \
                -DSDLIMAGE_DEPS_SHARED=OFF \
                -DSDLIMAGE_INSTALL_MAN=ON \
                -DSDLIMAGE_JPG=ON \
                -DSDLIMAGE_JXL=OFF \
                -DSDLIMAGE_PNG=ON \
                -DSDLIMAGE_SAMPLES=OFF \
                -DSDLIMAGE_STRICT=ON

post-destroot {
    set docdir ${prefix}/share/doc/${name}
    xinstall -d ${destroot}${docdir}
    xinstall -m 0644 -W ${worksrcpath} CHANGES.txt README.md \
        ${destroot}${docdir}
}

subport ${name}-devel {
    github.setup    libsdl-org SDL_image 3.4.0 release-
    revision        0
    checksums       rmd160  357fc2058e1d69dbf4b87e61381cf3f88ed7e035 \
                    sha256  2ceb75eab4235c2c7e93dafc3ef3268ad368ca5de40892bf8cffdd510f29d9d8 \
                    size    11133814
    github.tarball_from releases
    distname        SDL3_image-${version}

    depends_lib-replace     port:SDL3 port:SDL3-devel
}

variant jxl description "Enable JPEG XL support (experimental)" {
    depends_lib-append      port:libjxl
    configure.args-replace  -DSDLIMAGE_JXL=OFF \
                            -DSDLIMAGE_JXL=ON
}

post-destroot {
    system "install_name_tool -id ${prefix}/lib/libSDL3_image.dylib ${destroot}${prefix}/lib/libSDL3_image.dylib"
}
