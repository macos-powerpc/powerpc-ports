From 24a01fe273d830de5ad0c916d6b4416d9514bb30 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Tue, 4 Feb 2025 11:59:07 +0800
Subject: [PATCH 10/10] Fix tray

---
 CMakeLists.txt           | 7 ++++++-
 src/tray/unix/SDL_tray.c | 6 ++++++
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git CMakeLists.txt CMakeLists.txt
index 76c79d0d8..1fa498ccb 100644
--- CMakeLists.txt
+++ CMakeLists.txt
@@ -386,6 +386,7 @@
 set_option(SDL_ASAN                "Use AddressSanitizer to detect memory errors" OFF)
 set_option(SDL_CCACHE              "Use Ccache to speed up build" OFF)
 set_option(SDL_CLANG_TIDY          "Run clang-tidy static analysis" OFF)
+set_option(SDL_COCOA_TRAY          "Cocoa Tray on macOS" ON "APPLE" OFF)
 
 set(SDL_VENDOR_INFO "" CACHE STRING "Vendor name and/or version to add to SDL_REVISION")
 
@@ -2728,7 +2736,14 @@
   endif()
 
   if(SDL_TRAY AND MACOS)
-    sdl_glob_sources("${SDL3_SOURCE_DIR}/src/tray/cocoa/*.m")
+    if(SDL_COCOA_TRAY)
+      sdl_glob_sources("${SDL3_SOURCE_DIR}/src/tray/cocoa/*.m")
+    else()
+      sdl_glob_sources(
+        "${SDL3_SOURCE_DIR}/src/tray/unix/*.c"
+        "${SDL3_SOURCE_DIR}/src/core/unix/SDL_gtk.*"
+      )
+    endif()
     set(HAVE_SDL_TRAY TRUE)
   endif()
 
diff --git src/tray/unix/SDL_tray.c src/tray/unix/SDL_tray.c
index 5f017c2f5..9f0983529 100644
--- src/tray/unix/SDL_tray.c
+++ src/tray/unix/SDL_tray.c
@@ -82,6 +82,8 @@
 #ifdef SDL_PLATFORM_OPENBSD
     "libayatana-appindicator3.so",
     "libappindicator3.so",
+#elif SDL_PLATFORM_APPLE
+    "libayatana-appindicator3.dylib",
 #else
     "libayatana-appindicator3.so.1",
     "libappindicator3.so.1",
