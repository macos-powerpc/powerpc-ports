From d722c5df0b18b08ec6cb26f03ddaafe7836bd2d4 Mon Sep 17 00:00:00 2001
From: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
Date: Fri, 27 Jan 2023 15:02:01 -0800
Subject: [PATCH 07/18] darwin: Locate libffi with cc.find_library() rather
 than dependency()

Signed-off-by: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
---
 meson.build      | 7 ++++++-
 src/connection.c | 4 ++++
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/meson.build b/meson.build
index c95134d..eb5614a 100644
--- a/meson.build
+++ b/meson.build
@@ -82,7 +82,12 @@ if get_option('libraries')
 		# Otherwise, assume that epoll(7) is supported natively.
 		epoll_dep = []
 	endif
-	ffi_dep = dependency('libffi')
+
+	if host_machine.system() == 'darwin'
+		ffi_dep = cc.find_library('ffi')
+	else
+		ffi_dep = dependency('libffi')
+	endif
 
 	decls = [
 		{ 'header': 'sys/signalfd.h', 'symbol': 'SFD_CLOEXEC' },
diff --git a/src/connection.c b/src/connection.c
index 3ef8688..d72cafd 100644
--- a/src/connection.c
+++ b/src/connection.c
@@ -38,7 +38,11 @@
 #include <sys/types.h>
 #include <sys/socket.h>
 #include <time.h>
+#ifdef __APPLE__
+#include <ffi/ffi.h>
+#else
 #include <ffi.h>
+#endif
 
 #include "wayland-util.h"
 #include "wayland-private.h"
-- 
2.24.3 (Apple Git-128)

