From b43473f80afd8083c7de7ae09c25e95583d7455d Mon Sep 17 00:00:00 2001
From: Weijia Wang <contact@weijia.wang>
Date: Thu, 28 Jul 2022 01:37:50 +0200
Subject: [PATCH 03/18] os: Provide wl_os_socketpair_cloexec wrapper for
 systems without SOCK_CLOEXEC

Reviewed-by: Jeremy Huddleston Sequoia <jeremyhu@apple.com>
Signed-off-by: Weijia Wang <contact@weijia.wang>
---
 src/wayland-os.c         | 20 ++++++++++++++++++++
 src/wayland-os.h         |  3 +++
 tests/client-test.c      |  3 ++-
 tests/connection-test.c  |  9 +++++----
 tests/os-wrappers-test.c | 10 ++++++++--
 tests/resources-test.c   |  7 ++++---
 6 files changed, 42 insertions(+), 10 deletions(-)

diff --git a/src/wayland-os.c b/src/wayland-os.c
index 87ab6d3..fa00338 100644
--- a/src/wayland-os.c
+++ b/src/wayland-os.c
@@ -87,6 +87,26 @@ wl_os_socket_cloexec(int domain, int type, int protocol)
 	return set_cloexec_or_close(fd);
 }
 
+int
+wl_os_socketpair_cloexec(int domain, int type, int protocol, int sv[2])
+{
+	int retval;
+
+#ifdef SOCK_CLOEXEC
+	retval = socketpair(domain, type | SOCK_CLOEXEC, protocol, sv);
+	if (retval >= 0)
+		return retval;
+	if (errno != EINVAL)
+		return -1;
+#endif
+
+	retval = socketpair(domain, type, protocol, sv);
+	if (set_cloexec_or_close(sv[0]) == -1 || set_cloexec_or_close(sv[1]) == -1)
+		retval = -1;
+
+	return retval;
+}
+
 #if defined(__FreeBSD__)
 int
 wl_os_socket_peercred(int sockfd, uid_t *uid, gid_t *gid, pid_t *pid)
diff --git a/src/wayland-os.h b/src/wayland-os.h
index 068fd2f..42e2800 100644
--- a/src/wayland-os.h
+++ b/src/wayland-os.h
@@ -32,6 +32,9 @@
 int
 wl_os_socket_cloexec(int domain, int type, int protocol);
 
+int
+wl_os_socketpair_cloexec(int domain, int type, int protocol, int sv[2]);
+
 int
 wl_os_socket_peercred(int sockfd, uid_t *uid, gid_t *gid, pid_t *pid);
 
diff --git a/tests/client-test.c b/tests/client-test.c
index 5585c0c..5589e5e 100644
--- a/tests/client-test.c
+++ b/tests/client-test.c
@@ -34,6 +34,7 @@
 #include <sys/types.h>
 #include <sys/stat.h>
 
+#include "wayland-os.h"
 #include "wayland-private.h"
 #include "wayland-server.h"
 #include "test-runner.h"
@@ -97,7 +98,7 @@ TEST(client_destroy_listener)
 	bool user_data_destroyed = false;
 	int s[2];
 
-	assert(socketpair(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0, s) == 0);
+	assert(wl_os_socketpair_cloexec(AF_UNIX, SOCK_STREAM, 0, s) == 0);
 	display = wl_display_create();
 	assert(display);
 	client = wl_client_create(display, s[0]);
diff --git a/tests/connection-test.c b/tests/connection-test.c
index aed97a0..753091c 100644
--- a/tests/connection-test.c
+++ b/tests/connection-test.c
@@ -37,6 +37,7 @@
 #include <sys/stat.h>
 #include <poll.h>
 
+#include "wayland-os.h"
 #include "wayland-private.h"
 #include "test-runner.h"
 #include "test-compositor.h"
@@ -48,7 +49,7 @@ setup(int *s)
 {
 	struct wl_connection *connection;
 
-	assert(socketpair(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0, s) == 0);
+	assert(wl_os_socketpair_cloexec(AF_UNIX, SOCK_STREAM, 0, s) == 0);
 
 	connection = wl_connection_create(s[0], WL_BUFFER_DEFAULT_MAX_SIZE);
 	assert(connection);
@@ -181,8 +182,8 @@ struct marshal_data {
 static void
 setup_marshal_data(struct marshal_data *data)
 {
-	assert(socketpair(AF_UNIX,
-			  SOCK_STREAM | SOCK_CLOEXEC, 0, data->s) == 0);
+	assert(wl_os_socketpair_cloexec(AF_UNIX,
+			  SOCK_STREAM, 0, data->s) == 0);
 	data->read_connection = wl_connection_create(data->s[0],
 						     WL_BUFFER_DEFAULT_MAX_SIZE);
 	assert(data->read_connection);
@@ -885,7 +886,7 @@ TEST(request_bogus_size)
 	for (bogus_size = 11; bogus_size >= 0; bogus_size--) {
 		fprintf(stderr, "* bogus size %d\n", bogus_size);
 
-		assert(socketpair(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0, s) == 0);
+		assert(wl_os_socketpair_cloexec(AF_UNIX, SOCK_STREAM, 0, s) == 0);
 		display = wl_display_create();
 		assert(display);
 		client = wl_client_create(display, s[0]);
diff --git a/tests/os-wrappers-test.c b/tests/os-wrappers-test.c
index 56ef4af..087d539 100644
--- a/tests/os-wrappers-test.c
+++ b/tests/os-wrappers-test.c
@@ -61,10 +61,12 @@ socket_wrapper(int domain, int type, int protocol)
 {
 	wrapped_calls_socket++;
 
+#ifdef SOCK_CLOEXEC
 	if (fall_back && (type & SOCK_CLOEXEC)) {
 		errno = EINVAL;
 		return -1;
 	}
+#endif
 
 	return socket(domain, type, protocol);
 }
@@ -160,7 +162,11 @@ do_os_wrappers_socket_cloexec(int n)
 	 * Must have 2 calls if falling back, but must also allow
 	 * falling back without a forced fallback.
 	 */
+#ifdef SOCK_CLOEXEC
 	assert(wrapped_calls_socket > n);
+#else
+	assert(wrapped_calls_socket == 1);
+#endif
 
 	exec_fd_leak_check(nr_fds);
 }
@@ -234,8 +240,8 @@ struct marshal_data {
 static void
 setup_marshal_data(struct marshal_data *data)
 {
-	assert(socketpair(AF_UNIX,
-			  SOCK_STREAM | SOCK_CLOEXEC, 0, data->s) == 0);
+	assert(wl_os_socketpair_cloexec(AF_UNIX,
+			  SOCK_STREAM, 0, data->s) == 0);
 
 	data->read_connection = wl_connection_create(data->s[0],
 						     WL_BUFFER_DEFAULT_MAX_SIZE);
diff --git a/tests/resources-test.c b/tests/resources-test.c
index 9270729..4a08446 100644
--- a/tests/resources-test.c
+++ b/tests/resources-test.c
@@ -28,6 +28,7 @@
 #include <unistd.h>
 #include <stdint.h>
 
+#include "wayland-os.h"
 #include "wayland-server.h"
 #include "test-runner.h"
 
@@ -40,7 +41,7 @@ TEST(create_resource_tst)
 	int s[2];
 	uint32_t id;
 
-	assert(socketpair(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0, s) == 0);
+	assert(wl_os_socketpair_cloexec(AF_UNIX, SOCK_STREAM, 0, s) == 0);
 	display = wl_display_create();
 	assert(display);
 	client = wl_client_create(display, s[0]);
@@ -111,7 +112,7 @@ TEST(destroy_res_tst)
 		.notify = &destroy_notify
 	};
 
-	assert(socketpair(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0, s) == 0);
+	assert(wl_os_socketpair_cloexec(AF_UNIX, SOCK_STREAM, 0, s) == 0);
 	display = wl_display_create();
 	assert(display);
 	client = wl_client_create(display, s[0]);
@@ -159,7 +160,7 @@ TEST(create_resource_with_same_id)
 	int s[2];
 	uint32_t id;
 
-	assert(socketpair(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0, s) == 0);
+	assert(wl_os_socketpair_cloexec(AF_UNIX, SOCK_STREAM, 0, s) == 0);
 	display = wl_display_create();
 	assert(display);
 	client = wl_client_create(display, s[0]);
-- 
2.24.3 (Apple Git-128)

