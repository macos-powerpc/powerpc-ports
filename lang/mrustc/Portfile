# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           legacysupport 1.1

# FIXME: as of now, mrustc looks working on powerpc,
# while rustc builds up to initial executable, but it fails to run:
# error: Could not create LLVM TargetMachine for triple: ppc-apple-darwin: No available targets are compatible with this triple.
# powerpc-apple-darwin, powerpc-apple-darwin10.8.0, powerpc-apple-macosx10.6.0 were tried and failed identically.
# It is unclear why this is broken, and therefore how to fix it.

github.setup        thepowersgang mrustc 4276e5c35bf3d6bdeb06a6b0194c594681fbea0e

# When updated, please also update rustc_target_ver in cargo PG:
set rust_version    1.54.0
set rust_version_major [join [lrange [split ${rust_version} .-] 0 1] .]
set rust_version_major_underscore [join [lrange [split ${rust_version} .-] 0 1] _]

# Subport mrustc-rust has its own versioning
version             ${rust_version_major}-20251122
revision            0
epoch               1

categories          lang devel
license             MIT
maintainers         {@catap korins.ky:kirill} {@barracuda156 macos-powerpc.org:barracuda}
description         Alternative implementation of Rust
long_description    In-progress alternative Rust compiler. Capable of building \
                    a fully-working copy of rustc, but not suitable for everyday use \
                    (due to inadequate error messages).

set llvm_branch     7
set llvm_distver    ${llvm_branch}.1.0

# TODO: can gcc emutls be used instead?
master_sites-append https://static.rust-lang.org/dist/:rust \
                    https://releases.llvm.org/${llvm_distver}:compiler-rt \
                    https://github.com/crossbeam-rs/crossbeam/archive/refs/tags/:crossbeam

# TODO: this was a hack due to: https://github.com/crossbeam-rs/crossbeam/issues/1213
# Unneeded now, I think. See also: https://github.com/thepowersgang/mrustc/issues/381
set crossbeam_ver   0.8.4

distfiles-append    rustc-${rust_version}-src.tar.gz:rust \
                    compiler-rt-${llvm_distver}.src.tar.xz:compiler-rt \
                    crossbeam-utils-${crossbeam_ver}.tar.gz:crossbeam

checksums           mrustc-${github.version}.tar.gz \
                    rmd160  b4bc7be5460e96c7c3fc8863711060d4cac955e4 \
                    sha256  143d91e1a3ff28128bfa3ed64886ece336da5b3381934f90a121d191a5ee2d1f \
                    size    1383590 \
                    rustc-${rust_version}-src.tar.gz \
                    rmd160  be2de16e2deaf91aee723e631a36f6de52636ddd \
                    sha256  ac8511633e9b5a65ad030a1a2e5bdaa841fdfe3132f2baaa52cc04e71c6c6976 \
                    size    170480637 \
                    compiler-rt-${llvm_distver}.src.tar.xz \
                    rmd160  78fb2825ffecd83c8efc7d1d42ca67600b914fd2 \
                    sha256  057bdac0581215b5ceb39edfd5bbef9eb79578f16a8908349f3066251fba88d8 \
                    size    1864248 \
                    crossbeam-utils-${crossbeam_ver}.tar.gz \
                    rmd160  2a4d50bd1da7bcda35d604bbc94a68f0f9531b73 \
                    sha256  b558224e746845c06145da7d4e83cded78a4a1cc605a3e072b9a66c6977b26e5 \
                    size    250594
github.tarball_from archive

extract.only        mrustc-${github.version}.tar.gz rustc-${rust_version}-src.tar.gz crossbeam-utils-${crossbeam_ver}.tar.gz

depends_extract-append \
                    bin:xz:xz
depends_skip_archcheck xz

post-extract {
    system -W ${workpath} "xz -dc [shellescape ${distpath}/compiler-rt-${llvm_distver}.src.tar.xz] | ${portutil::autoconf::tar_command} -xf -"

#    delete -force ${workpath}/rustc-${rust_version}-src/vendor/crossbeam-utils
#    move ${workpath}/crossbeam-crossbeam-utils-${crossbeam_ver}/crossbeam-utils ${workpath}/rustc-${rust_version}-src/vendor/crossbeam-utils
}

set rust_platforms(arm64)  aarch64
set rust_platforms(ppc)    powerpc
set rust_platforms(ppc64)  powerpc64

if {![info exists rust_platforms(${configure.build_arch})]} {
    set rust_platforms(${configure.build_arch}) ${configure.build_arch}
}

set rust_platform   $rust_platforms(${configure.build_arch})

use_configure       no

universal_variant   no

compiler.cxx_standard 2014
compiler.c_standard 2011
compiler.thread_local_storage yes

# Officially tested with GCC 5.4+
compiler.blacklist *gcc-4.*

# See https://github.com/thepowersgang/mrustc/issues/255
compiler.blacklist-append {clang < 1300} {macports-clang-3.[0-9]} macports-clang-4.0

# A C compiler is needed at run-time; it doesn't have to be the same version as
# the C++ compiler used to compile mrustc, but we'll use that one as the default,
# and declare the dependency here
if {[string match macports-clang-* ${configure.compiler}]} {
    depends_run-append \
                    port:[string map {"macports-" ""} ${configure.compiler}]
}
if {[string match macports-gcc-* ${configure.compiler}]} {
    depends_run-append \
                   port:[string map {"macports-gcc-" "gcc"} ${configure.compiler}]

    # GCC requires linking with libatomic
    # See: https://github.com/thepowersgang/mrustc/issues/214
    # See: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=81358
    post-patch {
        set script [open "${worksrcpath}/script-overrides/stable-${rust_version}-macos/build_libc.txt" a]
        puts ${script} "cargo:rustc-link-lib=atomic"
        close ${script}
    }
}

post-extract {
    # Prevent it from re-download sources
    ln -sf ${distpath}/rustc-${rust_version}-src.tar.gz ${worksrcpath}/rustc-${rust_version}-src.tar.gz
    ln -sf ${workpath}/rustc-${rust_version}-src ${worksrcpath}/rustc-${rust_version}-src
    touch ${workpath}/rustc-${rust_version}-src/dl-version
    touch ${workpath}/rustc-${rust_version}-src/extracted
    
    ln -sf ${workpath}/compiler-rt-${llvm_distver}.src ${workpath}/compiler-rt
}

pre-patch {
    # Patch mrustc
    # https://github.com/thepowersgang/mrustc/issues/367
    # Notice, we do not set correct arch targets for LLVM at all, since it is not being built.
    system -W ${workpath}/${name}-${github.version} "patch -p1 < [shellescape ${filespath}/mrustc-minicargo.mk-use-external-llvm.patch]"
    # https://github.com/thepowersgang/mrustc/issues/368
    system -W ${workpath}/${name}-${github.version} "patch -p1 < [shellescape ${filespath}/mrustc-codegen_c.cpp-clang-does-not-accept-fno-tree-sra.patch]"
    # Fix unions
    system -W ${workpath}/${name}-${github.version} "patch -p1 < [shellescape ${filespath}/mrustc-target.cpp-fix-unions-for-powerpc.patch]"
    # Provisional extra fixes for powerpc (unconfirmed)
    system -W ${workpath}/${name}-${github.version} "patch -p1 < [shellescape ${filespath}/mrustc-powerpc-enum.patch]"
    system -W ${workpath}/${name}-${github.version} "patch -p1 < [shellescape ${filespath}/mrustc-codegen-target-minor-fix-to-struct-logic.patch]"
    system -W ${workpath}/${name}-${github.version} "patch -p1 < [shellescape ${filespath}/mrustc-target.cpp-minor-tweak-re-padding.patch]"
    # Can deal with tweaks once the build is working in full
    system -W ${workpath}/${name}-${github.version} "patch -p1 < [shellescape ${filespath}/mrustc-codegen_c.cpp-temporarily-disable-asserts-on-powerpc.patch]"
    # https://github.com/crossbeam-rs/crossbeam/issues/1213
    system -W ${workpath}/${name}-${github.version} "patch -p1 < [shellescape ${filespath}/mrustc-target.cpp-enable-16-bit-atomics-on-powerpc.patch]"

    # Patch the Rust source code with the patch included with mrustc
    system -W ${workpath}/rustc-${rust_version}-src "patch -p0 < [shellescape ${worksrcpath}/rustc-${rust_version}-src.patch]"
}

patch.dir           ${workpath}/rustc-${rust_version}-src
patch.pre_args-replace  -p0 -p1

# We need llvm-7 for now:
patchfiles-append   0001-Compat-fixes-for-llvm-7.patch \
                    0002-Trash-hwasan.patch \
                    0003-Revert-bc96516a28d9e8e816b0f45c628a9cd49a2f380d.patch \
                    0004-x86_64-target-128-bit-atomics-is-broken-default-to-6.patch \
                    0005-no-tiny-codemodel.patch

# Add powerpc into rustc:
patchfiles-append   0006-Add-powerpc-apple-darwin-targets.patch \
                    0007-vendor-libc.patch \
                    0008-vendor-libbacktrace.patch \
                    0009-vendor-jemalloc-archs.patch

# Unverified:
patchfiles-append   0010-ffi.rs-adjust-powerpc-for-macOS.patch

# FIXME: https://github.com/gimli-rs/object/issues/824
patchfiles-append   0011-vendor-object.patch

# FIXME: https://github.com/rust-lang/stacker/issues/132
platform darwin {
    patchfiles-append \
                    0012-vendor-psm-powerpc.patch
}

# FIXME: https://github.com/indexmap-rs/indexmap/issues/428
patchfiles-append   0013-vendor-indexmap-randomstate.patch

if {${configure.build_arch} in [list i386 ppc]} {
    # Revert breakage from https://github.com/rust-lang/rust/commit/f30cc74
    patchfiles-append \
                    0014-std-fix-time.patch

    # FIXME: it is supposed to pick settings from no_atomics.rs, but for w/e reason is does not.
    patchfiles-append \
                    0015-vendor-crossbeam-utils-no-64-atomics.patch
}

# Unverified
patchfiles-append   0016-Hack-around-invalid-xcrun-syntax.patch

if {${configure.cxx_stdlib} ne "libc++"} {
    patchfiles-append \
                    0017-Make-sane-choices-for-C-runtime-on-macOS.patch
}

# Patches as git tree: https://github.com/catap/rust-legacy-bootstrap/tree/1.54.0
patchfiles-append   1001-Introduced-support-of-MACPORTS_LEGACY_SUPPORT_.patch \
                    1002-curl-sys-never-try-to-link-with-lib-darwin.patch \
                    1003-libgit2-sys-use-src-instead-.git-as-vendored-indicat.patch \
                    1004-libssh2-sys-use-src-instead-.git-as-vendored-indicat.patch \
                    1005-libgit2-sys-recovered-LIBGIT2_SYS_USE_PKG_CONFIG.patch

if {${os.platform} eq "darwin" && ${os.major} < 12} {
    patchfiles-append \
                    1006-macOS-10.7-Switch-to-OpenSSL.patch
}

if {${os.platform} eq "darwin" && ${os.major} < 11} {
    patchfiles-append \
                    1007-macOS-10.6-enforce-emulated-TLS-via-LLVM.patch \
                    1008-macOS-10.6-Fix-pthread_cond_destroy.patch

    set libemutls ${workpath}/libemutls
    set libemutls_a ${libemutls}/libemutls.a
    set emutls_c ${workpath}/compiler-rt/lib/builtins/emutls.c

    build.env-append \
                    MRUSTC_LIBDIR=${libemutls}

    post-patch {
        set script [open "${worksrcpath}/script-overrides/stable-${rust_version}-macos/build_std.txt" a]
        puts ${script} "cargo:rustc-cfg=target_enforce_emulated_tls"
        puts ${script} "cargo:rustc-link-lib=static=emutls"
        close ${script}
    }

    pre-build {
        file mkdir ${libemutls}
        system "${configure.cc} ${configure.cflags} [get_canonical_archflags cc] -c -o ${libemutls_a} ${emutls_c}"

        set libemutls_s ${worksrcpath}/run_rustc/output-${rust_version}/prefix-s/lib/rustlib/${rust_platform}-apple-darwin/lib
        file mkdir ${libemutls_s}
        file copy -force {*}[glob ${libemutls}/*] ${libemutls_s}
    }
}

legacysupport.use_static    yes

set cxxflags        "${configure.cxxflags}"
set ldflags         "${configure.ldflags}"

if { ${os.platform} eq "darwin" && ${os.major} <= [option legacysupport.newest_darwin_requires_legacy] } {
    set cxxflags    "${cxxflags} [legacysupport::get_cpp_flags]"
    set ldflags     "${ldflags} [legacysupport::get_library_link_flags]"

    post-patch {
        set script [open "${worksrcpath}/script-overrides/stable-${rust_version}-macos/build_std.txt" a]
        puts ${script} "cargo:rustc-link-lib=static=MacportsLegacySupport"
        puts ${script} "cargo:rustc-link-search=native=${prefix}/lib"
        close ${script}
    }
}

# Temporary hack
platform darwin powerpc {
    post-patch {
        reinplace "s|unwrap_or((10\, 7))|unwrap_or((10\, 6))|" \
                        ${workpath}/rustc-${rust_version}-src/compiler/rustc_target/src/spec/apple_base.rs \
                        ${workpath}/rustc-${rust_version}-src/vendor/rustc-ap-rustc_target/src/spec/apple_base.rs
    }
}

# mrustc produces huge C file with size near of 1 GB,
# and compiling it in parallel requires significant amount of RAM.
# build.env-append    PARLEVEL=${build.jobs}

set llvm_version        ${llvm_branch}.0
set llvm_port           ${llvm_version}

platform darwin powerpc {
    set llvm_version    ${llvm_branch}.1.1
    set llvm_port       powerpc
}

build.env-append    CC=${configure.cc} \
                    CXX=${configure.cxx} \
                    CFG_DEFAULT_LINKER=${configure.cxx} \
                    "CXXFLAGS_EXTRA=${cxxflags}" \
                    "LINKFLAGS_EXTRA=${ldflags}" \
                    RUSTC_VERSION=${rust_version} \
                    MRUSTC_TARGET_VER=${rust_version_major}

# mrustc had hardcoded x86_64 as target platform
build.env-append    RUSTC_TARGET=${rust_platform}-apple-${os.platform}
post-patch {
    reinplace "s|x86_64-apple-darwin|${rust_platform}-apple-${os.platform}|" \
        ${worksrcpath}/minicargo.mk ${worksrcpath}/run_rustc/Makefile
    reinplace "s|STD_ENV_ARCH=x86_64|STD_ENV_ARCH=${rust_platform}|g" \
        ${worksrcpath}/script-overrides/stable-${rust_version}-macos/build_std.txt
    reinplace "s|@PREFIX@|${prefix}|g" \
        ${worksrcpath}/minicargo.mk ${worksrcpath}/run_rustc/Makefile
    reinplace "s|@LLVM_V@|${llvm_version}|g" \
        ${worksrcpath}/minicargo.mk ${worksrcpath}/run_rustc/Makefile
    # Not required, since we do not build LLVM, but does not hurt:
    reinplace "s|X86;ARM;AArch64|X86;ARM;AArch64;PowerPC|" ${worksrcpath}/minicargo.mk
    # Ensure the correct target is used on powerpc64-apple-darwin:
    if {${configure.build_arch} eq "ppc64"} {
        reinplace "s|powerpc-apple-darwin|${rust_platform}-apple-${os.platform}|" \
            ${worksrcpath}/minicargo.mk
    }

    # These are empty files, but the build wants them:
    foreach f {build_rustc_asan.txt build_rustc_lsan.txt build_rustc_msan.txt build_rustc_tsan.txt} {
        system "touch ${worksrcpath}/script-overrides/stable-${rust_version}-macos/${f}"
    }
}

set output_dir      output-${rust_version}

# Step 1: building mrustc, its libs and minicargo
if {${subport} eq ${name}} {
    depends_lib-append \
                    port:zlib

    # Parallel building of libs may cause random failure
    # See: https://github.com/thepowersgang/mrustc/issues/225
    build.target    -f minicargo.mk -j${build.jobs} bin/mrustc bin/minicargo && \
                    ${build.cmd} -j${build.jobs} -C tools/dump_hirfile && \
                    ${build.cmd} -j${build.jobs} -C tools/standalone_miri && \
                    ${build.cmd} -j1 -f minicargo.mk LIBS

    destroot {
        xinstall -d ${destroot}${prefix}/libexec/mrustc/bin

        xinstall -m 0755 -W ${worksrcpath}/bin mrustc minicargo dump_hirfile standalone_miri \
            ${destroot}${prefix}/libexec/mrustc/bin

        # Install all .rlib, .rlib.hir and .rlib.o to lib/
        xinstall -d ${destroot}${prefix}/libexec/mrustc/lib
        foreach f [glob -directory ${worksrcpath}/${output_dir} lib*.rlib lib*.rlib.hir lib*.rlib.o] {
            xinstall -m 0644 $f ${destroot}${prefix}/libexec/mrustc/lib
        }

        if {${os.platform} eq "darwin" && ${os.major} < 11} {
            foreach f [glob -directory ${libemutls}/ lib*] {
                xinstall -m 0644 $f ${destroot}${prefix}/libexec/mrustc/lib
            }
        }

        # Create a wrapper to run mrustc without setup any ENV
        set mrustc [open "${destroot}${prefix}/bin/mrustc" w 0755]
        puts ${mrustc} "#!/bin/sh"
        puts ${mrustc} "export CC=\"\$\{CC:-${configure.cc}\}\""
        puts ${mrustc} "export MRUSTC_TARGET_VER=\"\$\{MRUSTC_TARGET_VER:-${rust_version_major}\}\""
        puts ${mrustc} "export MRUSTC_LIBDIR=\"\$\{MRUSTC_LIBDIR:-${prefix}/libexec/mrustc/lib\}\""
        puts ${mrustc} "${prefix}/libexec/mrustc/bin/mrustc \$@"
        close ${mrustc}
    }
}

# Step 2: build a rustc and cargo by mrustc
subport mrustc-rust {
    PortGroup       openssl 1.0

    version         ${rust_version}
    revision        0
    epoch           1

    description     Rust and cargo which was compiled by mrustc.
    long_description {*}${description}

    # cargo is too old to be used with 3.0
    openssl.branch  1.1

    depends_build-append \
                    port:cctools \
                    path:bin/git:git \
                    port:gmake \
                    port:mrustc

    depends_lib-append \
                    port:curl \
                    port:libffi \
                    port:libiconv \
                    port:libxml2 \
                    port:llvm-${llvm_port} \
                    port:ncurses

    set py_v        2.7
    set py_v_nodot  [string map {. {}} ${py_v}]

    # Use the system python27 if present
    if {${os.platform} eq "darwin" && ${os.major} >= 11 && ${os.major} <= 21} {
        set pythonfullpath   /usr/bin/python${py_v}
    } else {
        set pythonfullpath   ${prefix}/bin/python${py_v}
        depends_build-append port:python${py_v_nodot}
    }

    build.env-append \
                    OPENSSL_DIR=[openssl::install_area] \
                    OPENSSL_INCLUDE_DIR=[openssl::include_dir] \
                    OPENSSL_LIB_DIR=[openssl::lib_dir] \
                    MINICARGO=${prefix}/libexec/mrustc/bin/minicargo \
                    "MINICARGO_FLAGS=--features curl-sys/force-system-lib-on-osx" \
                    MRUSTC=${prefix}/libexec/mrustc/bin/mrustc

    # Parallel building on some stages may cause random failure
    # See: https://github.com/thepowersgang/mrustc/issues/225
    # So:
    #  - Bootstrap everything in single mode
    build.target    ${build.cmd} -j1 -C run_rustc all

    destroot {
        xinstall -d ${destroot}${prefix}/libexec/${subport}/bin

        xinstall -m 0755 -W ${worksrcpath}/run_rustc/${output_dir}/prefix/bin \
            cargo rustc_binary \
            ${destroot}${prefix}/libexec/${subport}/bin

        set rustc [open "${destroot}${prefix}/libexec/${subport}/bin/rustc" w 0755]
        puts ${rustc} "#!/bin/sh"
        puts ${rustc} "# macOS never uses LD_LIBRARY_PATH, but rust uses it to find the path to its driver"
        puts ${rustc} "LD_LIBRARY_PATH=\"${prefix}/libexec/${subport}/lib\" ${prefix}/libexec/${subport}/bin/rustc_binary \$@"
        close ${rustc}

        ln -sf ${prefix}/libexec/${subport}/bin/rustc ${prefix}/bin/${subport}

        xinstall -d ${destroot}${prefix}/libexec/${subport}/lib
        file copy ${worksrcpath}/run_rustc/${output_dir}/prefix/lib/rustlib \
            ${destroot}${prefix}/libexec/${subport}/lib

        system -W ${destroot}${prefix}/libexec/${subport}/bin \
            "install_name_tool -change ${worksrcpath}/run_rustc/${output_dir}/build-rustc/${rust_platform}-apple-${os.platform}/release/deps/librustc_driver.dylib ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/librustc_driver.dylib ./rustc_binary"

        system -W ${destroot}${prefix}/libexec/${subport}/bin \
            "install_name_tool -change ${worksrcpath}/run_rustc/${output_dir}/build-std2/${rust_platform}-apple-${os.platform}/release/deps/libtest.dylib ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/libtest.dylib ./rustc_binary"

        system -W ${destroot}${prefix}/libexec/${subport}/bin \
            "install_name_tool -change ${worksrcpath}/run_rustc/${output_dir}/build-std2/${rust_platform}-apple-${os.platform}/release/deps/libstd.dylib ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/libstd.dylib ./rustc_binary"

        system -W ${destroot}${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib \
            "install_name_tool -id ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/librustc_driver.dylib ./librustc_driver.dylib"

        system -W ${destroot}${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib \
            "install_name_tool -id ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/libstd.dylib ./libstd.dylib"

        system -W ${destroot}${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib \
            "install_name_tool -id ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/libtest.dylib ./libtest.dylib"

        foreach f [ exec find ${destroot}${prefix}/libexec/${subport}/lib -name "*.dylib" ] {
            system "install_name_tool -change ${worksrcpath}/run_rustc/${output_dir}/build-rustc/${rust_platform}-apple-${os.platform}/release/deps/librustc_driver.dylib ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/librustc_driver.dylib $f"
            system "install_name_tool -change ${worksrcpath}/run_rustc/${output_dir}/build-rustc/${rust_platform}-apple-${os.platform}/release/deps/librustc_codegen_llvm.dylib ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/librustc_codegen_llvm.dylib $f"
            system "install_name_tool -change ${worksrcpath}/run_rustc/${output_dir}/build-rustc/${rust_platform}-apple-${os.platform}/release/deps/libtest.dylib ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/libtest.dylib $f"
            system "install_name_tool -change ${worksrcpath}/run_rustc/${output_dir}/build-rustc/${rust_platform}-apple-${os.platform}/release/deps/libstd.dylib ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/libstd.dylib $f"

            system "install_name_tool -change ${worksrcpath}/run_rustc/${output_dir}/build-std/${rust_platform}-apple-${os.platform}/release/deps/libtest.dylib ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/libtest.dylib $f"
            system "install_name_tool -change ${worksrcpath}/run_rustc/${output_dir}/build-std/${rust_platform}-apple-${os.platform}/release/deps/libstd.dylib ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/libstd.dylib $f"

            system "install_name_tool -change ${worksrcpath}/run_rustc/${output_dir}/build-std2/${rust_platform}-apple-${os.platform}/release/deps/libtest.dylib ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/libtest.dylib $f"
            system "install_name_tool -change ${worksrcpath}/run_rustc/${output_dir}/build-std2/${rust_platform}-apple-${os.platform}/release/deps/libstd.dylib ${prefix}/libexec/${subport}/lib/rustlib/${rust_platform}-apple-${os.platform}/lib/libstd.dylib $f"
        }
    }

    livecheck.type  none
}

# Lets add some basic tests for mrustc port
if {${subport} eq ${name}} {
    test.env        {*}${build.env} MRUSTC_LIBDIR=${output_dir}
    test.run        yes
    test.target     test
}
