From ec49425f4f716aa8071ce0211787c899c05df6b2 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Fri, 7 Nov 2025 17:43:40 +0800
Subject: [PATCH 5/5] fast_thread_local.rs: tentative fix for missing tls on <
 10.7

---
 src/libstd/sys/unix/fast_thread_local.rs | 17 ++++++++++++++---
 1 file changed, 14 insertions(+), 3 deletions(-)

diff --git a/src/libstd/sys/unix/fast_thread_local.rs b/src/libstd/sys/unix/fast_thread_local.rs
index d59d800a57..a9053c61cc 100644
--- a/src/libstd/sys/unix/fast_thread_local.rs
+++ b/src/libstd/sys/unix/fast_thread_local.rs
@@ -46,15 +46,26 @@ pub unsafe fn register_dtor(t: *mut u8, dtor: unsafe extern fn(*mut u8)) {
 // macOS's analog of the above linux function is this _tlv_atexit function.
 // The disassembly of thread_local globals in C++ (at least produced by
 // clang) will have this show up in the output.
-#[cfg(target_os = "macos")]
+// Native path for macOS 10.7+ (ELF TLS supported):
+#[cfg(all(target_os = "macos", target_has_elf_tls))]
 pub unsafe fn register_dtor(t: *mut u8, dtor: unsafe extern fn(*mut u8)) {
     extern {
-        fn _tlv_atexit(dtor: unsafe extern fn(*mut u8),
-                       arg: *mut u8);
+        fn _tlv_atexit(dtor: unsafe extern fn(*mut u8), arg: *mut u8);
     }
     _tlv_atexit(dtor, t);
 }
 
+// Fallback for macOS builds without ELF TLS:
+#[cfg(all(target_os = "macos", not(target_has_elf_tls)))]
+pub unsafe fn register_dtor(t: *mut u8, dtor: unsafe extern fn(*mut u8)) {
+    let mut key: libc::pthread_key_t = 0;
+    // Convert to the pthread destructor type. This is unsafe but the ABI is compatible.
+    let dtor_c: unsafe extern "C" fn(*mut libc::c_void) = core::mem::transmute(dtor);
+    if libc::pthread_key_create(&mut key, Some(dtor_c)) == 0 {
+        let _ = libc::pthread_setspecific(key, t as *mut libc::c_void);
+    }
+}
+
 pub fn requires_move_before_drop() -> bool {
     // The macOS implementation of TLS apparently had an odd aspect to it
     // where the pointer we have may be overwritten while this destructor
-- 
2.51.0

