From 23696729c0b0fe967dd77447d8a624d0533b0307 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Fri, 19 Dec 2025 18:05:01 +0800
Subject: [PATCH] Hack around invalid xcrun syntax

---
 compiler/rustc_codegen_ssa/src/back/link.rs | 19 ++-----------------
 1 file changed, 2 insertions(+), 17 deletions(-)

diff --git a/compiler/rustc_codegen_ssa/src/back/link.rs b/compiler/rustc_codegen_ssa/src/back/link.rs
index f726c852c34..f8cdc608ad9 100644
--- a/compiler/rustc_codegen_ssa/src/back/link.rs
+++ b/compiler/rustc_codegen_ssa/src/back/link.rs
@@ -2509,23 +2509,8 @@ fn get_apple_sdk_root(sdk_name: &str) -> Result<String, String> {
             _ => return Ok(sdkroot),
         }
     }
-    let res =
-        Command::new("xcrun").arg("--show-sdk-path").arg("-sdk").arg(sdk_name).output().and_then(
-            |output| {
-                if output.status.success() {
-                    Ok(String::from_utf8(output.stdout).unwrap())
-                } else {
-                    let error = String::from_utf8(output.stderr);
-                    let error = format!("process exit with error: {}", error.unwrap());
-                    Err(io::Error::new(io::ErrorKind::Other, &error[..]))
-                }
-            },
-        );
-
-    match res {
-        Ok(output) => Ok(output.trim().to_string()),
-        Err(e) => Err(format!("failed to get {} SDK path: {}", sdk_name, e)),
-    }
+    // Fallback to standard sysroot:
+    Ok("/".to_string()),
 }
 
 fn add_gcc_ld_path(cmd: &mut dyn Linker, sess: &Session, flavor: LinkerFlavor) {

From e4e84e5df6ae95c2d248745e277f7b2e76e4b8ce Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Fri, 19 Dec 2025 18:14:13 +0800
Subject: [PATCH 20/20] powerpc*-apple-darwin: hardcode triples, since rust
 cannot handle them correctly

---
 compiler/rustc_target/src/spec/apple_base.rs             | 1 +
 compiler/rustc_target/src/spec/powerpc64_apple_darwin.rs | 5 +++--
 compiler/rustc_target/src/spec/powerpc_apple_darwin.rs   | 5 +++--
 3 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/compiler/rustc_target/src/spec/apple_base.rs b/compiler/rustc_target/src/spec/apple_base.rs
index db17a879235..cc8f8e5dd4d 100644
--- a/compiler/rustc_target/src/spec/apple_base.rs
+++ b/compiler/rustc_target/src/spec/apple_base.rs
@@ -71,6 +71,7 @@ pub fn macos_llvm_target(arch: &str) -> String {
     format!("{}-apple-macosx{}.{}.0", arch, major, minor)
 }
 
+// This has to add darwin versions, for LLVM compatibility, but it does not atm.
 pub fn macos_llvm_target_ppc(arch: &str) -> String {
     format!("{}-apple-darwin", arch)
 }
diff --git a/compiler/rustc_target/src/spec/powerpc64_apple_darwin.rs b/compiler/rustc_target/src/spec/powerpc64_apple_darwin.rs
index 40851c80360..8c0031e638f 100644
--- a/compiler/rustc_target/src/spec/powerpc64_apple_darwin.rs
+++ b/compiler/rustc_target/src/spec/powerpc64_apple_darwin.rs
@@ -9,10 +9,11 @@ pub fn target() -> Target {
     base.eliminate_frame_pointer = false;
 
     let arch = "powerpc64";
-    let llvm_target = super::apple_base::macos_llvm_target_ppc(&arch);
+//    let llvm_target = super::apple_base::macos_llvm_target_ppc(&arch);
 
     Target {
-        llvm_target,
+// ppc64 is only supported on 10.5.8.
+        llvm_target: "powerpc64-apple-darwin9.8.0".to_string(),
         pointer_width: 64,
         data_layout: "E-m:o-i64:64-n32:64".to_string(),
         arch: arch.to_string(),
diff --git a/compiler/rustc_target/src/spec/powerpc_apple_darwin.rs b/compiler/rustc_target/src/spec/powerpc_apple_darwin.rs
index 2457cc5ad98..4760423dd8f 100644
--- a/compiler/rustc_target/src/spec/powerpc_apple_darwin.rs
+++ b/compiler/rustc_target/src/spec/powerpc_apple_darwin.rs
@@ -9,10 +9,11 @@ pub fn target() -> Target {
     base.eliminate_frame_pointer = false;
 
     let arch = "powerpc";
-    let llvm_target = super::apple_base::macos_llvm_target_ppc(&arch);
+//    let llvm_target = super::apple_base::macos_llvm_target_ppc(&arch);
 
     Target {
-        llvm_target,
+// This is acceptable at the moment, since we build on 10.6.8 specifically:
+        llvm_target: "powerpc-apple-darwin10.8.0".to_string(),
         pointer_width: 32,
         data_layout: "E-m:o-p:32:32-i64:64-n32".to_string(),
         arch: arch.to_string(),
