From 8d95b4004c196251b4fa769018639d3d0278d6a1 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Mon, 10 Nov 2025 21:53:24 +0800
Subject: [PATCH] Add powerpc and aarch64 targets for darwin

Includes backport of https://github.com/rust-lang/rust/commit/4c69d4bc05f43d801390c8498eea6e317e9d4b12
---
 .../spec/aarch64_apple_darwin.rs              | 29 ++++++++++++++++
 src/librustc_target/spec/i686_apple_darwin.rs |  5 ++-
 src/librustc_target/spec/mod.rs               |  5 ++-
 .../spec/powerpc64_apple_darwin.rs            | 33 +++++++++++++++++++
 .../spec/powerpc_apple_darwin.rs              | 33 +++++++++++++++++++
 .../spec/x86_64_apple_darwin.rs               |  5 ++-
 src/tools/build-manifest/src/main.rs          |  6 ++++
 7 files changed, 113 insertions(+), 3 deletions(-)
 create mode 100644 src/librustc_target/spec/aarch64_apple_darwin.rs
 create mode 100755 src/librustc_target/spec/powerpc64_apple_darwin.rs
 create mode 100755 src/librustc_target/spec/powerpc_apple_darwin.rs

diff --git a/src/librustc_target/spec/aarch64_apple_darwin.rs b/src/librustc_target/spec/aarch64_apple_darwin.rs
new file mode 100644
index 00000000000..f868abd9d93
--- /dev/null
+++ b/src/librustc_target/spec/aarch64_apple_darwin.rs
@@ -0,0 +1,29 @@
+use crate::spec::{LinkerFlavor, Target, TargetOptions, TargetResult};
+
+pub fn target() -> TargetResult {
+    let mut base = super::apple_base::opts();
+    base.cpu = "apple-a12".to_string();
+    base.max_atomic_width = Some(128);
+    base.pre_link_args.insert(LinkerFlavor::Gcc, vec!["-arch".to_string(), "arm64".to_string()]);
+    base.link_env_remove.extend(super::apple_base::macos_link_env_remove());
+
+    // Clang automatically chooses a more specific target based on
+    // MACOSX_DEPLOYMENT_TARGET.  To enable cross-language LTO to work
+    // correctly, we do too.
+    let arch = "aarch64";
+    let llvm_target = super::apple_base::macos_llvm_target(&arch);
+
+    Ok(Target {
+        llvm_target,
+        target_endian: "little".to_string(),
+        target_pointer_width: "64".to_string(),
+        target_c_int_width: "32".to_string(),
+        data_layout: "e-m:o-i64:64-i128:128-n32:64-S128".to_string(),
+        arch: arch.to_string(),
+        target_os: "macos".to_string(),
+        target_env: String::new(),
+        target_vendor: "apple".to_string(),
+        linker_flavor: LinkerFlavor::Gcc,
+        options: TargetOptions { target_mcount: "\u{1}mcount".to_string(), ..base },
+    })
+}
diff --git a/src/librustc_target/spec/i686_apple_darwin.rs b/src/librustc_target/spec/i686_apple_darwin.rs
index 27d05823bf2..b9412782158 100644
--- a/src/librustc_target/spec/i686_apple_darwin.rs
+++ b/src/librustc_target/spec/i686_apple_darwin.rs
@@ -4,7 +4,10 @@ pub fn target() -> TargetResult {
     let mut base = super::apple_base::opts();
     base.cpu = "yonah".to_string();
     base.max_atomic_width = Some(64);
-    base.pre_link_args.insert(LinkerFlavor::Gcc, vec!["-m32".to_string()]);
+    base.pre_link_args.insert(
+        LinkerFlavor::Gcc,
+        vec!["-m32".to_string(), "-arch".to_string(), "i386".to_string()],
+    );
     base.link_env_remove.extend(super::apple_base::macos_link_env_remove());
     base.stack_probes = true;
     base.eliminate_frame_pointer = false;
diff --git a/src/librustc_target/spec/mod.rs b/src/librustc_target/spec/mod.rs
index 626fa374a1b..55fe35a94c0 100644
--- a/src/librustc_target/spec/mod.rs
+++ b/src/librustc_target/spec/mod.rs
@@ -416,8 +416,11 @@ supported_targets! {
     ("i686-unknown-haiku", i686_unknown_haiku),
     ("x86_64-unknown-haiku", x86_64_unknown_haiku),
 
-    ("x86_64-apple-darwin", x86_64_apple_darwin),
+    ("aarch64-apple-darwin", aarch64_apple_darwin),
     ("i686-apple-darwin", i686_apple_darwin),
+    ("powerpc-apple-darwin", powerpc_apple_darwin),
+    ("powerpc64-apple-darwin", powerpc64_apple_darwin),
+    ("x86_64-apple-darwin", x86_64_apple_darwin),
 
     ("aarch64-fuchsia", aarch64_fuchsia),
     ("x86_64-fuchsia", x86_64_fuchsia),
diff --git a/src/librustc_target/spec/powerpc64_apple_darwin.rs b/src/librustc_target/spec/powerpc64_apple_darwin.rs
new file mode 100755
index 00000000000..7f22c0cf5b3
--- /dev/null
+++ b/src/librustc_target/spec/powerpc64_apple_darwin.rs
@@ -0,0 +1,33 @@
+use crate::spec::{LinkerFlavor, Target, TargetOptions, TargetResult};
+
+pub fn target() -> TargetResult {
+    let mut base = super::apple_base::opts();
+    base.cpu = "ppc64".to_string();
+    base.max_atomic_width = Some(64);
+    base.pre_link_args.insert(LinkerFlavor::Gcc, vec!["-arch".to_string(), "ppc64".to_string()]);
+    base.link_env_remove.extend(super::apple_base::macos_link_env_remove());
+    base.eliminate_frame_pointer = false;
+
+    // Clang automatically chooses a more specific target based on
+    // MACOSX_DEPLOYMENT_TARGET.  To enable cross-language LTO to work
+    // correctly, we do too.
+    let arch = "powerpc64";
+    let llvm_target = super::apple_base::macos_llvm_target(&arch);
+
+    Ok(Target {
+        llvm_target: llvm_target,
+        target_endian: "big".to_string(),
+        target_pointer_width: "64".to_string(),
+        target_c_int_width: "32".to_string(),
+        data_layout: "E-m:e-i64:64-n32:64".to_string(),
+        arch: "powerpc64".to_string(),
+        target_os: "macos".to_string(),
+        target_env: String::new(),
+        target_vendor: "apple".to_string(),
+        linker_flavor: LinkerFlavor::Gcc,
+        options: TargetOptions {
+            target_mcount: "\u{1}mcount".to_string(),
+            .. base
+        },
+    })
+}
diff --git a/src/librustc_target/spec/powerpc_apple_darwin.rs b/src/librustc_target/spec/powerpc_apple_darwin.rs
new file mode 100755
index 00000000000..655f02a97d3
--- /dev/null
+++ b/src/librustc_target/spec/powerpc_apple_darwin.rs
@@ -0,0 +1,33 @@
+use crate::spec::{LinkerFlavor, Target, TargetOptions, TargetResult};
+
+pub fn target() -> TargetResult {
+    let mut base = super::apple_base::opts();
+    base.cpu = "g4".to_string();
+    base.max_atomic_width = Some(32);
+    base.pre_link_args.insert(LinkerFlavor::Gcc, vec!["-arch".to_string(), "ppc".to_string()]);
+    base.link_env_remove.extend(super::apple_base::macos_link_env_remove());
+    base.eliminate_frame_pointer = false;
+
+    // Clang automatically chooses a more specific target based on
+    // MACOSX_DEPLOYMENT_TARGET.  To enable cross-language LTO to work
+    // correctly, we do too.
+    let arch = "powerpc";
+    let llvm_target = super::apple_base::macos_llvm_target(&arch);
+
+    Ok(Target {
+        llvm_target: llvm_target,
+        target_endian: "big".to_string(),
+        target_pointer_width: "32".to_string(),
+        target_c_int_width: "32".to_string(),
+        data_layout: "E-m:e-p:32:32-i64:64-n32".to_string(),
+        arch: "powerpc".to_string(),
+        target_os: "macos".to_string(),
+        target_env: String::new(),
+        target_vendor: "apple".to_string(),
+        linker_flavor: LinkerFlavor::Gcc,
+        options: TargetOptions {
+            target_mcount: "\u{1}mcount".to_string(),
+            .. base
+        },
+    })
+}
diff --git a/src/librustc_target/spec/x86_64_apple_darwin.rs b/src/librustc_target/spec/x86_64_apple_darwin.rs
index d059e44c5c8..6f5c16b8e05 100644
--- a/src/librustc_target/spec/x86_64_apple_darwin.rs
+++ b/src/librustc_target/spec/x86_64_apple_darwin.rs
@@ -5,7 +5,10 @@ pub fn target() -> TargetResult {
     base.cpu = "core2".to_string();
     base.max_atomic_width = Some(128); // core2 support cmpxchg16b
     base.eliminate_frame_pointer = false;
-    base.pre_link_args.insert(LinkerFlavor::Gcc, vec!["-m64".to_string()]);
+    base.pre_link_args.insert(
+        LinkerFlavor::Gcc,
+        vec!["-m64".to_string(), "-arch".to_string(), "x86_64".to_string()],
+    );
     base.link_env_remove.extend(super::apple_base::macos_link_env_remove());
     base.stack_probes = true;
 
diff --git a/src/tools/build-manifest/src/main.rs b/src/tools/build-manifest/src/main.rs
index f41e7dd17ed..8f14d9e02e1 100644
--- a/src/tools/build-manifest/src/main.rs
+++ b/src/tools/build-manifest/src/main.rs
@@ -17,6 +17,7 @@ use std::path::{PathBuf, Path};
 use std::process::{Command, Stdio};
 
 static HOSTS: &[&str] = &[
+    "aarch64-apple-darwin",
     "aarch64-unknown-linux-gnu",
     "arm-unknown-linux-gnueabi",
     "arm-unknown-linux-gnueabihf",
@@ -33,7 +34,9 @@ static HOSTS: &[&str] = &[
     "mipsisa32r6el-unknown-linux-gnu",
     "mipsisa64r6-unknown-linux-gnuabi64",
     "mipsisa64r6el-unknown-linux-gnuabi64",
+    "powerpc-apple-darwin",
     "powerpc-unknown-linux-gnu",
+    "powerpc64-apple-darwin",
     "powerpc64-unknown-linux-gnu",
     "powerpc64le-unknown-linux-gnu",
     "s390x-unknown-linux-gnu",
@@ -47,6 +50,7 @@ static HOSTS: &[&str] = &[
 ];
 
 static TARGETS: &[&str] = &[
+    "aarch64-apple-darwin",
     "aarch64-apple-ios",
     "aarch64-fuchsia",
     "aarch64-linux-android",
@@ -98,7 +102,9 @@ static TARGETS: &[&str] = &[
     "mipsel-unknown-linux-gnu",
     "mipsel-unknown-linux-musl",
     "nvptx64-nvidia-cuda",
+    "powerpc-apple-darwin",
     "powerpc-unknown-linux-gnu",
+    "powerpc64-apple-darwin",
     "powerpc64-unknown-linux-gnu",
     "powerpc64le-unknown-linux-gnu",
     "riscv32i-unknown-none-elf",
