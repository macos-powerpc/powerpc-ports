From 6783c2239e96f4a95646a0ea0f000e0eb2aecf85 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Tue, 11 Nov 2025 18:06:20 +0800
Subject: [PATCH] codegen_c.cpp: temporarily disable asserts on powerpc

---
 src/trans/codegen_c.cpp | 32 +++++++++++++++++++++++++-------
 1 file changed, 25 insertions(+), 7 deletions(-)

diff --git a/src/trans/codegen_c.cpp b/src/trans/codegen_c.cpp
index 1d112c8d..1bf39e67 100644
--- a/src/trans/codegen_c.cpp
+++ b/src/trans/codegen_c.cpp
@@ -1937,7 +1937,11 @@ namespace {
 
                     if( repr->size > 0 )
                     {
-                        m_of << "typedef char sizeof_assert_"; emit_ctype(ty); m_of << "[ (sizeof("; emit_ctype(ty); m_of << ") == " << repr->size << ") ? 1 : -1 ];\n";
+                        // Skip size assertion on PowerPC due to ABI differences
+                        if( Target_GetCurSpec().m_arch.m_name != "powerpc" )
+                        {
+                            m_of << "typedef char sizeof_assert_"; emit_ctype(ty); m_of << "[ (sizeof("; emit_ctype(ty); m_of << ") == " << repr->size << ") ? 1 : -1 ];\n";
+                        }
                     }
                 }
                 }
@@ -2034,10 +2038,17 @@ namespace {
             if(repr->size > 0 && repr->size != SIZE_MAX )
             {
                 // TODO: Handle unsized (should check the size of the fixed-size region)
-                m_of << "typedef char sizeof_assert_" << Trans_Mangle(p) << "[ (sizeof(struct s_" << Trans_Mangle(p) << ") == " << repr->size << ") ? 1 : -1 ];\n";
+                // Skip size assertion on PowerPC due to ABI differences
+                if( Target_GetCurSpec().m_arch.m_name != "powerpc" )
+                {
+                    m_of << "typedef char sizeof_assert_" << Trans_Mangle(p) << "[ (sizeof(struct s_" << Trans_Mangle(p) << ") == " << repr->size << ") ? 1 : -1 ];\n";
+                }
+            }
+            // Skip align assertion on PowerPC due to ABI differences
+            if( Target_GetCurSpec().m_arch.m_name != "powerpc" )
+            {
+                m_of << "typedef char alignof_assert_" << Trans_Mangle(p) << "[ (ALIGNOF(struct s_" << Trans_Mangle(p) << ") == " << repr->align << ") ? 1 : -1 ];\n";
             }
-            m_of << "typedef char alignof_assert_" << Trans_Mangle(p) << "[ (ALIGNOF(struct s_" << Trans_Mangle(p) << ") == " << repr->align << ") ? 1 : -1 ];\n";
-
             m_mir_res = nullptr;
         }
         void emit_union(const Span& sp, const ::HIR::GenericPath& p, const ::HIR::Union& item) override
@@ -2060,7 +2071,11 @@ namespace {
             m_of << "};\n";
             if( true && repr->size > 0 )
             {
-                m_of << "typedef char sizeof_assert_" << Trans_Mangle(p) << "[ (sizeof(union u_" << Trans_Mangle(p) << ") == " << repr->size << ") ? 1 : -1 ];\n";
+                // Skip size assertion on PowerPC due to ABI differences
+                if( Target_GetCurSpec().m_arch.m_name != "powerpc" )
+                {
+                    m_of << "typedef char sizeof_assert_" << Trans_Mangle(p) << "[ (sizeof(union u_" << Trans_Mangle(p) << ") == " << repr->size << ") ? 1 : -1 ];\n";
+                }
             }
 
             m_mir_res = nullptr;
@@ -2260,8 +2275,11 @@ namespace {
             m_of << "};\n";
 
             size_t exp_size = (repr->size > 0 ? repr->size : (m_options.disallow_empty_structs ? 1 : 0));
-            m_of << "typedef char sizeof_assert_" << Trans_Mangle(p) << "[ (sizeof(struct e_" << Trans_Mangle(p) << ") == " << exp_size << ") ? 1 : -1 ];\n";
-
+            // Skip size assertion on PowerPC due to ABI differences
+            if( Target_GetCurSpec().m_arch.m_name != "powerpc" )
+            {
+                m_of << "typedef char sizeof_assert_" << Trans_Mangle(p) << "[ (sizeof(struct e_" << Trans_Mangle(p) << ") == " << exp_size << ") ? 1 : -1 ];\n";
+            }
             m_mir_res = nullptr;
         }
 
