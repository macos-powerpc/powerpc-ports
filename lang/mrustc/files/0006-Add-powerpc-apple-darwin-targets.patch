From a40a6cd90afe1784eae2666dd80b7514f50a715e Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Mon, 15 Dec 2025 21:28:53 +0800
Subject: [PATCH] Add powerpc*-apple-darwin targets

---
 .../rustc_target/src/abi/call/powerpc64.rs    |  5 ++++-
 compiler/rustc_target/src/spec/mod.rs         |  2 ++
 .../src/spec/powerpc64_apple_darwin.rs        | 21 +++++++++++++++++++
 .../src/spec/powerpc_apple_darwin.rs          | 21 +++++++++++++++++++
 src/tools/build-manifest/src/main.rs          |  4 ++++
 5 files changed, 52 insertions(+), 1 deletion(-)
 create mode 100644 compiler/rustc_target/src/spec/powerpc64_apple_darwin.rs
 create mode 100644 compiler/rustc_target/src/spec/powerpc_apple_darwin.rs

diff --git a/compiler/rustc_target/src/abi/call/powerpc64.rs b/compiler/rustc_target/src/abi/call/powerpc64.rs
index 8c2a9d09a3d..3b30b87b5e0 100644
--- a/compiler/rustc_target/src/abi/call/powerpc64.rs
+++ b/compiler/rustc_target/src/abi/call/powerpc64.rs
@@ -1,6 +1,8 @@
 // FIXME:
 // Alignment of 128 bit types is not currently handled, this will
 // need to be fixed when PowerPC vector support is added.
+// FIXME:
+// PowerOpen ABI needs to be actually implemented and added to compute_abi_info below.
 
 use crate::abi::call::{ArgAbi, FnAbi, Reg, RegKind, Uniform};
 use crate::abi::{Endian, HasDataLayout, LayoutOf, TyAndLayout, TyAndLayoutMethods};
@@ -8,8 +10,9 @@
 
 #[derive(Debug, Clone, Copy, PartialEq)]
 enum ABI {
-    ELFv1, // original ABI used for powerpc64 (big-endian)
+    ELFv1, // ABI used for powerpc64 (big-endian) on Linux and *BSD
     ELFv2, // newer ABI used for powerpc64le and musl (both endians)
+    PowerOpen, // original AIX and macOS ABI
 }
 use ABI::*;
 
diff --git a/compiler/rustc_target/src/spec/mod.rs b/compiler/rustc_target/src/spec/mod.rs
index 0f2aaeb533a..786c5b8e169 100644
--- a/compiler/rustc_target/src/spec/mod.rs
+++ b/compiler/rustc_target/src/spec/mod.rs
@@ -793,6 +793,8 @@ fn $module() {
     ("aarch64-apple-darwin", aarch64_apple_darwin),
     ("x86_64-apple-darwin", x86_64_apple_darwin),
     ("i686-apple-darwin", i686_apple_darwin),
+    ("powerpc-apple-darwin", powerpc_apple_darwin),
+    ("powerpc64-apple-darwin", powerpc64_apple_darwin),
 
     ("aarch64-fuchsia", aarch64_fuchsia),
     ("x86_64-fuchsia", x86_64_fuchsia),
diff --git a/compiler/rustc_target/src/spec/powerpc64_apple_darwin.rs b/compiler/rustc_target/src/spec/powerpc64_apple_darwin.rs
new file mode 100644
index 00000000000..8e623bbc209
--- /dev/null
+++ b/compiler/rustc_target/src/spec/powerpc64_apple_darwin.rs
@@ -0,0 +1,21 @@
+use crate::spec::{LinkerFlavor, Target, TargetOptions};
+
+pub fn target() -> Target {
+    let mut base = super::apple_base::opts("macos");
+    base.cpu = "ppc64".to_string();
+    base.max_atomic_width = Some(64);
+    base.pre_link_args.insert(LinkerFlavor::Gcc, vec!["-arch".to_string(), "ppc64".to_string()]);
+    base.link_env_remove.extend(super::apple_base::macos_link_env_remove());
+    base.eliminate_frame_pointer = false;
+
+    let arch = "powerpc64";
+    let llvm_target = super::apple_base::macos_llvm_target(&arch);
+
+    Target {
+        llvm_target,
+        pointer_width: 64,
+        data_layout: "E-m:e-i64:64-n32:64".to_string(),
+        arch: arch.to_string(),
+        options: TargetOptions { endian: Endian::Big, mcount: "\u{1}mcount".to_string(), ..base },
+    }
+}
diff --git a/compiler/rustc_target/src/spec/powerpc_apple_darwin.rs b/compiler/rustc_target/src/spec/powerpc_apple_darwin.rs
new file mode 100644
index 00000000000..e05a92d2e78
--- /dev/null
+++ b/compiler/rustc_target/src/spec/powerpc_apple_darwin.rs
@@ -0,0 +1,21 @@
+use crate::spec::{LinkerFlavor, Target, TargetOptions};
+
+pub fn target() -> Target {
+    let mut base = super::apple_base::opts("macos");
+    base.cpu = "g4".to_string();
+    base.max_atomic_width = Some(32);
+    base.pre_link_args.insert(LinkerFlavor::Gcc, vec!["-arch".to_string(), "ppc".to_string()]);
+    base.link_env_remove.extend(super::apple_base::macos_link_env_remove());
+    base.eliminate_frame_pointer = false;
+
+    let arch = "powerpc";
+    let llvm_target = super::apple_base::macos_llvm_target(&arch);
+
+    Target {
+        llvm_target,
+        pointer_width: 32,
+        data_layout: "E-m:e-p:32:32-i64:64-n32".to_string(),
+        arch: "powerpc".to_string(),
+        options: TargetOptions { endian: Endian::Big, mcount: "\u{1}mcount".to_string(), ..base },
+    }
+}
diff --git a/src/tools/build-manifest/src/main.rs b/src/tools/build-manifest/src/main.rs
index 1e19b7b21d8..7f9b7509680 100644
--- a/src/tools/build-manifest/src/main.rs
+++ b/src/tools/build-manifest/src/main.rs
@@ -36,7 +36,9 @@
     "mipsisa32r6el-unknown-linux-gnu",
     "mipsisa64r6-unknown-linux-gnuabi64",
     "mipsisa64r6el-unknown-linux-gnuabi64",
+    "powerpc-apple-darwin",
     "powerpc-unknown-linux-gnu",
+    "powerpc64-apple-darwin",
     "powerpc64-unknown-linux-gnu",
     "powerpc64le-unknown-linux-gnu",
     "riscv64gc-unknown-linux-gnu",
@@ -111,7 +113,9 @@
     "mipsel-unknown-linux-gnu",
     "mipsel-unknown-linux-musl",
     "nvptx64-nvidia-cuda",
+    "powerpc-apple-darwin",
     "powerpc-unknown-linux-gnu",
+    "powerpc64-apple-darwin",
     "powerpc64-unknown-linux-gnu",
     "powerpc64le-unknown-linux-gnu",
     "riscv32i-unknown-none-elf",


--- /dev/null
+++ b/vendor/rustc-ap-rustc_target/src/spec/powerpc_apple_darwin.rs
@@ -0,0 +1,21 @@
+use crate::spec::{LinkerFlavor, Target, TargetOptions};
+
+pub fn target() -> Target {
+    let mut base = super::apple_base::opts("macos");
+    base.cpu = "g4".to_string();
+    base.max_atomic_width = Some(32);
+    base.pre_link_args.insert(LinkerFlavor::Gcc, vec!["-arch".to_string(), "ppc".to_string()]);
+    base.link_env_remove.extend(super::apple_base::macos_link_env_remove());
+    base.eliminate_frame_pointer = false;
+
+    let arch = "powerpc";
+    let llvm_target = super::apple_base::macos_llvm_target(&arch);
+
+    Target {
+        llvm_target,
+        pointer_width: 32,
+        data_layout: "E-m:e-p:32:32-i64:64-n32".to_string(),
+        arch: "powerpc".to_string(),
+        options: TargetOptions { endian: Endian::Big, mcount: "\u{1}mcount".to_string(), ..base },
+    }
+}

--- /dev/null
+++ b/vendor/rustc-ap-rustc_target/src/spec/powerpc64_apple_darwin.rs
@@ -0,0 +1,21 @@
+use crate::spec::{LinkerFlavor, Target, TargetOptions};
+
+pub fn target() -> Target {
+    let mut base = super::apple_base::opts("macos");
+    base.cpu = "ppc64".to_string();
+    base.max_atomic_width = Some(64);
+    base.pre_link_args.insert(LinkerFlavor::Gcc, vec!["-arch".to_string(), "ppc64".to_string()]);
+    base.link_env_remove.extend(super::apple_base::macos_link_env_remove());
+    base.eliminate_frame_pointer = false;
+
+    let arch = "powerpc64";
+    let llvm_target = super::apple_base::macos_llvm_target(&arch);
+
+    Target {
+        llvm_target,
+        pointer_width: 64,
+        data_layout: "E-m:e-i64:64-n32:64".to_string(),
+        arch: arch.to_string(),
+        options: TargetOptions { endian: Endian::Big, mcount: "\u{1}mcount".to_string(), ..base },
+    }
+}

--- a/vendor/rustc-ap-rustc_target/src/spec/mod.rs	2021-07-26 23:20:39.000000000 +0800
+++ b/vendor/rustc-ap-rustc_target/src/spec/mod.rs	2025-12-15 21:26:11.000000000 +0800
@@ -790,6 +790,8 @@
     ("aarch64-apple-darwin", aarch64_apple_darwin),
     ("x86_64-apple-darwin", x86_64_apple_darwin),
     ("i686-apple-darwin", i686_apple_darwin),
+    ("powerpc-apple-darwin", powerpc_apple_darwin),
+    ("powerpc64-apple-darwin", powerpc64_apple_darwin),
 
     ("aarch64-fuchsia", aarch64_fuchsia),
     ("x86_64-fuchsia", x86_64_fuchsia),
