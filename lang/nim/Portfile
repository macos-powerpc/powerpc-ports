# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           legacysupport 1.1

# At least for memmem
legacysupport.newest_darwin_requires_legacy 10

# This is working now, but EXPERIMENTAL and will likely change.
# TODO: see how FreeBSD builds this, there are improvements to pick.

name                nim
version             2.2.6
revision            0
license             MIT
categories          lang
maintainers         {@esafak gmail.com:esafak} openmaintainer

description         Nim programming language
long_description    Nim is a statically typed compiled systems programming \
                    language. It combines successful concepts from mature \
                    languages like Python, Ada and Modula. Its design focuses \
                    on efficiency, expressiveness and elegance (in that \
                    order of priority).

homepage            https://nim-lang.org

# TODO: using our csources is a temporary measure.
# Fixes should be merged to upstream Nim sources and then updated csources have to be generated.
# See: https://github.com/nim-lang/Nim/issues/24414

set c_hash          431db0c7e358f54265116886dbf77e289ce42188

master_sites        ${homepage}/download/:nim \
                    https://github.com/barracuda156/csources_v3/archive/${c_hash}/:csource
distfiles           ${distname}.tar.xz:nim \
                    csources_v3-${c_hash}.tar.gz:csource
checksums           ${distname}.tar.xz \
                    rmd160  3f62282891cc1c25dda93fb160efd56df9676951 \
                    sha256  657b0e3d5def788148d2a87fa6123fa755b2d92cad31ef60fd261e451785528b \
                    size    8471204 \
                    csources_v3-${c_hash}.tar.gz \
                    rmd160  48c81c5ae4f34b67ce3ab1436970619cd942a69b \
                    sha256  c7835d74f8ffc182030f960c2046d0477986e146720f2bedb54fa33282582485 \
                    size    372451553

use_xz              yes
extract.only        ${distname}.tar.xz

# FIXME: currently the port INSTALLS a symlink to the compiler of choice as ${prefix}/bin/gcc.
# This is helpful when using Nim to build something, but otherwise can cause a mess for other ports.
# Perhaps this should be handled via a PortGroup, like fortran PG does for fmp builds.

compiler.blacklist-append \
                    *gcc-4.0 *gcc-4.2

post-extract {
    set tar [findBinary tar ${portutil::autoconf::tar_command}]
    system -W ${workpath} "${tar} -zxf ${distpath}/csources_v3-${c_hash}.tar.gz"
    delete -force ${worksrcpath}/c_code
    delete -force ${worksrcpath}/build.sh
    delete -force ${worksrcpath}/makefile
    copy ${workpath}/csources_v3-${c_hash}/c_code ${worksrcpath}/
    copy ${workpath}/csources_v3-${c_hash}/build.sh ${worksrcpath}/
    copy ${workpath}/csources_v3-${c_hash}/makefile ${worksrcpath}/

    # We need to force it to use the right compiler.
    ln -s ${configure.cc} ${worksrcpath}/bin/gcc
}

patch.pre_args-replace  -p0 -p1

# https://github.com/nim-lang/Nim/issues/25372
# https://github.com/nim-lang/Nim/issues/25373
# https://github.com/nim-lang/csources_v1/pull/7
patchfiles-append   0001-Support-powerpc-darwin.patch

# TODO: see if we can ensure correct OpenSSL etc. are picked via configs.
if {${os.platform} eq "darwin" && ${os.major} < 11} {
    patchfiles-append \
                    0002-patch-legacy.diff
    # FIXME: https://github.com/nim-lang/Nim/issues/25381
    patchfiles-append \
                    0003-patch-sysrand.diff

    post-patch {
        reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/build.sh ${worksrcpath}/makefile ${worksrcpath}/config/nim.cfg
    }
}

use_configure       no

variant doc description "Build HTML docs" {}

depends_build-append \
                    path:bin/git:git

build {
    # See https://nim-lang.github.io/Nim/packaging.html
    set nim_build_arch ${os.arch}
    if {${build_arch} eq "arm64" } {
        # nim looks for aarch64 and not arm/arm64
        set nim_build_arch "aarch64"
    }

    system -W ${worksrcpath} "PATH=./bin:\$PATH ./build.sh --os ${os.platform} --cpu ${nim_build_arch}"
    system -W ${worksrcpath} "PATH=./bin:\$PATH ./bin/nim c koch"
    system -W ${worksrcpath} "PATH=./bin:\$PATH ./koch boot -d:release"
    system -W ${worksrcpath} "PATH=./bin:\$PATH ./koch tools -d:release"

    if {[variant_isset doc]} {
        system -W ${worksrcpath} "./koch docs"
    }
}

destroot {
    system -W \
        ${worksrcpath} "./install.sh [shellescape ${destroot}/${prefix}/lib]"

    foreach nimbin [glob ${worksrcpath}/bin/*] {
        xinstall -m 0755 ${nimbin} ${destroot}/${prefix}/lib/${name}/bin/

        ln -sf \
            ${prefix}/lib/${name}/bin/[file tail ${nimbin}] \
            ${destroot}/${prefix}/bin/
    }

    xinstall -d ${destroot}/${prefix}/share/doc/${name}
    copy {*}[glob ${worksrcpath}/doc/*] ${destroot}/${prefix}/share/doc/${name}
}

livecheck.url       ${homepage}/install.html
livecheck.regex     ${name}-(\[0-9.\]+).tar.xz

# https://github.com/nim-lang/nimble/issues/789
notes "Using nimble may require to set DYLD_LIBRARY_PATH to OpenSSL libdir."
