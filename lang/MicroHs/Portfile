# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem                  1.0
PortGroup                   github 1.0
PortGroup                   legacysupport 1.1
PortGroup                   makefile 1.0

# clock_gettime
legacysupport.newest_darwin_requires_legacy 15

github.setup                augustss MicroHs 0.14.33.0 v
revision                    0
epoch                       1

categories                  lang haskell
maintainers                 {@barracuda156 macos-powerpc.org:barracuda}
license                     Apache-2

description                 The language is an extended subset of Haskell-2010
long_description            {*}${description}.

checksums                   rmd160  44d926703c8f9ed815c5add94d0ddf5c4da6e4f5 \
                            sha256  415aadb65d126e780359bdb76364cec015ee00fd87405ba138a51bae4329d4fd \
                            size    1355226
github.tarball_from         archive

# If gmp variant is added, see: https://github.com/augustss/MicroHs/issues/351

patchfiles-append           patch-targets.conf.diff

post-patch {
    reinplace "s|CCLIBS=|CCLIBS +=|" ${worksrcpath}/Makefile
    reinplace "s|@CC@|${configure.cc}|" ${worksrcpath}/targets.conf.in
    if {${os.platform} eq "darwin" && ${os.major} < 16} {
        reinplace "s| @EXTRA_LIBS@| -L${prefix}/lib -lMacportsLegacySupport|" ${worksrcpath}/targets.conf.in
        reinplace "s| @EXTRA_CFLAGS@| -isystem${prefix}/include/LegacySupport -arch ${configure.build_arch}|" ${worksrcpath}/targets.conf.in
    } elseif {${os.platform} eq "darwin"} {
        reinplace "s| @EXTRA_LIBS@||" ${worksrcpath}/targets.conf.in
        reinplace "s| @EXTRA_CFLAGS@| -arch ${configure.build_arch}|" ${worksrcpath}/targets.conf.in
    } else {
        reinplace "s| @EXTRA_LIBS@||" ${worksrcpath}/targets.conf.in
        reinplace "s| @EXTRA_CFLAGS@||" ${worksrcpath}/targets.conf.in
    }
}

compiler.blacklist-append   *gcc-4.*

build.args-append           CONF=unix

if {${os.platform} eq "darwin" && ${os.major} < 16} {
    build.args-append       CCLIBS=-lMacportsLegacySupport
}

build.target                all

universal_variant           no

destroot.target             oldinstall
destroot.pre_args-append    PREFIX=${destroot}${prefix}

test.run                    yes
test.target                 everytestmhs
if {${os.platform} eq "darwin" && ${os.major} < 16} {
    test.args-append        CCLIBS=-lMacportsLegacySupport
}

notes "
Please set environment variable MHSDIR to ${prefix}/lib/mhs
"
