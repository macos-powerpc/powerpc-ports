# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem      1.0
PortGroup       active_variants 1.1
PortGroup       github 1.0
PortGroup       legacysupport 1.1
PortGroup       meson 1.0

# for strnlen, at least
legacysupport.newest_darwin_requires_legacy 10

# PLEASE DO NOT USE THIS PORT unless you know what you are doing.
# Provisionally it works on x86_86 and arm64, with some oddities.
# It does not build with gcc, on any system, so cannot build on PowerPC.
# Depspecs may or may not be accurate.

# FIXME: currently it fails to run:
# https://github.com/X11Libre/xserver/issues/1733

name            xlibre-xserver
github.setup    X11Libre xserver 25.0.0.18 ${name}-
revision        0
conflicts       xorg-server-legacy xorg-server-1.18 xorg-server xorg-server-devel xquartz
categories      x11 devel
platforms       {darwin > 8}
license         X11
maintainers     {@barracuda156 macos-powerpc.org:barracuda}
description     XLibre Xserver
long_description \
                The XLibre Xserver allows you to run X11 applications \
                on your computer.

set main_dist   ${distname}.tar.gz
checksums       ${main_dist} \
                rmd160  5ef21750148bd74ba064feb7e4584effb4c1e930 \
                sha256  620652fdb8e03a8642936a0c90506f1a3f51a51f1025be51dffcf897fa02172c \
                size    5415014
github.tarball_from archive

depends_build-append \
        path:bin/pkg-config:pkgconfig \
        port:xorg-font-util \
        port:xorg-libxkbfile \
        port:xorg-util-macros \
        port:xorg-xorgproto \
        port:xorg-xtrans

# Mesa is a *lib* dependency now: /opt/local/bin/Xephyr
# links to /opt/local/lib/libGL.1.dylib
depends_lib-append \
        port:libepoxy \
        path:lib/pkgconfig/pixman-1.pc:libpixman \
        port:mesa \
        port:xorg-libX11 \
        port:xorg-libXau \
        port:xorg-libxcb \
        port:xorg-libXdmcp \
        port:xorg-libXext \
        port:xorg-libXfixes \
        port:xorg-libXfont2 \
        port:xorg-libXinerama \
        port:xorg-libXres \
        port:xorg-libXScrnSaver \
        port:xorg-libxshmfence \
        port:xorg-xcb-util \
        port:xorg-xcb-util-image \
        port:xorg-xcb-util-keysyms \
        port:xorg-xcb-util-renderutil \
        port:xorg-xcb-util-wm

require_active_variants libepoxy egl
require_active_variants mesa egl

platform darwin {
    depends_lib-append \
        port:xorg-libAppleWM
}

# This xinit dependency needs to be port: not bin:
# because we specifically run ${prefix}/bin/startx from bundle-main.c
depends_run-append \
        port:quartz-wm \
        port:xauth \
        port:xinit \
        port:xkbcomp \
        port:xkeyboard-config \
        port:xorg-fonts

# Disable for now, see below.
# compiler.c_standard 2011

patch.pre_args-replace  -p0 -p1

# Fix broken build system:
patchfiles-append       meson-unbreak-bundle.patch

# https://github.com/X11Libre/xserver/pull/1743
patchfiles-append       0001-hw-xquartz-remove-apple-block-extension-code.patch \
                        0002-hw-xquartz-Rewrite-XQuartzDefaults-without-Apple-blo.patch \
                        0003-hw-xquartz-Purge-Apple-blocks-from-X11Application.m.patch \
                        0004-os-client-replace-apple-block-with-proper-function.patch \
                        0005-os-client-rename-get_argmax_fptr-to-get_argmax_from_.patch

# More portability fixes:
patchfiles-append       0006-xquartz-replace-__private_extern__-with-__attribute_.patch \
                        0007-xquartz-use-autoreleasepool-only-with-clang.patch

configure.args-append \
        -Dbundle-id-prefix=org.macports
#        -Ddocs=false \
        -Ddri2=false \
        -Ddri3=false \
        -Ddtrace=false \
        -Dlibunwind=false \
        -Dsha1=CommonCrypto \
        -Dtests=false \
        -Dxcsecurity=false \
        -Dxf86bigfont=false \
        -Dxpbproxy=false \
        -Dxwin=false

platform darwin {
    configure.args-append \
        -Dapple-applications-dir=${applications_dir}
#        -Ddrm=false
}

# -Dxorg=true triggers Linux-specific modules:
# pciaccess relies not only on libpciaccess but also linux kernel.
# However even if it is disabled, source pulls in libpciaccess header.
# https://github.com/X11Libre/xserver/issues/1731
# https://github.com/X11Libre/xserver/issues/1732
if {${os.platform} ne "linux"} {
#    configure.args-append \
        -Dint10=false \
        -Dpciaccess=false \
        -Dsystemd_logind=false \
        -Dudev=false \
        -Dvgahw=false \
        -Dxselinux=false
}

# TODO: check what is still needed of these.
# render/picture.c:876:26: error: array subscript 'union _SourcePict[0]' is partly outside array bounds of 'unsigned char[16]' [-Werror=array-bounds=]
# os/client.c:162:14: error: assignment to 'char **' from 'int' makes pointer from integer without a cast [-Wint-conversion]
# xquartz/quartz.c:417:9: error: implicit declaration of function 'xp_disable_hot_keys'; did you mean 'xp_disable_update'? [-Wimplicit-function-declaration]
# xquartz/X11Controller.m:173:31: error: passing argument 2 of 'insertItemWithTitle:action:keyEquivalent:atIndex:' from incompatible pointer type [-Wincompatible-pointer-types]
# xquartz/X11Controller.m:596:1: error: control reaches end of non-void function [-Werror=return-type]
# xquartz/pbproxy/x-selection.m:1205:5: error: '-fobjc-exceptions' is required to enable Objective-C exception syntax
if {[string match macports-gcc* ${configure.compiler}]} {
    configure.cflags-append \
        -Wno-error=array-bounds= \
        -Wno-error=implicit-function-declaration \
        -Wno-error=int-conversion \
        -Wno-error=incompatible-pointer-types
    configure.objcflags-append \
        -fobjc-exceptions \
        -Wno-error=return-type
}

platform darwin 9 {
    # Xplugin.h is missing on Tiger and incorrect on Leopard.
    configure.cppflags-append \
        -I${filespath}/include
}

destroot.args-append \
        --destdir=${destroot}

post-destroot {
        system "chown -R root:admin ${destroot}${applications_dir}/X11.app"

        ln -s Xquartz ${destroot}${prefix}/bin/X
}

variant xcsecurity description "Enable Security Extensions" {
    configure.args-replace \
        -Dxcsecurity=false -Dxcsecurity=true
}
