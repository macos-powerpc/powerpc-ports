From 0b9df419544099dc21ec86e963b1e64c96a1dfdc Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 25 Dec 2025 03:20:29 +0800
Subject: [PATCH 9/9] Misc compat fixes

---
 hw/xquartz/NSUserDefaults+XQuartzDefaults.m | 102 +++++++++++---------
 hw/xquartz/X11Application.m                 |  40 +++++---
 2 files changed, 83 insertions(+), 59 deletions(-)

diff --git a/hw/xquartz/NSUserDefaults+XQuartzDefaults.m b/hw/xquartz/NSUserDefaults+XQuartzDefaults.m
index 71e84a723..fc7223406 100644
--- a/hw/xquartz/NSUserDefaults+XQuartzDefaults.m
+++ b/hw/xquartz/NSUserDefaults+XQuartzDefaults.m
@@ -47,12 +47,14 @@ static void
 globalDefaultsOnce(void *arg)
 {
     NSUserDefaults **defaults = arg;
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1070
     NSString * const defaultsDomain = @".GlobalPreferences";
     *defaults = [[[NSUserDefaults alloc] initWithSuiteName:defaultsDomain] retain];
-
-    NSDictionary<NSString *, id> * const defaultDefaultsDict = @{
-        @"AppleSpacesSwitchOnActivate" : @(YES),
-    };
+#else
+    *defaults = [[NSUserDefaults standardUserDefaults] retain];
+#endif
+    NSMutableDictionary *defaultDefaultsDict = [[NSMutableDictionary alloc] init];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:YES] forKey:@"AppleSpacesSwitchOnActivate"];
 
     [*defaults registerDefaults:defaultDefaultsDict];
 }
@@ -61,12 +63,14 @@ static void
 dockDefaultsOnce(void *arg)
 {
     NSUserDefaults **defaults = arg;
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1070
     NSString * const defaultsDomain = @"com.apple.dock";
     *defaults = [[[NSUserDefaults alloc] initWithSuiteName:defaultsDomain] retain];
-
-    NSDictionary<NSString *, id> * const defaultDefaultsDict = @{
-        @"workspaces" : @(NO),
-    };
+#else
+    *defaults = [[NSUserDefaults standardUserDefaults] retain];
+#endif
+    NSMutableDictionary *defaultDefaultsDict = [[NSMutableDictionary alloc] init];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO] forKey:@"workspaces"];
 
     [*defaults registerDefaults:defaultDefaultsDict];
 }
@@ -75,61 +79,63 @@ static void
 xquartzDefaultsOnce(void *arg)
 {
     NSUserDefaults **defaults = (NSUserDefaults **)arg;
-    NSString *const defaultsDomain = @(BUNDLE_ID_PREFIX ".X11");
-    NSString *const defaultDefaultsDomain = NSBundle.mainBundle.bundleIdentifier;
+
+    NSString *defaultsDomain = [NSString stringWithFormat:@"%s.X11", BUNDLE_ID_PREFIX];
+    NSString *defaultDefaultsDomain = [[NSBundle mainBundle] bundleIdentifier];
 
     if ([defaultsDomain isEqualToString:defaultDefaultsDomain]) {
-        *defaults = [NSUserDefaults.standardUserDefaults retain];
+        *defaults = [[NSUserDefaults standardUserDefaults] retain];
     } else {
-        *defaults = [[[NSUserDefaults alloc] initWithSuiteName:defaultsDomain] retain];
+        *defaults = [[NSUserDefaults standardUserDefaults] retain];
     }
 
     NSString *defaultWindowItemModifiers = @"command";
-    NSString * const defaultWindowItemModifiersLocalized =
+    NSString *defaultWindowItemModifiersLocalized =
         NSLocalizedString(@"window item modifiers", @"window item modifiers");
 
     if (![defaultWindowItemModifiersLocalized isEqualToString:@"window item modifiers"]) {
         defaultWindowItemModifiers = defaultWindowItemModifiersLocalized;
     }
 
-    NSDictionary<NSString *, id> * const defaultDefaultsDict = @{
-        XQuartzPrefKeyFakeButtons : @(NO),
-        /* XQuartzPrefKeyFakeButton2 nil default */
-        /* XQuartzPrefKeyFakeButton3 nil default */
-        XQuartzPrefKeyKeyEquivs : @(YES),
-        XQuartzPrefKeyFullscreenHotkeys : @(NO),
-        XQuartzPrefKeyFullscreenMenu : @(NO),
-        XQuartzPrefKeySyncKeymap : @(NO),
-        XQuartzPrefKeyDepth : @(-1),
-        XQuartzPrefKeyNoAuth : @(NO),
-        XQuartzPrefKeyNoTCP : @(NO),
-        XQuartzPrefKeyDoneXinitCheck : @(NO),
-        XQuartzPrefKeyNoQuitAlert : @(NO),
-        XQuartzPrefKeyNoRANDRAlert : @(NO),
-        XQuartzPrefKeyOptionSendsAlt : @(NO),
-        /* XQuartzPrefKeyAppKitModifiers nil default */
-        XQuartzPrefKeyWindowItemModifiers : defaultWindowItemModifiers,
-        XQuartzPrefKeyRootless : @(YES),
-        XQuartzPrefKeyRENDERExtension : @(YES),
-        XQuartzPrefKeyTESTExtension : @(NO),
-        XQuartzPrefKeyLoginShell : @"/bin/sh",
-        XQuartzPrefKeyClickThrough : @(NO),
-        XQuartzPrefKeyFocusFollowsMouse : @(NO),
-        XQuartzPrefKeyFocusOnNewWindow : @(YES),
-
-        XQuartzPrefKeyScrollInDeviceDirection : @(NO),
-        XQuartzPrefKeySyncPasteboard : @(YES),
-        XQuartzPrefKeySyncPasteboardToClipboard : @(YES),
-        XQuartzPrefKeySyncPasteboardToPrimary : @(YES),
-        XQuartzPrefKeySyncClipboardToPasteBoard : @(YES),
-        XQuartzPrefKeySyncPrimaryOnSelect : @(NO),
-    };
+    NSMutableDictionary *defaultDefaultsDict = [[NSMutableDictionary alloc] init];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyFakeButtons];
+    // XQuartzPrefKeyFakeButton2 and 3 left as nil (no setObject)
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:YES]  forKey:XQuartzPrefKeyKeyEquivs];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyFullscreenHotkeys];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyFullscreenMenu];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeySyncKeymap];
+    [defaultDefaultsDict setObject:[NSNumber numberWithInt:-1]    forKey:XQuartzPrefKeyDepth];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyNoAuth];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyNoTCP];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyDoneXinitCheck];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyNoQuitAlert];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyNoRANDRAlert];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyOptionSendsAlt];
+    // XQuartzPrefKeyAppKitModifiers is nil
+    [defaultDefaultsDict setObject:defaultWindowItemModifiers     forKey:XQuartzPrefKeyWindowItemModifiers];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:YES]  forKey:XQuartzPrefKeyRootless];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:YES]  forKey:XQuartzPrefKeyRENDERExtension];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyTESTExtension];
+    [defaultDefaultsDict setObject:@"/bin/sh"                     forKey:XQuartzPrefKeyLoginShell];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyClickThrough];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyFocusFollowsMouse];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:YES]  forKey:XQuartzPrefKeyFocusOnNewWindow];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeyScrollInDeviceDirection];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:YES]  forKey:XQuartzPrefKeySyncPasteboard];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:YES]  forKey:XQuartzPrefKeySyncPasteboardToClipboard];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:YES]  forKey:XQuartzPrefKeySyncPasteboardToPrimary];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:YES]  forKey:XQuartzPrefKeySyncClipboardToPasteBoard];
+    [defaultDefaultsDict setObject:[NSNumber numberWithBool:NO]   forKey:XQuartzPrefKeySyncPrimaryOnSelect];
 
     [*defaults registerDefaults:defaultDefaultsDict];
+    [defaultDefaultsDict release];
 
-    NSString * const systemDefaultsPlistPath = [@(XQUARTZ_DATA_DIR) stringByAppendingPathComponent:@"defaults.plist"];
-    NSDictionary<NSString *, id> * const systemDefaultsDict = [NSDictionary dictionaryWithContentsOfFile:systemDefaultsPlistPath];
-    [*defaults registerDefaults:systemDefaultsDict];
+    NSString *systemDefaultsPlistPath =
+        [[NSString stringWithUTF8String:XQUARTZ_DATA_DIR] stringByAppendingPathComponent:@"defaults.plist"];
+    NSDictionary *systemDefaultsDict = [NSDictionary dictionaryWithContentsOfFile:systemDefaultsPlistPath];
+    if (systemDefaultsDict) {
+        [*defaults registerDefaults:systemDefaultsDict];
+    }
 }
 
 @implementation NSUserDefaults (XQuartzDefaults)
diff --git a/hw/xquartz/X11Application.m b/hw/xquartz/X11Application.m
index fcf9f8dda..d6c1c7aef 100644
--- a/hw/xquartz/X11Application.m
+++ b/hw/xquartz/X11Application.m
@@ -159,8 +159,18 @@ X11Application *X11App;
 @property (nonatomic, readwrite, assign) OSX_BOOL x_active;
 @end
 
+@interface X11Application : NSApplication
+{
+    OSX_BOOL x_active;
+    id controller;
+}
+@end
+
 @implementation X11Application
 
+@synthesize x_active;
+@synthesize controller;
+
 typedef struct message_struct message;
 struct message_struct {
     mach_msg_header_t hdr;
@@ -346,7 +356,7 @@ sendX11NSEvent_fptr(void *e_ptr)
     case NSKeyDown:
     case NSKeyUp:
 
-        if (_x_active) {
+        if (self.x_active) {
             static BOOL do_swallow = NO;
             static int swallow_keycode;
 
@@ -415,7 +425,7 @@ sendX11NSEvent_fptr(void *e_ptr)
 
     case NSFlagsChanged:
         /* Don't tell X11 about modifiers changing while it's not active */
-        if (!_x_active)
+        if (!self.x_active)
             for_x = NO;
         break;
 
@@ -439,9 +449,9 @@ sendX11NSEvent_fptr(void *e_ptr)
                 [self set_front_process:nil];
 
                 /* Get the Spaces preference for SwitchOnActivate */
-                BOOL const workspaces = [NSUserDefaults.dockDefaults boolForKey:@"workspaces"];
+                BOOL const workspaces = [[NSUserDefaults dockDefaults] boolForKey:@"workspaces"];
                 if (workspaces) {
-                    order_all_windows = [NSUserDefaults.globalDefaults boolForKey:@"AppleSpacesSwitchOnActivate"];
+                    order_all_windows = [[NSUserDefaults globalDefaults] boolForKey:@"AppleSpacesSwitchOnActivate"];
                 }
 
                 /* TODO: In the workspaces && !AppleSpacesSwitchOnActivate case, the windows are ordered
@@ -464,8 +474,8 @@ sendX11NSEvent_fptr(void *e_ptr)
         case NSApplicationDeactivatedEventType:
             for_x = NO;
 
-            x_was_active = _x_active;
-            if (_x_active)
+            x_was_active = self.x_active;
+            if (self.x_active)
                 [self activateX:NO];
             break;
         }
@@ -583,18 +593,26 @@ X11ApplicationSetWindowMenu(int nitems, const char **items,
 {
 #ifdef __clang__
     @autoreleasepool {
+        NSMutableArray<NSArray<NSString *> *> *allMenuItems =
 #else
     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
+        NSMutableArray *allMenuItems =
 #endif
-        NSMutableArray<NSArray<NSString *> *> *allMenuItems =
             [[NSMutableArray alloc] init];
 
         for (int i = 0; i < nitems; i++) {
+#ifdef __clang__
             NSMutableArray<NSString *> *menuItem =
+#else
+            NSMutableArray *menuItem =
+#endif
                 [[NSMutableArray alloc] init];
 
+#ifdef __clang__
             [menuItem addObject:@(items[i])];
-
+#else
+            [menuItem addObject:[NSString stringWithUTF8String:items[i]]];
+#endif
             if (shortcuts[i] == 0) {
                 [menuItem addObject:@""];
             } else {
@@ -845,7 +863,7 @@ X11ApplicationMain(int argc, char **argv, char **envp)
         [X11App read_defaults];
 
         [NSBundle loadNibNamed:@"main" owner:NSApp];
-        [NSNotificationCenter.defaultCenter addObserver:NSApp
+        [[NSNotificationCenter defaultCenter] addObserver:NSApp
                                                selector:@selector (became_key:)
                                                    name:NSWindowDidBecomeKeyNotification
                                                  object:nil];
@@ -857,9 +875,9 @@ X11ApplicationMain(int argc, char **argv, char **envp)
         QuartzModeBundleInit();
 
         /* Calculate the height of the menubar so we can avoid it. */
-        aquaMenuBarHeight = NSApp.mainMenu.menuBarHeight;
+        aquaMenuBarHeight = [[NSApp mainMenu] menuBarHeight];
         if (!aquaMenuBarHeight) {
-            NSScreen* primaryScreen = NSScreen.screens[0];
+            NSScreen* primaryScreen = [[NSScreen screens] objectAtIndex:0];
             aquaMenuBarHeight = NSHeight(primaryScreen.frame) - NSMaxY(primaryScreen.visibleFrame);
         }
 
-- 
2.52.0

