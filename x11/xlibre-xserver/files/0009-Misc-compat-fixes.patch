From c9e4123ba85bfb57dcff24929422ae9ec7d0d369 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 25 Dec 2025 03:20:29 +0800
Subject: [PATCH 9/9] Misc compat fixes

---
 hw/xquartz/X11Application.m | 33 ++++++++++++++++++++++-----------
 1 file changed, 22 insertions(+), 11 deletions(-)

diff --git a/hw/xquartz/X11Application.m b/hw/xquartz/X11Application.m
index fcf9f8dda..e2df7927f 100644
--- a/hw/xquartz/X11Application.m
+++ b/hw/xquartz/X11Application.m
@@ -161,6 +161,9 @@ X11Application *X11App;
 
 @implementation X11Application
 
+@synthesize x_active;
+@synthesize controller;
+
 typedef struct message_struct message;
 struct message_struct {
     mach_msg_header_t hdr;
@@ -346,7 +349,7 @@ sendX11NSEvent_fptr(void *e_ptr)
     case NSKeyDown:
     case NSKeyUp:
 
-        if (_x_active) {
+        if (self.x_active) {
             static BOOL do_swallow = NO;
             static int swallow_keycode;
 
@@ -415,7 +418,7 @@ sendX11NSEvent_fptr(void *e_ptr)
 
     case NSFlagsChanged:
         /* Don't tell X11 about modifiers changing while it's not active */
-        if (!_x_active)
+        if (!self.x_active)
             for_x = NO;
         break;
 
@@ -439,9 +442,9 @@ sendX11NSEvent_fptr(void *e_ptr)
                 [self set_front_process:nil];
 
                 /* Get the Spaces preference for SwitchOnActivate */
-                BOOL const workspaces = [NSUserDefaults.dockDefaults boolForKey:@"workspaces"];
+                BOOL const workspaces = [[NSUserDefaults dockDefaults] boolForKey:@"workspaces"];
                 if (workspaces) {
-                    order_all_windows = [NSUserDefaults.globalDefaults boolForKey:@"AppleSpacesSwitchOnActivate"];
+                    order_all_windows = [[NSUserDefaults globalDefaults] boolForKey:@"AppleSpacesSwitchOnActivate"];
                 }
 
                 /* TODO: In the workspaces && !AppleSpacesSwitchOnActivate case, the windows are ordered
@@ -464,8 +467,8 @@ sendX11NSEvent_fptr(void *e_ptr)
         case NSApplicationDeactivatedEventType:
             for_x = NO;
 
-            x_was_active = _x_active;
-            if (_x_active)
+            x_was_active = self.x_active;
+            if (self.x_active)
                 [self activateX:NO];
             break;
         }
@@ -583,18 +586,26 @@ X11ApplicationSetWindowMenu(int nitems, const char **items,
 {
 #ifdef __clang__
     @autoreleasepool {
+        NSMutableArray<NSArray<NSString *> *> *allMenuItems =
 #else
     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
+        NSMutableArray *allMenuItems =
 #endif
-        NSMutableArray<NSArray<NSString *> *> *allMenuItems =
             [[NSMutableArray alloc] init];
 
         for (int i = 0; i < nitems; i++) {
+#ifdef __clang__
             NSMutableArray<NSString *> *menuItem =
+#else
+            NSMutableArray *menuItem =
+#endif
                 [[NSMutableArray alloc] init];
 
+#ifdef __clang__
             [menuItem addObject:@(items[i])];
-
+#else
+            [menuItem addObject:[NSString stringWithUTF8String:items[i]]];
+#endif
             if (shortcuts[i] == 0) {
                 [menuItem addObject:@""];
             } else {
@@ -845,7 +856,7 @@ X11ApplicationMain(int argc, char **argv, char **envp)
         [X11App read_defaults];
 
         [NSBundle loadNibNamed:@"main" owner:NSApp];
-        [NSNotificationCenter.defaultCenter addObserver:NSApp
+        [[NSNotificationCenter defaultCenter] addObserver:NSApp
                                                selector:@selector (became_key:)
                                                    name:NSWindowDidBecomeKeyNotification
                                                  object:nil];
@@ -857,9 +868,9 @@ X11ApplicationMain(int argc, char **argv, char **envp)
         QuartzModeBundleInit();
 
         /* Calculate the height of the menubar so we can avoid it. */
-        aquaMenuBarHeight = NSApp.mainMenu.menuBarHeight;
+        aquaMenuBarHeight = [[NSApp mainMenu] menuBarHeight];
         if (!aquaMenuBarHeight) {
-            NSScreen* primaryScreen = NSScreen.screens[0];
+            NSScreen* primaryScreen = [[NSScreen screens] objectAtIndex:0];
             aquaMenuBarHeight = NSHeight(primaryScreen.frame) - NSMaxY(primaryScreen.visibleFrame);
         }
 
-- 
2.52.0

