From ad54e7f04ece15cb71d295c7168504c51aaaf548 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Fri, 26 Dec 2025 21:46:36 +0800
Subject: [PATCH 10/10] Misc hacks for gcc & legacy OS

---
 hw/xquartz/X11Application.h           |  10 ++-
 hw/xquartz/X11Application.m           |  11 ---
 hw/xquartz/X11Controller.h            |  34 +++++++-
 hw/xquartz/X11Controller.m            | 108 +++++++++++++++++---------
 hw/xquartz/applewmExt.h               |   6 ++
 hw/xquartz/mach-startup/bundle-main.c |   2 +
 hw/xquartz/quartz.c                   |  15 +---
 hw/xquartz/xpr/xprEvent.c             |  10 ++-
 8 files changed, 130 insertions(+), 66 deletions(-)

diff --git a/hw/xquartz/X11Application.h b/hw/xquartz/X11Application.h
index 1ef98bee3..5dd1410e9 100644
--- a/hw/xquartz/X11Application.h
+++ b/hw/xquartz/X11Application.h
@@ -37,10 +37,12 @@
 
 #import "X11Controller.h"
 
-@interface X11Application : NSApplication
-
-@property (nonatomic, readwrite, strong) X11Controller *controller;
-@property (nonatomic, readonly, assign) OSX_BOOL x_active;
+@interface X11Application : NSApplication {
+    OSX_BOOL x_active;
+    X11Controller *controller;
+}
+@property (nonatomic, readwrite, retain) X11Controller *controller;
+@property (nonatomic, readwrite, assign) OSX_BOOL x_active;
 
 @end
 
diff --git a/hw/xquartz/X11Application.m b/hw/xquartz/X11Application.m
index d6c1c7aef..4b3a9528d 100644
--- a/hw/xquartz/X11Application.m
+++ b/hw/xquartz/X11Application.m
@@ -155,17 +155,6 @@ X11Application *X11App;
 - (void) sendX11NSEvent:(NSEvent *)e;
 @end
 
-@interface X11Application ()
-@property (nonatomic, readwrite, assign) OSX_BOOL x_active;
-@end
-
-@interface X11Application : NSApplication
-{
-    OSX_BOOL x_active;
-    id controller;
-}
-@end
-
 @implementation X11Application
 
 @synthesize x_active;
diff --git a/hw/xquartz/X11Controller.h b/hw/xquartz/X11Controller.h
index b7130895f..baaaef0c5 100644
--- a/hw/xquartz/X11Controller.h
+++ b/hw/xquartz/X11Controller.h
@@ -48,7 +48,39 @@
 #define strong retain
 #endif
 
-@interface X11Controller : NSObject <NSTableViewDataSource>
+@interface X11Controller : NSObject <NSTableViewDataSource> {
+    NSPanel *_prefs_panel;
+    NSButton *_fake_buttons;
+    NSButton *_enable_fullscreen;
+    NSButton *_enable_fullscreen_menu;
+    NSTextField *_enable_fullscreen_menu_text;
+    NSButton *_enable_keyequivs;
+    NSButton *_sync_keymap;
+    NSButton *_option_sends_alt;
+    NSButton *_scroll_in_device_direction;
+    NSButton *_click_through;
+    NSButton *_focus_follows_mouse;
+    NSButton *_focus_on_new_window;
+    NSButton *_enable_auth;
+    NSButton *_enable_tcp;
+    NSButton *_sync_pasteboard;
+    NSButton *_sync_pasteboard_to_clipboard;
+    NSButton *_sync_pasteboard_to_primary;
+    NSButton *_sync_clipboard_to_pasteboard;
+    NSButton *_sync_primary_immediately;
+    NSTextField *_sync_text1;
+    NSTextField *_sync_text2;
+    NSPopUpButton *_depth;
+    NSMenuItem *_x11_about_item;
+    NSMenuItem *_dock_window_separator;
+    NSMenuItem *_apps_separator;
+    NSMenuItem *_toggle_fullscreen_item;
+    NSMenuItem *_copy_menu_item;
+    NSMenu *_dock_apps_menu;
+    NSTableView *_apps_table;
+    NSMenu *_dock_menu;
+}
+
 @property (nonatomic, readwrite, strong) IBOutlet NSPanel *prefs_panel;
 
 @property (nonatomic, readwrite, strong) IBOutlet NSButton *fake_buttons;
diff --git a/hw/xquartz/X11Controller.m b/hw/xquartz/X11Controller.m
index 7e7306895..cf18ffc61 100644
--- a/hw/xquartz/X11Controller.m
+++ b/hw/xquartz/X11Controller.m
@@ -59,11 +59,11 @@ extern char *bundle_id_prefix;
 
 @interface X11Controller ()
 #ifdef XQUARTZ_SPARKLE
-@property (nonatomic, readwrite, strong) NSMenuItem *check_for_updates_item; // Programatically enabled
+@property (nonatomic, readwrite, retain) NSMenuItem *check_for_updates_item; // Programatically enabled
 #endif
 
-@property (nonatomic, readwrite, strong) NSArray <NSArray <NSString *> *> *apps;
-@property (nonatomic, readwrite, strong) NSMutableArray <NSMutableArray <NSString *> *> *table_apps;
+@property (nonatomic, readwrite, retain) NSArray *apps;
+@property (nonatomic, readwrite, retain) NSMutableArray *table_apps;
 @property (nonatomic, readwrite, assign) NSInteger windows_menu_nitems;
 @property (nonatomic, readwrite, assign) int checked_window_item;
 @property (nonatomic, readwrite, assign) x_list *pending_apps;
@@ -72,6 +72,37 @@ extern char *bundle_id_prefix;
 
 @implementation X11Controller
 
+@synthesize prefs_panel = _prefs_panel;
+@synthesize fake_buttons = _fake_buttons;
+@synthesize enable_fullscreen = _enable_fullscreen;
+@synthesize enable_fullscreen_menu = _enable_fullscreen_menu;
+@synthesize enable_fullscreen_menu_text = _enable_fullscreen_menu_text;
+@synthesize enable_keyequivs = _enable_keyequivs;
+@synthesize sync_keymap = _sync_keymap;
+@synthesize option_sends_alt = _option_sends_alt;
+@synthesize scroll_in_device_direction = _scroll_in_device_direction;
+@synthesize click_through = _click_through;
+@synthesize focus_follows_mouse = _focus_follows_mouse;
+@synthesize focus_on_new_window = _focus_on_new_window;
+@synthesize enable_auth = _enable_auth;
+@synthesize enable_tcp = _enable_tcp;
+@synthesize sync_pasteboard = _sync_pasteboard;
+@synthesize sync_pasteboard_to_clipboard = _sync_pasteboard_to_clipboard;
+@synthesize sync_pasteboard_to_primary = _sync_pasteboard_to_primary;
+@synthesize sync_clipboard_to_pasteboard = _sync_clipboard_to_pasteboard;
+@synthesize sync_primary_immediately = _sync_primary_immediately;
+@synthesize sync_text1 = _sync_text1;
+@synthesize sync_text2 = _sync_text2;
+@synthesize depth = _depth;
+@synthesize x11_about_item = _x11_about_item;
+@synthesize dock_window_separator = _dock_window_separator;
+@synthesize apps_separator = _apps_separator;
+@synthesize toggle_fullscreen_item = _toggle_fullscreen_item;
+@synthesize copy_menu_item = _copy_menu_item;
+@synthesize dock_apps_menu = _dock_apps_menu;
+@synthesize apps_table = _apps_table;
+@synthesize dock_menu = _dock_menu;
+
 - (void) awakeFromNib
 {
     X11Application *xapp = NSApp;
@@ -87,7 +118,7 @@ extern char *bundle_id_prefix;
 
         /* convert from [TITLE1 COMMAND1 TITLE2 COMMAND2 ...]
            to [[TITLE1 COMMAND1] [TITLE2 COMMAND2] ...] format. */
-        if (count > 0 && ![appsMenu[0] isKindOfClass:NSArray.class]) {
+        if (count > 0 && ![[appsMenu objectAtIndex:0] isKindOfClass:[NSArray class]]) {
             int i;
             NSMutableArray *copy, *sub;
 
@@ -95,8 +126,8 @@ extern char *bundle_id_prefix;
 
             for (i = 0; i < count / 2; i++) {
                 sub = [[NSMutableArray alloc] initWithCapacity:3];
-                [sub addObject:appsMenu[i * 2]];
-                [sub addObject:appsMenu[i * 2 + 1]];
+                [sub addObject:[appsMenu objectAtIndex:i * 2]];
+                [sub addObject:[appsMenu objectAtIndex:i * 2 + 1]];
                 [sub addObject:@""];
                 [copy addObject:sub];
                 [sub release];
@@ -109,7 +140,7 @@ extern char *bundle_id_prefix;
         [self set_apps_menu:appsMenu];
     }
 
-    [NSNotificationCenter.defaultCenter addObserver:self
+    [[NSNotificationCenter defaultCenter] addObserver:self
                                            selector:@selector(apps_table_done:)
                                                name:NSWindowWillCloseNotification
                                              object:self.apps_table.window];
@@ -155,10 +186,10 @@ extern char *bundle_id_prefix;
     self.apps = nil;
 }
 
-- (void) prepend_apps_item:(NSArray <NSArray <NSString *> *> *)list index:(int)i menu:(NSMenu *)menu
+- (void) prepend_apps_item:(NSArray *)list index:(int)i menu:(NSMenu *)menu
 {
     NSString *title, *shortcut = @"";
-    NSArray <NSString *> *group;
+    NSArray *group;
     NSMenuItem *item;
 
     group = [list objectAtIndex:i];
@@ -182,7 +213,7 @@ extern char *bundle_id_prefix;
     [item setTag:i + 1];                  /* can't be zero, so add one */
 }
 
-- (void) install_apps_menu:(NSArray <NSArray <NSString *> *> *)list
+- (void) install_apps_menu:(NSArray *)list;
 {
     NSMenu *menu;
     int i, count;
@@ -206,7 +237,7 @@ extern char *bundle_id_prefix;
     self.apps = list;
 }
 
-- (void) set_window_menu:(NSArray <NSArray <NSString *> *> *)list
+- (void) set_window_menu:(NSArray *)list;
 {
     NSMenu * const menu = X11App.windowsMenu;
     NSMenu * const dock_menu = self.dock_menu;
@@ -236,25 +267,26 @@ extern char *bundle_id_prefix;
 
         for (NSInteger i = 0; i < itemsToAdd; i++) {
             NSString *name, *shortcut;
+            NSArray *row = [list objectAtIndex:i];
 
-            name = list[i][0];
-            shortcut = list[i][1];
+            name = [row objectAtIndex:0];
+            shortcut = [row objectAtIndex:1];
 
             if (windowItemModMask == 0 || windowItemModMask == -1)
                 shortcut = @"";
 
             item = (NSMenuItem *)[menu addItemWithTitle:name
-                                                 action:@selector(item_selected:)
-                                          keyEquivalent:shortcut];
+                                        action:@selector(item_selected:)
+                                    keyEquivalent:shortcut];
             [item setKeyEquivalentModifierMask:(NSUInteger)windowItemModMask];
             [item setTarget:self];
             [item setTag:i];
             [item setEnabled:YES];
 
-            item = (NSMenuItem *)[dock_menu  insertItemWithTitle:name
-                                                          action:@selector(item_selected:)
-                                                   keyEquivalent:shortcut
-                                                         atIndex:i];
+            item = (NSMenuItem *)[dock_menu insertItemWithTitle:name
+                                                action:@selector(item_selected:)
+                                            keyEquivalent:shortcut
+                                                atIndex:i];
             [item setKeyEquivalentModifierMask:(NSUInteger)windowItemModMask];
             [item setTarget:self];
             [item setTag:i];
@@ -302,7 +334,7 @@ extern char *bundle_id_prefix;
     self.checked_window_item = n;
 }
 
-- (void) set_apps_menu:(NSArray <NSArray <NSString *> *> *)list
+- (void) set_apps_menu:(NSArray *)list;
 {
     [self remove_apps_menu];
     [self install_apps_menu:list];
@@ -362,6 +394,7 @@ extern char *bundle_id_prefix;
         setenv("DISPLAY", buf, TRUE);
     }
 
+#if defined(ASL_LOG_DESCRIPTOR_READ)
     if (&asl_log_descriptor) {
         char *asl_sender;
         aslmsg amsg = asl_new(ASL_TYPE_MSG);
@@ -393,6 +426,7 @@ extern char *bundle_id_prefix;
 
         asl_free(amsg);
     }
+#endif
 
     /* Do the fork-twice trick to avoid having to reap zombies */
     child1 = fork();
@@ -410,12 +444,13 @@ extern char *bundle_id_prefix;
             _exit(1);
 
         case 0:                                     /* child2 */
+#if defined(ASL_LOG_DESCRIPTOR_READ)
             if (&asl_log_descriptor) {
                 /* Replace our stdout/stderr */
                 dup2(stdout_pipe[1], STDOUT_FILENO);
                 dup2(stderr_pipe[1], STDERR_FILENO);
             }
-
+#endif
             /* close all open files except for standard streams */
             max_files = sysconf(_SC_OPEN_MAX);
             for (i = 3; i < max_files; i++)
@@ -436,19 +471,20 @@ extern char *bundle_id_prefix;
     default:                                    /* parent */
         waitpid(child1, &status, 0);
     }
-
+#if defined(ASL_LOG_DESCRIPTOR_READ)
     if (&asl_log_descriptor) {
         /* Close the write ends of the pipe */
         close(stdout_pipe[1]);
         close(stderr_pipe[1]);
     }
+#endif
 }
 
 - (void) app_selected:sender
 {
     int tag;
     NSString *item;
-    NSArray <NSArray <NSString *> *> * const apps = self.apps;
+    NSArray * const apps = self.apps;
 
     tag = [sender tag] - 1;
     if (apps == nil || tag < 0 || tag >= [apps count])
@@ -462,15 +498,15 @@ extern char *bundle_id_prefix;
 - (IBAction) apps_table_show:sender
 {
     NSArray *columns;
-    NSMutableArray <NSMutableArray <NSString *> *> * const oldapps = self.table_apps;
+    NSMutableArray * const oldapps = self.table_apps;
     NSTableView * const apps_table = self.apps_table;
 
-    NSMutableArray <NSMutableArray <NSString *> *> * const table_apps = [[NSMutableArray alloc] initWithCapacity:1];
+    NSMutableArray * const table_apps = [[NSMutableArray alloc] initWithCapacity:1];
     self.table_apps = table_apps;
 
-    NSArray <NSArray <NSString *> *> * const apps = self.apps;
+    NSArray * const apps = self.apps;
     if (apps != nil) {
-        for (NSArray <NSString *> * row in apps) {
+        for (NSArray * row in apps) {
             [table_apps addObject:row.mutableCopy];
         }
     }
@@ -492,7 +528,7 @@ extern char *bundle_id_prefix;
 
 - (IBAction) apps_table_done:sender
 {
-    NSMutableArray <NSMutableArray <NSString *> *> * const table_apps = self.table_apps;
+    NSMutableArray * const table_apps = self.table_apps;
     NSTableView * const apps_table = self.apps_table;
     [apps_table deselectAll:sender];    /* flush edits? */
 
@@ -510,7 +546,7 @@ extern char *bundle_id_prefix;
 - (IBAction) apps_table_new:sender
 {
     NSMutableArray *item;
-    NSMutableArray <NSMutableArray <NSString *> *> * const table_apps = self.table_apps;
+    NSMutableArray * const table_apps = self.table_apps;
     NSTableView * const apps_table = self.apps_table;
 
     int row = [apps_table selectedRow], i;
@@ -539,10 +575,10 @@ extern char *bundle_id_prefix;
 
 - (IBAction) apps_table_duplicate:sender
 {
-    NSMutableArray <NSMutableArray <NSString *> *> * const table_apps = self.table_apps;
+    NSMutableArray * const table_apps = self.table_apps;
     NSTableView * const apps_table = self.apps_table;
     int row = [apps_table selectedRow], i;
-    NSMutableArray <NSString *> *item;
+    NSMutableArray *item;
 
     if (row < 0) {
         [self apps_table_new:sender];
@@ -565,7 +601,7 @@ extern char *bundle_id_prefix;
 
 - (IBAction) apps_table_delete:sender
 {
-    NSMutableArray <NSMutableArray <NSString *> *> * const table_apps = self.table_apps;
+    NSMutableArray * const table_apps = self.table_apps;
     NSTableView * const apps_table = self.apps_table;
     int row = [apps_table selectedRow];
 
@@ -589,7 +625,7 @@ extern char *bundle_id_prefix;
 
 - (NSInteger) numberOfRowsInTableView:(NSTableView *)tableView
 {
-    NSMutableArray <NSMutableArray <NSString *> *> * const table_apps = self.table_apps;
+    NSMutableArray * const table_apps = self.table_apps;
     if (table_apps == nil) return 0;
 
     return [table_apps count];
@@ -598,7 +634,7 @@ extern char *bundle_id_prefix;
 - (id)             tableView:(NSTableView *)tableView
    objectValueForTableColumn:(NSTableColumn *)tableColumn row:(NSInteger)row
 {
-    NSMutableArray <NSMutableArray <NSString *> *> * const table_apps = self.table_apps;
+    NSMutableArray * const table_apps = self.table_apps;
     NSArray *item;
     int col;
 
@@ -616,8 +652,8 @@ extern char *bundle_id_prefix;
 - (void) tableView:(NSTableView *)tableView setObjectValue:(id)object
     forTableColumn:(NSTableColumn *)tableColumn row:(NSInteger)row
 {
-    NSMutableArray <NSMutableArray <NSString *> *> * const table_apps = self.table_apps;
-    NSMutableArray <NSString *> *item;
+    NSMutableArray * const table_apps = self.table_apps;
+    NSMutableArray *item;
     int col;
 
     if (table_apps == nil) return;
diff --git a/hw/xquartz/applewmExt.h b/hw/xquartz/applewmExt.h
index 9a8b8d639..14c77214a 100644
--- a/hw/xquartz/applewmExt.h
+++ b/hw/xquartz/applewmExt.h
@@ -35,6 +35,12 @@
 #include "window.h"
 #include <Xplugin.h>
 
+#if XPLUGIN_VERSION < 4
+typedef int xp_frame_attr;
+typedef int xp_frame_class;
+typedef int xp_frame_rect;
+#endif
+
 typedef int (*DisableUpdateProc)(void);
 typedef int (*EnableUpdateProc)(void);
 typedef int (*SetWindowLevelProc)(WindowPtr pWin, int level);
diff --git a/hw/xquartz/mach-startup/bundle-main.c b/hw/xquartz/mach-startup/bundle-main.c
index e52dceda8..c5eb17102 100644
--- a/hw/xquartz/mach-startup/bundle-main.c
+++ b/hw/xquartz/mach-startup/bundle-main.c
@@ -524,8 +524,10 @@ setup_console_redirect(const char *bundle_id)
 
     asl_set_filter(aslc, ASL_FILTER_MASK_UPTO(ASL_LEVEL_WARNING));
 
+#if defined(ASL_LOG_DESCRIPTOR_READ)
     asl_log_descriptor(aslc, NULL, ASL_LEVEL_INFO, STDOUT_FILENO, ASL_LOG_DESCRIPTOR_WRITE);
     asl_log_descriptor(aslc, NULL, ASL_LEVEL_NOTICE, STDERR_FILENO, ASL_LOG_DESCRIPTOR_WRITE);
+#endif
 }
 
 static void
diff --git a/hw/xquartz/quartz.c b/hw/xquartz/quartz.c
index a8bce1532..7c941bb28 100644
--- a/hw/xquartz/quartz.c
+++ b/hw/xquartz/quartz.c
@@ -69,10 +69,6 @@
 #include <signal.h>
 #include <AvailabilityMacros.h>
 
-#ifndef __clang__
-#include <Foundation/Foundation.h>
-#endif
-
 #include <rootlessCommon.h>
 #include <Xplugin.h>
 
@@ -82,7 +78,7 @@
 // in the OS without major bincompat ramifications.
 //
 // These were added in macOS 10.7.
-#ifdef __clang__ && (MAC_OS_X_VERSION_MIN_REQUIRED >= 1070)
+#if defined(__clang__) && (MAC_OS_X_VERSION_MIN_REQUIRED >= 1070)
 void * _Nonnull objc_autoreleasePoolPush(void);
 void objc_autoreleasePoolPop(void * _Nonnull context);
 #endif
@@ -167,20 +163,13 @@ QuartzSetupScreen(int index,
 static void
 QuartzBlockHandler(void *blockData, void *pTimeout)
 {
-#ifdef __clang__ && (MAC_OS_X_VERSION_MIN_REQUIRED >= 1070)
+#if defined(__clang__) && (MAC_OS_X_VERSION_MIN_REQUIRED >= 1070)
     static void *poolToken = NULL;
 
     if (poolToken) {
         objc_autoreleasePoolPop(poolToken);
     }
     poolToken = objc_autoreleasePoolPush();
-#else
-    static NSAutoreleasePool *pool = nil;
-
-    if (pool) {
-        [pool drain];
-    }
-    pool = [[NSAutoreleasePool alloc] init];
 #endif
 }
 
diff --git a/hw/xquartz/xpr/xprEvent.c b/hw/xquartz/xpr/xprEvent.c
index 9fe33c6c5..937c4c1b6 100644
--- a/hw/xquartz/xpr/xprEvent.c
+++ b/hw/xquartz/xpr/xprEvent.c
@@ -50,7 +50,10 @@
 #include <sys/uio.h>
 #include <unistd.h>
 
+// Unused otherwise, see below.
+#if XPLUGIN_VERSION >= 6
 #include <dispatch/dispatch.h>
+#endif
 
 #include "rootlessWindow.h"
 #include "xprEvent.h"
@@ -59,7 +62,9 @@ static void
 bringAllToFront(void *unused)
 {
     (void) unused; /* to silence the compiler warning */
+#if XPLUGIN_VERSION >= 6
     xp_window_bring_all_to_front();
+#endif
 }
 
 Bool
@@ -79,10 +84,13 @@ QuartzModeEventHandler(int screenNum, XQuartzEvent *e, DeviceIntPtr dev)
 
     case kXquartzBringAllToFront:
         DEBUG_LOG("kXquartzBringAllToFront\n");
+#if XPLUGIN_VERSION >= 6 // No xp_window_bring_all_to_front before that.
         dispatch_async_f(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0),
                  NULL,
                  bringAllToFront);
-
+#else
+        RootlessOrderAllWindows(e->data[0]);
+#endif
         return TRUE;
 
     default:
-- 
2.52.0

