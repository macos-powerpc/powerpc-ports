From a0139abd3ae0aa1f1f4617782824f27c79ac1e31 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Fri, 26 Dec 2025 22:19:58 +0800
Subject: [PATCH 11/11] Misc hacks

---
 hw/xquartz/X11Application.h           | 10 ++++----
 hw/xquartz/X11Application.m           |  7 ------
 hw/xquartz/X11Controller.m            | 33 +++++++++++++++------------
 hw/xquartz/applewmExt.h               |  6 +++++
 hw/xquartz/mach-startup/bundle-main.c |  2 ++
 5 files changed, 33 insertions(+), 25 deletions(-)

diff --git a/hw/xquartz/X11Application.h b/hw/xquartz/X11Application.h
index 1ef98bee3..5dd1410e9 100644
--- a/hw/xquartz/X11Application.h
+++ b/hw/xquartz/X11Application.h
@@ -37,10 +37,12 @@
 
 #import "X11Controller.h"
 
-@interface X11Application : NSApplication
-
-@property (nonatomic, readwrite, strong) X11Controller *controller;
-@property (nonatomic, readonly, assign) OSX_BOOL x_active;
+@interface X11Application : NSApplication {
+    OSX_BOOL x_active;
+    X11Controller *controller;
+}
+@property (nonatomic, readwrite, retain) X11Controller *controller;
+@property (nonatomic, readwrite, assign) OSX_BOOL x_active;
 
 @end
 
diff --git a/hw/xquartz/X11Application.m b/hw/xquartz/X11Application.m
index d6c1c7aef..e2df7927f 100644
--- a/hw/xquartz/X11Application.m
+++ b/hw/xquartz/X11Application.m
@@ -159,13 +159,6 @@ X11Application *X11App;
 @property (nonatomic, readwrite, assign) OSX_BOOL x_active;
 @end
 
-@interface X11Application : NSApplication
-{
-    OSX_BOOL x_active;
-    id controller;
-}
-@end
-
 @implementation X11Application
 
 @synthesize x_active;
diff --git a/hw/xquartz/X11Controller.m b/hw/xquartz/X11Controller.m
index 0149dc45c..bf0f7b1ed 100644
--- a/hw/xquartz/X11Controller.m
+++ b/hw/xquartz/X11Controller.m
@@ -87,7 +87,7 @@ extern char *bundle_id_prefix;
 
         /* convert from [TITLE1 COMMAND1 TITLE2 COMMAND2 ...]
            to [[TITLE1 COMMAND1] [TITLE2 COMMAND2] ...] format. */
-        if (count > 0 && ![appsMenu[0] isKindOfClass:NSArray.class]) {
+        if (count > 0 && ![[appsMenu objectAtIndex:0] isKindOfClass:[NSArray class]]) {
             int i;
             NSMutableArray *copy, *sub;
 
@@ -95,8 +95,8 @@ extern char *bundle_id_prefix;
 
             for (i = 0; i < count / 2; i++) {
                 sub = [[NSMutableArray alloc] initWithCapacity:3];
-                [sub addObject:appsMenu[i * 2]];
-                [sub addObject:appsMenu[i * 2 + 1]];
+                [sub addObject:[appsMenu objectAtIndex:i * 2]];
+                [sub addObject:[appsMenu objectAtIndex:i * 2 + 1]];
                 [sub addObject:@""];
                 [copy addObject:sub];
                 [sub release];
@@ -109,7 +109,7 @@ extern char *bundle_id_prefix;
         [self set_apps_menu:appsMenu];
     }
 
-    [NSNotificationCenter.defaultCenter addObserver:self
+    [[NSNotificationCenter defaultCenter] addObserver:self
                                            selector:@selector(apps_table_done:)
                                                name:NSWindowWillCloseNotification
                                              object:self.apps_table.window];
@@ -236,25 +236,26 @@ extern char *bundle_id_prefix;
 
         for (NSInteger i = 0; i < itemsToAdd; i++) {
             NSString *name, *shortcut;
+            NSArray *row = [list objectAtIndex:i];
 
-            name = list[i][0];
-            shortcut = list[i][1];
+            name = [row objectAtIndex:0];
+            shortcut = [row objectAtIndex:1];
 
             if (windowItemModMask == 0 || windowItemModMask == -1)
                 shortcut = @"";
 
             item = (NSMenuItem *)[menu addItemWithTitle:name
-                                                 action:@selector(item_selected:)
-                                          keyEquivalent:shortcut];
+                                        action:@selector(item_selected:)
+                                    keyEquivalent:shortcut];
             [item setKeyEquivalentModifierMask:(NSUInteger)windowItemModMask];
             [item setTarget:self];
             [item setTag:i];
             [item setEnabled:YES];
 
-            item = (NSMenuItem *)[dock_menu  insertItemWithTitle:name
-                                                          action:@selector(item_selected:)
-                                                   keyEquivalent:shortcut
-                                                         atIndex:i];
+            item = (NSMenuItem *)[dock_menu insertItemWithTitle:name
+                                                action:@selector(item_selected:)
+                                            keyEquivalent:shortcut
+                                                atIndex:i];
             [item setKeyEquivalentModifierMask:(NSUInteger)windowItemModMask];
             [item setTarget:self];
             [item setTag:i];
@@ -362,6 +363,7 @@ extern char *bundle_id_prefix;
         setenv("DISPLAY", buf, TRUE);
     }
 
+#if defined(ASL_LOG_DESCRIPTOR_READ)
     if (&asl_log_descriptor) {
         char *asl_sender;
         aslmsg amsg = asl_new(ASL_TYPE_MSG);
@@ -393,6 +395,7 @@ extern char *bundle_id_prefix;
 
         asl_free(amsg);
     }
+#endif
 
     /* Do the fork-twice trick to avoid having to reap zombies */
     child1 = fork();
@@ -410,12 +413,13 @@ extern char *bundle_id_prefix;
             _exit(1);
 
         case 0:                                     /* child2 */
+#if defined(ASL_LOG_DESCRIPTOR_READ)
             if (&asl_log_descriptor) {
                 /* Replace our stdout/stderr */
                 dup2(stdout_pipe[1], STDOUT_FILENO);
                 dup2(stderr_pipe[1], STDERR_FILENO);
             }
-
+#endif
             /* close all open files except for standard streams */
             max_files = sysconf(_SC_OPEN_MAX);
             for (i = 3; i < max_files; i++)
@@ -436,12 +440,13 @@ extern char *bundle_id_prefix;
     default:                                    /* parent */
         waitpid(child1, &status, 0);
     }
-
+#if defined(ASL_LOG_DESCRIPTOR_READ)
     if (&asl_log_descriptor) {
         /* Close the write ends of the pipe */
         close(stdout_pipe[1]);
         close(stderr_pipe[1]);
     }
+#endif
 }
 
 - (void) app_selected:sender
diff --git a/hw/xquartz/applewmExt.h b/hw/xquartz/applewmExt.h
index 9a8b8d639..14c77214a 100644
--- a/hw/xquartz/applewmExt.h
+++ b/hw/xquartz/applewmExt.h
@@ -35,6 +35,12 @@
 #include "window.h"
 #include <Xplugin.h>
 
+#if XPLUGIN_VERSION < 4
+typedef int xp_frame_attr;
+typedef int xp_frame_class;
+typedef int xp_frame_rect;
+#endif
+
 typedef int (*DisableUpdateProc)(void);
 typedef int (*EnableUpdateProc)(void);
 typedef int (*SetWindowLevelProc)(WindowPtr pWin, int level);
diff --git a/hw/xquartz/mach-startup/bundle-main.c b/hw/xquartz/mach-startup/bundle-main.c
index e52dceda8..c5eb17102 100644
--- a/hw/xquartz/mach-startup/bundle-main.c
+++ b/hw/xquartz/mach-startup/bundle-main.c
@@ -524,8 +524,10 @@ setup_console_redirect(const char *bundle_id)
 
     asl_set_filter(aslc, ASL_FILTER_MASK_UPTO(ASL_LEVEL_WARNING));
 
+#if defined(ASL_LOG_DESCRIPTOR_READ)
     asl_log_descriptor(aslc, NULL, ASL_LEVEL_INFO, STDOUT_FILENO, ASL_LOG_DESCRIPTOR_WRITE);
     asl_log_descriptor(aslc, NULL, ASL_LEVEL_NOTICE, STDERR_FILENO, ASL_LOG_DESCRIPTOR_WRITE);
+#endif
 }
 
 static void
-- 
2.52.0

