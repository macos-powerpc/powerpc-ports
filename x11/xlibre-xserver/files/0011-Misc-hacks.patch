From a95ceceb117179e7a544da27781e7c0ce97c3534 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Fri, 26 Dec 2025 22:19:58 +0800
Subject: [PATCH 11/11] Misc hacks

---
 hw/xquartz/X11Application.h           | 10 ++++----
 hw/xquartz/X11Application.m           | 11 ---------
 hw/xquartz/X11Controller.m            | 33 +++++++++++++++------------
 hw/xquartz/applewmExt.h               |  6 +++++
 hw/xquartz/mach-startup/bundle-main.c |  2 ++
 hw/xquartz/quartz.c                   | 15 ++----------
 hw/xquartz/xpr/xprEvent.c             | 10 +++++++-
 7 files changed, 44 insertions(+), 43 deletions(-)

diff --git a/hw/xquartz/X11Application.h b/hw/xquartz/X11Application.h
index 1ef98bee3..5dd1410e9 100644
--- a/hw/xquartz/X11Application.h
+++ b/hw/xquartz/X11Application.h
@@ -37,10 +37,12 @@
 
 #import "X11Controller.h"
 
-@interface X11Application : NSApplication
-
-@property (nonatomic, readwrite, strong) X11Controller *controller;
-@property (nonatomic, readonly, assign) OSX_BOOL x_active;
+@interface X11Application : NSApplication {
+    OSX_BOOL x_active;
+    X11Controller *controller;
+}
+@property (nonatomic, readwrite, retain) X11Controller *controller;
+@property (nonatomic, readwrite, assign) OSX_BOOL x_active;
 
 @end
 
diff --git a/hw/xquartz/X11Application.m b/hw/xquartz/X11Application.m
index d6c1c7aef..4b3a9528d 100644
--- a/hw/xquartz/X11Application.m
+++ b/hw/xquartz/X11Application.m
@@ -155,17 +155,6 @@ X11Application *X11App;
 - (void) sendX11NSEvent:(NSEvent *)e;
 @end
 
-@interface X11Application ()
-@property (nonatomic, readwrite, assign) OSX_BOOL x_active;
-@end
-
-@interface X11Application : NSApplication
-{
-    OSX_BOOL x_active;
-    id controller;
-}
-@end
-
 @implementation X11Application
 
 @synthesize x_active;
diff --git a/hw/xquartz/X11Controller.m b/hw/xquartz/X11Controller.m
index 0149dc45c..bf0f7b1ed 100644
--- a/hw/xquartz/X11Controller.m
+++ b/hw/xquartz/X11Controller.m
@@ -87,7 +87,7 @@ extern char *bundle_id_prefix;
 
         /* convert from [TITLE1 COMMAND1 TITLE2 COMMAND2 ...]
            to [[TITLE1 COMMAND1] [TITLE2 COMMAND2] ...] format. */
-        if (count > 0 && ![appsMenu[0] isKindOfClass:NSArray.class]) {
+        if (count > 0 && ![[appsMenu objectAtIndex:0] isKindOfClass:[NSArray class]]) {
             int i;
             NSMutableArray *copy, *sub;
 
@@ -95,8 +95,8 @@ extern char *bundle_id_prefix;
 
             for (i = 0; i < count / 2; i++) {
                 sub = [[NSMutableArray alloc] initWithCapacity:3];
-                [sub addObject:appsMenu[i * 2]];
-                [sub addObject:appsMenu[i * 2 + 1]];
+                [sub addObject:[appsMenu objectAtIndex:i * 2]];
+                [sub addObject:[appsMenu objectAtIndex:i * 2 + 1]];
                 [sub addObject:@""];
                 [copy addObject:sub];
                 [sub release];
@@ -109,7 +109,7 @@ extern char *bundle_id_prefix;
         [self set_apps_menu:appsMenu];
     }
 
-    [NSNotificationCenter.defaultCenter addObserver:self
+    [[NSNotificationCenter defaultCenter] addObserver:self
                                            selector:@selector(apps_table_done:)
                                                name:NSWindowWillCloseNotification
                                              object:self.apps_table.window];
@@ -236,25 +236,26 @@ extern char *bundle_id_prefix;
 
         for (NSInteger i = 0; i < itemsToAdd; i++) {
             NSString *name, *shortcut;
+            NSArray *row = [list objectAtIndex:i];
 
-            name = list[i][0];
-            shortcut = list[i][1];
+            name = [row objectAtIndex:0];
+            shortcut = [row objectAtIndex:1];
 
             if (windowItemModMask == 0 || windowItemModMask == -1)
                 shortcut = @"";
 
             item = (NSMenuItem *)[menu addItemWithTitle:name
-                                                 action:@selector(item_selected:)
-                                          keyEquivalent:shortcut];
+                                        action:@selector(item_selected:)
+                                    keyEquivalent:shortcut];
             [item setKeyEquivalentModifierMask:(NSUInteger)windowItemModMask];
             [item setTarget:self];
             [item setTag:i];
             [item setEnabled:YES];
 
-            item = (NSMenuItem *)[dock_menu  insertItemWithTitle:name
-                                                          action:@selector(item_selected:)
-                                                   keyEquivalent:shortcut
-                                                         atIndex:i];
+            item = (NSMenuItem *)[dock_menu insertItemWithTitle:name
+                                                action:@selector(item_selected:)
+                                            keyEquivalent:shortcut
+                                                atIndex:i];
             [item setKeyEquivalentModifierMask:(NSUInteger)windowItemModMask];
             [item setTarget:self];
             [item setTag:i];
@@ -362,6 +363,7 @@ extern char *bundle_id_prefix;
         setenv("DISPLAY", buf, TRUE);
     }
 
+#if defined(ASL_LOG_DESCRIPTOR_READ)
     if (&asl_log_descriptor) {
         char *asl_sender;
         aslmsg amsg = asl_new(ASL_TYPE_MSG);
@@ -393,6 +395,7 @@ extern char *bundle_id_prefix;
 
         asl_free(amsg);
     }
+#endif
 
     /* Do the fork-twice trick to avoid having to reap zombies */
     child1 = fork();
@@ -410,12 +413,13 @@ extern char *bundle_id_prefix;
             _exit(1);
 
         case 0:                                     /* child2 */
+#if defined(ASL_LOG_DESCRIPTOR_READ)
             if (&asl_log_descriptor) {
                 /* Replace our stdout/stderr */
                 dup2(stdout_pipe[1], STDOUT_FILENO);
                 dup2(stderr_pipe[1], STDERR_FILENO);
             }
-
+#endif
             /* close all open files except for standard streams */
             max_files = sysconf(_SC_OPEN_MAX);
             for (i = 3; i < max_files; i++)
@@ -436,12 +440,13 @@ extern char *bundle_id_prefix;
     default:                                    /* parent */
         waitpid(child1, &status, 0);
     }
-
+#if defined(ASL_LOG_DESCRIPTOR_READ)
     if (&asl_log_descriptor) {
         /* Close the write ends of the pipe */
         close(stdout_pipe[1]);
         close(stderr_pipe[1]);
     }
+#endif
 }
 
 - (void) app_selected:sender
diff --git a/hw/xquartz/applewmExt.h b/hw/xquartz/applewmExt.h
index 9a8b8d639..14c77214a 100644
--- a/hw/xquartz/applewmExt.h
+++ b/hw/xquartz/applewmExt.h
@@ -35,6 +35,12 @@
 #include "window.h"
 #include <Xplugin.h>
 
+#if XPLUGIN_VERSION < 4
+typedef int xp_frame_attr;
+typedef int xp_frame_class;
+typedef int xp_frame_rect;
+#endif
+
 typedef int (*DisableUpdateProc)(void);
 typedef int (*EnableUpdateProc)(void);
 typedef int (*SetWindowLevelProc)(WindowPtr pWin, int level);
diff --git a/hw/xquartz/mach-startup/bundle-main.c b/hw/xquartz/mach-startup/bundle-main.c
index e52dceda8..c5eb17102 100644
--- a/hw/xquartz/mach-startup/bundle-main.c
+++ b/hw/xquartz/mach-startup/bundle-main.c
@@ -524,8 +524,10 @@ setup_console_redirect(const char *bundle_id)
 
     asl_set_filter(aslc, ASL_FILTER_MASK_UPTO(ASL_LEVEL_WARNING));
 
+#if defined(ASL_LOG_DESCRIPTOR_READ)
     asl_log_descriptor(aslc, NULL, ASL_LEVEL_INFO, STDOUT_FILENO, ASL_LOG_DESCRIPTOR_WRITE);
     asl_log_descriptor(aslc, NULL, ASL_LEVEL_NOTICE, STDERR_FILENO, ASL_LOG_DESCRIPTOR_WRITE);
+#endif
 }
 
 static void
diff --git a/hw/xquartz/quartz.c b/hw/xquartz/quartz.c
index a8bce1532..7c941bb28 100644
--- a/hw/xquartz/quartz.c
+++ b/hw/xquartz/quartz.c
@@ -69,10 +69,6 @@
 #include <signal.h>
 #include <AvailabilityMacros.h>
 
-#ifndef __clang__
-#include <Foundation/Foundation.h>
-#endif
-
 #include <rootlessCommon.h>
 #include <Xplugin.h>
 
@@ -82,7 +78,7 @@
 // in the OS without major bincompat ramifications.
 //
 // These were added in macOS 10.7.
-#ifdef __clang__ && (MAC_OS_X_VERSION_MIN_REQUIRED >= 1070)
+#if defined(__clang__) && (MAC_OS_X_VERSION_MIN_REQUIRED >= 1070)
 void * _Nonnull objc_autoreleasePoolPush(void);
 void objc_autoreleasePoolPop(void * _Nonnull context);
 #endif
@@ -167,20 +163,13 @@ QuartzSetupScreen(int index,
 static void
 QuartzBlockHandler(void *blockData, void *pTimeout)
 {
-#ifdef __clang__ && (MAC_OS_X_VERSION_MIN_REQUIRED >= 1070)
+#if defined(__clang__) && (MAC_OS_X_VERSION_MIN_REQUIRED >= 1070)
     static void *poolToken = NULL;
 
     if (poolToken) {
         objc_autoreleasePoolPop(poolToken);
     }
     poolToken = objc_autoreleasePoolPush();
-#else
-    static NSAutoreleasePool *pool = nil;
-
-    if (pool) {
-        [pool drain];
-    }
-    pool = [[NSAutoreleasePool alloc] init];
 #endif
 }
 
diff --git a/hw/xquartz/xpr/xprEvent.c b/hw/xquartz/xpr/xprEvent.c
index 9fe33c6c5..937c4c1b6 100644
--- a/hw/xquartz/xpr/xprEvent.c
+++ b/hw/xquartz/xpr/xprEvent.c
@@ -50,7 +50,10 @@
 #include <sys/uio.h>
 #include <unistd.h>
 
+// Unused otherwise, see below.
+#if XPLUGIN_VERSION >= 6
 #include <dispatch/dispatch.h>
+#endif
 
 #include "rootlessWindow.h"
 #include "xprEvent.h"
@@ -59,7 +62,9 @@ static void
 bringAllToFront(void *unused)
 {
     (void) unused; /* to silence the compiler warning */
+#if XPLUGIN_VERSION >= 6
     xp_window_bring_all_to_front();
+#endif
 }
 
 Bool
@@ -79,10 +84,13 @@ QuartzModeEventHandler(int screenNum, XQuartzEvent *e, DeviceIntPtr dev)
 
     case kXquartzBringAllToFront:
         DEBUG_LOG("kXquartzBringAllToFront\n");
+#if XPLUGIN_VERSION >= 6 // No xp_window_bring_all_to_front before that.
         dispatch_async_f(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0),
                  NULL,
                  bringAllToFront);
-
+#else
+        RootlessOrderAllWindows(e->data[0]);
+#endif
         return TRUE;
 
     default:
-- 
2.52.0

