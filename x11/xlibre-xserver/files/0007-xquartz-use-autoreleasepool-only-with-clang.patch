From 7c99ac5204d4f7d388e1a439ad96ec3c71ad6008 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Thu, 25 Dec 2025 01:46:03 +0800
Subject: [PATCH 7/7] xquartz: use autoreleasepool only with clang

---
 hw/xquartz/X11Application.m  | 27 ++++++++++++++++++++++++---
 hw/xquartz/pbproxy/main.m    | 18 +++++++++++++++++-
 hw/xquartz/pbproxy/x-input.m | 14 ++++++++++++--
 hw/xquartz/quartz.c          | 16 ++++++++++++++++
 4 files changed, 69 insertions(+), 6 deletions(-)

diff --git a/hw/xquartz/X11Application.m b/hw/xquartz/X11Application.m
index 21c19296c..fcf9f8dda 100644
--- a/hw/xquartz/X11Application.m
+++ b/hw/xquartz/X11Application.m
@@ -581,7 +581,11 @@ void
 X11ApplicationSetWindowMenu(int nitems, const char **items,
                             const char *shortcuts)
 {
+#ifdef __clang__
     @autoreleasepool {
+#else
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
+#endif
         NSMutableArray<NSArray<NSString *> *> *allMenuItems =
             [[NSMutableArray alloc] init];
 
@@ -605,7 +609,11 @@ X11ApplicationSetWindowMenu(int nitems, const char **items,
         dispatch_async_f(dispatch_get_main_queue(),
                          allMenuItems,
                          setWindowMenuOnMain_fptr);
+#ifdef __clang__
     }
+#else
+    [pool drain];
+#endif
 }
 
 static void
@@ -686,14 +694,21 @@ appLaunchClient_fptr(void *string_ptr)
 void
 X11ApplicationLaunchClient(const char *cmd)
 {
+#ifdef __clang__
     @autoreleasepool {
+#else
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
+#endif
         NSString *string_alloc = [[NSString alloc] initWithUTF8String:cmd];
         dispatch_async_f(dispatch_get_main_queue(), string_alloc, appLaunchClient_fptr);
+#ifdef __clang__
     }
+#else
+    [pool drain];
+#endif
 }
 
 
-
 /* helper function for X11ApplicationCanEnterRandR(),
  * extracted from previous Apple block */
 static void
@@ -722,7 +737,6 @@ runAlertPanel(void *result_ptr)
 Bool
 X11ApplicationCanEnterRandR(void)
 {
-    
     NSUserDefaults * const defaults = NSUserDefaults.xquartzDefaults;
 
     if ([defaults boolForKey:XQuartzPrefKeyNoRANDRAlert] ||
@@ -822,7 +836,11 @@ X11ApplicationMain(int argc, char **argv, char **envp)
     while (access("/tmp/x11-block", F_OK) == 0) sleep(1);
 #endif
 
+#ifdef __clang__
     @autoreleasepool {
+#else
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
+#endif
         X11App = (X11Application *)[X11Application sharedApplication];
         [X11App read_defaults];
 
@@ -874,8 +892,11 @@ X11ApplicationMain(int argc, char **argv, char **envp)
         [[SUUpdater sharedUpdater] resetUpdateCycle];
         //    [[SUUpdater sharedUpdater] checkForUpdates:X11App];
 #endif
+#ifdef __clang__
     }
-
+#else
+    [pool drain];
+#endif
     [NSApp run];
     /* not reached */
 }
diff --git a/hw/xquartz/pbproxy/main.m b/hw/xquartz/pbproxy/main.m
index 92cde0437..c2efbd3ff 100644
--- a/hw/xquartz/pbproxy/main.m
+++ b/hw/xquartz/pbproxy/main.m
@@ -78,7 +78,11 @@ x_error_handler(Display *dpy, XErrorEvent *errevent)
 int
 xpbproxy_run(void)
 {
+#ifdef __clang__
     @autoreleasepool {
+#else
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
+#endif
         size_t i;
 
         for (i = 0, xpbproxy_dpy = NULL; !xpbproxy_dpy && i < 5; i++) {
@@ -97,6 +101,9 @@ xpbproxy_run(void)
 
         if (xpbproxy_dpy == NULL) {
             ErrorF("xpbproxy: can't open default display\n");
+    #ifndef __clang__
+            [pool drain];
+    #endif
             return EXIT_FAILURE;
         }
 
@@ -106,6 +113,9 @@ xpbproxy_run(void)
         if (!XAppleWMQueryExtension(xpbproxy_dpy, &xpbproxy_apple_wm_event_base,
                                     &xpbproxy_apple_wm_error_base)) {
             ErrorF("xpbproxy: can't open AppleWM server extension\n");
+    #ifndef __clang__
+            [pool drain];
+    #endif
             return EXIT_FAILURE;
         }
 
@@ -117,10 +127,16 @@ xpbproxy_run(void)
         _selection_object = [x_selection new];
 
         if (!xpbproxy_input_register()) {
+    #ifndef __clang__
+            [pool drain];
+    #endif
             return EXIT_FAILURE;
         }
+#ifdef __clang__
     }
-
+#else
+    [pool drain];
+#endif
     CFRunLoopRun();
 
     return EXIT_SUCCESS;
diff --git a/hw/xquartz/pbproxy/x-input.m b/hw/xquartz/pbproxy/x-input.m
index 3be9ce407..049acae08 100644
--- a/hw/xquartz/pbproxy/x-input.m
+++ b/hw/xquartz/pbproxy/x-input.m
@@ -89,7 +89,12 @@ x_event_apple_wm_notify(XAppleWMNotifyEvent *e)
 static void
 xpbproxy_process_xevents(void)
 {
-    while (XPending(xpbproxy_dpy) != 0) { @autoreleasepool {
+    while (XPending(xpbproxy_dpy) != 0) {
+#ifdef __clang__
+    @autoreleasepool {
+#else
+    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
+#endif
         XEvent e;
 
         XNextEvent(xpbproxy_dpy, &e);
@@ -127,7 +132,12 @@ xpbproxy_process_xevents(void)
         }
 
         XFlush(xpbproxy_dpy);
-    }}
+#ifdef __clang__
+        }
+#else
+        [pool drain];
+#endif
+    }
 }
 
 static BOOL
diff --git a/hw/xquartz/quartz.c b/hw/xquartz/quartz.c
index c587a6702..a8bce1532 100644
--- a/hw/xquartz/quartz.c
+++ b/hw/xquartz/quartz.c
@@ -67,6 +67,11 @@
 #include <IOKit/pwr_mgt/IOPMLib.h>
 #include <libkern/OSAtomic.h>
 #include <signal.h>
+#include <AvailabilityMacros.h>
+
+#ifndef __clang__
+#include <Foundation/Foundation.h>
+#endif
 
 #include <rootlessCommon.h>
 #include <Xplugin.h>
@@ -77,8 +82,10 @@
 // in the OS without major bincompat ramifications.
 //
 // These were added in macOS 10.7.
+#ifdef __clang__ && (MAC_OS_X_VERSION_MIN_REQUIRED >= 1070)
 void * _Nonnull objc_autoreleasePoolPush(void);
 void objc_autoreleasePoolPop(void * _Nonnull context);
+#endif
 
 DevPrivateKeyRec quartzScreenKeyRec;
 int aquaMenuBarHeight = 0;
@@ -160,12 +167,21 @@ QuartzSetupScreen(int index,
 static void
 QuartzBlockHandler(void *blockData, void *pTimeout)
 {
+#ifdef __clang__ && (MAC_OS_X_VERSION_MIN_REQUIRED >= 1070)
     static void *poolToken = NULL;
 
     if (poolToken) {
         objc_autoreleasePoolPop(poolToken);
     }
     poolToken = objc_autoreleasePoolPush();
+#else
+    static NSAutoreleasePool *pool = nil;
+
+    if (pool) {
+        [pool drain];
+    }
+    pool = [[NSAutoreleasePool alloc] init];
+#endif
 }
 
 /*
-- 
2.52.0

