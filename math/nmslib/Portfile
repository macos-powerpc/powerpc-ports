# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0

github.setup        nmslib nmslib 6e7ce26912cfe4a31bbd6b4865eaef5f079faa08
version             2026.01.06
categories          math
license             Apache-2
maintainers         {@barracuda156 gmail.com:vital.had} openmaintainer
description         Non-Metric Space Library (NMSLIB)
long_description    Efficient similarity search library and a toolkit \
                    for evaluation of k-NN methods for generic non-metric spaces
checksums           rmd160  75a4b27494d1e4374a081334fffdbc3fe644bebc \
                    sha256  60d34dcbeff32cf3df8f7dc1bad059a15e3241bd2e639497ff3a52eb81ee7eb1 \
                    size    67287569
github.tarball_from archive

cmake.build_type    Release

cmake.source_dir    ${worksrcpath}/similarity_search

# Otherwise tests cannot find support files.
# https://github.com/nmslib/nmslib/issues/570
cmake.out_of_source no

patchfiles-append   patch-fix-tests.diff

depends_build-append \
                    path:bin/pkg-config:pkgconfig
depends_lib-append  path:share/pkgconfig/eigen3.pc:eigen3

# Current Eigen needs C++14:
post-patch {
    reinplace "s|-std=c++11|-std=c++14|g" ${cmake.source_dir}/CMakeLists.txt

    platform powerpc {
        reinplace "s|-march=native|-mtune=native|" ${cmake.source_dir}/CMakeLists.txt
    }
}

compiler.cxx_standard           2014
compiler.thread_local_storage   yes

# https://github.com/nmslib/nmslib/issues/545
compiler.blacklist-append       {clang}

configure.args-append \
                    -DWITH_EXTRAS=ON

# Disabled for now due to:
# https://github.com/nmslib/nmslib/issues/546
test.run            yes
test.dir            ${cmake.source_dir}/release
test.cmd            ./bunit
test.target
test.env-append     DYLD_LIBRARY_PATH=${test.dir}
